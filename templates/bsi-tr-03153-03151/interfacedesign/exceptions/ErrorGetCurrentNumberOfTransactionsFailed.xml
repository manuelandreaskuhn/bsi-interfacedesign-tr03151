<?xml version="1.0" encoding="UTF-8"?>
<exception id="ErrorGetCurrentNumberOfTransactionsFailed" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
    <name>ErrorGetCurrentNumberOfTransactionsFailed</name>
    <description>This exception is thrown if the determination of the number of currently opened transactions failed. ErrorGetCurrentNumberOfTransactionsFailed represents a failure in the device's ability to retrieve and report the count of currently active transactions. This exception indicates that the getCurrentNumberOfTransactions function requested transaction count information from the device but the device cannot determine or provide the required count due to a hardware error, firmware issue, transaction registry failure, or communication breakdown. The exception is raised when the device's transaction management tracking functionality did not complete successfully, preventing applications from monitoring active transactions and device transaction utilization. The exception is raised during the transaction count retrieval phase before the count is packaged into the return structure, ensuring no partial or incomplete count data is returned.</description>
    <category>Transaction Management - Information Retrieval</category>
    <severity>Medium</severity>
    <javadoc>
        <summary>This class defines the exception ErrorGetCurrentNumberOfTransactionsFailed that is thrown if the determination of the number of currently opened transactions failed.</summary>
        <description>The getCurrentNumberOfTransactions function performs a multi-step process to determine how many transactions are currently opened and active. This exception is raised when the device cannot provide the required transaction count information during the retrieval phase. When this exception occurs, no transaction count data is returned to the user, and the function exits without providing any count information. The failure indicates that the device's transaction counting or reporting functionality did not complete successfully, preventing applications from monitoring active transactions.</description>
        <constructors>
            <constructor>
                <signature>ErrorGetCurrentNumberOfTransactionsFailed()</signature>
                <description>Constructs a new ErrorGetCurrentNumberOfTransactionsFailed exception with null as the value for its detail message</description>
            </constructor>
            <constructor>
                <signature>ErrorGetCurrentNumberOfTransactionsFailed(String message)</signature>
                <description>Constructs a new ErrorGetCurrentNumberOfTransactionsFailed exception whereby its detail message is initialized with the passed value</description>
                <parameter name="message">value for the detail message of the exception, typically describing the transaction count retrieval failure</parameter>
            </constructor>
            <constructor>
                <signature>ErrorGetCurrentNumberOfTransactionsFailed(String message, Throwable cause)</signature>
                <description>Constructs a new ErrorGetCurrentNumberOfTransactionsFailed exception whereby its detail message and cause are initialized with the appropriate passed values</description>
                <parameter name="message">value for the detail message of the exception</parameter>
                <parameter name="cause">value for the cause of the exception</parameter>
            </constructor>
            <constructor>
                <signature>ErrorGetCurrentNumberOfTransactionsFailed(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace)</signature>
                <description>Constructs a new ErrorGetCurrentNumberOfTransactionsFailed exception whereby its detail message and cause are initialized with the appropriate passed values. Furthermore, it is specified whether or not suppression should be enabled or disabled and whether or not the stack trace should be writable for this exception.</description>
                <parameter name="message">value for the detail message of the exception</parameter>
                <parameter name="cause">value for the cause of the exception</parameter>
                <parameter name="enableSuppression">specifies whether or not suppression should be enabled for this exception</parameter>
                <parameter name="writableStackTrace">specifies whether or not the stack trace should be writable for this exception</parameter>
            </constructor>
        </constructors>
    </javadoc>
    <specification>
        <source>BSI TR-03151-1</source>
        <section>3.3.16 Transaction Management - getCurrentNumberOfTransactions</section>
        <requirement>The function getCurrentNumberOfTransactions SHALL query the device to determine how many transactions are currently opened and active. If the device cannot provide or determine the required transaction count information, the function SHALL raise the exception ErrorGetCurrentNumberOfTransactionsFailed and exit without returning any count data. The transaction count determination failure indicates the device's transaction tracking functionality could not complete successfully.</requirement>
        <applicability>Transaction management operations - getCurrentNumberOfTransactions function only</applicability>
        <reference>getCurrentNumberOfTransactions â€“ Function (3.3.16)</reference>
    </specification>
    <thrownBy>
        <function>getCurrentNumberOfTransactions</function>
    </thrownBy>
    <triggerConditions>
        <condition>
            <scenario>Device transaction registry query failure</scenario>
            <description>The device attempts to query the transaction registry to determine the current count of active transactions, but the registry is inaccessible or the query fails. Transaction count retrieval fails due to registry errors.</description>
            <trigger>Device transaction registry query failure or inaccessibility preventing transaction count determination</trigger>
        </condition>
        <condition>
            <scenario>Transaction registry storage failure or corruption</scenario>
            <description>The device's transaction registry storage is corrupted, inaccessible, or in an inconsistent state preventing accurate transaction count determination.</description>
            <trigger>Transaction registry storage failure or transaction registry data corruption preventing retrieval</trigger>
        </condition>
        <condition>
            <scenario>Device transaction management system error</scenario>
            <description>The device's transaction management system encounters an internal error or exception while processing the transaction count request. Firmware bugs, memory corruption, or state inconsistency prevent successful transaction count determination.</description>
            <trigger>Device transaction management system error during transaction count retrieval and determination operation</trigger>
        </condition>
        <condition>
            <scenario>Communication failure during transaction count transfer</scenario>
            <description>The device successfully determines the transaction count but the communication channel fails during transfer of count data from device to caller. The application cannot receive the complete count information.</description>
            <trigger>Communication failure during transaction count data transfer from device</trigger>
        </condition>
        <condition>
            <scenario>Device in restricted state preventing transaction tracking access</scenario>
            <description>The device has entered a protected, restricted, or locked state that prevents access to or retrieval of transaction tracking information. Transaction count query is blocked by device security restrictions.</description>
            <trigger>Device in restricted state preventing transaction management information access or retrieval</trigger>
        </condition>
    </triggerConditions>
    <executionSequence>
        <step number="1" name="Function Invocation">User or application calls getCurrentNumberOfTransactions function</step>
        <step number="2" name="Authentication Check">The function checks authentication status if required by the implementation guideline</step>
        <step number="3" name="Authorization Check">The function checks authorization to verify the caller has permission to query transaction management information</step>
        <step number="4" name="Device Initialization Verification">The function verifies that the device is in an initialized state and ready for transaction information queries</step>
        <step number="5" name="Transaction Registry Query">The function sends a request to the device to query the transaction registry and determine the current number of active transactions</step>
        <step number="5a" name="Transaction Count Retrieval Success">If the device successfully queries the transaction registry and determines the current transaction count, execution continues to step 6 (not taken in this exception case)</step>
        <step number="5b" name="Transaction Count Retrieval Failure">If the device cannot query the registry, determine the count, or provide the required transaction count information due to storage failure, firmware error, communication loss, or security restrictions, execution branches to exception handling at step 6b</step>
        <step number="6a" name="Count Validation and Return">Upon successful transaction count retrieval, the function validates the count and prepares the return value (not taken in this exception case)</step>
        <step number="6b" name="Exception Context Preparation">Upon transaction count retrieval failure, exception context is prepared including device error details, transaction management context, and timestamp</step>
        <step number="7" name="Exception Instance Creation">ErrorGetCurrentNumberOfTransactionsFailed exception instance is created with error message indicating device transaction count determination failure</step>
        <step number="8" name="Exception Propagation">Exception is raised and propagated up the call stack without returning any transaction count data to the caller</step>
        <step number="9" name="Device State Verification">The device and transaction registry remain in their current state with no modifications or data extraction having occurred</step>
    </executionSequence>
    <recovery>
        <step>Verify that the device is functioning properly and is not in a failed, error, or restricted state</step>
        <step>Ensure the device is properly initialized before attempting to retrieve current transaction count</step>
        <step>Verify the device's transaction registry is not corrupted or inaccessible using device diagnostics</step>
        <step>Check the communication channel between the application and device for any errors, interference, or disconnection issues</step>
        <step>Review device diagnostics to verify that transaction management and registry functionality is operational</step>
        <step>Verify that currently active transactions can still communicate with the device by testing with existing transaction operations</step>
        <step>Attempt to start or finish a test transaction to verify that transaction management operations still function correctly</step>
        <step>Check if transaction registry consistency can be verified through alternative queries (getMaxNumberOfTransactions, getOpenTransactions)</step>
        <step>Attempt the getCurrentNumberOfTransactions function again after verifying device status to determine if the failure was transient</step>
        <step>Implement comprehensive logging of this failure to understand if transaction counting is consistently unavailable or experiencing intermittent issues</step>
    </recovery>
    <relatedExceptions>
        <exception>ErrorFunctionFailed</exception>
        <exception>ErrorDeviceNotInitialized</exception>
        <exception>ErrorClientNotRegistered</exception>
        <exception>ErrorGetMaxNumberOfTransactionsFailed</exception>
        <exception>ErrorGetOpenTransactionsFailed</exception>
    </relatedExceptions>
    <postconditionality>
        <state name="Transaction Count State">No transaction count data is returned to the caller. The transaction count retrieval has not completed and no information is provided to the user.</state>
        <state name="Device State">Device state remains completely unchanged. No modifications to internal state, configuration, or data structures have occurred during the transaction count retrieval attempt.</state>
        <state name="Transaction Registry State">Transaction registry remains unchanged and all active transactions remain active. No transactions have been started or finished as a result of this operation.</state>
        <state name="Transaction Functionality">All currently active transactions continue to function normally. The count retrieval failure does not affect existing transaction operations.</state>
        <state name="State Consistency">No state inconsistency exists. The function exits at the transaction count retrieval phase before any data assembly or return operations.</state>
        <state name="Device Functionality">Device functions continue to execute normally. The device remains fully operational and all API functions remain accessible.</state>
    </postconditionality>
    <notes>
        <note>ErrorGetCurrentNumberOfTransactionsFailed is thrown ONLY by the getCurrentNumberOfTransactions function - it is the most specific exception for transaction count retrieval failures.</note>
        <note>This exception indicates a failure in the device's ability to report the current number of active transactions during the retrieval phase (step 5b), before count validation and return.</note>
        <note>Unlike ErrorFunctionFailed (which indicates unexpected critical errors), ErrorGetCurrentNumberOfTransactionsFailed specifically indicates transaction count information is unavailable or cannot be determined.</note>
        <note>After this exception is raised, the device remains unchanged and active transactions remain intact. All existing transactions continue to function normally. The transaction count query can be retried once the underlying issue is resolved.</note>
        <note>This exception has Medium severity because it prevents users from monitoring active transactions and device transaction utilization, but does not prevent device operation or existing transaction functionality.</note>
        <note>Transaction count information is essential for monitoring transaction status, capacity planning, understanding device transaction processing capacity in multi-transaction environments, and preventing transaction overflow.</note>
        <note>The getCurrentNumberOfTransactions function returns only the COUNT of active transactions, not their details or identities. Use getOpenTransactions for detailed transaction information.</note>
        <note>The transaction count must always be between 0 and the maximum number of transactions supported by the device. Failures in tracking may indicate transaction registry corruption or transaction management issues.</note>
        <note>Applications should implement appropriate error handling for transaction count retrieval failures and not assume current transaction information is always available or consistent across multiple queries.</note>
        <note>If this exception occurs repeatedly, it indicates a serious issue with transaction management tracking or transaction registry integrity that may require professional investigation or device repair.</note>
    </notes>
    <usage>
        <scenario name="Scenario 1: Transaction Capacity Monitoring During Transaction Start">
            <description>An application monitors active transactions and ensures that the device does not exceed transaction capacity. Before starting a new transaction, the application calls getCurrentNumberOfTransactions to check available capacity. If ErrorGetCurrentNumberOfTransactionsFailed is raised, the application conservatively refuses to start new transactions to avoid potential transaction overflow.</description>
            <relatedFunctions>getCurrentNumberOfTransactions, getMaxNumberOfTransactions, startTransaction</relatedFunctions>
            <errorContext>Transaction count unavailable preventing capacity verification for new transaction start</errorContext>
        </scenario>
        <scenario name="Scenario 2: System Health Monitoring and Diagnostics">
            <description>An application collects comprehensive device diagnostic information for monitoring and support purposes. As part of this process, it queries getCurrentNumberOfTransactions to track device transaction load. If ErrorGetCurrentNumberOfTransactionsFailed is raised, the application logs this as a diagnostic indicator of potential transaction management issues.</description>
            <relatedFunctions>getCurrentNumberOfTransactions, getMaxNumberOfTransactions, getOpenTransactions, getDeviceHealth</relatedFunctions>
            <errorContext>Transaction count information unavailable during system health monitoring</errorContext>
        </scenario>
        <scenario name="Scenario 3: Cross-Validation of Transaction Management Data">
            <description>An application verifies consistency in transaction management by cross-checking getCurrentNumberOfTransactions against getMaxNumberOfTransactions and attempting to list open transactions. If ErrorGetCurrentNumberOfTransactionsFailed is raised but other queries succeed, it indicates a specific transaction counting issue versus general transaction management failure.</description>
            <relatedFunctions>getCurrentNumberOfTransactions, getMaxNumberOfTransactions, getOpenTransactions</relatedFunctions>
            <errorContext>Transaction count retrieval failure for consistency verification</errorContext>
        </scenario>
        <scenario name="Scenario 4: Multi-Device Transaction Load Distribution">
            <description>An enterprise application manages transactions across multiple devices and attempts to distribute transaction load. The application queries getCurrentNumberOfTransactions on each device to determine utilization. If ErrorGetCurrentNumberOfTransactionsFailed is raised on one device, the application marks that device as having unknown capacity and routes new transactions away from it until the issue is resolved.</description>
            <relatedFunctions>getCurrentNumberOfTransactions, getMaxNumberOfTransactions, startTransaction</relatedFunctions>
            <errorContext>Transaction count unavailable for load distribution decisions in multi-device environment</errorContext>
        </scenario>
    </usage>
    <implementationContext>
        <note>The getCurrentNumberOfTransactions function is part of the transaction management subsystem that tracks active transactions and their lifecycle.</note>
        <note>A transaction is started using the startTransaction function, updated with updateTransaction, and finished using finishTransaction. The count reflects the current active transaction state.</note>
        <note>The current number of transactions must always be between 0 and the maximum number of transactions supported by the device as returned by getMaxNumberOfTransactions.</note>
        <note>Transaction count information is essential for understanding device transaction processing capacity, load distribution, and multi-transaction environment management in enterprise deployments.</note>
        <note>If transaction count retrieval fails but transactions continue to operate normally and other transaction management functions work correctly, the issue is with the counting/tracking mechanism, not the underlying transaction management itself.</note>
        <note>Active transactions are those that have been started but not yet finished, including transactions in various states of progress (initiated, processing, awaiting completion).</note>
        <note>Different device models and configurations may support different maximum numbers of concurrent transactions, making the relationship between current and maximum counts important for capacity planning.</note>
        <note>Transaction count retrieval is a read-only query that should not modify device state or affect existing active transactions, so recovery typically only requires retrying the query.</note>
    </implementationContext>
</exception>
