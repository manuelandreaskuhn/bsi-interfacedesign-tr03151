<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorSigningEventDataFailed" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorSigningEventDataFailed</name>
  <description>This exception is thrown if the Secure Element fails to create the log message parts and digital signature for event data during transaction processing. The Secure Element signs transaction event data to create a tamper-proof audit trail where signatures prove the integrity and authenticity of recorded transactions. The signing process includes formatting event data, computing digital signatures, and creating log message parts. If the signing operation fails, ErrorSigningEventDataFailed indicates the event data could not be signed and no tamper-proof record of the transaction was created. Common causes include: cryptographic operation failures, device processing errors, invalid event data, insufficient device resources, or communication failures. ErrorSigningEventDataFailed indicates a critical audit trail failure and the transaction may not have been properly recorded.</description>
  <category>Logging</category>
  <subcategory>Event Signing - Signature Creation Failure</subcategory>
  <severity>Critical</severity>
  <thrownBy>
    <function>authenticateUser</function>
    <function>configureLogging</function>
    <function>deleteLogMessages</function>
    <function>deregisterClient</function>
    <function>disableSecureElement</function>
    <function>finishTransaction</function>
    <function>initialize</function>
    <function>lockTransactionLogging</function>
    <function>logOut</function>
    <function>registerClient</function>
    <function>selfTest</function>
    <function>setDescription</function>
    <function>startTransaction</function>
    <function>unblockPin</function>
    <function>unlockTransactionLogging</function>
    <function>updateDevice</function>
    <function>updateTime</function>
    <function>updateTransaction</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorSigningEventDataFailed that is thrown if Secure Element signing of event data fails.</summary>
    <description>This exception is thrown when the Secure Element fails to create log message parts and digital signatures for transaction event data. Digital signatures on transaction data create a cryptographic proof of transaction integrity and authenticity, preventing tampering and providing audit trail protection. ErrorSigningEventDataFailed indicates that the signing operation could not be completed. Common causes include: cryptographic operation failures (signature generation, key operations), device processing errors, invalid or corrupted event data, insufficient device resources, communication failures, or cryptographic key issues. ErrorSigningEventDataFailed is a Critical severity exception because it indicates the audit trail cannot be reliably maintained for the transaction. Without successful signing, the transaction is not protected by cryptographic proof of integrity. Recovery requires investigating the cryptographic failure and potentially retrying the operation or checking device state.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.2 Transaction Operations - Digital Signatures for Event Data</section>
    <requirement>During transaction processing (startTransaction, updateTransaction, finishTransaction), the Secure Element SHALL create digital signatures over transaction event data to establish cryptographic proof of transaction integrity and authenticity. The signing process includes formatting event data, computing digital signatures using cryptographic keys, and generating log message parts containing the signature and metadata. If the signing operation fails at any step (data formatting, signature computation, or log message generation), the function SHALL raise ErrorSigningEventDataFailed. The transaction may not have been properly recorded if signing fails. Event data signing is essential for audit trail integrity and must not be bypassed.</requirement>
    <applicability>Transaction operations requiring event data signing: startTransaction, updateTransaction, finishTransaction</applicability>
    <reference>Transaction Operations (3.3.2), Digital Signature Generation</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Cryptographic signature generation failure</scenario>
      <description>The cryptographic operation to generate the signature fails</description>
      <trigger>A startTransaction call formats event data and attempts signature generation but the cryptographic operation fails (key issue, algorithm failure). ErrorSigningEventDataFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Invalid or corrupted event data for signing</scenario>
      <description>The event data to be signed is invalid or corrupted</description>
      <trigger>An updateTransaction call attempts to sign event data but the data is invalid or corrupted. The device detects the invalid data and raises ErrorSigningEventDataFailed.</trigger>
    </condition>
    <condition>
      <scenario>Device cryptographic processor failure</scenario>
      <description>The device cryptographic processor fails during signing operation</description>
      <trigger>A finishTransaction call initiates signing but the device cryptographic processor fails or becomes unavailable. ErrorSigningEventDataFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Insufficient device resources for signing</scenario>
      <description>The device lacks sufficient resources to complete signing operation</description>
      <trigger>A startTransaction call attempts signing but the device runs out of memory or processing capacity. The signing operation cannot complete and ErrorSigningEventDataFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Communication failure during signature generation</scenario>
      <description>Communication with the device fails during the signing operation</description>
      <trigger>An updateTransaction call transmits event data for signing but communication is interrupted before signature is returned. ErrorSigningEventDataFailed is raised.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls transaction operation that requires event signing (e.g., finishTransaction)</step>
    <step number="2">Function validates input parameters and transaction context</step>
    <step number="3">Function initiates communication with Secure Element</step>
    <step number="4">Secure Element receives transaction event data</step>
    <step number="5">Secure Element validates and formats event data for signing</step>
    <step number="5a">If event data invalid → ErrorSigningEventDataFailed raised, operation aborted</step>
    <step number="5b">If event data valid → proceed to step 6</step>
    <step number="6">Secure Element retrieves cryptographic signing key</step>
    <step number="6a">If key retrieval fails → ErrorSigningEventDataFailed raised, operation aborted</step>
    <step number="6b">If key retrieved successfully → proceed to step 7</step>
    <step number="7">Secure Element computes digital signature over event data</step>
    <step number="7a">If signature computation fails → ErrorSigningEventDataFailed raised, operation aborted</step>
    <step number="7b">If signature computation succeeds → proceed to step 8</step>
    <step number="8">Secure Element constructs log message parts including signature and metadata</step>
    <step number="8a">If log message construction fails → ErrorSigningEventDataFailed raised, operation aborted</step>
    <step number="8b">If log message construction succeeds → proceed to step 9</step>
    <step number="9">Secure Element stores log message parts in audit trail</step>
    <step number="10">Secure Element returns signed event data and log message parts to function</step>
    <step number="11">Function processes result and returns to caller</step>
  </executionSequence>
  <recovery>
    <step>Verify device is initialized</step>
    <step>Confirm Secure Element is operational</step>
    <step>Check if signature counter is exhausted</step>
    <step>Retry logging operation after confirming preconditions</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorDeviceInitializationFailed</exception>
    <exception>ErrorConfigureLoggingFailed</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Event Data Not Signed">The transaction event data is not signed by the device.</state>
    <state name="Signature Not Created">The digital signature over event data is not created.</state>
    <state name="Log Message Not Generated">The log message parts containing signature and metadata are not generated.</state>
    <state name="Transaction Not Properly Recorded">The transaction may not have been properly recorded in the tamper-proof audit trail.</state>
    <state name="Audit Trail Integrity Compromised">The transaction lacks cryptographic proof of integrity and authenticity.</state>
    <state name="Transaction State Uncertain">The transaction state is uncertain - it may or may not have been processed.</state>
  </postconditionality>
  <notes>
    <note>Indication: Signing of event data failed - cryptographic operation unsuccessful</note>
    <note>Topics: Logging Operations, Cryptography, Signature Operations, Event Signing</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Transaction Signing with Cryptographic Failure">
      <description>A finishTransaction call sends transaction event data to be signed. The device cryptographic processor fails during signature generation. ErrorSigningEventDataFailed is raised. The transaction is rolled back and the user is informed that the transaction could not be properly recorded.</description>
      <relatedFunctions>finishTransaction, startTransaction, updateTransaction</relatedFunctions>
      <errorContext>Transaction processing blocked by event signing failure</errorContext>
    </scenario>
    <scenario name="Scenario 2: Audit Trail Integrity Verification">
      <description>A compliance audit queries transaction signatures to verify audit trail integrity. When transactions cannot be verified because they lack proper signatures (due to ErrorSigningEventDataFailed), the audit identifies gaps in the audit trail.</description>
      <relatedFunctions>startTransaction, exportLogMessages</relatedFunctions>
      <errorContext>Compliance audit detects unsigned transactions from signing failures</errorContext>
    </scenario>
    <scenario name="Scenario 3: High-Load System Signing Exhaustion">
      <description>A high-volume transaction system experiences ErrorSigningEventDataFailed during peak load. Analysis reveals device cryptographic processor is resource-constrained. System load is reduced or device is upgraded to handle signature load.</description>
      <relatedFunctions>startTransaction, finishTransaction</relatedFunctions>
      <errorContext>High-load transaction system encounters cryptographic resource limits</errorContext>
    </scenario>
    <scenario name="Scenario 4: Event Data Validation Before Signing">
      <description>Transaction processing validates event data before transmission to device for signing. When ErrorSigningEventDataFailed occurs, the system has data validation logs that help troubleshoot whether the failure was data-related or device-related.</description>
      <relatedFunctions>startTransaction, updateTransaction, finishTransaction</relatedFunctions>
      <errorContext>Event data validation helps distinguish between data and device issues in signing failures</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by logging functions when cryptographic signing operation fails</note>
    <note>Logging subsystem signs event data via Secure Element</note>
    <note>Device creates cryptographic signature for log messages</note>
    <note>Signing failure prevents log message creation</note>
  </implementationContext>
</exception>

