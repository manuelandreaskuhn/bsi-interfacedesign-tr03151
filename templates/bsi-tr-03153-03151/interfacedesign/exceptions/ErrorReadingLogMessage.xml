<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorReadingLogMessage" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorReadingLogMessage</name>
  <description>This exception is thrown if the SE API functions getLastLogMessage or exportLogMessages encounter a failure while reading or retrieving log message data from the Secure Element's logging storage. The functions successfully locate log messages but encounter an error when attempting to read, extract, or retrieve the message data from device storage. ErrorReadingLogMessage indicates that a device-level I/O or storage access error occurred during the log message retrieval operation, preventing successful reading of the located messages.</description>
  <category>Event Logging</category>
  <subcategory>Storage Access Failure</subcategory>
  <severity>High</severity>
  <thrownBy>
    <function>getLastLogMessage</function>
    <function>getLastTransactionLogMessage</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorReadingLogMessage that is thrown if reading log message data from the Secure Element fails.</summary>
    <description>This exception is thrown when the getLastLogMessage or exportLogMessages functions successfully locate log messages in the Secure Element's storage but encounter a failure when attempting to read or retrieve the message data. Different from ErrorNoLogMessageFound (which indicates no messages exist), ErrorReadingLogMessage indicates that messages exist but cannot be accessed due to a device-level storage or I/O error. Common causes include: device storage corruption, device communication failure during data retrieval, device internal error during read operation, or insufficient device resources to complete the read operation. ErrorReadingLogMessage is a High severity exception that indicates a device malfunction or serious storage issue. Recovery requires investigating the device error condition and potentially retrying the operation or performing device maintenance.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.1 Event Logging and Log Message Retrieval - getLastLogMessage and exportLogMessages</section>
    <requirement>The functions getLastLogMessage and exportLogMessages SHALL retrieve transaction log message entries from the Secure Element's logging storage. If log messages are found but a device-level error occurs during the reading or extraction of message data from storage, these functions SHALL raise the exception ErrorReadingLogMessage. This exception indicates that the requested log messages exist but cannot be accessed due to a device storage error, I/O failure, communication error during retrieval, or device internal error. ErrorReadingLogMessage is distinct from ErrorNoLogMessageFound - it indicates messages exist but cannot be read.</requirement>
    <applicability>Log message retrieval operations - getLastLogMessage and exportLogMessages functions only, when device read error occurs</applicability>
    <reference>getLastLogMessage – Function (3.3.1); exportLogMessages – Function (3.3.1)</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Device storage corruption detected during read</scenario>
      <description>Log messages exist but device detects storage corruption while reading the data</description>
      <trigger>The getLastLogMessage function locates the most recent log message in storage, but when attempting to read the message data, the device detects corruption (e.g., checksum failure, invalid structure). The device reports a storage error and ErrorReadingLogMessage is raised.</trigger>
    </condition>
    <condition>
      <scenario>Device communication failure during data retrieval</scenario>
      <description>Communication with Secure Element is lost while transmitting log message data</description>
      <trigger>The exportLogMessages function successfully queries the device for matching log messages, but the communication channel is lost when the device begins transmitting the message data back to the caller. The partial data cannot be reassembled and ErrorReadingLogMessage is raised.</trigger>
    </condition>
    <condition>
      <scenario>Device internal error during read operation</scenario>
      <description>Secure Element reports an internal error while accessing logging storage</description>
      <trigger>The getLastLogMessage function requests the most recent log message. The Secure Element attempts to read the data from its internal logging storage but encounters an internal error (hardware fault, resource exhaustion, etc.). The device reports the error and ErrorReadingLogMessage is raised.</trigger>
    </condition>
    <condition>
      <scenario>Insufficient device resources for read operation</scenario>
      <description>Device lacks resources required to complete the read operation</description>
      <trigger>The exportLogMessages function attempts to export a large set of log messages but the device runs out of memory or processing capacity during the read operation. The device cannot complete the read and ErrorReadingLogMessage is raised.</trigger>
    </condition>
    <condition>
      <scenario>Storage access permission or access violation</scenario>
      <description>Device detects access violation or permission issue during storage read</description>
      <trigger>The exportLogMessages function attempts to read log messages from protected storage areas. The device detects an access violation or permission issue and refuses to provide the data. ErrorReadingLogMessage is raised.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls getLastLogMessage or exportLogMessages function</step>
    <step number="2">Function validates input parameters</step>
    <step number="3">Function initiates communication with Secure Element</step>
    <step number="4">Function transmits log retrieval query to Secure Element</step>
    <step number="5">Secure Element searches logging storage for matching log messages</step>
    <step number="6">Secure Element identifies matching log messages or the most recent message</step>
    <step number="7">Secure Element begins reading log message data from storage</step>
    <step number="7a">If storage read succeeds → proceed to step 8</step>
    <step number="7b">If storage read fails (corruption, I/O error, etc.) → ErrorReadingLogMessage raised, function exits</step>
    <step number="8">Secure Element transmits log message data to caller</step>
    <step number="8a">If transmission completes successfully → proceed to step 9</step>
    <step number="8b">If transmission fails or is interrupted → ErrorReadingLogMessage raised, function exits</step>
    <step number="9">Function receives and processes log message data</step>
    <step number="10">Function closes communication channel with Secure Element</step>
    <step number="11">Function returns log messages to caller</step>
  </executionSequence>
  <recovery>
    <step>Verify log message exists and is accessible</step>
    <step>Confirm storage medium is connected and readable</step>
    <step>Retry log message read operation</step>
    <step>Check storage integrity and availability</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorNoLogMessageFound</exception>
    <exception>ErrorExportLoggingCertificateFailed</exception>
    <exception>ErrorDeleteLogMessagesFailed</exception>
    <exception>ErrorConfigureLoggingFailed</exception>
    <exception>ErrorFunctionFailed</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="No Log Data Retrieved">No log message data is returned to the caller. The retrieval operation fails before message data can be provided.</state>
    <state name="Partial Data May Be Recovered">In some cases, partial message data may have been read before the error occurred, but it is likely incomplete or invalid.</state>
    <state name="Storage Data Unchanged">The device's logging storage remains unchanged. The read operation is read-only and does not modify any stored log messages.</state>
    <state name="Device State Potentially Degraded">The read failure may indicate underlying device issues - the device state may be degraded or unstable.</state>
    <state name="Error Information Available">Device error codes or diagnostic information about the read failure may be available for investigation.</state>
    <state name="Retry Potentially Possible">The operation may be retryable depending on whether the error is transient or persistent.</state>
  </postconditionality>
  <notes>
    <note>Indication: Reading of a log message failed - message data could not be retrieved</note>
    <note>Topics: Logging Operations, Message Retrieval, Storage Operations, Data Access</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Log Retrieval with Error Detection and Retry">
      <description>An application calls getLastLogMessage to retrieve the most recent log entry. The function raises ErrorReadingLogMessage, indicating a device storage read error. The application logs the error, queries device status to understand the failure, and retries the operation after a brief delay.</description>
      <relatedFunctions>getLastLogMessage, exportLogMessages</relatedFunctions>
      <errorContext>Device storage read failure prevents log message retrieval</errorContext>
    </scenario>
    <scenario name="Scenario 2: Bulk Export with Error Handling">
      <description>An application calls exportLogMessages to retrieve a large set of log messages. The function successfully locates the messages but raises ErrorReadingLogMessage when reading the data due to communication failure or device error. The application catches the error and uses a retry strategy or fallback mechanism.</description>
      <relatedFunctions>exportLogMessages, getLastLogMessage</relatedFunctions>
      <errorContext>Device communication or storage error during bulk log export</errorContext>
    </scenario>
    <scenario name="Scenario 3: Device Health Monitoring with Failure Tracking">
      <description>A system monitoring application periodically calls exportLogMessages to verify logging is functioning. When ErrorReadingLogMessage is raised, the monitoring system detects a device issue and triggers diagnostics. Repeated occurrences trigger device replacement requests.</description>
      <relatedFunctions>getLastLogMessage, exportLogMessages</relatedFunctions>
      <errorContext>Device health monitoring using log retrieval as indicator</errorContext>
    </scenario>
    <scenario name="Scenario 4: Storage Integrity Verification">
      <description>A device diagnostic utility attempts to read all log messages via exportLogMessages to verify storage integrity. If ErrorReadingLogMessage is raised, it indicates storage corruption. The diagnostic system performs device self-tests and reports the corruption to the user.</description>
      <relatedFunctions>exportLogMessages, getLastLogMessage</relatedFunctions>
      <errorContext>Storage integrity verification and corruption detection</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by getLastLogMessage and getLastTransactionLogMessage when message read fails</note>
    <note>Log retrieval functions read log message data from storage</note>
    <note>Device attempts to access stored log message</note>
    <note>Read failure prevents message data access</note>
  </implementationContext>
</exception>

