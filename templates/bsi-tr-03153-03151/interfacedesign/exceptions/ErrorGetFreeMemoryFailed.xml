<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorGetFreeMemoryFailed" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorGetFreeMemoryFailed</name>
  <description>This exception is thrown if the SE API function getFreeMemory fails to retrieve the amount of currently free memory available in the Secure Element. The function attempts to obtain the current available memory capacity for storing data and processing operations, but the retrieval process fails before the memory value can be determined and returned.</description>
  <category>Resource Management - Memory Status</category>
  <severity>Medium</severity>
  <javadoc>
    <summary>This class defines the exception ErrorGetFreeMemoryFailed that is thrown if the SE API function getFreeMemory fails to determine the amount of currently free memory in the device.</summary>
    <description>This exception is thrown when the getFreeMemory function cannot retrieve the current available memory from the Secure Element. Free memory information indicates the amount of memory capacity that is currently available for storing data and processing operations. ErrorGetFreeMemoryFailed indicates that the Secure Element cannot provide the memory status information due to hardware failure, memory management system errors, storage corruption, communication failures, or Secure Element state restrictions. When this exception occurs, no memory data is returned and applications cannot determine available memory capacity or assess resource availability. Recovery typically involves device verification, memory management subsystem diagnostics, and possible hardware diagnosis if the failure persists.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.5.1 Resource Management - getFreeMemory</section>
    <requirement>The function getFreeMemory SHALL retrieve the amount of currently free memory available in the Secure Element for data storage and processing operations. If the Secure Element cannot provide or return the required memory information, the function SHALL raise the exception ErrorGetFreeMemoryFailed and exit without returning any memory data. The free memory retrieval failure indicates the Secure Element's memory status query functionality could not complete successfully.</requirement>
    <applicability>Resource management operations - getFreeMemory function only</applicability>
    <reference>getFreeMemory – Function (3.5.1)</reference>
  </specification>
  <thrownBy>
    <function>getFreeMemory</function>
  </thrownBy>
  <triggerConditions>
    <condition>
      <scenario>Memory management hardware failure</scenario>
      <description>The Secure Element's memory management hardware or monitoring circuits malfunction or become inaccessible, preventing memory status retrieval</description>
      <trigger>The Secure Element's memory management hardware fails or memory status monitoring circuits cannot be read. When getFreeMemory is called, the memory query is sent to the Secure Element, but the hardware cannot provide valid memory status. The function receives a failure status from the Secure Element, triggering ErrorGetFreeMemoryFailed.</trigger>
    </condition>
    <condition>
      <scenario>Memory management system data corruption</scenario>
      <description>The Secure Element's memory management subsystem data or memory allocation tables become corrupted or are lost</description>
      <trigger>The Secure Element's memory management data structures (allocation tables, free block tracking, usage statistics) become corrupted, experience data loss, or are marked as inaccessible due to storage errors. When getFreeMemory attempts to calculate free memory from management tables, the data cannot be reliably used, triggering ErrorGetFreeMemoryFailed.</trigger>
    </condition>
    <condition>
      <scenario>Memory management subsystem internal error</scenario>
      <description>The Secure Element's memory management subsystem encounters critical errors that prevent free memory calculation or retrieval</description>
      <trigger>The Secure Element's memory management subsystem (responsible for allocating memory, tracking usage, and providing memory status) encounters an internal error, deadlock, or exception. When getFreeMemory is called, the memory management system cannot process the query, triggering ErrorGetFreeMemoryFailed.</trigger>
    </condition>
    <condition>
      <scenario>Device-to-Secure Element communication failure during memory query</scenario>
      <description>The communication channel between device and Secure Element is disrupted during memory status retrieval</description>
      <trigger>A communication failure occurs while getFreeMemory transmits the memory query to the Secure Element or while receiving the memory status response. The command may be corrupted, the response may be incomplete, or the communication link may be temporarily unavailable. The function receives a communication error status, triggering ErrorGetFreeMemoryFailed.</trigger>
    </condition>
    <condition>
      <scenario>Secure Element in restricted or error state prohibiting memory access</scenario>
      <description>The Secure Element is in a locked, restricted, or error state that prevents external queries for memory status information</description>
      <trigger>The Secure Element enters a state where resource queries or memory status access is not permitted. When getFreeMemory is called and the Secure Element's state prohibits memory access, the function receives a state-related rejection, triggering ErrorGetFreeMemoryFailed.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls getFreeMemory function on device</step>
    <step number="2">Function validates input parameters and checks authentication status (if required by referencing guideline)</step>
    <step number="3">Function checks authorization for resource information access (if required by referencing guideline)</step>
    <step number="4">Function verifies device is properly initialized and memory management is operational</step>
    <step number="5">Function initiates communication channel to Secure Element and prepares memory status query command</step>
    <step number="6">Function transmits memory query command to Secure Element requesting current free memory amount</step>
    <step number="6a">If Secure Element responds with failure status (hardware error, management error, memory retrieval error) → ErrorGetFreeMemoryFailed raised, function exits without memory data</step>
    <step number="6b">If communication failure occurs during query transmission or response reception → ErrorGetFreeMemoryFailed raised, function exits</step>
    <step number="7">If successful, function receives free memory amount from Secure Element</step>
    <step number="8">Function validates memory value for correctness (format, numeric range, logical consistency with total memory)</step>
    <step number="9">Function closes Secure Element communication channel</step>
    <step number="10">Function returns valid free memory value to caller</step>
  </executionSequence>
  <recovery>
    <step>Verify device is initialized</step>
    <step>Retry memory query operation</step>
    <step>Check storage medium status</step>
    <step>Monitor storage capacity in application</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorDeviceNotInitialized</exception>
    <exception>ErrorGetTotalMemoryFailed</exception>
    <exception>ErrorInsufficientMemory</exception>
    <exception>ErrorMemoryAllocationFailed</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Device Operational State">Device remains fully operational and unmodified. The failure to retrieve free memory information does not affect device initialization state, internal memory contents, memory allocation, or the ability to perform other operations. All device components remain in their pre-call state.</state>
    <state name="Memory Data Return Status">No memory value is returned to the caller. The function exits without providing any available memory information. Applications must not assume default memory values or cached information; they must handle the exception as indicating memory status is unavailable.</state>
    <state name="Secure Element Memory State">Secure Element memory remains unchanged by the failed memory query. No memory deallocation, allocation changes, or memory management modifications occur. Memory contents and allocation state continue unchanged regardless of the retrieval failure.</state>
    <state name="Memory Availability Continuity">The Secure Element continues to maintain accurate memory tracking and allocation internally. The failure to retrieve free memory status does not affect the actual available memory or memory management operations. Memory queries can be retried once the underlying issue is resolved.</state>
    <state name="No Cascading State Effects">No cascading state inconsistencies or secondary failures occur as a result of the memory query failure. Device internal consistency is maintained. Other SE API functions and memory operations continue normally without state corruption.</state>
    <state name="Recovery Preconditions Met">The device state after exception is consistent and allows for recovery operations. The underlying issue (hardware error, communication error, management system error) remains present, but the device is stable enough to accept diagnostic queries or recovery attempts.</state>
  </postconditionality>
  <notes>
    <note>Indication: Retrieval of free memory information failed - cannot determine available memory</note>
    <note>Topics: Memory Management, Device Resources, Information Retrieval, Storage Status</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Pre-Operation Memory Capacity Verification">
      <description>Before performing memory-intensive operations (transaction processing, logging, data storage), an application checks available free memory to ensure sufficient capacity exists. The application retrieves free memory using getFreeMemory and compares it against operation requirements. If ErrorGetFreeMemoryFailed is raised, the application cannot verify capacity and must conservatively defer memory-intensive operations.</description>
      <relatedFunctions>getFreeMemory, getTotalMemory, startTransaction</relatedFunctions>
      <errorContext>Free memory status unavailable for pre-operation capacity verification</errorContext>
    </scenario>
    <scenario name="Scenario 2: Resource Monitoring and Device Capacity Assessment">
      <description>A monitoring system periodically assesses device resource utilization by querying memory status. The system uses free memory information to understand device capacity utilization and predict resource exhaustion. If ErrorGetFreeMemoryFailed is raised, the system cannot determine memory status for monitoring and must alert operators to monitoring failure.</description>
      <relatedFunctions>getFreeMemory, getTotalMemory, getDeviceHealth</relatedFunctions>
      <errorContext>Free memory information unavailable for resource monitoring and capacity assessment</errorContext>
    </scenario>
    <scenario name="Scenario 3: Memory-Aware Load Distribution Across Devices">
      <description>An enterprise application distributes workload across multiple devices, considering memory availability to avoid devices with insufficient resources. The application queries getFreeMemory on each device to assess available capacity. If ErrorGetFreeMemoryFailed is raised on one device, the application cannot determine that device's memory capacity and conservatively excludes it from new work distribution.</description>
      <relatedFunctions>getFreeMemory, getTotalMemory, startTransaction</relatedFunctions>
      <errorContext>Free memory status unavailable for memory-aware load distribution</errorContext>
    </scenario>
    <scenario name="Scenario 4: Device Diagnostics and Resource Availability Reporting">
      <description>A diagnostics tool collects comprehensive device resource information for analysis and support purposes. As part of resource diagnostics, the tool retrieves current free memory to document memory availability and utilization. If ErrorGetFreeMemoryFailed is raised, the tool cannot include memory information in the diagnostic report.</description>
      <relatedFunctions>getFreeMemory, getTotalMemory, getDeviceHealth</relatedFunctions>
      <errorContext>Free memory information unavailable for device diagnostics and resource reporting</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by getFreeMemory when free memory information retrieval fails</note>
    <note>Memory function queries available device storage</note>
    <note>Device tracks storage usage and available capacity</note>
    <note>Retrieval failure prevents available memory information</note>
  </implementationContext>
</exception>
