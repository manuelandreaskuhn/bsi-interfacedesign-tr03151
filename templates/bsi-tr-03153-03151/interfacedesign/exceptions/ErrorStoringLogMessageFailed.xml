<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorStoringLogMessageFailed" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorStoringLogMessageFailed</name>
  <description>This exception is thrown if the storage of a log message in the device storage fails. Transaction operations (startTransaction, updateTransaction, finishTransaction) create digitally signed log messages that record transaction events in the audit trail. If the log message cannot be stored to device storage, ErrorStoringLogMessageFailed indicates the transaction was not properly recorded in the audit trail. Common causes include: device storage write errors, insufficient storage capacity, storage medium issues, or communication failures. ErrorStoringLogMessageFailed is a Critical condition because it means the transaction is not protected by a tamper-proof audit trail record. The transaction may have been partially processed but is not reliably recorded.</description>
  <category>Logging</category>
  <subcategory>Log Message Storage - Storage Failure</subcategory>
  <severity>Critical</severity>
  <thrownBy>
    <function>authenticateUser</function>
    <function>configureLogging</function>
    <function>deleteLogMessages</function>
    <function>deregisterClient</function>
    <function>disableSecureElement</function>
    <function>finishTransaction</function>
    <function>initialize</function>
    <function>lockTransactionLogging</function>
    <function>logOut</function>
    <function>registerClient</function>
    <function>selfTest</function>
    <function>setDescription</function>
    <function>startTransaction</function>
    <function>unblockPin</function>
    <function>unlockTransactionLogging</function>
    <function>updateDevice</function>
    <function>updateTime</function>
    <function>updateTransaction</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorStoringLogMessageFailed that is thrown if log message storage fails.</summary>
    <description>This exception is thrown when the Secure Element fails to store a digitally signed log message to device storage during transaction processing. Transaction operations create log messages that establish an audit trail of all transactions with cryptographic proof of integrity and authenticity. ErrorStoringLogMessageFailed indicates the log message could not be successfully written to storage, meaning the transaction is not properly recorded in the audit trail. Common causes include: device storage write errors, insufficient storage capacity, storage medium disconnection or failure, or communication failures. ErrorStoringLogMessageFailed is a Critical severity exception because it indicates the transaction lacks a tamper-proof audit trail record. Without successful log storage, the transaction integrity cannot be verified. Recovery requires addressing the storage issue and potentially retrying the transaction.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.2 Transaction Operations and 3.3.3 Logging Operations - Transaction Log Storage</section>
    <requirement>During transaction processing (startTransaction, updateTransaction, finishTransaction), the Secure Element creates digitally signed log messages and stores them in device audit trail storage. The log message contains transaction context, timestamp, signature, and status information. If the log message storage operation fails to successfully write the message to storage, the function SHALL raise ErrorStoringLogMessageFailed. The transaction may be partially processed but is not properly recorded in the audit trail. Log message storage is essential for audit trail integrity and must not be bypassed. Failed log storage indicates the transaction is not protected by tamper-proof recording.</requirement>
    <applicability>Transaction operations creating log messages: startTransaction, updateTransaction, finishTransaction</applicability>
    <reference>Transaction Operations (3.3.2), Logging Operations (3.3.3), Audit Trail Management</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Device storage write error during log storage</scenario>
      <description>The device storage system fails to write the log message</description>
      <trigger>A finishTransaction call creates log message and attempts to store it but the storage write operation fails (I/O error, hardware failure). ErrorStoringLogMessageFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Insufficient storage capacity for log message</scenario>
      <description>Storage capacity is full or insufficient for the log message</description>
      <trigger>A startTransaction call creates log message but storage is full. The message cannot be stored and ErrorStoringLogMessageFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Storage medium disconnected or unavailable</scenario>
      <description>The storage medium becomes disconnected or unavailable during write</description>
      <trigger>An updateTransaction call attempts to store log message but storage becomes unreachable. ErrorStoringLogMessageFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Communication failure during log storage</scenario>
      <description>Communication with storage fails during the write operation</description>
      <trigger>A finishTransaction call transmits log message to storage but communication is interrupted before write completes. ErrorStoringLogMessageFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Storage corruption or write verification failure</scenario>
      <description>Storage corruption is detected or write verification fails</description>
      <trigger>An updateTransaction call writes log message but post-write verification fails or corruption is detected. ErrorStoringLogMessageFailed is raised.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls a transaction operation that creates log messages (e.g., finishTransaction)</step>
    <step number="2">Function validates input parameters and transaction context</step>
    <step number="3">Function initiates communication with Secure Element</step>
    <step number="4">Secure Element receives transaction request</step>
    <step number="5">Secure Element processes transaction operation</step>
    <step number="6">Secure Element creates digitally signed log message</step>
    <step number="7">Secure Element checks storage capacity for log message</step>
    <step number="7a">If storage full → ErrorStorageMemoryFull raised (or ErrorStoringLogMessageFailed)</step>
    <step number="7b">If storage available → proceed to step 8</step>
    <step number="8">Secure Element attempts to write log message to storage</step>
    <step number="8a">If storage write fails → ErrorStoringLogMessageFailed raised, operation aborted</step>
    <step number="8b">If storage write succeeds → proceed to step 9</step>
    <step number="9">Secure Element verifies log message storage and integrity</step>
    <step number="9a">If verification fails → ErrorStoringLogMessageFailed raised</step>
    <step number="9b">If verification succeeds → proceed to step 10</step>
    <step number="10">Secure Element confirms transaction completion and log storage</step>
    <step number="11">Secure Element returns result to function</step>
    <step number="12">Function returns successfully</step>
  </executionSequence>
  <recovery>
    <step>Verify device storage is accessible and has free space</step>
    <step>Confirm Secure Element is operational</step>
    <step>Check logging subsystem health</step>
    <step>Retry operation after confirming preconditions</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorFunctionFailed</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Log Message Not Stored">The log message is not stored in device audit trail storage.</state>
    <state name="Transaction Not Recorded">The transaction is not properly recorded in the audit trail.</state>
    <state name="Transaction Audit Protection Lost">The transaction lacks a tamper-proof audit trail record.</state>
    <state name="Transaction State Uncertain">The transaction may be partially processed but recording failed.</state>
    <state name="Audit Trail Incomplete">The audit trail has a gap where the transaction should be recorded.</state>
    <state name="Transaction Integrity Unverified">The transaction integrity cannot be verified without audit trail record.</state>
  </postconditionality>
  <notes>
    <note>Indication: Storing of log message failed - message could not be persisted</note>
    <note>Topics: Logging Operations, Storage Operations, Data Persistence, Log Management</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Transaction Log Storage Failure During Processing">
      <description>A finishTransaction call processes successfully but fails to store the transaction log message. ErrorStoringLogMessageFailed is raised. The transaction is rolled back and user is informed that the transaction could not be properly recorded.</description>
      <relatedFunctions>finishTransaction, startTransaction, updateTransaction</relatedFunctions>
      <errorContext>Transaction processing blocked by log message storage failure</errorContext>
    </scenario>
    <scenario name="Scenario 2: Audit Trail Gap Detection">
      <description>An audit review detects a gap in the transaction log where a transaction should have been recorded but is missing. Investigation reveals ErrorStoringLogMessageFailed occurred during that transaction, preventing audit trail recording.</description>
      <relatedFunctions>startTransaction, exportLogMessages</relatedFunctions>
      <errorContext>Audit trail gap detected due to failed log storage</errorContext>
    </scenario>
    <scenario name="Scenario 3: Storage Full Prevents Log Recording">
      <description>High-volume transaction system reaches storage full. A startTransaction call fails with ErrorStoringLogMessageFailed because storage is full and log message cannot be recorded. System exports old logs to free space, then resumes transactions.</description>
      <relatedFunctions>startTransaction, exportLogMessages, deleteLogMessages</relatedFunctions>
      <errorContext>Log storage failure due to full storage - resolved by freeing space</errorContext>
    </scenario>
    <scenario name="Scenario 4: Compliance Requirement for Audit Trail Continuity">
      <description>Compliance audit requires continuous audit trail with no gaps. When ErrorStoringLogMessageFailed is detected, compliance officers are notified and device is inspected for storage issues. Missing transaction is manually investigated.</description>
      <relatedFunctions>startTransaction, finishTransaction, exportLogMessages</relatedFunctions>
      <errorContext>Compliance audit identifies missing transaction due to log storage failure</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by logging functions when log message storage fails</note>
    <note>Device stores created log messages in persistent storage</note>
    <note>Logging subsystem persists messages for audit trail</note>
    <note>Storage failure prevents log message persistence</note>
  </implementationContext>
</exception>

