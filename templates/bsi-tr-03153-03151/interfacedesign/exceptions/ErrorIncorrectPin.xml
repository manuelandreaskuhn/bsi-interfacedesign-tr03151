<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorIncorrectPin" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorIncorrectPin</name>
  <description>This exception is thrown if the SE API function authenticateUser fails because an incorrect PIN was provided. The function attempts to authenticate a user with supplied credentials, but the provided PIN does not match the registered authentication credential, causing the authentication process to fail and reject the authentication attempt.</description>
  <category>Authentication - PIN Verification</category>
  <severity>High</severity>
  <javadoc>
    <summary>This class defines the exception ErrorIncorrectPin that is thrown if the SE API function authenticateUser has been invoked with an incorrect PIN.</summary>
    <description>This exception is thrown when the authenticateUser function receives an incorrect PIN that does not match the user's registered authentication credential. PIN verification is a critical security operation that controls access to protected SE API functions and operations. ErrorIncorrectPin indicates that the supplied PIN does not match the registered credential stored on the Secure Element. When this exception occurs, the authentication attempt fails and the user remains unauthenticated. The Secure Element may also track failed authentication attempts and implement security countermeasures (PIN retry counter decrement, potential PIN blocking after maximum failures). Recovery requires supplying the correct PIN in a subsequent authentication attempt, or requesting PIN reset through administrative procedures if the PIN is forgotten.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.5.2 User Authentication - authenticateUser</section>
    <requirement>The function authenticateUser SHALL authenticate a user by verifying the provided PIN against the registered authentication credential. If the provided PIN does not match the registered credential, the function SHALL raise the exception ErrorIncorrectPin and reject the authentication attempt without establishing user authentication. The Secure Element SHALL track failed authentication attempts and may implement security countermeasures including PIN retry counter management.</requirement>
    <applicability>User authentication operations - authenticateUser function only</applicability>
    <reference>authenticateUser – Function (3.5.2)</reference>
  </specification>
  <thrownBy>
    <function>authenticateUser</function>
  </thrownBy>
  <triggerConditions>
    <condition>
      <scenario>User supplies incorrect PIN value</scenario>
      <description>The user provides a PIN that does not match the registered authentication credential</description>
      <trigger>The user/application calls authenticateUser with a PIN parameter that does not match the registered credential stored on the Secure Element. The Secure Element verifies the supplied PIN against the registered credential and finds a mismatch. The verification fails and the Secure Element raises ErrorIncorrectPin to reject the authentication attempt.</trigger>
    </condition>
    <condition>
      <scenario>PIN verification failure due to typo or user error</scenario>
      <description>User accidentally enters an incorrect PIN due to typing error, keyboard layout mismatch, or other accidental input errors</description>
      <trigger>The user enters a PIN that is similar to but not identical to the correct PIN (single character difference, reversed digits, etc.). When authenticateUser verifies the PIN, the mismatch is detected and ErrorIncorrectPin is raised.</trigger>
    </condition>
    <condition>
      <scenario>Malicious or brute force authentication attempt</scenario>
      <description>An attacker attempts to authenticate with incorrect PINs in a brute force attack or denial of service attempt</description>
      <trigger>An attacker or unauthorized party calls authenticateUser multiple times with various incorrect PIN values attempting to guess the correct PIN. Each incorrect PIN triggers ErrorIncorrectPin. The Secure Element may track these repeated failures and implement security countermeasures.</trigger>
    </condition>
    <condition>
      <scenario>Authentication attempt after user credential change</scenario>
      <description>A user attempts to authenticate with an old PIN after the PIN has been changed or updated</description>
      <trigger>The user attempts authentication using a previously valid PIN that has been changed or reset through administrative procedures. The old PIN no longer matches the current registered credential, causing PIN verification to fail and ErrorIncorrectPin to be raised.</trigger>
    </condition>
    <condition>
      <scenario>PIN verification with corrupted or incomplete PIN data</scenario>
      <description>The authentication attempt uses a PIN that is incomplete, corrupted, or improperly formatted</description>
      <trigger>The user supplies a PIN that is incomplete (fewer characters than required), corrupted (contains invalid characters), or improperly formatted. When the Secure Element verifies this PIN against the registered credential, the verification fails due to format/content mismatch, triggering ErrorIncorrectPin.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls authenticateUser function with PIN parameter</step>
    <step number="2">Function validates input parameters including PIN format and length</step>
    <step number="3">Function checks if authentication is currently allowed (not already authenticated, not in locked state)</step>
    <step number="4">Function verifies user exists and PIN authentication is applicable for this user</step>
    <step number="5">Function initiates communication channel to Secure Element and prepares authentication command with supplied PIN</step>
    <step number="6">Function transmits authentication command to Secure Element with supplied PIN for verification</step>
    <step number="6a">If supplied PIN does NOT match registered credential → Secure Element responds with failure, ErrorIncorrectPin raised, function exits</step>
    <step number="6b">If PIN verification confirms mismatch → Secure Element increments failed authentication counter and may apply security countermeasures</step>
    <step number="7">If supplied PIN matches registered credential, function receives authentication success confirmation</step>
    <step number="8">Function establishes authenticated user session and records successful authentication</step>
    <step number="9">Function closes Secure Element communication channel</step>
    <step number="10">Function returns to caller with authenticated user context established</step>
  </executionSequence>
  <recovery>
    <step>Verify PIN entry - check for typos in user input</step>
    <step>Retry authentication with correct PIN</step>
    <step>Check if PIN has been changed recently</step>
    <step>Use unblockPin if PIN is forgotten and PUK available</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorPinBlocked</exception>
    <exception>ErrorUserNotAuthenticated</exception>
    <exception>ErrorUserAlreadyAuthenticated</exception>
    <exception>ErrorAuthenticationFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Authentication State">User remains unauthenticated. The failed authentication attempt does not establish authentication context. The device operates in the unauthenticated state and protected operations continue to require authentication.</state>
    <state name="Failed Authentication Counter Update">The Secure Element's failed authentication counter is typically incremented to track the authentication failure. If implemented, this counter tracks repeated failed attempts and may trigger security countermeasures (PIN blocking) after excessive failures.</state>
    <state name="PIN Blocking Preconditions">Repeated failed authentication attempts may eventually trigger PIN blocking or account lockout. If the failed attempt counter reaches the maximum threshold configured for PIN blocking, the next authenticateUser call may raise ErrorPinBlocked instead of ErrorIncorrectPin.</state>
    <state name="No Credential Modification">The registered authentication credential remains unchanged. The incorrect PIN does not modify the registered credential or authentication configuration. Subsequent authentication attempts use the same registered credential.</state>
    <state name="Device Operational State">Device remains fully operational and unmodified. The failed authentication does not affect device state, configuration, or other operations. All device components remain in their pre-call state.</state>
    <state name="Recovery Preconditions Met">The device state after exception is consistent and allows for recovery operations. User can immediately retry authentication with the correct PIN. No special recovery procedures are required unless PIN blocking is triggered or PIN reset is needed.</state>
  </postconditionality>
  <notes>
    <note>Indication: PIN provided does not match the stored PIN - authentication failed</note>
    <note>Topics: Authentication, PIN Management, User Verification, Access Control</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: User Authentication and Secure Access Control">
      <description>A system protects sensitive operations with PIN-based user authentication. When a user attempts to access protected operations, the system calls authenticateUser with the user-supplied PIN. If ErrorIncorrectPin is raised, the system informs the user that the PIN is incorrect and prompts for retry. Correct PIN entry establishes authentication for accessing protected functions.</description>
      <relatedFunctions>authenticateUser, logoutUser</relatedFunctions>
      <errorContext>Incorrect PIN supplied during user authentication attempt</errorContext>
    </scenario>
    <scenario name="Scenario 2: Multi-Attempt Authentication with User Guidance">
      <description>A user interface guides users through PIN entry and authentication. When authenticateUser raises ErrorIncorrectPin, the UI displays an error message and allows the user to retry. The UI tracks the number of failed attempts and warns users when approaching the PIN blocking threshold.</description>
      <relatedFunctions>authenticateUser, logoutUser</relatedFunctions>
      <errorContext>PIN verification failure with user retry capability</errorContext>
    </scenario>
    <scenario name="Scenario 3: Authentication Security Monitoring and Brute Force Detection">
      <description>A security monitoring system logs all authentication attempts and detects potential brute force attacks. When ErrorIncorrectPin is raised, the monitoring system logs the failure, tracks the source, and identifies suspicious patterns. If multiple failed attempts occur from the same source in short time, the system triggers security alerts.</description>
      <relatedFunctions>authenticateUser</relatedFunctions>
      <errorContext>Authentication failure monitoring and brute force attack detection</errorContext>
    </scenario>
    <scenario name="Scenario 4: Automated System Authentication with Retry Logic">
      <description>An automated system requires PIN authentication for certain operations. When authenticateUser raises ErrorIncorrectPin, the system logs the failure, checks the failed attempt counter, and determines whether to retry or fail the operation. After excessive failures, the system alerts administrators or implements fallback procedures.</description>
      <relatedFunctions>authenticateUser, logoutUser</relatedFunctions>
      <errorContext>Automated system authentication with retry and failure handling</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by authenticateUser when provided PIN does not match stored PIN</note>
    <note>Authentication function verifies PIN via Secure Element comparison</note>
    <note>Device maintains PIN secret and retry counter</note>
    <note>PIN mismatch indicates failed authentication attempt</note>
  </implementationContext>
</exception>
