<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorTransactionCounterExhausted" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorTransactionCounterExhausted</name>
  <description>This exception is thrown if the physical memory of the transaction counter has been exhausted and can no longer guarantee error-free operation. The transaction counter maintains a record of all executed transactions in persistent memory to ensure authenticity and non-repudiation. The physical memory is a finite resource that can become exhausted after many transactions. When memory approaches or reaches saturation, the counter cannot reliably record new transactions. ErrorTransactionCounterExhausted is a Critical severity exception because it prevents all transaction operations and indicates device maintenance is urgently required. The device must be serviced to restore or replace the counter memory before transaction functionality can resume.</description>
  <category>Transaction Management - Counter Resource Exhaustion</category>
  <severity>Critical</severity>
  <thrownBy>
    <function>startTransaction</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorTransactionCounterExhausted that is thrown if the physical memory of the transaction counter is exhausted and can no longer guarantee error-free operation.</summary>
    <description>This exception is thrown when the transaction counter's physical memory has been exhausted and cannot guarantee reliable recording of new transactions. The transaction counter maintains a persistent record of all executed transactions for authenticity and non-repudiation purposes. Physical memory resources are finite and can become exhausted after many transactions. When memory is exhausted, the counter cannot reliably record transactions and ErrorTransactionCounterExhausted is raised. This is a Critical severity exception because transaction functionality is completely blocked. All transaction operations (startTransaction, updateTransaction, finishTransaction) cannot proceed. Device maintenance is required to restore or replace counter memory. ErrorTransactionCounterExhausted indicates a serious device resource limitation requiring immediate intervention.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.2.2 Transaction Management - Transaction Counter</section>
    <requirement>The Secure Element maintains a transaction counter in persistent memory to record all executed transactions. This counter is essential for authenticity and non-repudiation. Physical memory for the counter is a finite resource. If counter memory becomes exhausted such that error-free operation cannot be guaranteed, the Secure Element SHALL raise ErrorTransactionCounterExhausted and block all transaction operations. This Critical severity exception indicates urgent device maintenance is required. The device must be serviced to restore or replace counter memory before transaction functionality can resume.</requirement>
    <applicability>All transaction operations when counter physical memory exhausted: startTransaction, updateTransaction, finishTransaction</applicability>
    <reference>Transaction Management (3.2.2), Transaction Counter (3.2.2), startTransaction – Function (3.2.2), updateTransaction – Function (3.2.2), finishTransaction – Function (3.2.2)</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Transaction counter physical memory completely filled</scenario>
      <description>The persistent memory dedicated to transaction counter has reached maximum capacity</description>
      <trigger>After thousands of transactions over extended operation, counter physical memory reaches saturation. Next startTransaction call detects exhaustion and raises ErrorTransactionCounterExhausted.</trigger>
    </condition>
    <condition>
      <scenario>Counter memory reliability degraded</scenario>
      <description>Physical memory integrity has degraded such that reliable operation cannot be guaranteed</description>
      <trigger>Memory wear over extended operation causes reliability concerns. Device self-test indicates counter memory cannot guarantee error-free operation. ErrorTransactionCounterExhausted is raised to prevent unreliable transactions.</trigger>
    </condition>
    <condition>
      <scenario>Critical memory utilization threshold exceeded</scenario>
      <description>Memory utilization reaches critical threshold triggering protective shutdown</description>
      <trigger>Counter memory usage exceeds 95% threshold during updateTransaction. Device protective logic raises ErrorTransactionCounterExhausted to prevent catastrophic memory failure.</trigger>
    </condition>
    <condition>
      <scenario>Hardware memory failure or degradation detected</scenario>
      <description>Physical memory hardware detects errors or indicates imminent failure</description>
      <trigger>Memory error detection circuit in Secure Element detects correctable errors accumulating. Device raises ErrorTransactionCounterExhausted to halt operations before uncorrectable failures occur.</trigger>
    </condition>
    <condition>
      <scenario>Counter initialization reveals exhausted state</scenario>
      <description>Device initialization or diagnostics discover counter memory exhausted</description>
      <trigger>Device startup self-test or user-initiated diagnostics discover counter memory is exhausted. Subsequent transaction operations raise ErrorTransactionCounterExhausted until remediated.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls transaction operation (e.g., startTransaction, updateTransaction, finishTransaction)</step>
    <step number="2">Function validates input parameters and operations prerequisites</step>
    <step number="3">Function initiates communication with Secure Element</step>
    <step number="4">Secure Element receives transaction operation request</step>
    <step number="5">Secure Element performs counter memory status check</step>
    <step number="5a">If counter memory status normal and available → proceed to step 6</step>
    <step number="5b">If counter memory exhausted or unavailable → ErrorTransactionCounterExhausted raised, operation aborted</step>
    <step number="6">Secure Element prepares transaction record for counter</step>
    <step number="7">Secure Element verifies memory available for new transaction entry</step>
    <step number="7a">If memory insufficient for entry → ErrorTransactionCounterExhausted raised</step>
    <step number="7b">If memory available → proceed to step 8</step>
    <step number="8">Secure Element writes transaction record to counter memory</step>
    <step number="9">Secure Element increments counter value</step>
    <step number="10">Secure Element returns success to function</step>
    <step number="11">Function returns to caller indicating transaction recorded</step>
  </executionSequence>
  <recovery>
    <step>Check current counter value</step>
    <step>Device cannot create new transactions after exhaustion</step>
    <step>Plan for counter exhaustion reaching device capacity</step>
    <step>Contact device vendor about counter management</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorDeviceNotInitialized</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Transaction Operations Blocked">No transaction operations can proceed (startTransaction, updateTransaction, finishTransaction).</state>
    <state name="Counter Not Updated">Transaction record is not written to counter memory.</state>
    <state name="Counter Value Unchanged">Counter remains at current exhausted state without incrementing.</state>
    <state name="Device Requires Maintenance">Device maintenance is required to restore counter functionality.</state>
    <state name="Critical Exception Returned">Function returns ErrorTransactionCounterExhausted Critical exception to caller.</state>
    <state name="Transaction Authenticity At Risk">Transaction recording capability compromised due to counter memory exhaustion.</state>
  </postconditionality>
  <notes>
    <note>Indication: Transaction counter has reached its maximum value - no more transactions possible</note>
    <note>Topics: Transaction Management, Counter Management, Resource Limits, Transaction Capacity</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Counter Exhaustion During High Transaction Volume">
      <description>A device has executed millions of transactions over years of operation. Transaction counter memory becomes exhausted. When operator attempts to execute new transaction via startTransaction, ErrorTransactionCounterExhausted is raised. Operator contacts manufacturer for counter memory service.</description>
      <relatedFunctions>startTransaction, updateTransaction, finishTransaction</relatedFunctions>
      <errorContext>Counter memory exhausted after extended operational lifetime - service required</errorContext>
    </scenario>
    <scenario name="Scenario 2: Exhaustion Detected During Device Diagnostics">
      <description>Administrator runs device diagnostics as part of maintenance plan. Diagnostics reveal counter memory nearing exhaustion. While counter not yet completely exhausted, device sets internal exhaustion flag. Subsequent transaction operations raise ErrorTransactionCounterExhausted to prevent imminent failure.</description>
      <relatedFunctions>startTransaction, updateTransaction, finishTransaction</relatedFunctions>
      <errorContext>Proactive diagnostics detect exhaustion risk - preventive exception raised</errorContext>
    </scenario>
    <scenario name="Scenario 3: Counter Memory Degradation After Hardware Error">
      <description>Device experiences memory error during operation. Error detection circuits identify correctable errors in counter memory. Device protective mechanisms raise ErrorTransactionCounterExhausted to halt operations until hardware issue is resolved.</description>
      <relatedFunctions>startTransaction, updateTransaction, finishTransaction</relatedFunctions>
      <errorContext>Hardware memory errors detected - device halts transactions for protection</errorContext>
    </scenario>
    <scenario name="Scenario 4: Planned Service Before Complete Exhaustion">
      <description>Device monitoring system tracks counter memory utilization. When reaching 85% threshold, alert is generated. Operator schedules service at convenient time before complete exhaustion occurs. Service is performed to restore counter memory before ErrorTransactionCounterExhausted condition is triggered.</description>
      <relatedFunctions>startTransaction, updateTransaction, finishTransaction</relatedFunctions>
      <errorContext>Proactive maintenance prevents exhaustion exception through planned service</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by startTransaction when transaction counter reaches maximum</note>
    <note>Transaction numbering subsystem tracks issued transaction numbers</note>
    <note>Device maintains counter of transactions</note>
    <note>Exhaustion prevents new transaction creation</note>
  </implementationContext>
</exception>
