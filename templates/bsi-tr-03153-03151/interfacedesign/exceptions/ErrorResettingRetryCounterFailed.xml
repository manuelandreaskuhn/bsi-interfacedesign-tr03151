<?xml version="1.0" encoding="UTF-8"?>
<exception id="ErrorResettingRetryCounterFailed" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
    <name>ErrorResettingRetryCounterFailed</name>
    <description>This exception is thrown if the SE API function unblockPin fails to reset the PIN retry counter as part of the PIN unblocking operation. The function successfully unblocks the PIN and sets a new PIN, but fails when attempting to reset the failed attempt counter to zero. ErrorResettingRetryCounterFailed indicates that while the PIN is unblocked, the retry counter was not properly reset, potentially leaving the account in an inconsistent state where the PIN is usable but the retry counter is not reset.</description>
    <category>Authentication - Retry Counter Management</category>
    <severity>High</severity>
    <javadoc>
        <summary>This class defines the exception ErrorResettingRetryCounterFailed that is thrown if the PIN retry counter reset fails during PIN unblocking.</summary>
        <description>This exception is thrown when the unblockPin function successfully unblocks the user's PIN and sets a new PIN but fails to reset the failed PIN attempt counter to zero. When a PIN is unblocked via the unblockPin function, the device should perform two operations: 1) Unblock the PIN and set a new PIN, and 2) Reset the failed attempt counter to zero. ErrorResettingRetryCounterFailed indicates that operation 1 succeeded but operation 2 failed. The result is that the PIN is now unblocked and can be used for authentication, but the retry counter still reflects the previous failed attempts. This leaves the account in a potentially inconsistent state - the next failed PIN attempt may immediately trigger a re-block if the counter still shows high failed attempts. ErrorResettingRetryCounterFailed is a High severity exception that indicates a partial failure in the PIN unblocking process. Recovery requires ensuring the retry counter is properly reset so the account is in a consistent state.</description>
        <constructors>
            <constructor>
                <signature>ErrorResettingRetryCounterFailed()</signature>
                <description>Constructs a new ErrorResettingRetryCounterFailed exception with null as the value for its detail message</description>
            </constructor>
            <constructor>
                <signature>ErrorResettingRetryCounterFailed(String message)</signature>
                <description>Constructs a new ErrorResettingRetryCounterFailed exception whereby its detail message is initialized with the passed value</description>
                <parameter name="message">value for the detail message of the exception, typically indicating retry counter reset failure</parameter>
            </constructor>
            <constructor>
                <signature>ErrorResettingRetryCounterFailed(String message, Throwable cause)</signature>
                <description>Constructs a new ErrorResettingRetryCounterFailed exception whereby its detail message and cause are initialized with the appropriate passed values</description>
                <parameter name="message">value for the detail message of the exception</parameter>
                <parameter name="cause">value for the cause of the exception</parameter>
            </constructor>
            <constructor>
                <signature>ErrorResettingRetryCounterFailed(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace)</signature>
                <description>Constructs a new ErrorResettingRetryCounterFailed exception whereby its detail message and cause are initialized with the appropriate passed values. Furthermore, it is specified whether or not suppression should be enabled or disabled and whether or not the stack trace should be writable for this exception.</description>
                <parameter name="message">value for the detail message of the exception</parameter>
                <parameter name="cause">value for the cause of the exception</parameter>
                <parameter name="enableSuppression">specifies whether or not suppression should be enabled for this exception</parameter>
                <parameter name="writableStackTrace">specifies whether or not the stack trace should be writable for this exception</parameter>
            </constructor>
        </constructors>
    </javadoc>
    <specification>
        <source>BSI TR-03151-1</source>
        <section>3.1.2 PIN Unblocking - unblockPin</section>
        <requirement>The function unblockPin SHALL unblock a user's blocked PIN by verifying the provided PUK and creating a new PIN. The unblock operation consists of multiple steps: verification of PUK, creation of new PIN, and reset of the failed PIN attempt counter to zero. If the PUK verification and new PIN creation succeed but the retry counter reset fails, the function SHALL raise the exception ErrorResettingRetryCounterFailed. In this partial failure scenario, the PIN is unblocked and the new PIN is set, but the retry counter remains at its previous value. The device should ensure transaction consistency - if the retry counter reset fails, the entire unblock operation should either be rolled back or explicitly noted as partially complete.</requirement>
        <applicability>PIN unblocking operations - unblockPin function only, when retry counter reset fails</applicability>
        <reference>unblockPin – Function (3.1.2)</reference>
    </specification>
    <thrownBy>
        <function>unblockPin</function>
    </thrownBy>
    <triggerConditions>
        <condition>
            <scenario>Device storage write failure during retry counter reset</scenario>
            <description>PIN is unblocked successfully but device fails to write the reset retry counter value to storage</description>
            <trigger>The unblockPin function successfully verifies the PUK and sets a new PIN. When attempting to reset the retry counter, the device encounters a storage write failure. The counter remains at its old value and ErrorResettingRetryCounterFailed is raised.</trigger>
        </condition>
        <condition>
            <scenario>Device communication failure during counter reset step</scenario>
            <description>PIN unblock and new PIN set succeed but communication fails during the retry counter reset transmission</description>
            <trigger>The unblockPin function completes PIN unblocking and new PIN setting. When transmitting the command to reset the retry counter, device communication is lost. The counter reset is not confirmed and ErrorResettingRetryCounterFailed is raised.</trigger>
        </condition>
        <condition>
            <scenario>Device internal error during retry counter update</scenario>
            <description>Secure Element reports an internal error when attempting to update the retry counter</description>
            <trigger>The unblockPin function successfully completes PIN-related operations. When the device attempts to update the retry counter, it encounters an internal error (hardware issue, verification failure, etc.). ErrorResettingRetryCounterFailed is raised.</trigger>
        </condition>
        <condition>
            <scenario>Partial transaction rollback leaves counter unreset</scenario>
            <description>A partial transaction or atomic operation failure leaves the retry counter in an unreset state</description>
            <trigger>The unblockPin operation uses an atomic transaction to update PIN and counter. The transaction fails on the counter update step but the PIN update is already committed. The counter remains unreset and ErrorResettingRetryCounterFailed is raised.</trigger>
        </condition>
        <condition>
            <scenario>Device resource exhaustion during counter reset</scenario>
            <description>Device lacks resources to complete the retry counter reset operation</description>
            <trigger>The PIN is successfully unblocked but the device runs out of resources (memory, processing) when attempting to reset the retry counter. ErrorResettingRetryCounterFailed is raised.</trigger>
        </condition>
    </triggerConditions>
    <executionSequence>
        <step number="1">User/application calls unblockPin function with user ID and PUK</step>
        <step number="2">Function validates input parameters including PUK format</step>
        <step number="3">Function initiates communication with Secure Element</step>
        <step number="4">Function transmits unblock command with PUK to Secure Element</step>
        <step number="5">Secure Element verifies the provided PUK</step>
        <step number="6">Secure Element unblocks the PIN and sets the new PIN value</step>
        <step number="6a">If PIN unblock/set fails → ErrorUnblockPinFailed raised, function exits</step>
        <step number="6b">If PIN unblock/set succeeds → proceed to step 7</step>
        <step number="7">Secure Element attempts to reset the failed PIN attempt counter to zero</step>
        <step number="7a">If counter reset succeeds → proceed to step 8</step>
        <step number="7b">If counter reset fails → ErrorResettingRetryCounterFailed raised, function exits</step>
        <step number="8">Function receives acknowledgment confirming both operations complete</step>
        <step number="9">Function closes communication channel with Secure Element</step>
        <step number="10">Function returns successfully with PIN unblocked and counter reset</step>
    </executionSequence>
    <recovery>
        <step>Verify PIN unblocking succeeded - confirm the PIN is actually unblocked and can be used</step>
        <step>Check device state - query device to determine if the retry counter is still at old value</step>
        <step>Manually reset retry counter - if possible, call a retry counter reset function or administrative command</step>
        <step>Query current retry counter value - determine what value the counter is at</step>
        <step>Check device storage - verify device storage is functioning and accessible</step>
        <step>Check device resources - verify device has sufficient memory and processing capacity</step>
        <step>Verify device connectivity - ensure Secure Element is accessible and responsive</step>
        <step>Retry the counter reset - attempt to reset the counter via administrative command or function</step>
        <step>Monitor retry counter - watch for unintended re-blocking if the counter still shows high failed attempts</step>
        <step>If persistent, contact device manufacturer - repeated counter reset failures may indicate device issue</step>
    </recovery>
    <relatedExceptions>
        <exception>ErrorUnblockPinFailed</exception>
        <exception>ErrorPinBlocked</exception>
        <exception>ErrorIncorrectPuk</exception>
        <exception>ErrorPukBlocked</exception>
        <exception>ErrorFunctionFailed</exception>
    </relatedExceptions>
    <postconditionality>
        <state name="PIN Successfully Unblocked">The user's PIN is now unblocked and can be used for authentication. The PIN is no longer in blocked state.</state>
        <state name="New PIN Set">A new PIN value is set on the user's account. The old PIN (which was blocked) is replaced with the new PIN.</state>
        <state name="Retry Counter Not Reset">The failed PIN attempt counter is NOT reset to zero. It retains its previous value indicating multiple failed attempts.</state>
        <state name="Account State Inconsistent">The account is in a potentially inconsistent state - PIN is unblocked but retry counter is not reset, which may cause unintended re-blocking.</state>
        <state name="Authentication Possible">User authentication with the new PIN is immediately possible - they can log in right away.</state>
        <state name="Potential Rapid Re-block">If the user makes another failed PIN attempt, they may be re-blocked more quickly than expected due to the unreset counter.</state>
    </postconditionality>
    <notes>
        <note>ErrorResettingRetryCounterFailed is thrown ONLY by the unblockPin function - specific to PIN unblocking</note>
        <note>This exception indicates a partial failure - PIN is unblocked but retry counter is not reset</note>
        <note>The exception has High severity because it leaves the account in an inconsistent state</note>
        <note>The PIN is usable despite the exception - it is not blocked again due to the counter not being reset</note>
        <note>However, the account remains vulnerable to rapid re-blocking if the counter is not reset properly</note>
        <note>The retry counter should be reset as part of PIN unblocking to provide a clean slate for new authentication attempts</note>
        <note>Failure to reset the counter may cause users to experience unintended re-blocking after the first failed attempt</note>
        <note>Device transaction management should ensure atomic operations for PIN/counter updates</note>
        <note>Error handling should detect partial failures and either roll back or complete the operation</note>
        <note>Monitoring should track counter reset failures to identify device issues</note>
        <note>Administrative tools should provide capability to manually reset retry counters if automated reset fails</note>
        <note>Error messages should clearly indicate that PIN is unblocked but counter was not reset</note>
        <note>Users should be informed that the account is in an inconsistent state and counter should be reset</note>
        <note>The exception is distinct from PIN unblocking failures - the PIN IS unblocked here</note>
        <note>Transaction logs should record both the successful PIN unblock and the failed counter reset</note>
    </notes>
    <usage>
        <scenario name="Scenario 1: PIN Unblock with Partial Failure Handling">
            <description>An application calls unblockPin to unblock a user's PIN using the correct PUK. The function raises ErrorResettingRetryCounterFailed, indicating the PIN is unblocked but the retry counter was not reset. The application informs the user that their PIN is now active but the account should have the retry counter reset for consistency.</description>
            <relatedFunctions>unblockPin, authenticateUser</relatedFunctions>
            <errorContext>PIN unblocked successfully but retry counter reset failed</errorContext>
        </scenario>
        <scenario name="Scenario 2: Device State Verification After Partial Failure">
            <description>After receiving ErrorResettingRetryCounterFailed, an application queries the device to verify the PIN is actually unblocked and checks the current retry counter value. The application logs the inconsistent state and schedules a task to reset the counter.</description>
            <relatedFunctions>unblockPin</relatedFunctions>
            <errorContext>Verification of device state after partial PIN unblocking failure</errorContext>
        </scenario>
        <scenario name="Scenario 3: Automatic Recovery with Retry Counter Reset">
            <description>When ErrorResettingRetryCounterFailed is raised, a recovery procedure is triggered that calls an administrative reset function to reset the retry counter. After the counter is reset, the account is in a consistent state.</description>
            <relatedFunctions>unblockPin</relatedFunctions>
            <errorContext>Automatic recovery attempting to reset retry counter after partial failure</errorContext>
        </scenario>
        <scenario name="Scenario 4: User Communication About Inconsistent State">
            <description>A support system receives ErrorResettingRetryCounterFailed during a user PIN recovery process. The system informs the user that their PIN is now active, but also notifies them that they should be careful with their next authentication attempts as the retry counter may not have been reset properly.</description>
            <relatedFunctions>unblockPin</relatedFunctions>
            <errorContext>User guidance after partial PIN unblocking failure</errorContext>
        </scenario>
    </usage>
    <implementationContext>
        <note>The unblockPin function must attempt to reset the retry counter as part of the unblocking operation</note>
        <note>Device transaction management should use atomic operations to ensure PIN and counter are updated together</note>
        <note>If atomic operations are not possible, the function should detect partial failures and handle them appropriately</note>
        <note>If retry counter reset fails, the function should report ErrorResettingRetryCounterFailed while noting that PIN is unblocked</note>
        <note>Error messages should clearly distinguish between PIN unblock failures and counter reset failures</note>
        <note>Retry counter reset should be persistent - the counter value should be durably written to device storage</note>
        <note>Device should provide diagnostic capability to query the current retry counter state</note>
        <note>Administrative tools should provide capability to manually reset retry counters if necessary</note>
        <note>Transaction logs should record both successful PIN operations and failed counter operations</note>
        <note>Monitoring systems should track counter reset failures as a sign of device issues</note>
    </implementationContext>
</exception>
