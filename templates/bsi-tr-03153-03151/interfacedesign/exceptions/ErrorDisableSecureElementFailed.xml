<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorDisableSecureElementFailed" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorDisableSecureElementFailed</name>
  <description>This exception is thrown if the deactivation of the Secure Element failed during execution of the disableSecureElement function. The exception represents a critical failure in the device's ability to deactivate and disable the Secure Element's cryptographic and logging functionality. ErrorDisableSecureElementFailed is raised when the disableSecureElement function invokes the Secure Element's deactivation command but the Secure Element cannot complete the deactivation process due to a hardware failure, firmware error, communication breakdown, or internal Secure Element malfunction. This exception indicates that the Secure Element remains in an enabled, operational state and all of its functionality continues to be fully accessible and functional. The exception is raised after validation checks but before the deactivation log entry is created, preventing any state change or audit trail entry from being recorded.</description>
  <category>Secure Element Operation</category>
  <severity>Critical</severity>
  <javadoc>
    <summary>This class defines the exception ErrorDisableSecureElementFailed that is thrown if the deactivation of the Secure Element failed.</summary>
    <description>The disableSecureElement function invokes the Secure Element's deactivation functionality. This exception is raised when the Secure Element cannot be successfully deactivated. Once raised, the Secure Element remains in an enabled state and all its functionality continues to be accessible. After this exception is raised, the function exits without storing the log message. No further modifications to the device state are made - only the attempted deactivation of the Secure Element failed.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.6 Core Functionality - disableSecureElement</section>
    <requirement>The function disableSecureElement SHALL invoke the functionality of the Secure Element for its deactivation. If the deactivation of the Secure Element fails, the function SHALL raise the exception ErrorDisableSecureElementFailed and exit the function. The Secure Element deactivation failure indicates that none of its functionality can be disabled as intended, leaving the Secure Element in an enabled state.</requirement>
    <applicability>Secure Element deactivation operations - Core functionality disableSecureElement only</applicability>
    <reference>disableSecureElement â€“ Function (3.3.6)</reference>
  </specification>
  <thrownBy>
    <function>disableSecureElement</function>
  </thrownBy>
  <triggerConditions>
    <condition>
      <scenario>Secure Element hardware deactivation failure</scenario>
      <description>The Secure Element's deactivation command is invoked, but the Secure Element hardware fails to complete the deactivation sequence due to a hardware malfunction, power issue, or internal hardware error that prevents state transition to disabled status.</description>
      <trigger>Secure Element hardware failure or malfunction during deactivation command execution</trigger>
    </condition>
    <condition>
      <scenario>Secure Element firmware error during deactivation</scenario>
      <description>The Secure Element's firmware encounters an error or exception during deactivation processing. Firmware bugs, memory corruption, or firmware state inconsistency prevent the deactivation operation from completing.</description>
      <trigger>Secure Element firmware error or exception during deactivation sequence</trigger>
    </condition>
    <condition>
      <scenario>Communication failure between device and Secure Element</scenario>
      <description>The device successfully sends the deactivation command to the Secure Element, but the communication channel fails before the response can be received. The device cannot determine whether the Secure Element completed deactivation or not.</description>
      <trigger>Communication failure or timeout during deactivation command execution</trigger>
    </condition>
    <condition>
      <scenario>Secure Element in protected or locked state preventing deactivation</scenario>
      <description>The Secure Element has entered a protected state, security lockdown, or operational mode that prevents deactivation. This may occur due to security policies, suspicious activity detection, or emergency protocols.</description>
      <trigger>Secure Element in protected state that prevents deactivation</trigger>
    </condition>
    <condition>
      <scenario>Secure Element physical disconnection mid-operation</scenario>
      <description>The Secure Element becomes physically disconnected or loses power during the deactivation sequence. The deactivation operation fails due to the hardware suddenly becoming unavailable.</description>
      <trigger>Secure Element physically disconnected or powered off during deactivation</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1" name="Function Invocation">User or application calls disableSecureElement function with no parameters required</step>
    <step number="2" name="Authentication Check">The function checks authentication status if required by the implementation guideline to ensure the caller is authorized</step>
    <step number="3" name="Authorization Check">The function checks authorization to verify the caller has permission to disable the Secure Element</step>
    <step number="4" name="Device Initialization Verification">The function verifies that the device is in an initialized state and ready for operations</step>
    <step number="5" name="Time Synchronization Check">The function verifies that device time is synchronized if required for Secure Element operations</step>
    <step number="6" name="Secure Element Deactivation Command">The function sends a deactivation command to the Secure Element and waits for completion</step>
    <step number="6a" name="Deactivation Success Path">If the Secure Element successfully completes deactivation, execution continues to step 7 (not taken in this exception case)</step>
    <step number="6b" name="Deactivation Failure Path">If the Secure Element cannot complete deactivation (hardware error, firmware failure, communication loss, or protected state), execution branches to exception handling at step 7b</step>
    <step number="7a" name="Log Message Creation">Upon successful deactivation, the function creates a log message recording the Secure Element deactivation event (not taken in this exception case)</step>
    <step number="7b" name="Exception Context Preparation">Upon deactivation failure, exception context is prepared including Secure Element error details, device state information, and timestamp</step>
    <step number="8" name="Exception Instance Creation">ErrorDisableSecureElementFailed exception instance is created with appropriate error message indicating Secure Element deactivation failure</step>
    <step number="9" name="Exception Propagation">Exception is raised and propagated up the call stack without creating or storing any deactivation log entry</step>
    <step number="10" name="Device State Verification">The Secure Element remains in an enabled state with all functionality operational. No state changes have been made.</step>
  </executionSequence>
  <recovery>
    <step>Verify device is initialized</step>
    <step>Check Secure Element status and connectivity</step>
    <step>Retry disable operation</step>
    <step>Contact device support if SE disable remains unavailable</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Secure Element State">Secure Element remains ENABLED with all cryptographic, signing, and logging functionality operational and accessible. Deactivation has not occurred.</state>
    <state name="Deactivation Log State">No deactivation log entry has been created or stored. The deactivation event is not recorded in the audit trail due to the deactivation failure before logging.</state>
    <state name="Device Functionality State">Device functions continue to execute normally. Functions requiring Secure Element remain fully operational. Export functions and other Secure Element-dependent operations can continue.</state>
    <state name="Device State Consistency">Device state remains completely unchanged. No modifications to internal state, configuration, or data structures have occurred as a result of the failed deactivation attempt.</state>
    <state name="Export Operations">Export functions remain available and operational (as noted in the specification: "Functions requiring Secure Element are not involved in export operations").</state>
    <state name="Function Exit">The function exits abnormally via exception propagation without completing any device state modifications or audit trail entries</state>
  </postconditionality>
  <notes>
    <note>Indication: Attempt to disable the Secure Element failed - device remains in current state</note>
    <note>Topics: Secure Element Management, Device Control, Security Operations, SE State</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Secure Element Hardware Failure During Deactivation">
      <description>A device performs a normal shutdown sequence and attempts to disable the Secure Element. The Secure Element encounters an internal hardware failure during the deactivation sequence and cannot complete the operation.</description>
      <relatedFunctions>disableSecureElement, getDeviceHealth, getComponentVersions</relatedFunctions>
      <errorContext>Hardware malfunction detected during critical deactivation operation</errorContext>
    </scenario>
    <scenario name="Scenario 2: Secure Element Communication Loss Mid-Operation">
      <description>The device sends the deactivation command to the Secure Element, but the communication channel fails before the response can be received. The device cannot determine whether the Secure Element completed deactivation.</description>
      <relatedFunctions>disableSecureElement, getDeviceHealth</relatedFunctions>
      <errorContext>Communication failure during critical hardware operation</errorContext>
    </scenario>
    <scenario name="Scenario 3: Secure Element in Protected State Preventing Deactivation">
      <description>The Secure Element has entered a protected or locked state due to security policies or suspicious activity detection. Deactivation is prevented by security restrictions, and this exception indicates the security lockdown.</description>
      <relatedFunctions>disableSecureElement, getDeviceHealth, authenticateUser</relatedFunctions>
      <errorContext>Security policy enforcement preventing intended deactivation</errorContext>
    </scenario>
    <scenario name="Scenario 4: Persistent Deactivation Failure Requiring Service">
      <description>Repeated deactivation attempts fail consistently. After diagnostics confirm Secure Element hardware damage or firmware corruption, the device is marked for professional service or replacement while continuing to operate with Secure Element enabled.</description>
      <relatedFunctions>disableSecureElement, getDeviceHealth, getComponentVersions</relatedFunctions>
      <errorContext>Persistent hardware failure requiring professional intervention</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by disableSecureElement when SE disable operation fails</note>
    <note>Secure Element state management controls device cryptographic capabilities</note>
    <note>Device attempts to transition SE to disabled state</note>
    <note>SE disable failure prevents security configuration change</note>
  </implementationContext>
</exception>
