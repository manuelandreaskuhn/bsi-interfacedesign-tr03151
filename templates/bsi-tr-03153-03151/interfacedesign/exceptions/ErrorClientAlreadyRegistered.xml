<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorClientAlreadyRegistered" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorClientAlreadyRegistered</name>
  <description>This exception is thrown if the SE API function registerClient has already been invoked for the specific clientId. The clientId is therefore already registered. The function attempts to register a new client but detects that the provided clientId is already in use by another registered client.</description>
  <category>Client Management</category>
  <subcategory>Registration</subcategory>
  <severity>Medium</severity>
  <javadoc>
    <summary>This class defines the exception ErrorClientAlreadyRegistered that is thrown if the SE API function registerClient has already been invoked for the specific clientId. The clientId is therefore already registered.</summary>
    <description>The ErrorClientAlreadyRegistered exception indicates that an attempt was made to register a client ID that has already been registered with the device. Each client ID must be unique within the device's client registry, and duplicate registration attempts violate this constraint. When this exception is raised, the registration operation fails immediately without modifying the client registry or device state. The application must choose a different clientId or deregister the existing client before attempting a new registration with the same ID.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.14 Client Management - registerClient Function (3.3.14.4)</section>
    <requirement>The exception ErrorClientAlreadyRegistered SHALL be raised if the passed clientId is already registered. The function registerClient SHALL check if the passed clientId is already registered. If the passed clientId is already registered, the function SHALL raise the exception ErrorClientAlreadyRegistered and exit the function without modifying any state. This ensures unique client identities within the device's client registry.</requirement>
    <applicability>Client registration operations - registerClient function only</applicability>
    <reference>registerClient – Function (3.3.14) - Section 3.3.14.4 Exception Specification</reference>
  </specification>
  <thrownBy>
    <function>registerClient</function>
  </thrownBy>
  <triggerConditions>
    <condition>
      <scenario>Duplicate client registration attempt</scenario>
      <description>The registerClient function is invoked with a clientId that has already been successfully registered</description>
      <trigger>The application calls registerClient with a clientId that matches an existing registered client. The device checks the client registry and finds a matching clientId. This triggers ErrorClientAlreadyRegistered.</trigger>
    </condition>
    <condition>
      <scenario>Multiple registration attempts for same client</scenario>
      <description>An application attempts to register the same clientId multiple times without deregistering it first</description>
      <trigger>The first registerClient call with a given clientId succeeds and registers the client. Subsequent registerClient calls with the identical clientId fail with ErrorClientAlreadyRegistered.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls registerClient function with a clientId</step>
    <step number="2">Function checks authentication status (if required by referencing guideline)</step>
    <step number="3">Function checks authorization (if required by referencing guideline)</step>
    <step number="4">Function checks device initialization status</step>
    <step number="5">Function checks if current number of clients is less than maximum</step>
    <step number="6">Function queries client registry to check if clientId is already registered</step>
    <step number="6a">If clientId IS already registered → ErrorClientAlreadyRegistered raised and function exits</step>
    <step number="7">If clientId is NOT registered, function validates clientId format and characters</step>
    <step number="8">Function adds clientId to device's client registry</step>
    <step number="9">Function returns successfully to the user</step>
  </executionSequence>
  <recovery>
    <step>Verify which clientId is already registered using getRegisteredClients</step>
    <step>Choose alternative clientId with different identifier for new registration</step>
    <step>Or deregister existing client first using deregisterClient before re-registering</step>
    <step>Ensure application-level logic prevents duplicate registration attempts</step>
    <step>Review client registration workflow in application code</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorClientLimitReached</exception>
    <exception>ErrorClientNotRegistered</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorDeviceNotInitialized</exception>
  </relatedExceptions>
  <postconditionality>
    <state>Client registry unchanged - no client was registered or modified</state>
    <state>Current number of clients unchanged - failed registration does not affect client count</state>
    <state>Duplicate clientId not registered - the problematic clientId is still associated with the original registration only</state>
    <state>Device state unchanged - no modifications made during failed registration attempt</state>
    <state>Function exits without creating log message (registration did not succeed)</state>
    <state>No state inconsistency - client registry remains consistent with only one entry per unique clientId</state>
  </postconditionality>
  <notes>
    <note>Indication: Attempted to register a client ID that is already registered - duplicate client registration detected</note>
    <note>Topics: Client Management, Registration, Client Registry, Uniqueness Constraints</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Duplicate Client Registration Attempt">
      <description>An application attempts to register a client with a clientId that is already registered in the device. The registration fails immediately with ErrorClientAlreadyRegistered. The application catches the exception and either uses the existing registration or attempts deregistration first.</description>
      <relatedFunctions>registerClient, deregisterClient, getRegisteredClients</relatedFunctions>
      <errorContext>Duplicate clientId - client already registered - conflict in client registry</errorContext>
    </scenario>
    <scenario name="Scenario 2: Client Re-Registration Without Deregistration">
      <description>An application previously registered a client with a specific clientId. Without deregistering first, the application attempts to register again with the same clientId. The device detects the duplicate and raises ErrorClientAlreadyRegistered. Application must deregister first.</description>
      <relatedFunctions>registerClient, deregisterClient</relatedFunctions>
      <errorContext>Duplicate registration - client already active - deregistration required before re-registration</errorContext>
    </scenario>
    <scenario name="Scenario 3: Concurrent Registration Attempts">
      <description>Multiple application threads or processes attempt to register clients simultaneously. Due to race conditions, both attempt to register with the same clientId. One succeeds, the other receives ErrorClientAlreadyRegistered. Application must implement synchronization.</description>
      <relatedFunctions>registerClient</relatedFunctions>
      <errorContext>Race condition - concurrent registration attempts - synchronization needed</errorContext>
    </scenario>
    <scenario name="Scenario 4: Client Registry Persistence Check">
      <description>Application checks the current registered clients using getRegisteredClients before attempting registration. This proactive approach can help avoid ErrorClientAlreadyRegistered by detecting duplicates before registration is attempted.</description>
      <relatedFunctions>registerClient, getRegisteredClients</relatedFunctions>
      <errorContext>Proactive duplicate detection - client registry query - conflict prevention</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by registerClient when passed clientId is already registered in device registry</note>
    <note>Client registration subsystem enforces unique clientId constraint</note>
    <note>Device checks client registry before allowing new registration</note>
    <note>Prevents duplicate client identities that would violate uniqueness constraint</note>
  </implementationContext>
</exception>

