<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorSignatureCounterOverflow" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorSignatureCounterOverflow</name>
  <description>This exception is thrown if the signature counter reaches its logical maximum value. The signature counter is a monotonically increasing value that provides audit trail integrity and replay attack protection for transactions. The counter has a maximum value (e.g., 2^64-1 for a 64-bit counter) and cannot be incremented further once this maximum is reached. ErrorSignatureCounterOverflow indicates that the signature counter has reached its logical limit and cannot accept new transactions. This is an extremely rare condition that typically requires device replacement or counter reset procedures. Common causes include: device has processed an extraordinarily large number of transactions over its lifetime, counter implementation limits reached, or counter not properly designed for system lifetime.</description>
  <category>Logging</category>
  <subcategory>Signature Counter - Overflow</subcategory>
  <severity>Critical</severity>
  <thrownBy>
    <function>authenticateUser</function>
    <function>configureLogging</function>
    <function>deleteLogMessages</function>
    <function>deregisterClient</function>
    <function>disableSecureElement</function>
    <function>finishTransaction</function>
    <function>initialize</function>
    <function>lockTransactionLogging</function>
    <function>logOut</function>
    <function>registerClient</function>
    <function>selfTest</function>
    <function>setDescription</function>
    <function>startTransaction</function>
    <function>unblockPin</function>
    <function>unlockTransactionLogging</function>
    <function>updateDevice</function>
    <function>updateTime</function>
    <function>updateTransaction</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorSignatureCounterOverflow that is thrown if the signature counter reaches its logical maximum.</summary>
    <description>This exception is thrown when the signature counter reaches its logical maximum value and cannot be incremented further. The signature counter is a critical component that maintains a monotonically increasing counter for transaction signatures, providing audit trail integrity and replay attack protection. The counter has a defined maximum value (implementation-dependent, e.g., 2^64-1 for a 64-bit counter). ErrorSignatureCounterOverflow indicates that the counter has reached this logical limit. This is an extremely rare condition in practice because the maximum is typically very large. Common causes include: device has processed an extraordinarily large number of transactions (billions or trillions), counter design does not match system transaction volume, or counter has been in production for an exceptionally long time with high transaction load. ErrorSignatureCounterOverflow is a Critical severity exception because it permanently prevents transaction processing. The counter cannot wrap around to zero (which would compromise audit trail integrity). The device is effectively unusable and requires replacement or counter reset procedures.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.2 Transaction Operations and 3.3.3 Logging Operations - Signature Counter Management</section>
    <requirement>The Secure Element maintains a signature counter that is incremented for each transaction, providing audit trail integrity and replay attack protection. The signature counter is monotonically increasing and has a defined maximum value (implementation-dependent). When the signature counter reaches its logical maximum value, the device cannot increment it further and SHALL raise ErrorSignatureCounterOverflow on any operation requiring counter increment (startTransaction, updateTransaction, finishTransaction, configureLogging). The device must not accept new transactions when counter is at maximum, as wrapping to zero would compromise audit trail integrity. This is an extremely rare condition expected to occur only after processing an extraordinarily large number of transactions over many years.</requirement>
    <applicability>Transaction operations requiring signature counter increment: startTransaction, updateTransaction, finishTransaction, configureLogging</applicability>
    <reference>Transaction Operations (3.3.2), Logging Operations (3.3.3), Signature Counter Management</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Signature counter reaches logical maximum value</scenario>
      <description>The signature counter has been incremented to its maximum possible value</description>
      <trigger>A startTransaction call is made but the device detects the signature counter is already at maximum value (e.g., 2^64-1). ErrorSignatureCounterOverflow is raised because the counter cannot be incremented further.</trigger>
    </condition>
    <condition>
      <scenario>Extremely high transaction volume over device lifetime</scenario>
      <description>The device has processed an extraordinarily large number of transactions</description>
      <trigger>After many years of production operation with very high transaction load, a finishTransaction call detects the signature counter has reached maximum. ErrorSignatureCounterOverflow is raised.</trigger>
    </condition>
    <condition>
      <scenario>Counter size insufficient for system requirements</scenario>
      <description>The counter implementation uses insufficient bit width for the system's transaction volume</description>
      <trigger>An updateTransaction call is made but counter reaches maximum because the counter size is too small for the system's transaction rate. ErrorSignatureCounterOverflow is raised.</trigger>
    </condition>
    <condition>
      <scenario>Signature counter increment operation would overflow</scenario>
      <description>The next increment operation would cause the counter to exceed its maximum value</description>
      <trigger>A configureLogging call attempts to enable more transactions but the counter cannot be incremented further. ErrorSignatureCounterOverflow is raised to prevent overflow.</trigger>
    </condition>
    <condition>
      <scenario>Device approaching or at theoretical maximum transaction limit</scenario>
      <description>The device is at or approaching the theoretical maximum transactions it can support</description>
      <trigger>Any transaction operation detects the counter is at maximum. The device has reached its absolute transaction processing limit.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls transaction operation that requires signature counter increment (e.g., startTransaction)</step>
    <step number="2">Function validates input parameters</step>
    <step number="3">Function initiates communication with Secure Element</step>
    <step number="4">Secure Element receives transaction request</step>
    <step number="5">Secure Element checks current signature counter value</step>
    <step number="5a">If counter is at maximum → ErrorSignatureCounterOverflow raised, operation aborted</step>
    <step number="5b">If counter is below maximum → proceed to step 6</step>
    <step number="6">Secure Element processes transaction operation</step>
    <step number="7">Secure Element calculates new counter value = current counter + 1</step>
    <step number="8">Secure Element verifies new counter does not exceed maximum</step>
    <step number="8a">If new counter would exceed maximum → ErrorSignatureCounterOverflow raised, operation aborted</step>
    <step number="8b">If new counter is valid → proceed to step 9</step>
    <step number="9">Secure Element increments signature counter</step>
    <step number="10">Secure Element writes updated counter value to storage</step>
    <step number="11">Secure Element completes transaction operation</step>
    <step number="12">Secure Element returns result to function</step>
    <step number="13">Function returns successfully</step>
  </executionSequence>
  <recovery>
    <step>Check current counter value approaching maximum</step>
    <step>Plan for counter overflow - stop logging operations</step>
    <step>Implement overflow mitigation in application</step>
    <step>Monitor counter approaching maximum threshold</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorLimitOfSimultaneousOpenTransactionsReached</exception>
    <exception>ErrorOpenTransactionFound</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="Transaction Not Created">The requested transaction is not created due to counter overflow.</state>
    <state name="Signature Counter Not Incremented">The counter remains at maximum and cannot be incremented.</state>
    <state name="Device Cannot Process Transactions">The device cannot process any new transactions - counter overflow is permanent.</state>
    <state name="Audit Trail Protection Broken">Allowing counter to wrap would compromise audit trail integrity.</state>
    <state name="Device Effectively Decommissioned">The device has reached the end of its useful transaction processing life.</state>
    <state name="Device Requires Replacement">The device must be replaced or decommissioned.</state>
  </postconditionality>
  <notes>
    <note>Indication: Signature counter would overflow - maximum capacity exceeded</note>
    <note>Topics: Signature Operations, Counter Management, Resource Limits, Overflow Protection</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Counter Overflow After Decades of Operation">
      <description>A device has been in production for 20+ years processing millions of transactions daily. A startTransaction call finally receives ErrorSignatureCounterOverflow. The counter has reached its maximum after processing billions of transactions. The device is decommissioned and replaced.</description>
      <relatedFunctions>startTransaction, exportLogMessages, getDescription</relatedFunctions>
      <errorContext>Device end-of-life due to counter overflow after decades of operation</errorContext>
    </scenario>
    <scenario name="Scenario 2: Counter Monitoring Predicts Overflow">
      <description>Capacity planning tools monitor counter growth rates and predict when counters will overflow based on current transaction volume. For a device projected to overflow in 5 years, replacement is scheduled proactively.</description>
      <relatedFunctions>getDescription, startTransaction</relatedFunctions>
      <errorContext>Proactive planning detects future counter overflow risk</errorContext>
    </scenario>
    <scenario name="Scenario 3: Unexpected Counter Overflow Detection">
      <description>A system experiences unexpected transaction processing failure. Investigation reveals a startTransaction call receives ErrorSignatureCounterOverflow. Analysis shows the counter was undersized for the actual transaction volume. Emergency device replacement is performed and counter sizing is reviewed.</description>
      <relatedFunctions>startTransaction, finishTransaction</relatedFunctions>
      <errorContext>Emergency handling of unexpected counter overflow due to undersized counter</errorContext>
    </scenario>
    <scenario name="Scenario 4: High-Load System Counter Management">
      <description>A high-volume transaction system monitors counter increment rates. When counter is predicted to overflow in 2 months at current load, the system schedules gradual migration of transactions to replacement devices to maintain continuous service.</description>
      <relatedFunctions>startTransaction, getDescription</relatedFunctions>
      <errorContext>Managed transition planning for high-load systems with predictable counter overflow</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by logging functions when signature counter would overflow</note>
    <note>Overflow protection prevents counter value wrap-around</note>
    <note>Device detects impending counter maximum</note>
    <note>Overflow condition blocks further signatures</note>
  </implementationContext>
</exception>

