<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorSettingNewPinFailed" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorSettingNewPinFailed</name>
  <description>This exception is thrown if the SE API function unblockPin fails to set the new PIN during the unblock operation. The unblockPin function attempts to unblock a blocked or locked PIN by using the PUK (PIN Unblock Key) and setting a new PIN value. If the new PIN setting operation fails after successful PUK authentication, ErrorSettingNewPinFailed indicates the PIN change could not be completed. Common causes include: device storage errors, invalid PIN format, PIN policy violations, device internal errors, or communication failures. ErrorSettingNewPinFailed indicates the unblock operation is incomplete - the old PIN remains blocked and the new PIN was not set.</description>
  <category>Authentication - PIN Management - PIN Setting Failure</category>
  <severity>High</severity>
  <javadoc>
    <summary>This class defines the exception ErrorSettingNewPinFailed that is thrown if new PIN setting fails during unblock.</summary>
    <description>This exception is thrown when the unblockPin function attempts to set a new PIN value during the PIN unblock operation but encounters a failure. The unblockPin function first validates the PUK (PIN Unblock Key) and then attempts to set the new PIN to replace the blocked PIN. ErrorSettingNewPinFailed indicates that the new PIN setting step has failed, leaving the PIN in a blocked state. Common causes include: device storage errors, invalid new PIN format, PIN policy violations (minimum length, character requirements), device internal errors, or communication failures. ErrorSettingNewPinFailed is a High severity exception because it prevents PIN recovery and blocks user authentication. The user remains unable to authenticate with the blocked PIN. Recovery requires investigating the specific failure reason and retrying the unblock operation with a valid PIN.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.3.1 Authentication Operations - unblockPin</section>
    <requirement>The function unblockPin SHALL unblock a blocked PIN by authenticating with the PUK (PIN Unblock Key) and setting a new PIN value. The operation proceeds in two steps: (1) PUK authentication validation, (2) New PIN setting. If the new PIN setting operation fails after successful PUK authentication, the function SHALL raise ErrorSettingNewPinFailed. The new PIN must meet security policy requirements including minimum length and character restrictions. If the new PIN does not meet requirements or the device fails to store the new PIN, ErrorSettingNewPinFailed is raised. The original blocked PIN remains blocked if the new PIN setting fails.</requirement>
    <applicability>PIN unblock operations - unblockPin function only</applicability>
    <reference>unblockPin – Function (3.3.1)</reference>
  </specification>
  <thrownBy>
    <function>unblockPin</function>
  </thrownBy>
  <triggerConditions>
    <condition>
      <scenario>Invalid new PIN format or policy violation</scenario>
      <description>The new PIN does not meet security policy requirements</description>
      <trigger>An unblockPin call provides a new PIN that violates policy (too short, invalid characters, weak PIN). The device validates the new PIN and raises ErrorSettingNewPinFailed.</trigger>
    </condition>
    <condition>
      <scenario>Device storage write error for new PIN</scenario>
      <description>The device fails to write the new PIN to storage</description>
      <trigger>An unblockPin call reaches the new PIN setting step but the device encounters storage write errors. The new PIN cannot be stored and ErrorSettingNewPinFailed is raised.</trigger>
    </condition>
    <condition>
      <scenario>Device internal error during PIN setting</scenario>
      <description>The device encounters an internal error while processing the new PIN</description>
      <trigger>An unblockPin call processes the new PIN but the device encounters internal processing errors. The device aborts the PIN setting and raises ErrorSettingNewPinFailed.</trigger>
    </condition>
    <condition>
      <scenario>Communication failure during PIN setting</scenario>
      <description>Communication with the device is lost during new PIN setting</description>
      <trigger>An unblockPin call transmits new PIN data but communication is interrupted. The device cannot complete PIN setting and raises ErrorSettingNewPinFailed.</trigger>
    </condition>
    <condition>
      <scenario>PIN policy configuration error</scenario>
      <description>Device PIN security policy configuration prevents the new PIN from being set</description>
      <trigger>An unblockPin call attempts to set a new PIN but device policy configuration prevents it (policy timeout, policy lock). The device raises ErrorSettingNewPinFailed.</trigger>
    </condition>
  </triggerConditions>
  <executionSequence>
    <step number="1">User/application calls unblockPin function with PUK and new PIN parameters</step>
    <step number="2">Function validates input parameters (PUK and new PIN)</step>
    <step number="3">Function checks new PIN against security policy</step>
    <step number="3a">If new PIN violates policy → ErrorSettingNewPinFailed raised, function exits</step>
    <step number="3b">If new PIN meets policy requirements → proceed to step 4</step>
    <step number="4">Function initiates communication with Secure Element</step>
    <step number="5">Function sends unblock request with PUK and new PIN to Secure Element</step>
    <step number="6">Secure Element receives unblock request</step>
    <step number="7">Secure Element authenticates using PUK</step>
    <step number="7a">If PUK authentication fails → ErrorUnblockingPinFailed raised</step>
    <step number="7b">If PUK authentication succeeds → proceed to step 8</step>
    <step number="8">Secure Element validates new PIN format</step>
    <step number="8a">If new PIN invalid → ErrorSettingNewPinFailed raised, function exits</step>
    <step number="8b">If new PIN valid → proceed to step 9</step>
    <step number="9">Secure Element writes new PIN to secure storage</step>
    <step number="9a">If storage write fails → ErrorSettingNewPinFailed raised, function exits</step>
    <step number="9b">If storage write succeeds → proceed to step 10</step>
    <step number="10">Secure Element confirms new PIN is now active (old PIN no longer blocked)</step>
    <step number="11">Secure Element returns success acknowledgment to function</step>
    <step number="12">Function closes communication channel with Secure Element</step>
    <step number="13">Function returns successfully - PIN unblocked with new PIN set</step>
  </executionSequence>
  <recovery>
    <step>Review error message - examine the error message to understand why PIN setting failed</step>
    <step>Verify new PIN format - ensure the new PIN meets security policy requirements</step>
    <step>Check new PIN length - verify new PIN is not too short or exceeds maximum length</step>
    <step>Check new PIN characters - verify new PIN uses only allowed characters</step>
    <step>Check device state - query device to verify it is operational</step>
    <step>Check device connectivity - verify clean communication with Secure Element</step>
    <step>Verify PUK is correct - ensure PUK provided is still valid (not exhausted)</step>
    <step>Retry with valid PIN - attempt unblockPin again with a PIN that meets all requirements</step>
    <step>Check security policy - verify device security policy allows PIN changes</step>
    <step>If persistent, contact manufacturer - device may have configuration or storage issues</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorUnblockingPinFailed</exception>
    <exception>ErrorPinBlocked</exception>
    <exception>ErrorPukTemporarilyBlocked</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorParameterTooLong</exception>
  </relatedExceptions>
  <postconditionality>
    <state name="New PIN Not Set">The new PIN is not set on the device. The new PIN setting operation fails before completion.</state>
    <state name="Original PIN Remains Blocked">The original blocked PIN remains in blocked state. The PIN is not unblocked.</state>
    <state name="Device Storage Unchanged">The device's PIN storage is not modified by the failed new PIN setting attempt.</state>
    <state name="Authentication Still Blocked">User authentication remains blocked with the original blocked PIN.</state>
    <state name="PUK May Be Consumed">The PUK may have been consumed during the failed unblock attempt, depending on device behavior.</state>
    <state name="Retry Possible">The unblock operation can be retried after addressing the PIN format or policy issue.</state>
  </postconditionality>
  <notes>
    <note>ErrorSettingNewPinFailed is thrown only by the unblockPin function - specific to PIN unblock operations</note>
    <note>This exception indicates the new PIN setting step of unblock failed</note>
    <note>The exception is distinct from ErrorUnblockingPinFailed which indicates PUK authentication failed</note>
    <note>This exception indicates the PIN remains blocked - user authentication is still not possible</note>
    <note>The exception has High severity because it leaves the user unable to authenticate</note>
    <note>New PIN must meet device security policy requirements for length and characters</note>
    <note>Device should validate new PIN format before attempting to store it</note>
    <note>Storage failure is a serious issue - device may have storage problems</note>
    <note>Communication reliability is important during critical PIN operations</note>
    <note>Error messages should indicate whether the issue is PIN format or device storage</note>
    <note>PUK consumption should be tracked - repeated failures may exhaust PUK attempts</note>
    <note>User may need to contact administrator if PIN cannot be unblocked</note>
    <note>Security policy should enforce PIN requirements that prevent weak PINs</note>
    <note>Device should provide clear feedback about PIN policy requirements to users</note>
    <note>Alternative authentication methods should be available if PIN unblock fails repeatedly</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: User PIN Unblock with Policy Validation">
      <description>A user with a blocked PIN calls unblockPin with their PUK and a new PIN. The new PIN is too short and violates security policy. ErrorSettingNewPinFailed is raised. The user is informed about PIN requirements and retries with a valid PIN.</description>
      <relatedFunctions>unblockPin, authenticateUser</relatedFunctions>
      <errorContext>PIN unblock fails due to new PIN violating security policy</errorContext>
    </scenario>
    <scenario name="Scenario 2: PIN Recovery with Device Storage Issues">
      <description>A PIN recovery process calls unblockPin. The PUK authentication succeeds but device storage fails when attempting to write the new PIN. ErrorSettingNewPinFailed is raised. The administrator is notified of device storage problems.</description>
      <relatedFunctions>unblockPin, selfTest</relatedFunctions>
      <errorContext>PIN recovery blocked by device storage failure</errorContext>
    </scenario>
    <scenario name="Scenario 3: Help Desk PIN Reset with Retry Logic">
      <description>Help desk staff use unblockPin to reset a user's PIN. When ErrorSettingNewPinFailed is raised, the help desk system logs the failure, verifies the new PIN meets policy, and retries the operation.</description>
      <relatedFunctions>unblockPin, getDescription</relatedFunctions>
      <errorContext>Help desk PIN reset operation encounters new PIN setting failure</errorContext>
    </scenario>
    <scenario name="Scenario 4: Emergency Access with Authentication Recovery">
      <description>An employee locked out of the system calls emergency support to unblock their PIN. When ErrorSettingNewPinFailed is raised, support verifies device state and works through recovery procedures to restore PIN access.</description>
      <relatedFunctions>unblockPin, authenticateUser</relatedFunctions>
      <errorContext>Emergency PIN recovery blocked by new PIN setting failure</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>The unblockPin function must validate new PIN format before attempting to store it</note>
    <note>New PIN validation should enforce all security policy requirements (length, characters, strength)</note>
    <note>Clear error messages should distinguish between PIN format issues vs. device storage issues</note>
    <note>Device should provide feedback about PIN policy requirements for user information</note>
    <note>PIN storage should be performed atomically - either fully commit or fully rollback</note>
    <note>Communication during PIN operations should be reliable and error-checked</note>
    <note>New PIN should be securely handled - never logged or transmitted insecurely</note>
    <note>PUK consumption should be tracked to prevent exhaustion of unblock attempts</note>
    <note>Device should differentiate between PUK authentication failure vs. PIN setting failure</note>
    <note>Security policy should be enforced consistently across all PIN operations</note>
  </implementationContext>
</exception>
