<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<exception xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="ErrorDeviceNotInitialized" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/exceptions.xsd">
  <name>ErrorDeviceNotInitialized</name>
  <description>This exception is thrown by any SE API function if the device is not initialized but the function requires the device to be initialized. The exception represents a critical mandatory prerequisite violation that prevents all SE API operations that depend on device initialization. ErrorDeviceNotInitialized is raised when an application invokes any of 44 SE API functions that require the device to be in an initialized state, but the device has not yet been successfully initialized or a previous initialization attempt failed. This exception enforces the fundamental architectural requirement that the initialize function must be called once and complete successfully before any other API functionality can be accessed. The exception is raised immediately upon entry to any dependent function when the device initialization state is verified to be uninitialized, preventing any function operations from proceeding.</description>
  <category>Common Exception</category>
  <severity>Critical</severity>
  <thrownBy>
    <function>configureLogging</function>
    <function>deleteLogMessages</function>
    <function>deregisterClient</function>
    <function>disableSecureElement</function>
    <function>exportFilteredTransactionLogs</function>
    <function>exportLogMessages</function>
    <function>exportLoggingCertificates</function>
    <function>exportSerialNumbers</function>
    <function>finishTransaction</function>
    <function>getComponentVersions</function>
    <function>getCurrentLoggingSignatureCounters</function>
    <function>getCurrentNumberOfClients</function>
    <function>getCurrentNumberOfTransactions</function>
    <function>getCurrentTransactionCounter</function>
    <function>getDescription</function>
    <function>getDeviceHealth</function>
    <function>getEndOfUsageDate</function>
    <function>getFreeMemory</function>
    <function>getLastLogMessage</function>
    <function>getLastTransactionLogMessage</function>
    <function>getMaxNumberOfClients</function>
    <function>getMaxNumberOfTransactions</function>
    <function>getOpenTransactions</function>
    <function>getRegisteredClients</function>
    <function>getSupportedTransactionUpdateVariants</function>
    <function>getTimeSyncVariant</function>
    <function>getTotalMemory</function>
    <function>getTransactionState</function>
    <function>getUsedMemory</function>
    <function>lockTransactionLogging</function>
    <function>registerClient</function>
    <function>restoreLogsFromBackup</function>
    <function>selfTest</function>
    <function>setDescription</function>
    <function>startTransaction</function>
    <function>unlockTransactionLogging</function>
    <function>updateDevice</function>
    <function>updateTime</function>
    <function>updateTransaction</function>
  </thrownBy>
  <javadoc>
    <summary>This class defines the exception ErrorDeviceNotInitialized that is thrown by any SE API function if the device is not initialized but the function requires the device to be initialized.</summary>
    <description>A function requiring device initialization has been invoked when the device has not yet been initialized. This exception indicates a mandatory prerequisite violation - the initialize function must be called once and complete successfully before any other API functions that require device initialization can be executed. The device must be in an initialized state for the vast majority of API functions to operate correctly.</description>
  </javadoc>
  <specification>
    <source>BSI TR-03151-1</source>
    <section>3.1.2.2</section>
    <requirement>The exception ErrorDeviceNotInitialized SHALL be implemented by all functions that require the device to be initialized before a correct usage of the function. This exception SHALL be raised when any function depending on device initialization is invoked before the initialize function has been successfully completed.</requirement>
    <applicability>Common exception - mandatory prerequisite enforcement for all API functions requiring initialization</applicability>
    <reference>initialize â€“ Core functionality (3.3.1)</reference>
  </specification>
  <triggerConditions>
    <condition>
      <scenario>Dependent function invoked before any initialization</scenario>
      <description>An application immediately attempts to call an SE API function that requires device initialization (such as startTransaction, getDeviceHealth, or registerClient) without first calling initialize. The device has never been initialized.</description>
      <trigger>Any initialization-dependent function called when device initialization state is uninitialized</trigger>
    </condition>
    <condition>
      <scenario>Initialization never completed or was never attempted</scenario>
      <description>The application was supposed to call initialize but failed to do so, either due to application logic error, missing initialization code, or incorrect error handling that masked initialization failure.</description>
      <trigger>Device-dependent function invoked without prior successful initialize completion</trigger>
    </condition>
    <condition>
      <scenario>Device initialization failure not properly handled</scenario>
      <description>The initialize function was called and raised ErrorDeviceInitializationFailed or returned failure, but the application incorrectly treated this as a success or proceeded to use the device despite initialization failure.</description>
      <trigger>Dependent function invoked after failed initialization attempt</trigger>
    </condition>
    <condition>
      <scenario>Device state corruption or loss between initialization and use</scenario>
      <description>The device was successfully initialized, but the internal initialization state flags were corrupted or lost due to a crash, firmware issue, or storage failure. The device appears uninitialized despite previous successful initialization.</description>
      <trigger>Dependent function detects initialization state loss or corruption</trigger>
    </condition>
  </triggerConditions>
  <recovery>
    <step>Call initialize function before using device API</step>
    <step>Wait for initialization to complete successfully</step>
    <step>Verify initialize operation completed without errors</step>
    <step>Ensure application initialization flow is correct</step>
    <step>Check device logs for initialization errors</step>
  </recovery>
  <relatedExceptions>
    <exception>ErrorDeviceInitializationFailed</exception>
    <exception>ErrorDeviceIsInitialized</exception>
    <exception>ErrorFunctionFailed</exception>
  </relatedExceptions>
  <executionSequence>
    <step number="1" name="Function Invocation">Entry point is reached for any of the 44 device-dependent API functions (such as startTransaction, registerClient, getDeviceHealth, etc.)</step>
    <step number="2" name="Initialization State Check">The function immediately checks whether the device is in an initialized state by examining the device initialization status flags</step>
    <step number="3a" name="Device Initialized">If the device is initialized, execution proceeds to the function's main operation logic (not taken in this exception case)</step>
    <step number="3b" name="Device Not Initialized">If the device is not initialized, execution branches to exception handling at step 4</step>
    <step number="4" name="Exception Context Preparation">Exception context is prepared including the function name that was invoked, the device uninitialized state, and timestamp of the error</step>
    <step number="5" name="Exception Instance Creation">ErrorDeviceNotInitialized exception instance is created with appropriate error message indicating that initialization is required before the function can execute</step>
    <step number="6" name="Exception Propagation">Exception is raised and propagated up the call stack to the calling application without performing any function operations</step>
    <step number="7" name="Device State Unchanged">The device remains in its current state with no changes resulting from the attempted function call</step>
  </executionSequence>
  <postconditionality>
    <state name="Exception State">An ErrorDeviceNotInitialized exception has been created and raised, indicating that the device initialization prerequisite has not been met</state>
    <state name="Device Operational State">The device remains in an uninitialized state, unavailable for API operations. No device functionality is accessible.</state>
    <state name="Device Initialization Status">The device remains uninitialized. No initialization has been started or completed. The device requires explicit initialization via the initialize function.</state>
    <state name="Internal State">No changes have been made to device internal state, configuration, or data structures. The device state is completely unchanged by the failed function call attempt.</state>
    <state name="Function Execution">The intended function has not been executed. None of its operations have been performed. The function exits immediately upon initialization state verification.</state>
    <state name="Application Responsibility">The application must call the initialize function before any further operations can proceed. This is a mandatory step that cannot be bypassed or deferred.</state>
  </postconditionality>
  <notes>
    <note>Indication: Operation attempted on a device that has not been initialized - device not ready</note>
    <note>Topics: Device Initialization, Device State, Initialization Requirements, System Setup</note>
  </notes>
  <usage>
    <scenario name="Scenario 1: Missing Initialization in Application Startup">
      <description>An application attempts to register a client (registerClient) without first calling initialize. The application skipped or forgot the initialization step in its startup sequence.</description>
      <relatedFunctions>initialize, registerClient, getDeviceHealth</relatedFunctions>
      <errorContext>Application startup bug where initialize was omitted from the startup sequence</errorContext>
    </scenario>
    <scenario name="Scenario 2: Failed Initialization Not Properly Handled">
      <description>The application called initialize, but the call failed with ErrorDeviceInitializationFailed. The application incorrectly treated this as success or masked the error, then attempted to use the device.</description>
      <relatedFunctions>initialize, getDeviceHealth, authenticateUser</relatedFunctions>
      <errorContext>Error handling bug where initialization failure was not properly detected</errorContext>
    </scenario>
    <scenario name="Scenario 3: Device State Loss After Successful Initialization">
      <description>A device was successfully initialized and used. Later, the device crashes or reboots, losing internal initialization state. Subsequent function calls fail with this exception, indicating the device must be re-initialized.</description>
      <relatedFunctions>initialize, startTransaction, getDeviceHealth</relatedFunctions>
      <errorContext>Device crash or state corruption requiring re-initialization</errorContext>
    </scenario>
    <scenario name="Scenario 4: Multi-Device Management Without Proper Sequencing">
      <description>An application manages multiple devices and attempts to use a device before initializing it, while other devices are properly initialized. The uninitialized device raises this exception.</description>
      <relatedFunctions>initialize, getDeviceHealth, registerClient</relatedFunctions>
      <errorContext>Multi-device management bug where device initialization sequencing was incorrect</errorContext>
    </scenario>
  </usage>
  <implementationContext>
    <note>Raised by functions when device initialization prerequisite not met</note>
    <note>Most functions require device initialized state for operation</note>
    <note>Device state tracking enforces initialization requirement</note>
    <note>Application must call initialize before using most API functions</note>
  </implementationContext>
</exception>

