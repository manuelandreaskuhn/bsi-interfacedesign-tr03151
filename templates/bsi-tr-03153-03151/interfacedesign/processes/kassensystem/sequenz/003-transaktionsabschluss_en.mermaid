sequenceDiagram
    participant ERS as Recording System (ERS)
    participant TSE as TSE
    participant SM as Security Module
    participant Storage as Storage Medium

    ERS->>TSE: finishTransaction(clientId, transactionNumber,<br/>processData, processType)
    activate TSE
    
    TSE->>TSE: Check User Authentication
    TSE->>TSE: Check Transaction exists
    
    Note over TSE,SM: If Variant B: Save collected Updates
    
    TSE->>SM: Create final Checksum
    activate SM
    SM->>SM: Calculate Checksum over:<br/>- all processData<br/>- transactionNumber<br/>- serialNumber<br/>- signatureCounter<br/>- signatureCreationTime
    SM->>SM: signatureCounter++
    SM-->>TSE: signature, signatureCounter
    deactivate SM
    
    TSE->>Storage: Save Log Message<br/>(Transaction-Log: finish)
    activate Storage
    Storage-->>TSE: OK
    deactivate Storage
    
    TSE->>TSE: Complete Transaction
    
    TSE-->>ERS: Return:<br/>- logTime<br/>- signatureCounter<br/>- signature
    deactivate TSE
    
    Note over ERS,Storage: Transaction is now completed<br/>and cannot be updated anymore
