<?xml version='1.0' encoding='utf-8'?>
<function id="updateDevice" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>updateDevice</name>
  <category>Gerätewartung</category>
  <description>Triggers the execution of a self test.</description>
  <detailedSteps>
    <step>
      <number>1</number>
      <originalText>If the referencing guideline limits the access to the functionality solely to authenticated users , the function SHALL check if the user that has invoked the function has the status authenticated. If the status is not authenticated, the function SHALL raise the exception ErrorUserNotAuthenticated and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf authentifizierte Benutzer beschränkt: Prüfe, ob der aufrufende Benutzer authentifiziert ist. Falls nicht: Werfe ErrorUserNotAuthenticated und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT authentifiziert DANN
  WERFE ErrorUserNotAuthenticated
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthenticated</exception>
        <trigger>Der Benutzer ist nicht authentifiziert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <originalText>If the referencing guideline limits the access to the functionality to certain roles, the function SHALL check in the corresponding role if the (unauthenticated) user is authorized to execute the function. If the user is not authorized, the function SHALL raise the exception ErrorUserNotAuthorized and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf bestimmte Rollen beschränkt: Prüfe in der entsprechenden Rolle, ob der (unauthentifizierte) Benutzer berechtigt ist, die Funktion auszuführen. Falls nicht: Werfe ErrorUserNotAuthorized und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT autorisiert DANN
  WERFE ErrorUserNotAuthorized
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthorized</exception>
        <trigger>Der Benutzer ist nicht berechtigt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <originalText>The function SHALL check if there are open transactions that are currently managed by the Secure Element. If at least one transaction was started but is not finished and not classified abandoned, the function SHOULD raise the exception ErrorOpenTransactionFound and exit the function.</originalText>
      <germanText>Prüfe, ob offene Transaktionen vom Secure Element verwaltet werden. Falls mindestens eine Transaktion gestartet, nicht beendet und nicht als verwaist klassifiziert ist: Werfe ErrorOpenTransactionFound und beende Funktion.</germanText>
      <pseudocode>WENN offene Transaktionen vorhanden DANN
  WERFE ErrorOpenTransactionFound
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorOpenTransactionFound</exception>
        <trigger>Offene Transaktionen vorhanden</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>4</number>
      <originalText>If the current time in the SE is not set, the function SHALL raise the exception ErrorTimeNotSet and exit the function.</originalText>
      <germanText>Falls die aktuelle Zeit im SE nicht gesetzt ist: Werfe ErrorTimeNotSet und beende Funktion.</germanText>
      <pseudocode>WENN Aktuelle Zeit im SE NICHT gesetzt DANN
  WERFE ErrorTimeNotSet
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorTimeNotSet</exception>
        <trigger>Die aktuelle Zeit im SE ist nicht gesetzt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <originalText>The function SHALL invoke the functionality of the Secure Element to create the log message parts to log the start of the update .</originalText>
      <germanText>Rufe Secure-Element-Funktionalität auf, um Log-Nachricht-Teile für Update-Start zu erstellen. Bei Fehler: Werfe ErrorSigningEventDataFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  RUFE_AUF Secure-Element-Funktionalität
  ERSTELLE Log-Nachricht-Teile für Update-Start
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Secure-Element-Funktionalität fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <originalText>The function SHALL retrieve the parts of the log message determined by the Secure Element. If the retrieval of the log message parts fails, the function SHALL raise the exception ErrorRetrieveLogMessageFailed and exit the function.</originalText>
      <germanText>Hole die Log-Nachricht-Teile vom Secure Element. Falls der Abruf fehlschlägt: Werfe ErrorRetrieveLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  HOLE Log-Nachricht-Teile vom Secure Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>Der Abruf der Log-Nachricht-Teile schlägt fehl</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>7</number>
      <originalText>The function SHALL store the data of the retrieved log message parts. If the data has not been stored successfully, the function SHALL raise the exception ErrorStoringLogMessageFailed and exit the function.</originalText>
      <germanText>Speichere die Log-Nachricht-Teile. Falls Speicherung fehlschlägt: Werfe ErrorStoringLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  SPEICHERE Log-Nachricht-Teile
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>Die Daten wurden nicht erfolgreich gespeichert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>8</number>
      <originalText>The function SHALL update the device. The following steps MUST be performed, but MAY be performed after the initial function call to updateDevice has been terminated – for example because of a reboot of the device which is part of the update process. The steps are in any case still logically considered part of the updateDevice function.</originalText>
      <germanText>Führe das Geräte-Update durch. Folgende Schritte können nach dem Funktionsaufruf ausgeführt werden (z.B. nach Geräte-Neustart). Sie sind logisch Teil dieser Funktion.</germanText>
      <pseudocode>VERSUCHE
  UPDATE_DEVICE
BEI_FEHLER
  RUFE_AUF Protokollierung fehlgeschlagener Update-Versuch
  WERFE ErrorUpdateDeviceFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUpdateDeviceFailed</exception>
        <trigger>Geräte-Update fehlgeschlagen</trigger>
        <action>Protokolliere Fehler, Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>9</number>
      <originalText>If the update process fails, the function SHALL perform the steps described in 3.3.5.6.1 to log the failed update attempt. This includes the termination of the function updateDevice.</originalText>
      <germanText>Falls Update-Prozess fehlschlägt: Führe Protokollierungsschritte für fehlgeschlagenen Update-Versuch durch und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  LOG fehlgeschlagener Update-Versuch
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed oder ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Protokollierung des Update-Fehlers fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>10</number>
      <originalText>The function SHALL invoke the functionality of the Secure Element to create the log message parts to log the completion of the update .</originalText>
      <germanText>Rufe Secure-Element-Funktionalität auf, um Log-Nachricht-Teile für Update-Abschluss zu erstellen. Bei Fehler: Werfe ErrorSigningEventDataFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  RUFE_AUF Secure-Element-Funktionalität
  ERSTELLE Log-Nachricht-Teile für Update-Abschluss
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Secure-Element-Funktionalität fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>11</number>
      <originalText>The function SHALL retrieve the parts of the log message determined by the Secure Element. If the retrieval of the log message parts fails, the function SHOULD raise the exception ErrorRetrieveLogMessageFailed and exit the function.</originalText>
      <germanText>Hole die Log-Nachricht-Teile vom Secure Element. Falls Abruf fehlschlägt: Werfe ErrorRetrieveLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  HOLE Log-Nachricht-Teile vom Secure Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>Abruf der Log-Nachricht-Teile fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>12</number>
      <originalText>The function SHALL store the data of the retrieved log message parts. If the data has not been stored successfully, the function SHOULD raise the exception ErrorStoringLogMessageFailed and exit the function.</originalText>
      <germanText>Speichere die Log-Nachricht-Teile. Falls Speicherung fehlschlägt: Werfe ErrorStoringLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  SPEICHERE Log-Nachricht-Teile
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>Speicherung fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>13</number>
      <originalText>The function SHOULD return without raising an exception to indicate that the execution of the function updateDevice has been successful.</originalText>
      <germanText>Gebe ohne Exception zurück, um erfolgreiche Ausfürung anzuzeigen.</germanText>
      <pseudocode>RETURN ohne Exception
BEENDE_ERFOLGREICH</pseudocode>
      <successCase>
        <condition>Update war erfolgreich</condition>
        <action>Funktion kehrt ohne Exception zurück</action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>update</name>
      <type>InputStream</type>
      <description>the update data for the device.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
  </parameters>
  <returnValue>
    <type>void</type>
    <description>This function does not return a value.</description>
  </returnValue>
  <exceptions>
    <exception>ErrorCertificateExpired</exception>
    <exception>ErrorDeviceNotInitialized</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorOpenTransactionFound</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorParameterTooLong</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
    <exception>ErrorSignatureCounterOverflow</exception>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorTimeNotSet</exception>
    <exception>ErrorUpdateDeviceFailed</exception>
    <exception>ErrorUserNotAuthenticated</exception>
    <exception>ErrorUserNotAuthorized</exception>
  </exceptions>
  <systemLog>
    <logType>system</logType>
    <requirement>MUST</requirement>
    <asn1Structure>
      <logMessage>LogMessage ::= SEQUENCE {
  version                INTEGER (3),
  certifiedDataType      OBJECT IDENTIFIER (id-SE-API-system-log),
  certifiedData          SystemLogMessage,  -- embedded system log
  serialNumber           OCTET STRING (SIZE (32)),
  signatureAlgorithm     AlgorithmIdentifier,
  seAuditData            OCTET STRING OPTIONAL,
  signatureCounter       INTEGER,
  signatureCreationTime  Time,
  signatureValue         OCTET STRING
}</logMessage>
      <systemLogMessage>SystemLogMessage ::= SEQUENCE {
  version                    INTEGER (3),
  certifiedDataType          OBJECT IDENTIFIER (id-SE-API-system-log),
  eventType                  [0] IMPLICIT PrintableString ("updateDevice"),
  eventOrigin                [1] IMPLICIT PrintableString OPTIONAL,
  eventTriggeredByUser       [2] IMPLICIT UserId OPTIONAL,
  eventData                  [3] IMPLICIT UpdateDeviceEventData,
  additionalInternalData     [4] IMPLICIT OCTET STRING OPTIONAL,
  serialNumber               OCTET STRING (SIZE (32)),
  signatureAlgorithm         AlgorithmIdentifier,
  signatureCounter           INTEGER,
  signatureCreationTime      Time,
  signatureValue             OCTET STRING
}

UpdateDeviceEventData ::= SEQUENCE {
    deviceInformationBeforeUpdate  DeviceInformationSet
}</systemLogMessage>
    </asn1Structure>
    <structure>
      <field>
        <name>version</name>
        <type>INTEGER (3)</type>
        <required>true</required>
        <defaultValue>3</defaultValue>
        <description>Version of the log message format. SHALL be set to '3'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>certifiedDataType</name>
        <type>OBJECT IDENTIFIER</type>
        <required>true</required>
        <defaultValue>id-SE-API-system-log</defaultValue>
        <description>MUST be set to the OID id-SE-API-system-log.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventType</name>
        <type>PrintableString</type>
        <tag>[0] IMPLICIT</tag>
        <required>true</required>
        <defaultValue>updateDevice</defaultValue>
        <description>MUST be set to 'updateDevice'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventOrigin</name>
        <type>PrintableString</type>
        <tag>[1] IMPLICIT</tag>
        <required>false</required>
        <description>Component that triggered the event (e.g., component name).</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventTriggeredByUser</name>
        <type>UserId</type>
        <tag>[2] IMPLICIT</tag>
        <required>false</required>
        <description>User ID of the user that triggered the event.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventData</name>
        <type>UpdateDeviceEventData</type>
        <tag>[3] IMPLICIT</tag>
        <required>true</required>
        <description>Function-specific event data.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>additionalInternalData</name>
        <type>OCTET STRING</type>
        <tag>[4] IMPLICIT</tag>
        <required>false</required>
        <description>MUST NOT be present. Reserved for future use.</description>
        <note>RFU</note>
        <origin>-</origin>
      </field>
      <field>
        <name>serialNumber</name>
        <type>OCTET STRING (SIZE (32))</type>
        <required>true</required>
        <description>Serial number of the Secure Element consisting of the hash value of the public key of the certificate used to verify system logs.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureAlgorithm</name>
        <type>AlgorithmIdentifier</type>
        <required>true</required>
        <description>Information about the signature creation.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureCounter</name>
        <type>INTEGER</type>
        <required>true</required>
        <description>Current count of signatures created with the log message signing key protected by the Secure Element.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureCreationTime</name>
        <type>Time</type>
        <required>true</required>
        <description>Point in time of the Secure Element when the log message was signed.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureValue</name>
        <type>OCTET STRING</type>
        <required>true</required>
        <description>Result of the signature computation encoded as octet string.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
    </structure>
  </systemLog>
</function>
