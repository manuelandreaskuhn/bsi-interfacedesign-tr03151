<?xml version='1.0' encoding='utf-8'?>
<function id="updateTime" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>updateTime</name>
  <category>Zeitverwaltung</category>
  <description>The function updateTime updates the current date/time that is maintained by the Secure Element by using the functionality for time synchronization of the Secure Element.</description>
  <detailedSteps>
    <step>
      <number>1</number>
      <originalText>If the referencing guideline limits the access to the functionality solely to authenticated users, the function SHALL check if the user that has invoked the function has the status authenticated. If the status is not authenticated, the function SHALL raise the exception ErrorUserNotAuthenticated and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf authentifizierte Benutzer beschränkt: Prüfe, ob der aufrufende Benutzer authentifiziert ist. Falls nicht: Werfe ErrorUserNotAuthenticated und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT authentifiziert DANN
  WERFE ErrorUserNotAuthenticated
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthenticated</exception>
        <trigger>Der Benutzer ist nicht authentifiziert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <originalText>If the referencing guideline limits the access to the functionality to certain roles, the function SHALL check in the corresponding role if the (unauthenticated) user is authorized to execute the function. If the user is not authorized, the function SHALL raise the exception ErrorUserNotAuthorized and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf bestimmte Rollen beschränkt: Prüfe in der entsprechenden Rolle, ob der (unauthentifizierte) Benutzer berechtigt ist, die Funktion auszuführen. Falls nicht: Werfe ErrorUserNotAuthorized und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT autorisiert DANN
  WERFE ErrorUserNotAuthorized
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthorized</exception>
        <trigger>Der Benutzer ist nicht berechtigt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <originalText>If the function updateTime is invoked without an input parameter, the function SHALL instruct the Secure Element to use its time synchronization mechanism to update the local time. If the API implementation of the function allows to call the function without parameters even though no time synchronization function is implemented, the function shall raise the exception ErrorUnsupportedTimeSyncVariant and exit the function. If the execution fails for any other reason, the function SHALL raise the exception ErrorUpdateTimeFailed and exit the function.</originalText>
      <germanText>Falls updateTime ohne Input-Parameter aufgerufen wird: Instruiere das Secure Element, seine Zeitsynchronisierungsmechanismus zu verwenden. Falls keine Zeitsynchronisierungsfunktion implementiert: Werfe ErrorUnsupportedTimeSyncVariant. Bei sonstigem Fehler: Werfe ErrorUpdateTimeFailed und beende Funktion.</germanText>
      <pseudocode>WENN updateTime ohne Parameter aufgerufen DANN
  VERSUCHE
    RUFE_AUF Secure-Element-Zeitsynchronisierung
  BEI_FEHLER_UNSUPPORTED
    WERFE ErrorUnsupportedTimeSyncVariant
    BEENDE_FUNKTION
  BEI_FEHLER
    WERFE ErrorUpdateTimeFailed
    BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUnsupportedTimeSyncVariant</exception>
        <trigger>Zeitsynchronisierungsfunktion nicht implementiert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
      <errorCase>
        <exception>ErrorUpdateTimeFailed</exception>
        <trigger>Zeitupdatefunktion fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>4</number>
      <originalText>If the function updateTime is invoked with a value for the input parameter newDateTime, the function SHALL invoke the functionality of the Secure Element to set the time with the provided newDateTime. If the API implementation of the function allows to call the function with parameters even though it does not implement the direct update of the time by passing parameters, the function shall raise the exception ErrorUnsupportedTimeSyncVariant and exit the function. If the execution fails for any other reason, the function SHALL raise the exception ErrorUpdateTimeFailed and exit the function.</originalText>
      <germanText>Falls updateTime mit newDateTime aufgerufen wird: Rufe Secure-Element-Funktionalität auf, um Zeit mit newDateTime zu setzen. Falls direkte Zeit-Updatefunktion nicht implementiert: Werfe ErrorUnsupportedTimeSyncVariant. Bei sonstigem Fehler: Werfe ErrorUpdateTimeFailed und beende Funktion.</germanText>
      <pseudocode>WENN updateTime mit newDateTime Parameter aufgerufen DANN
  VERSUCHE
    RUFE_AUF Secure-Element-Zeitsetzfunktion
    ÜBERGEBE newDateTime
  BEI_FEHLER_UNSUPPORTED
    WERFE ErrorUnsupportedTimeSyncVariant
    BEENDE_FUNKTION
  BEI_FEHLER
    WERFE ErrorUpdateTimeFailed
    BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUnsupportedTimeSyncVariant</exception>
        <trigger>Direkte Zeitupdatefunktion nicht implementiert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
      <errorCase>
        <exception>ErrorUpdateTimeFailed</exception>
        <trigger>Zeitupdatefunktion fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <originalText>The function SHALL invoke the functionality of the Secure Element to create the log message parts to log the time change and to pass the relevant data to the Secure Element. If the execution fails, the function SHALL raise the exception ErrorSigningEventDataFailed and exit the function.</originalText>
      <germanText>Rufe Secure-Element-Funktionalität auf, um Log-Nachricht-Teile für Zeitänderung zu erstellen. Übergebe relevante Daten. Bei Fehler: Werfe ErrorSigningEventDataFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  RUFE_AUF Secure-Element-Funktionalität
  ERSTELLE Log-Nachricht-Teile für Zeitwechsel
  ÜBERGEBE relevante Daten
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Secure-Element-Funktionalität fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <originalText>The function SHALL retrieve the parts of the log message determined by the Secure Element. If the retrieval of the log message parts fails, the function SHALL raise the exception ErrorRetrieveLogMessageFailed and exit the function.</originalText>
      <germanText>Hole die Log-Nachricht-Teile vom Secure Element. Falls Abruf fehlschlägt: Werfe ErrorRetrieveLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  HOLE Log-Nachricht-Teile vom Secure Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>Abruf der Log-Nachricht-Teile fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>7</number>
      <originalText>The function SHALL store the data of the previously retrieved log message parts on the storage medium. If the data has not been stored successfully, the function SHALL raise the exception ErrorStoringLogMessageFailed and exit the function.</originalText>
      <germanText>Speichere die Log-Nachricht-Teile auf dem Speichermedium. Falls Speicherung fehlschlägt: Werfe ErrorStoringLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  SPEICHERE Log-Nachricht-Teile auf Speichermedium
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>Speicherung auf Speichermedium fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>8</number>
      <originalText>The function SHALL return without raising an exception to indicate that the execution of the function updateTime has been successful.</originalText>
      <germanText>Gebe ohne Exception zurück, um erfolgreiche Ausführung anzuzeigen.</germanText>
      <pseudocode>RETURN ohne Exception
BEENDE_ERFOLGREICH</pseudocode>
      <successCase>
        <condition>Ausführung war erfolgreich</condition>
        <action>Funktion kehrt ohne Exception zurück</action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>newDateTime</name>
      <type>ZonedDateTime</type>
      <description>the new date and time to be set.</description>
      <direction>INPUT</direction>
      <required>false</required>
      <note>This parameter is optional. The function has an overloaded version without parameters that uses automatic time synchronization.</note>
    </parameter>
  </parameters>
  <returnValue>
    <type>void</type>
    <description>This function does not return a value.</description>
  </returnValue>
  <exceptions>
    <exception>ErrorCertificateExpired</exception>
    <exception>ErrorDeviceNotInitialized</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorInvalidTime</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
    <exception>ErrorSignatureCounterOverflow</exception>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorUnsupportedTimeSyncVariant</exception>
    <exception>ErrorUpdateTimeFailed</exception>
    <exception>ErrorUserNotAuthenticated</exception>
    <exception>ErrorUserNotAuthorized</exception>
  </exceptions>
  <systemLog>
    <logType>system</logType>
    <requirement>MUST</requirement>
    <asn1Structure>
      <logMessage>LogMessage ::= SEQUENCE {
  version                INTEGER (3),
  certifiedDataType      OBJECT IDENTIFIER (id-SE-API-system-log),
  certifiedData          SystemLogMessage,  -- embedded system log
  serialNumber           OCTET STRING (SIZE (32)),
  signatureAlgorithm     AlgorithmIdentifier,
  seAuditData            OCTET STRING OPTIONAL,
  signatureCounter       INTEGER,
  signatureCreationTime  Time,
  signatureValue         OCTET STRING
}</logMessage>
      <systemLogMessage>SystemLogMessage ::= SEQUENCE {
  version                    INTEGER (3),
  certifiedDataType          OBJECT IDENTIFIER (id-SE-API-system-log),
  eventType                  [0] IMPLICIT PrintableString ("updateTime"),
  eventOrigin                [1] IMPLICIT PrintableString OPTIONAL,
  eventTriggeredByUser       [2] IMPLICIT UserId OPTIONAL,
  eventData                  [3] IMPLICIT UpdateTimeEventData,
  additionalInternalData     [4] IMPLICIT OCTET STRING OPTIONAL,
  serialNumber               OCTET STRING (SIZE (32)),
  signatureAlgorithm         AlgorithmIdentifier,
  signatureCounter           INTEGER,
  signatureCreationTime      Time,
  signatureValue             OCTET STRING
}

UpdateTimeEventData ::= SEQUENCE {
    seTimeBeforeUpdate  Time,
    seTimeAfterUpdate  Time,
    slewSettings  SlewSettings OPTIONAL
}</systemLogMessage>
    </asn1Structure>
    <structure>
      <field>
        <name>version</name>
        <type>INTEGER (3)</type>
        <required>true</required>
        <defaultValue>3</defaultValue>
        <description>Version of the log message format. SHALL be set to '3'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>certifiedDataType</name>
        <type>OBJECT IDENTIFIER</type>
        <required>true</required>
        <defaultValue>id-SE-API-system-log</defaultValue>
        <description>MUST be set to the OID id-SE-API-system-log.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventType</name>
        <type>PrintableString</type>
        <tag>[0] IMPLICIT</tag>
        <required>true</required>
        <defaultValue>updateTime</defaultValue>
        <description>MUST be set to 'updateTime'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventOrigin</name>
        <type>PrintableString</type>
        <tag>[1] IMPLICIT</tag>
        <required>false</required>
        <description>Component that triggered the event (e.g., component name).</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventTriggeredByUser</name>
        <type>UserId</type>
        <tag>[2] IMPLICIT</tag>
        <required>false</required>
        <description>User ID of the user that triggered the event.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventData</name>
        <type>UpdateTimeEventData</type>
        <tag>[3] IMPLICIT</tag>
        <required>true</required>
        <description>Function-specific event data.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>additionalInternalData</name>
        <type>OCTET STRING</type>
        <tag>[4] IMPLICIT</tag>
        <required>false</required>
        <description>MUST NOT be present. Reserved for future use.</description>
        <note>RFU</note>
        <origin>-</origin>
      </field>
      <field>
        <name>serialNumber</name>
        <type>OCTET STRING (SIZE (32))</type>
        <required>true</required>
        <description>Serial number of the Secure Element consisting of the hash value of the public key of the certificate used to verify system logs.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureAlgorithm</name>
        <type>AlgorithmIdentifier</type>
        <required>true</required>
        <description>Information about the signature creation.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureCounter</name>
        <type>INTEGER</type>
        <required>true</required>
        <description>Current count of signatures created with the log message signing key protected by the Secure Element.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureCreationTime</name>
        <type>Time</type>
        <required>true</required>
        <description>Point in time of the Secure Element when the log message was signed.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureValue</name>
        <type>OCTET STRING</type>
        <required>true</required>
        <description>Result of the signature computation encoded as octet string.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
    </structure>
  </systemLog>
</function>
