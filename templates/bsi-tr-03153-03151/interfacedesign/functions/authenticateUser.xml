<?xml version='1.0' encoding='utf-8'?>
<function xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="authenticateUser" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>authenticateUser</name>
  <category>Authentifizierung</category>
  <description>
    <text xml:lang="en">Enables an authorized user or application to authenticate to the SE API for the usage of restricted SE API functions.</text>
    <text xml:lang="de">Ermöglicht einem autorisierten Benutzer oder einer Anwendung, sich gegenüber der SE API zu authentifizieren, um auf eingeschränkte SE API-Funktionen zuzugreifen.</text>
  </description>
  <detailedSteps>
    <step>
      <number>1</number>
      <description>
        <text xml:lang="en">The function SHALL check if the value for the passed userId is managed by the device. If the passed userId is not managed by the device, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "unkownUserId". Afterwards the function SHALL raise the exception ErrorUnknownUserId and exit the function.</text>
        <text xml:lang="de">Prüft, ob userId bekannt. Falls nicht: Log, authenticationResult = "unknownUserId", Exception ErrorUnknownUserId, Ende.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">IF userId NOT managed THEN
  LOG failed_attempt
  SET authenticationResult = "unknownUserId"
  RAISE ErrorUnknownUserId
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">WENN userId NICHT verwaltet DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "unknownUserId"
  WERFE ErrorUnknownUserId
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorUnknownUserId</exception>
        <trigger>
          <text xml:lang="en">The passed userId is not managed by the device</text>
          <text xml:lang="de">Die übergebene userId wird nicht vom Gerät verwaltet</text>
        </trigger>
        <action>
          <text xml:lang="en">Log the failed authentication attempt and exit the function</text>
          <text xml:lang="de">Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <description>
        <text xml:lang="en">The function SHALL check for the userId if the corresponding PIN retry counter has a value greater than 0. The PIN retry counter SHALL represent the number of remaining attempts for entering a wrong PIN. If the value is not greater than 0, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "pinBlocked". Afterwards the function SHALL raise the exception ErrorPinBlocked and exit the function.</text>
        <text xml:lang="de">Prüft, ob PIN-Versuche &gt; 0. Falls nicht: Log, authenticationResult = "pinBlocked", Exception ErrorPinBlocked, Ende.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">IF PIN_Retry_Counter &lt;= 0 THEN
  LOG failed_attempt
  SET authenticationResult = "pinBlocked"
  RAISE ErrorPinBlocked
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">WENN PIN_Retry_Counter &lt;= 0 DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "pinBlocked"
  WERFE ErrorPinBlocked
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorPinBlocked</exception>
        <trigger>
          <text xml:lang="en">PIN retry counter is not greater than 0 (PIN blocked)</text>
          <text xml:lang="de">PIN-Retry-Counter ist nicht größer als 0 (PIN gesperrt)</text>
        </trigger>
        <action>
          <text xml:lang="en">Log the failed authentication attempt and exit the function</text>
          <text xml:lang="de">Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <description>
        <text xml:lang="en">If the PIN retry counter is greater than 0, the function SHALL decrement the value of the PIN retry counter.</text>
        <text xml:lang="de">Wenn PIN-Versuche &gt; 0: Zähler minus 1.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">IF PIN_Retry_Counter &gt; 0 THEN
  PIN_Retry_Counter = PIN_Retry_Counter - 1
END</text>
        <text xml:lang="de">WENN PIN_Retry_Counter &gt; 0 DANN
  PIN_Retry_Counter = PIN_Retry_Counter - 1
ENDE</text>
      </pseudocode>
    </step>
    <step>
      <number>4</number>
      <description>
        <text xml:lang="en">The function SHALL check the passed PIN. If the PIN is not correct, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "incorrectPin". Afterwards the function SHALL raise the exception ErrorIncorrectPin and exit the function. The function SHOULD provide additional information on the PIN retry counter value alongside the exception.</text>
        <text xml:lang="de">Prüft PIN. Falls falsch: Log, authenticationResult = "incorrectPin", Exception ErrorIncorrectPin (mit Zähler), Ende.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">IF PIN NOT correct THEN
  LOG failed_attempt
  SET authenticationResult = "incorrectPin"
  RAISE ErrorIncorrectPin (with PIN_Retry_Counter_Info)
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">WENN PIN NICHT korrekt DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "incorrectPin"
  WERFE ErrorIncorrectPin (mit PIN_Retry_Counter_Info)
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorIncorrectPin</exception>
        <trigger>
          <text xml:lang="en">The passed PIN is not correct</text>
          <text xml:lang="de">Die übergebene PIN ist nicht korrekt</text>
        </trigger>
        <action>
          <text xml:lang="en">Log the failed authentication attempt and exit the function</text>
          <text xml:lang="de">Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <description>
        <text xml:lang="en">If the PIN is correct, the function SHALL check if another user (a user with a different userId than the one attempting to authenticate themselves) currently has the status "authenticated". If another user has the status "authenticated", the function SHALL perform an automatic log out as described in chapter 3.2.2.2 before continuing the execution of authenticateUser. If an exception is raised during the creation of the log message for the automatic log out, the function authenticateUser SHALL raise that exception as well and exit the function.</text>
        <text xml:lang="de">Ist PIN korrekt und anderer Nutzer angemeldet: Automatischer Logout, Fehler weitergeben.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">IF PIN correct AND other_user_authenticated THEN
  TRY
    EXECUTE automatic_logout
  ON_EXCEPTION e
    RAISE e
    EXIT_FUNCTION
  END
END</text>
        <text xml:lang="de">WENN PIN korrekt UND anderer_Benutzer_authentifiziert DANN
  VERSUCHE
    FÜHRE_AUS automatischer_Logout
  BEI_EXCEPTION e
    WERFE e
    BEENDE_FUNKTION
  ENDE
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>Verschiedene (abhängig vom Log-out)</exception>
        <trigger>
          <text xml:lang="en">Exception during automatic logout of another user</text>
          <text xml:lang="de">Exception während automatischem Log-out eines anderen Benutzers</text>
        </trigger>
        <action>
          <text xml:lang="en">Forward the exception and exit the function</text>
          <text xml:lang="de">Exception weiterreichen und Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <description>
        <text xml:lang="en">The function SHALL set the authentication status for the userId to "authenticated". Additionally, the function SHALL set the value for the PIN retry counter to the defined maximum value for retries.</text>
        <text xml:lang="de">Setzt Status auf "authenticated" und PIN-Versuche auf Maximum.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">SET Authentication_Status[userId] = "authenticated"
SET PIN_Retry_Counter = MAX_RETRIES</text>
        <text xml:lang="de">SETZE Authentifizierungsstatus[userId] = "authenticated"
SETZE PIN_Retry_Counter = MAX_RETRIES</text>
      </pseudocode>
    </step>
    <step>
      <number>7</number>
      <standardStep number="5">
        <shortCommand xml:lang="de">SE-Funktionalität Log-Erstellung</shortCommand>
        <shortCommand xml:lang="en">SE Log Message Creation</shortCommand>
      </standardStep>
      <description>
        <text xml:lang="en">The function SHALL invoke the functionality of the Secure Element to determine the log message parts for the event data of the successful authentication attempt. The element authenticationResult SHALL be set to the value "success". If the execution of this Secure Element functionality fails, the function authenticateUser SHALL raise the exception ErrorSigningEventDataFailed and exit the function.</text>
        <text xml:lang="de">Erstellt Log für erfolgreiche Anmeldung, authenticationResult = "success". Bei Fehler: Exception ErrorSigningEventDataFailed.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">SET authenticationResult = "success"
TRY
  CALL Secure_Element.determine_Log_Message()
ON_ERROR
  RAISE ErrorSigningEventDataFailed
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">SETZE authenticationResult = "success"
VERSUCHE
  RUFE_AUF Secure_Element.ermittle_Log_Nachricht()
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>
          <text xml:lang="en">Execution of Secure Element functionality failed</text>
          <text xml:lang="de">Ausführung der Secure-Element-Funktionalität fehlgeschlagen</text>
        </trigger>
        <action>
          <text xml:lang="en">Exit the function</text>
          <text xml:lang="de">Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>8</number>
      <standardStep number="6">
        <shortCommand xml:lang="de">Log-Nachricht-Teile abrufen</shortCommand>
        <shortCommand xml:lang="en">Retrieve Log Message Parts</shortCommand>
      </standardStep>
      <description>
        <text xml:lang="en">The function SHALL retrieve the parts of the log message determined by the Secure Element. If the retrieval of the log message parts fails, the function SHALL raise the exception ErrorRetrieveLogMessageFailed and exit the function.</text>
        <text xml:lang="de">Holt Log-Teile vom Secure Element. Bei Fehler: Exception ErrorRetrieveLogMessageFailed.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">TRY
  log_parts = GET Log_Message_Parts_from_Secure_Element
ON_ERROR
  RAISE ErrorRetrieveLogMessageFailed
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">VERSUCHE
  log_teile = HOLE Log_Nachricht_Teile_von_Secure_Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>
          <text xml:lang="en">Retrieval of log message parts from Secure Element failed</text>
          <text xml:lang="de">Abruf der Log-Nachricht-Teile vom Secure Element fehlgeschlagen</text>
        </trigger>
        <action>
          <text xml:lang="en">Exit the function</text>
          <text xml:lang="de">Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>9</number>
      <standardStep number="7">
        <shortCommand xml:lang="de">Log-Nachricht-Teile speichern</shortCommand>
        <shortCommand xml:lang="en">Store Log Message Parts</shortCommand>
      </standardStep>
      <description>
        <text xml:lang="en">The function SHALL store the data of the previously retrieved log message parts on the storage medium. If the data has not been stored successfully, the function SHALL raise the exception ErrorStoringLogMessageFailed and exit the function.</text>
        <text xml:lang="de">Speichert Log-Teile. Bei Fehler: Exception ErrorStoringLogMessageFailed.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">TRY
  STORE log_parts on storage medium
ON_ERROR
  RAISE ErrorStoringLogMessageFailed
  EXIT_FUNCTION
END</text>
        <text xml:lang="de">VERSUCHE
  SPEICHERE log_teile auf Speichermedium
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</text>
      </pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>
          <text xml:lang="en">Data was not stored successfully</text>
          <text xml:lang="de">Daten wurden nicht erfolgreich gespeichert</text>
        </trigger>
        <action>
          <text xml:lang="en">Exit the function</text>
          <text xml:lang="de">Funktion beenden</text>
        </action>
      </errorCase>
    </step>
    <step>
      <number>10</number>
      <standardStep number="9">
        <shortCommand xml:lang="de">Erfolgreiche Rückgabe</shortCommand>
        <shortCommand xml:lang="en">Successful Return</shortCommand>
      </standardStep>
      <description>
        <text xml:lang="en">The function SHALL return without raising an exception to indicate that the execution of the function has been successful.</text>
        <text xml:lang="de">Gibt ohne Exception zurück, wenn erfolgreich.</text>
      </description>
      <pseudocode>
        <text xml:lang="en">RETURN successfully
END_SUCCESSFULLY</text>
        <text xml:lang="de">GEBE_ZURÜCK erfolgreich
BEENDE_ERFOLGREICH</text>
      </pseudocode>
      <successCase>
        <condition>
          <text xml:lang="en">Authentication was successful</text>
          <text xml:lang="de">Authentifizierung war erfolgreich</text>
        </condition>
        <action>
          <text xml:lang="en">Function returns without exception</text>
          <text xml:lang="de">Funktion kehrt ohne Exception zurück</text>
        </action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>userId</name>
      <type>String</type>
      <description>
        <text xml:lang="en">the ID of the user who or application that wants to be authenticated.</text>
        <text xml:lang="de">Die Kennung des Benutzers oder der Anwendung, die sich authentifizieren möchte.</text>
      </description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
    <parameter>
      <name>pin</name>
      <type>byte[]</type>
      <description>
        <text xml:lang="en">the PIN for the authentication.</text>
        <text xml:lang="de">Die PIN zur Authentifizierung.</text>
      </description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
  </parameters>
  <returnValue>
    <type>void</type>
    <description>
      <text xml:lang="en">This function does not return a value.</text>
      <text xml:lang="de">Diese Funktion gibt keinen Wert zurück.</text>
    </description>
  </returnValue>
  <exceptions>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorIncorrectPin</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorParameterTooLong</exception>
    <exception>ErrorPinBlocked</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorSignatureCounterOverflow</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorUnknownUserId</exception>
  </exceptions>
  <systemLog>
    <logType>system</logType>
    <requirement>MUST</requirement>
    <asn1Structure>
      <logMessage>LogMessage ::= SEQUENCE {
  version                INTEGER (3),
  certifiedDataType      OBJECT IDENTIFIER (id-SE-API-system-log),
  certifiedData          SystemLogMessage,  -- embedded system log
  serialNumber           OCTET STRING (SIZE (32)),
  signatureAlgorithm     AlgorithmIdentifier,
  seAuditData            OCTET STRING OPTIONAL,
  signatureCounter       INTEGER,
  signatureCreationTime  Time,
  signatureValue         OCTET STRING
}</logMessage>
      <systemLogMessage>SystemLogMessage ::= SEQUENCE {
  version                    INTEGER (3),
  certifiedDataType          OBJECT IDENTIFIER (id-SE-API-system-log),
  eventType                  [0] IMPLICIT PrintableString ("authenticateUser"),
  eventOrigin                [1] IMPLICIT PrintableString OPTIONAL,
  eventTriggeredByUser       [2] IMPLICIT UserId OPTIONAL,
  eventData                  [3] IMPLICIT AuthenticateUserEventData,
  additionalInternalData     [4] IMPLICIT OCTET STRING OPTIONAL,
  serialNumber               OCTET STRING (SIZE (32)),
  signatureAlgorithm         AlgorithmIdentifier,
  signatureCounter           INTEGER,
  signatureCreationTime      Time,
  signatureValue             OCTET STRING
}

AuthenticateUserEventData ::= SEQUENCE {
    userId  PrintableString,
    role  Role,
    authenticationResult  PinAuthenticationResult,
    remainingRetries  INTEGER
}</systemLogMessage>
    </asn1Structure>
    <structure>
      <field>
        <name>version</name>
        <type>INTEGER (3)</type>
        <required>true</required>
        <defaultValue>3</defaultValue>
        <description>
          <text xml:lang="en">Version of the log message format. SHALL be set to '3'.</text>
          <text xml:lang="de">Version des Protokollnachrichtenformats. Muss auf "3" gesetzt werden.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>certifiedDataType</name>
        <type>OBJECT IDENTIFIER</type>
        <required>true</required>
        <defaultValue>id-SE-API-system-log</defaultValue>
        <description>
          <text xml:lang="en">MUST be set to the OID id-SE-API-system-log.</text>
          <text xml:lang="de">Muss auf die OID id-SE-API-system-log gesetzt werden.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventType</name>
        <type>PrintableString</type>
        <tag>[0] IMPLICIT</tag>
        <required>true</required>
        <defaultValue>authenticateUser</defaultValue>
        <description>
          <text xml:lang="en">MUST be set to 'authenticateUser'.</text>
          <text xml:lang="de">Muss auf "authenticateUser" gesetzt werden.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventOrigin</name>
        <type>PrintableString</type>
        <tag>[1] IMPLICIT</tag>
        <required>false</required>
        <description>
          <text xml:lang="en">Component that triggered the event (e.g., component name).</text>
          <text xml:lang="de">Komponente, die das Ereignis ausgelöst hat (z.B. Komponentenname).</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventTriggeredByUser</name>
        <type>UserId</type>
        <tag>[2] IMPLICIT</tag>
        <required>false</required>
        <description>
          <text xml:lang="en">User ID of the user that triggered the event.</text>
          <text xml:lang="de">Benutzer-ID des Benutzers, der das Ereignis ausgelöst hat.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventData</name>
        <type>AuthenticateUserEventData</type>
        <tag>[3] IMPLICIT</tag>
        <required>true</required>
        <description>
          <text xml:lang="en">Function-specific event data.</text>
          <text xml:lang="de">Funktionsspezifische Ereignisdaten.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>additionalInternalData</name>
        <type>OCTET STRING</type>
        <tag>[4] IMPLICIT</tag>
        <required>false</required>
        <description>
          <text xml:lang="en">MUST NOT be present. Reserved for future use.</text>
          <text xml:lang="de">Darf nicht vorhanden sein. Für zukünftige Verwendung reserviert.</text>
        </description>
        <note>RFU</note>
        <origin>-</origin>
      </field>
      <field>
        <name>serialNumber</name>
        <type>OCTET STRING (SIZE (32))</type>
        <required>true</required>
        <description>
          <text xml:lang="en">Serial number of the Secure Element consisting of the hash value of the public key of the certificate used to verify system logs.</text>
          <text xml:lang="de">Seriennummer des Secure Element bestehend aus dem Hash-Wert des öffentlichen Schlüssels des Zertifikats zur Überprüfung von Systemprotokollen.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureAlgorithm</name>
        <type>AlgorithmIdentifier</type>
        <required>true</required>
        <description>
          <text xml:lang="en">Information about the signature creation.</text>
          <text xml:lang="de">Informationen zur Signaturerstellung.</text>
        </description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureCounter</name>
        <type>INTEGER</type>
        <required>true</required>
        <description>
          <text xml:lang="en">Current count of signatures created with the log message signing key protected by the Secure Element.</text>
          <text xml:lang="de">Aktuelle Anzahl der mit dem durch das Secure Element geschützten Protokollnachricht-Signaturschlüssel erstellten Signaturen.</text>
        </description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureCreationTime</name>
        <type>Time</type>
        <required>true</required>
        <description>
          <text xml:lang="en">Point in time of the Secure Element when the log message was signed.</text>
          <text xml:lang="de">Zeitpunkt des Secure Element, zu dem die Protokollnachricht signiert wurde.</text>
        </description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureValue</name>
        <type>OCTET STRING</type>
        <required>true</required>
        <description>
          <text xml:lang="en">Result of the signature computation encoded as octet string.</text>
          <text xml:lang="de">Ergebnis der Signaturberechnung kodiert als Oktettstring.</text>
        </description>
        <origin>Provided by the Secure Element</origin>
      </field>
    </structure>
  </systemLog>
</function>
