<?xml version='1.0' encoding='utf-8'?>
<function id="authenticateUser" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>authenticateUser</name>
  <category>Authentifizierung</category>
  <description>Enables an authorized user or application to authenticate to the SE API for the usage of restricted SE API functions.</description>
  <detailedSteps>
    <step>
      <number>1</number>
      <originalText>The function SHALL check if the value for the passed userId is managed by the device. If the passed userId is not managed by the device, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "unkownUserId". Afterwards the function SHALL raise the exception ErrorUnknownUserId and exit the function.</originalText>
      <germanText>Prüft, ob userId bekannt. Falls nicht: Log, authenticationResult = "unknownUserId", Exception ErrorUnknownUserId, Ende.</germanText>
      <pseudocode>WENN userId NICHT verwaltet DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "unknownUserId"
  WERFE ErrorUnknownUserId
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUnknownUserId</exception>
        <trigger>Die übergebene userId wird nicht vom Gerät verwaltet</trigger>
        <action>Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <originalText>The function SHALL check for the userId if the corresponding PIN retry counter has a value greater than 0. The PIN retry counter SHALL represent the number of remaining attempts for entering a wrong PIN. If the value is not greater than 0, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "pinBlocked". Afterwards the function SHALL raise the exception ErrorPinBlocked and exit the function.</originalText>
      <germanText>Prüft, ob PIN-Versuche &gt; 0. Falls nicht: Log, authenticationResult = "pinBlocked", Exception ErrorPinBlocked, Ende.</germanText>
      <pseudocode>WENN PIN_Retry_Counter &lt;= 0 DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "pinBlocked"
  WERFE ErrorPinBlocked
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorPinBlocked</exception>
        <trigger>PIN-Retry-Counter ist nicht größer als 0 (PIN gesperrt)</trigger>
        <action>Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <originalText>If the PIN retry counter is greater than 0, the function SHALL decrement the value of the PIN retry counter.</originalText>
      <germanText>Wenn PIN-Versuche &gt; 0: Zähler minus 1.</germanText>
      <pseudocode>WENN PIN_Retry_Counter &gt; 0 DANN
  PIN_Retry_Counter = PIN_Retry_Counter - 1
ENDE</pseudocode>
    </step>
    <step>
      <number>4</number>
      <originalText>The function SHALL check the passed PIN. If the PIN is not correct, the function SHALL perform the tasks defined in chapter 3.2.3.5.1 to log the failed authentication attempt. The element authenticationResult SHALL be set to the value "incorrectPin". Afterwards the function SHALL raise the exception ErrorIncorrectPin and exit the function. The function SHOULD provide additional information on the PIN retry counter value alongside the exception.</originalText>
      <germanText>Prüft PIN. Falls falsch: Log, authenticationResult = "incorrectPin", Exception ErrorIncorrectPin (mit Zähler), Ende.</germanText>
      <pseudocode>WENN PIN NICHT korrekt DANN
  LOGGE fehlgeschlagenen_Versuch
  SETZE authenticationResult = "incorrectPin"
  WERFE ErrorIncorrectPin (mit PIN_Retry_Counter_Info)
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorIncorrectPin</exception>
        <trigger>Die übergebene PIN ist nicht korrekt</trigger>
        <action>Fehlgeschlagenen Authentifizierungsversuch loggen und Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <originalText>If the PIN is correct, the function SHALL check if another user (a user with a different userId than the one attempting to authenticate themselves) currently has the status "authenticated". If another user has the status "authenticated", the function SHALL perform an automatic log out as described in chapter 3.2.2.2 before continuing the execution of authenticateUser. If an exception is raised during the creation of the log message for the automatic log out, the function authenticateUser SHALL raise that exception as well and exit the function.</originalText>
      <germanText>Ist PIN korrekt und anderer Nutzer angemeldet: Automatischer Logout, Fehler weitergeben.</germanText>
      <pseudocode>WENN PIN korrekt UND anderer_Benutzer_authentifiziert DANN
  VERSUCHE
    FÜHRE_AUS automatischer_Logout
  BEI_EXCEPTION e
    WERFE e
    BEENDE_FUNKTION
  ENDE
ENDE</pseudocode>
      <errorCase>
        <exception>Verschiedene (abhängig vom Log-out)</exception>
        <trigger>Exception während automatischem Log-out eines anderen Benutzers</trigger>
        <action>Exception weiterreichen und Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <originalText>The function SHALL set the authentication status for the userId to "authenticated". Additionally, the function SHALL set the value for the PIN retry counter to the defined maximum value for retries.</originalText>
      <germanText>Setzt Status auf "authenticated" und PIN-Versuche auf Maximum.</germanText>
      <pseudocode>SETZE Authentifizierungsstatus[userId] = "authenticated"
SETZE PIN_Retry_Counter = MAX_RETRIES</pseudocode>
    </step>
    <step>
      <number>7</number>
      <originalText>The function SHALL invoke the functionality of the Secure Element to determine the log message parts for the event data of the successful authentication attempt. The element authenticationResult SHALL be set to the value "success". If the execution of this Secure Element functionality fails, the function authenticateUser SHALL raise the exception ErrorSigningEventDataFailed and exit the function.</originalText>
      <germanText>Erstellt Log für erfolgreiche Anmeldung, authenticationResult = "success". Bei Fehler: Exception ErrorSigningEventDataFailed.</germanText>
      <pseudocode>SETZE authenticationResult = "success"
VERSUCHE
  RUFE_AUF Secure_Element.ermittle_Log_Nachricht()
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Ausführung der Secure-Element-Funktionalität fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>8</number>
      <originalText>The function SHALL retrieve the parts of the log message determined by the Secure Element. If the retrieval of the log message parts fails, the function SHALL raise the exception ErrorRetrieveLogMessageFailed and exit the function.</originalText>
      <germanText>Holt Log-Teile vom Secure Element. Bei Fehler: Exception ErrorRetrieveLogMessageFailed.</germanText>
      <pseudocode>VERSUCHE
  log_teile = HOLE Log_Nachricht_Teile_von_Secure_Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>Abruf der Log-Nachricht-Teile vom Secure Element fehlgeschlagen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>9</number>
      <originalText>The function SHALL store the data of the previously retrieved log message parts on the storage medium. If the data has not been stored successfully, the function SHALL raise the exception ErrorStoringLogMessageFailed and exit the function.</originalText>
      <germanText>Speichert Log-Teile. Bei Fehler: Exception ErrorStoringLogMessageFailed.</germanText>
      <pseudocode>VERSUCHE
  SPEICHERE log_teile auf Speichermedium
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>Daten wurden nicht erfolgreich gespeichert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>10</number>
      <originalText>The function SHALL return without raising an exception to indicate that the execution of the function has been successful.</originalText>
      <germanText>Gibt ohne Exception zurück, wenn erfolgreich.</germanText>
      <pseudocode>// Erfolgreicher Abschluss
GEBE_ZURÜCK erfolgreich
BEENDE_ERFOLGREICH</pseudocode>
      <successCase>
        <condition>Authentifizierung war erfolgreich</condition>
        <action>Funktion kehrt ohne Exception zurück</action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>userId</name>
      <type>String</type>
      <description>the ID of the user who or application that wants to be authenticated.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
    <parameter>
      <name>pin</name>
      <type>byte[]</type>
      <description>the PIN for the authentication.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
  </parameters>
  <returnValue>
    <type>void</type>
    <description>This function does not return a value.</description>
  </returnValue>
  <exceptions>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorIncorrectPin</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorParameterTooLong</exception>
    <exception>ErrorPinBlocked</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
    <exception>ErrorSignatureCounterOverflow</exception>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorUnknownUserId</exception>
  </exceptions>
  <systemLog>
    <logType>system</logType>
    <requirement>MUST</requirement>
    <asn1Structure>
      <logMessage>LogMessage ::= SEQUENCE {
  version                INTEGER (3),
  certifiedDataType      OBJECT IDENTIFIER (id-SE-API-system-log),
  certifiedData          SystemLogMessage,  -- embedded system log
  serialNumber           OCTET STRING (SIZE (32)),
  signatureAlgorithm     AlgorithmIdentifier,
  seAuditData            OCTET STRING OPTIONAL,
  signatureCounter       INTEGER,
  signatureCreationTime  Time,
  signatureValue         OCTET STRING
}</logMessage>
      <systemLogMessage>SystemLogMessage ::= SEQUENCE {
  version                    INTEGER (3),
  certifiedDataType          OBJECT IDENTIFIER (id-SE-API-system-log),
  eventType                  [0] IMPLICIT PrintableString ("authenticateUser"),
  eventOrigin                [1] IMPLICIT PrintableString OPTIONAL,
  eventTriggeredByUser       [2] IMPLICIT UserId OPTIONAL,
  eventData                  [3] IMPLICIT AuthenticateUserEventData,
  additionalInternalData     [4] IMPLICIT OCTET STRING OPTIONAL,
  serialNumber               OCTET STRING (SIZE (32)),
  signatureAlgorithm         AlgorithmIdentifier,
  signatureCounter           INTEGER,
  signatureCreationTime      Time,
  signatureValue             OCTET STRING
}

AuthenticateUserEventData ::= SEQUENCE {
    userId  PrintableString,
    role  Role,
    authenticationResult  PinAuthenticationResult,
    remainingRetries  INTEGER
}</systemLogMessage>
    </asn1Structure>
    <structure>
      <field>
        <name>version</name>
        <type>INTEGER (3)</type>
        <required>true</required>
        <defaultValue>3</defaultValue>
        <description>Version of the log message format. SHALL be set to '3'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>certifiedDataType</name>
        <type>OBJECT IDENTIFIER</type>
        <required>true</required>
        <defaultValue>id-SE-API-system-log</defaultValue>
        <description>MUST be set to the OID id-SE-API-system-log.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventType</name>
        <type>PrintableString</type>
        <tag>[0] IMPLICIT</tag>
        <required>true</required>
        <defaultValue>authenticateUser</defaultValue>
        <description>MUST be set to 'authenticateUser'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventOrigin</name>
        <type>PrintableString</type>
        <tag>[1] IMPLICIT</tag>
        <required>false</required>
        <description>Component that triggered the event (e.g., component name).</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventTriggeredByUser</name>
        <type>UserId</type>
        <tag>[2] IMPLICIT</tag>
        <required>false</required>
        <description>User ID of the user that triggered the event.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>eventData</name>
        <type>AuthenticateUserEventData</type>
        <tag>[3] IMPLICIT</tag>
        <required>true</required>
        <description>Function-specific event data.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>additionalInternalData</name>
        <type>OCTET STRING</type>
        <tag>[4] IMPLICIT</tag>
        <required>false</required>
        <description>MUST NOT be present. Reserved for future use.</description>
        <note>RFU</note>
        <origin>-</origin>
      </field>
      <field>
        <name>serialNumber</name>
        <type>OCTET STRING (SIZE (32))</type>
        <required>true</required>
        <description>Serial number of the Secure Element consisting of the hash value of the public key of the certificate used to verify system logs.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureAlgorithm</name>
        <type>AlgorithmIdentifier</type>
        <required>true</required>
        <description>Information about the signature creation.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureCounter</name>
        <type>INTEGER</type>
        <required>true</required>
        <description>Current count of signatures created with the log message signing key protected by the Secure Element.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureCreationTime</name>
        <type>Time</type>
        <required>true</required>
        <description>Point in time of the Secure Element when the log message was signed.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureValue</name>
        <type>OCTET STRING</type>
        <required>true</required>
        <description>Result of the signature computation encoded as octet string.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
    </structure>
  </systemLog>
</function>
