<?xml version='1.0' encoding='utf-8'?>
<function xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="updateTransaction" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>updateTransaction</name>
  <category>Client- und Transaktionsverwaltung</category>
  <description>This function updates an existing transaction. In case the device supports unsigned updates, further control of the creation of signed and unsigned updates is possible.</description>
  <detailedSteps>
    <step>
      <number>1</number>
      <originalText>If the referencing guideline limits the access to the functionality solely to authenticated users, the function SHALL check if the user that has invoked the function has the status authenticated. If the status is not authenticated, the function SHALL raise the exception ErrorUserNotAuthenticated and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf authentifizierte Benutzer beschränkt: Prüfe, ob der aufrufende Benutzer authentifiziert ist. Falls nicht: Werfe ErrorUserNotAuthenticated und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT authentifiziert DANN
  WERFE ErrorUserNotAuthenticated
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthenticated</exception>
        <trigger>Der Benutzer ist nicht authentifiziert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <originalText>If the referencing guideline limits the access to the functionality to certain roles, the function SHALL check in the corresponding role if the (unauthenticated) user is authorized to execute the function. If the user is not authorized, the function SHALL raise the exception ErrorUserNotAuthorized and exit the function.</originalText>
      <germanText>Falls die Richtlinie den Zugriff auf bestimmte Rollen beschränkt: Prüfe in der entsprechenden Rolle, ob der (unauthentifizierte) Benutzer berechtigt ist, die Funktion auszuführen. Falls nicht: Werfe ErrorUserNotAuthorized und beende Funktion.</germanText>
      <pseudocode>WENN Benutzer NICHT autorisiert DANN
  WERFE ErrorUserNotAuthorized
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthorized</exception>
        <trigger>Der Benutzer ist nicht berechtigt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <originalText>If the current time in the SE is not set, the function SHALL raise the exception ErrorTimeNotSet and exit the function.</originalText>
      <germanText>Falls die aktuelle Zeit im SE nicht gesetzt ist: Werfe ErrorTimeNotSet und beende Funktion.</germanText>
      <pseudocode>WENN Aktuelle Zeit im SE NICHT gesetzt DANN
  WERFE ErrorTimeNotSet
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorTimeNotSet</exception>
        <trigger>Die aktuelle Zeit im SE ist nicht gesetzt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>4</number>
      <originalText>If the function lockTransactionLogging is implemented, the function SHALL check if transaction logging is currently locked. If transaction logging is locked, the function SHALL raise the exception ErrorTransactionLoggingLocked and exit the function.</originalText>
      <germanText>Falls lockTransactionLogging implementiert ist: Prüfe, ob Transaktionsprotokollierung gesperrt ist. Falls ja: Werfe ErrorTransactionLoggingLocked und beende Funktion.</germanText>
      <pseudocode>WENN Transaktionsprotokollierung gesperrt DANN
  WERFE ErrorTransactionLoggingLocked
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorTransactionLoggingLocked</exception>
        <trigger>Die Transaktionsprotokollierung ist gesperrt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <originalText>If the function registerClient is not implemented, the function SHALL check if the passed clientId consists only of valid characters. If the passed clientId contains invalid characters, the function SHALL raise the exception ErrorInvalidClientIdCharacter and exit the function.</originalText>
      <germanText>Falls registerClient nicht implementiert ist: Prüfe, ob übergebene ClientID nur gültige Zeichen enthält. Falls ungültige Zeichen: Werfe ErrorInvalidClientIdCharacter und beende Funktion.</germanText>
      <pseudocode>WENN ClientID ungültige Zeichen DANN
  WERFE ErrorInvalidClientIdCharacter
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorInvalidClientIdCharacter</exception>
        <trigger>Die übergebene ClientID enthält ungültige Zeichen</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <originalText>If the function registerClient is implemented, the function SHALL check if the ID passed as parameter clientId is registered using the function registerClient. If the ID is not registered, the function SHALL raise the exception ErrorClientNotRegistered and exit the function.</originalText>
      <germanText>Falls registerClient implementiert ist: Prüfe, ob übergebene ClientID registriert ist. Falls nicht: Werfe ErrorClientNotRegistered und beende Funktion.</germanText>
      <pseudocode>WENN ClientID NICHT registriert DANN
  WERFE ErrorClientNotRegistered
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorClientNotRegistered</exception>
        <trigger>Die ClientID ist nicht registriert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>7</number>
      <originalText>The Secure Element SHALL check whether the transactionNumber belongs to an open transaction. If this is not the case, the function SHALL raise the exception ErrorTransactionNumberNotFound and exit the function.</originalText>
      <germanText>Prüfe, ob die Transaktionsnummer zu einer offenen Transaktion gehört. Falls nicht: Werfe ErrorTransactionNumberNotFound und beende Funktion.</germanText>
      <pseudocode>WENN TransactionNumber nicht zu offener Transaktion gehört DANN
  WERFE ErrorTransactionNumberNotFound
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorTransactionNumberNotFound</exception>
        <trigger>Transaktionsnummer gehört nicht zu offener Transaktion</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>8</number>
      <originalText>If the Secure Element consists of multiple logical or physical parts that need to be connected in order to perform the whole function updateTransaction without errors the function shall check that the needed parts are connected. If one or more of the mandatory connections is lost, the function SHALL raise the exception ErrorSecureElementPartsDisconnected and exit the function.</originalText>
      <germanText>Falls SE aus mehreren logischen oder physikalischen Teilen besteht: Prüfe, ob alle nötigen Teile verbunden sind. Falls nicht: Werfe ErrorSecureElementPartsDisconnected und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  PRÜFE ob SE-Teile verbunden sind
BEI_FEHLER
  WERFE ErrorSecureElementPartsDisconnected
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSecureElementPartsDisconnected</exception>
        <trigger>Das SE-Teil ist nicht verbunden</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>9</number>
      <originalText>The function SHALL invoke the functionality of the Secure Element to update a transaction and SHALL pass all data that is to be secured, and not created or determined by Secure Element itself, to the Secure Element. If the execution fails, the function SHALL raise the exception ErrorSigningEventDataFailed and exit the function.</originalText>
      <germanText>Rufe Secure-Element-Funktionalität auf, um Transaktion zu aktualisieren. Übergebe alle zu sichernden Daten. Bei Fehler: Werfe ErrorSigningEventDataFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  RUFE_AUF Secure-Element-Funktionalität
  UPDATE_TRANSAKTION
  ÜBERGEBE processData und processType
BEI_FEHLER
  WERFE ErrorSigningEventDataFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorSigningEventDataFailed</exception>
        <trigger>Die Ausführung schlägt fehl</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>10</number>
      <originalText>The function SHALL retrieve the parts of the log message determined by the Secure Element from it. If the retrieval of the log message parts fails, the function SHALL raise the exception ErrorRetrieveLogMessageFailed and exit the function.</originalText>
      <germanText>Hole die Log-Nachricht-Teile vom Secure Element. Falls der Abruf fehlschlägt: Werfe ErrorRetrieveLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  HOLE Log-Nachricht-Teile vom Secure Element
BEI_FEHLER
  WERFE ErrorRetrieveLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorRetrieveLogMessageFailed</exception>
        <trigger>Der Abruf der Log-Nachricht-Teile schlägt fehl</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>11</number>
      <originalText>The data sent to the Secure Element and the data of the log message parts retrieved from the Secure Element (together forming the log message contents) SHALL be stored. If the data has not been stored successfully, the function SHALL raise the exception ErrorStoringLogMessageFailed and exit the function.</originalText>
      <germanText>Speichere die Daten (von SE und Log-Nachricht-Teile) als Transaktionsloginhalt. Falls Speicherung fehlschlägt: Werfe ErrorStoringLogMessageFailed und beende Funktion.</germanText>
      <pseudocode>VERSUCHE
  SPEICHERE Transaktionsloginhalt
BEI_FEHLER
  WERFE ErrorStoringLogMessageFailed
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorStoringLogMessageFailed</exception>
        <trigger>Die Daten wurden nicht erfolgreich gespeichert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>12</number>
      <originalText>After the data has been stored successfully, the function SHALL return the type of performed protection on the data by performedUpdateProtection with a value of noPrevPassedProtected, the time of the log message creation by firstLogsignatureCreationTime, the signature counter by firstLogsignatureCounter and the signature value by firstLogsignatureValue. Additionally, the function SHALL return without raising an exception to indicate that the execution of the function updateTransaction has been successful.</originalText>
      <germanText>Gebe erfolgreich die Aktualisierungsschutzart, Signaturerstellungszeit, Signaturzähler und Signaturwert zurück. Funktion kehrt ohne Exception zurück.</germanText>
      <pseudocode>GEBE_ZURÜCK (performedUpdateProtection, firstLogsignatureCreationTime, firstLogsignatureCounter, firstLogsignatureValue)
RETURN ohne Exception
BEENDE_ERFOLGREICH</pseudocode>
      <successCase>
        <condition>Speicherung war erfolgreich</condition>
        <action>Funktion kehrt ohne Exception zurück, gibt alle Parameter zurück</action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>clientId</name>
      <type>String</type>
      <description>represents the ID of the application that has invoked the function.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
    <parameter>
      <name>transactionNumber</name>
      <type>long</type>
      <description>parameter is used to unambiguously identify the current transaction.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
    <parameter>
      <name>processData</name>
      <type>byte[]</type>
      <description>represents all the new information regarding the state of the process since the start of the corresponding transaction or its last update.</description>
      <direction>INPUT</direction>
      <required>true</required>
    </parameter>
    <parameter>
      <name>processType</name>
      <type>String</type>
      <description>identifies the type of the transaction as defined by the application. The String representing the processType shall be restricted to a length of 100.</description>
      <direction>INPUT</direction>
      <required>false</required>
      <note>conditional parameter</note>
    </parameter>
    <parameter>
      <name>additionalExternalData</name>
      <type>byte[]</type>
      <description>the application may send additional external data to the device.</description>
      <direction>INPUT</direction>
      <required>false</required>
    </parameter>
    <parameter>
      <name>forceSignature</name>
      <type>boolean</type>
      <description>this parameter is used to force a "signed update", for cases where "signed" and "unsigned updates" are supported.</description>
      <direction>INPUT</direction>
      <required>false</required>
      <note>Only available in overloaded version. If unsigned updates are not supported this parameter shall be ignored.</note>
    </parameter>
  </parameters>
  <returnValue>
    <type>UpdateTransactionResult</type>
    <description>an UpdateTransactionResult containing information about the updated transaction(s), including signature counter and log message data.</description>
  </returnValue>
  <exceptions>
    <exception>ErrorCertificateExpired</exception>
    <exception>ErrorClientNotRegistered</exception>
    <exception>ErrorDeviceNotInitialized</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorInvalidClientIdCharacter</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorParameterTooLong</exception>
    <exception>ErrorRetrieveLogMessageFailed</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorSecureElementPartsDisconnected</exception>
    <exception>ErrorSignatureCounterExhausted</exception>
    <exception>ErrorSignatureCounterOverflow</exception>
    <exception>ErrorSigningEventDataFailed</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorStorageMemoryFull</exception>
    <exception>ErrorStoringLogMessageFailed</exception>
    <exception>ErrorTimeNotSet</exception>
    <exception>ErrorTransactionLoggingLocked</exception>
    <exception>ErrorTransactionNumberNotFound</exception>
    <exception>ErrorUpdateTransactionFailed</exception>
    <exception>ErrorUserNotAuthenticated</exception>
    <exception>ErrorUserNotAuthorized</exception>
  </exceptions>
  <transactionLog>
    <logType>transaction-log</logType>
    <requirement>MUST be logged when updateTransaction function is invoked successfully.</requirement>
    <asn1Structure>
      <logMessage>LogMessage ::= SEQUENCE {
  version                INTEGER (3),
  certifiedDataType      OBJECT IDENTIFIER (id-SE-API-transaction-log),
  certifiedData          TransactionLogMessage,  -- embedded transaction log
  serialNumber           OCTET STRING (SIZE (32)),
  signatureAlgorithm     AlgorithmIdentifier,
  seAuditData            [0] IMPLICIT OCTET STRING OPTIONAL,  -- RFU
  signatureCounter       INTEGER,
  signatureCreationTime  Time,
  signatureValue         OCTET STRING
}</logMessage>
      <transactionLogMessage>TransactionLogMessage ::= SEQUENCE {
  version                    INTEGER (3),
  certifiedDataType          OBJECT IDENTIFIER (id-SE-API-transaction-log),
  operationType              [0] IMPLICIT PrintableString ("updateTransaction"),
  clientId                   [1] IMPLICIT ClientId,
  processData                [2] IMPLICIT OCTET STRING,
  processType                [3] IMPLICIT PrintableString (SIZE (0..100)),
  additionalExternalData     [4] IMPLICIT OCTET STRING OPTIONAL,
  transactionNumber          [5] IMPLICIT INTEGER,
  additionalInternalData     [6] IMPLICIT OCTET STRING OPTIONAL,  -- RFU, MUST NOT be present
  serialNumber               OCTET STRING (SIZE (32)),
  signatureAlgorithm         AlgorithmIdentifier,
  signatureCounter           INTEGER,
  signatureCreationTime      Time,
  signatureValue             OCTET STRING
}</transactionLogMessage>
    </asn1Structure>
    <structure>
      <field>
        <name>version</name>
        <type>INTEGER (3)</type>
        <required>true</required>
        <defaultValue>3</defaultValue>
        <description>Version of the log message format. SHALL be set to '3'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>certifiedDataType</name>
        <type>OBJECT IDENTIFIER</type>
        <required>true</required>
        <defaultValue>id-SE-API-transaction-log</defaultValue>
        <description>MUST be set to the OID id-SE-API-transaction-log.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>operationType</name>
        <type>PrintableString</type>
        <tag>[0] IMPLICIT</tag>
        <required>true</required>
        <defaultValue>updateTransaction</defaultValue>
        <description>MUST be set to 'updateTransaction'.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>clientId</name>
        <type>ClientId</type>
        <tag>[1] IMPLICIT</tag>
        <required>true</required>
        <description>ID of the application that has initiated the logging of a transaction phase.</description>
        <origin>External application</origin>
      </field>
      <field>
        <name>processData</name>
        <type>OCTET STRING</type>
        <tag>[2] IMPLICIT</tag>
        <required>true</required>
        <description>The process data.</description>
        <origin>External application</origin>
      </field>
      <field>
        <name>processType</name>
        <type>PrintableString (SIZE (0..100))</type>
        <tag>[3] IMPLICIT</tag>
        <required>true</required>
        <description>Information about the type of process.</description>
        <origin>External application</origin>
      </field>
      <field>
        <name>additionalExternalData</name>
        <type>OCTET STRING</type>
        <tag>[4] IMPLICIT</tag>
        <required>false</required>
        <description>Additional data encoded as an octet string.</description>
        <origin>External application</origin>
      </field>
      <field>
        <name>transactionNumber</name>
        <type>INTEGER</type>
        <tag>[5] IMPLICIT</tag>
        <required>true</required>
        <description>Transaction number generated by the Secure Element at the start of the transaction.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>additionalInternalData</name>
        <type>OCTET STRING</type>
        <tag>[6] IMPLICIT</tag>
        <required>false</required>
        <description>MUST NOT be present. Reserved for future use.</description>
        <note>RFU</note>
        <origin>-</origin>
      </field>
      <field>
        <name>serialNumber</name>
        <type>OCTET STRING (SIZE (32))</type>
        <required>true</required>
        <description>Serial number of the Secure Element consisting of the hash value of the public key of the certificate used to verify transaction logs.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureAlgorithm</name>
        <type>AlgorithmIdentifier</type>
        <required>true</required>
        <description>Information about the signature creation.</description>
        <origin>Provided by the device</origin>
      </field>
      <field>
        <name>signatureCounter</name>
        <type>INTEGER</type>
        <required>true</required>
        <description>Current count of signatures created with the log message signing key protected by the Secure Element.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureCreationTime</name>
        <type>Time</type>
        <required>true</required>
        <description>Point in time of the Secure Element when the log message was signed.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
      <field>
        <name>signatureValue</name>
        <type>OCTET STRING</type>
        <required>true</required>
        <description>Result of the signature computation encoded as octet string.</description>
        <origin>Provided by the Secure Element</origin>
      </field>
    </structure>
  </transactionLog>
</function>
