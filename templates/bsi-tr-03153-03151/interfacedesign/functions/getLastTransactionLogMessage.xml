<?xml version='1.0' encoding='utf-8'?>
<function id="getLastTransactionLogMessage" xmlns="http://bsi.bund.de/TR03151" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://bsi.bund.de/TR03151 ../../schema/functions.xsd">
  <name>getLastTransactionLogMessage</name>
  <category>Client- und Transaktionsverwaltung</category>
  <description>This function returns the last transaction log message that has been produced and processed by the Secure Element filtered by a transaction number.</description>
  <detailedSteps>
    <step>
      <number>1</number>
      <originalText>If the referencing guideline limits the access to the functionality solely to authenticated users, the function SHALL check if the user that has invoked the function has the status authenticated. If the status is not authenticated, the function SHALL raise the exception ErrorUserNotAuthenticated and exit the function.</originalText>
      <germanText>Prüft, ob Nutzer authentifiziert. Falls nicht: Exception ErrorUserNotAuthenticated, Ende.</germanText>
      <pseudocode>WENN Benutzer NICHT authentifiziert DANN
  WERFE ErrorUserNotAuthenticated
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthenticated</exception>
        <trigger>Der Benutzer ist nicht authentifiziert</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>2</number>
      <originalText>If the referencing guideline limits the access to the functionality to certain roles, the function SHALL check in the corresponding role if the (unauthenticated) user is authorized to execute the function. If the user is not authorized, the function SHALL raise the exception ErrorUserNotAuthorized and exit the function.</originalText>
      <germanText>Prüft, ob Nutzer berechtigt. Falls nicht: Exception ErrorUserNotAuthorized, Ende.</germanText>
      <pseudocode>WENN Benutzer NICHT autorisiert DANN
  WERFE ErrorUserNotAuthorized
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorUserNotAuthorized</exception>
        <trigger>Der Benutzer ist nicht berechtigt</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>3</number>
      <originalText>If the function is invoked with the parameter transactionNumber, the transaction log to be exported SHALL be the last transaction log created for the transaction number passed by the parameter. If no transaction log for the provided transaction number is found on the device, the exception ErrorNoLogMessageFound SHALL be raised and the function SHALL be exited.</originalText>
      <germanText>Mit Parameter transactionNumber: Ermittelt letztes Transaktionslog für diese Nummer. Falls nicht gefunden: Exception ErrorNoLogMessageFound, Ende.</germanText>
      <pseudocode>WENN Parameter transactionNumber vorhanden DANN
  SUCHE letztes Transaktionslog für diese Nummer
  WENN nicht gefunden DANN
    WERFE ErrorNoLogMessageFound
    BEENDE_FUNKTION
  ENDE
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorNoLogMessageFound</exception>
        <trigger>Kein Transaktionslog für die übergebene Nummer gefunden</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>4</number>
      <originalText>If the function is invoked without the parameter transactionNumber the transaction log to be exported SHALL be the most recent transaction log message created by the device. If no transaction log messages are found on the device, the exception ErrorNoLogMessageFound SHALL be raised and the function SHALL be exited.</originalText>
      <germanText>Ohne Parameter transactionNumber: Ermittelt aktuellstes Transaktionslog. Falls nicht gefunden: Exception ErrorNoLogMessageFound, Ende.</germanText>
      <pseudocode>WENN kein Parameter transactionNumber DANN
  SUCHE aktuellstes Transaktionslog
  WENN nicht gefunden DANN
    WERFE ErrorNoLogMessageFound
    BEENDE_FUNKTION
  ENDE
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorNoLogMessageFound</exception>
        <trigger>Kein Transaktionslog auf dem Gerät gefunden</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>5</number>
      <originalText>The function SHALL retrieve the transaction log message determined by the function. If the retrieval of the transaction log message fails, the exception ErrorReadingLogMessage SHALL be raised and the function SHALL be exited.</originalText>
      <germanText>Ruft das ermittelte Transaktionslog ab. Bei Fehler: Exception ErrorReadingLogMessage, Ende.</germanText>
      <pseudocode>VERSUCHE
  HOLE Transaktionslog
BEI_FEHLER
  WERFE ErrorReadingLogMessage
  BEENDE_FUNKTION
ENDE</pseudocode>
      <errorCase>
        <exception>ErrorReadingLogMessage</exception>
        <trigger>Der Abruf des Transaktionslogs schlägt fehl</trigger>
        <action>Funktion beenden</action>
      </errorCase>
    </step>
    <step>
      <number>6</number>
      <originalText>The retrieved transaction log message SHALL be returned to the application by the output parameter logMessageContent and logMessageFileName. The function SHALL return without raising an exception to indicate that the execution of the function has been successful.</originalText>
      <germanText>Gibt Transaktionslog und Dateiname zurück. Bei Erfolg keine Exception.</germanText>
      <pseudocode>GEBE Transaktionslog-Content zurück (logMessageContent Parameter)
GEBE Dateiname zurück (logMessageFileName Parameter)
RETURN ohne Exception</pseudocode>
      <successCase>
        <condition>Das Transaktionslog wurde erfolgreich abgerufen</condition>
        <action>Gibt das Transaktionslog-Content und den Dateinamen zurück und kehrt ohne Exception zurück</action>
      </successCase>
    </step>
  </detailedSteps>
  <parameters>
    <parameter>
      <name>transactionNumber</name>
      <type>long</type>
      <description>parameter is used to unambiguously identify the transaction.</description>
      <direction>INPUT</direction>
      <required>false</required>
      <note>This parameter is optional. The function has an overloaded version without parameters.</note>
    </parameter>
  </parameters>
  <returnValue>
    <type>ExportDataResult</type>
    <description>an ExportDataResult which contains an InputStream delivering the content of the last transaction log message and the filename of the log message.</description>
  </returnValue>
  <exceptions>
    <exception>ErrorDeviceNotInitialized</exception>
    <exception>ErrorFunctionFailed</exception>
    <exception>ErrorFunctionNotSupported</exception>
    <exception>ErrorNoLogMessageFound</exception>
    <exception>ErrorParameterSyntax</exception>
    <exception>ErrorReadingLogMessage</exception>
    <exception>ErrorSecureElementDisabled</exception>
    <exception>ErrorStorageMediumDisconnected</exception>
    <exception>ErrorUserNotAuthenticated</exception>
    <exception>ErrorUserNotAuthorized</exception>
  </exceptions>
</function>
