<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interface Design - Schnittstellenbeschreibung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/interfacedesign.css">
  <style>
    /* Additional inline styles for Interface Design module */
    .nav-item {
      transition: all 0.2s ease;
    }
    .nav-item:hover {
      background-color: rgba(16, 185, 129, 0.1);
    }
    .nav-item.active {
      background-color: rgba(16, 185, 129, 0.15);
      border-left: 3px solid #10b981;
    }
    .category-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .item-card {
      transition: all 0.2s ease;
    }
    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    // ============================================
    // Helper Functions
    // ============================================

    // Get instance from URL path
    const getInstance = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      return pathParts[0] || null;
    };

    // API URL helper
    const getApiUrl = (instance, endpoint) => {
      return `/api/${instance}/interfacedesign${endpoint}`;
    };

    // ============================================
    // Icon Component
    // ============================================

    const Icon = ({ name, className = '' }) => (
      <i className={`fas fa-${name} ${className}`}></i>
    );

    // ============================================
    // Navigation Items Configuration
    // ============================================

    const NAV_ITEMS = [
      { 
        id: 'functions', 
        label: 'Funktionen', 
        icon: 'code',
        color: 'blue',
        description: 'API-Funktionen der Schnittstelle'
      },
      { 
        id: 'types', 
        label: 'Datentypen', 
        icon: 'cube',
        color: 'purple',
        description: 'Komplexe Datentypen und Strukturen'
      },
      { 
        id: 'enums', 
        label: 'Aufzählungen', 
        icon: 'list-ol',
        color: 'amber',
        description: 'Enumerationen und Konstanten'
      },
      { 
        id: 'exceptions', 
        label: 'Exceptions', 
        icon: 'exclamation-triangle',
        color: 'red',
        description: 'Fehler und Ausnahmen'
      }
    ];

    // ============================================
    // Sidebar Navigation Component
    // ============================================

    const Sidebar = ({ activeView, onViewChange, overview, loading }) => {
      return (
        <aside className="w-72 bg-white border-r flex flex-col flex-shrink-0 overflow-hidden min-h-0">
          <div className="p-4 border-b bg-gray-50">
            <h2 className="font-semibold text-gray-700 flex items-center">
              <Icon name="sitemap" className="mr-2 text-emerald-600" />
              Schnittstellenstruktur
            </h2>
          </div>
          <nav className="flex-1 overflow-y-auto">
            {/* Overview */}
            <div 
              className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 border-b ${activeView === 'overview' ? 'active' : ''}`}
              onClick={() => onViewChange('overview')}
            >
              <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Icon name="th-large" className="text-emerald-600" />
              </div>
              <div className="flex-1">
                <div className="font-medium text-gray-800">Übersicht</div>
                <div className="text-xs text-gray-500">Alle Kategorien</div>
              </div>
            </div>

            {/* Category Navigation */}
            <div className="py-2">
              <div className="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                Kategorien
              </div>
              {NAV_ITEMS.map(item => {
                const count = overview?.[item.id]?.count || 0;
                const categoryCount = overview?.[item.id]?.categories 
                  ? Object.keys(overview[item.id].categories).length 
                  : 0;
                
                const bgColorClass = `bg-${item.color}-100`;
                const textColorClass = `text-${item.color}-600`;
                const badgeBgClass = `bg-${item.color}-100`;
                const badgeTextClass = `text-${item.color}-700`;
                
                return (
                  <div 
                    key={item.id}
                    className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 ${
                      activeView === item.id || 
                      (item.id === 'exceptions' && activeView === 'exception-detail') ||
                      (item.id === 'enums' && activeView === 'enum-detail') ? 'active' : ''
                    }`}
                    onClick={() => onViewChange(item.id)}
                  >
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                      item.color === 'blue' ? 'bg-blue-100' :
                      item.color === 'purple' ? 'bg-purple-100' :
                      item.color === 'amber' ? 'bg-amber-100' :
                      item.color === 'red' ? 'bg-red-100' : 'bg-gray-100'
                    }`}>
                      <Icon name={item.icon} className={
                        item.color === 'blue' ? 'text-blue-600' :
                        item.color === 'purple' ? 'text-purple-600' :
                        item.color === 'amber' ? 'text-amber-600' :
                        item.color === 'red' ? 'text-red-600' : 'text-gray-600'
                      } />
                    </div>
                    <div className="flex-1">
                      <div className="font-medium text-gray-800 flex items-center justify-between">
                        {item.label}
                        {!loading && (
                          <span className={`badge rounded-full ${
                            item.color === 'blue' ? 'bg-blue-100 text-blue-700' :
                            item.color === 'purple' ? 'bg-purple-100 text-purple-700' :
                            item.color === 'amber' ? 'bg-amber-100 text-amber-700' :
                            item.color === 'red' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'
                          }`}>
                            {count}
                          </span>
                        )}
                      </div>
                      <div className="text-xs text-gray-500">
                        {loading ? 'Lädt...' : `${categoryCount} Gruppe${categoryCount !== 1 ? 'n' : ''}`}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </nav>

          {/* Footer */}
          <div className="p-3 border-t bg-gray-50 text-xs text-gray-500">
            <div className="flex items-center gap-2">
              <Icon name="info-circle" />
              <span>BSI TR-03151 Schnittstelle</span>
            </div>
          </div>
        </aside>
      );
    };

    // ============================================
    // Overview Component
    // ============================================

    const OverviewView = ({ overview, onNavigate }) => {
      return (
        <div className="p-6 fade-in">
          <div className="max-w-6xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <Icon name="th-large" className="mr-3 text-emerald-600" />
              Schnittstellenübersicht
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {NAV_ITEMS.map(item => {
                const data = overview?.[item.id] || { count: 0, categories: {} };
                const categories = Object.entries(data.categories || {}).sort((a, b) => b[1] - a[1]);
                
                const gradientClass = 
                  item.color === 'blue' ? 'from-blue-500 to-blue-600' :
                  item.color === 'purple' ? 'from-purple-500 to-purple-600' :
                  item.color === 'amber' ? 'from-amber-500 to-amber-600' :
                  item.color === 'red' ? 'from-red-500 to-red-600' : 'from-gray-500 to-gray-600';
                
                const badgeClass = 
                  item.color === 'blue' ? 'bg-blue-50 text-blue-700' :
                  item.color === 'purple' ? 'bg-purple-50 text-purple-700' :
                  item.color === 'amber' ? 'bg-amber-50 text-amber-700' :
                  item.color === 'red' ? 'bg-red-50 text-red-700' : 'bg-gray-50 text-gray-700';
                
                return (
                  <div 
                    key={item.id}
                    className="item-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer"
                    onClick={() => onNavigate(item.id)}
                  >
                    <div className={`bg-gradient-to-r ${gradientClass} p-4 text-white`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                            <Icon name={item.icon} className="text-2xl" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold">{item.label}</h3>
                            <p className="text-sm opacity-90">{item.description}</p>
                          </div>
                        </div>
                        <div className="text-3xl font-bold">{data.count}</div>
                      </div>
                    </div>
                    <div className="p-4">
                      {categories.length > 0 ? (
                        <div className="space-y-2">
                          <div className="text-xs font-semibold text-gray-500 uppercase">Gruppierung</div>
                          <div className="flex flex-wrap gap-2">
                            {categories.slice(0, 6).map(([cat, count]) => (
                              <span 
                                key={cat}
                                className={`px-2 py-1 text-xs rounded-full ${badgeClass}`}
                              >
                                {cat} ({count})
                              </span>
                            ))}
                            {categories.length > 6 && (
                              <span className="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                +{categories.length - 6} weitere
                              </span>
                            )}
                          </div>
                        </div>
                      ) : (
                        <div className="text-sm text-gray-500">Keine Einträge</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Functions List Component
    // ============================================

    const FunctionsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});

      useEffect(() => {
        loadFunctions();
      }, [instance]);

      const loadFunctions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/functions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            // Expand all categories by default
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
          }
        } catch (err) {
          console.error('Error loading functions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="code" className="mr-3 text-blue-600" />
                Funktionen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              {/* Search */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Funktion suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Function Groups */}
            <div className="space-y-4">
              {Object.entries(filteredGroups).map(([category, items]) => (
                <div key={category} className="bg-white rounded-lg shadow overflow-hidden">
                  {/* Category Header */}
                  <div 
                    className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                    onClick={() => toggleCategory(category)}
                  >
                    <div className="flex items-center gap-3">
                      <Icon 
                        name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                        className="text-gray-400"
                      />
                      <span className="font-semibold text-gray-700">{category}</span>
                      <span className="badge bg-blue-100 text-blue-700 rounded-full">{items.length}</span>
                    </div>
                  </div>

                  {/* Function Items */}
                  {expandedCategories[category] && (
                    <div className="divide-y">
                      {items.map(func => (
                        <div 
                          key={func.id}
                          className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                          onClick={() => onSelectItem && onSelectItem('function', func)}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <code className="text-blue-600 font-semibold">{func.name}</code>
                                {func.hasSystemLog && (
                                  <span className="badge bg-green-100 text-green-700 rounded">
                                    <Icon name="file-alt" className="mr-1" />SystemLog
                                  </span>
                                )}
                              </div>
                              <p className="text-sm text-gray-600 mt-1 line-clamp-2">{func.description}</p>
                              <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                <span>
                                  <Icon name="sign-in-alt" className="mr-1" />
                                  {func.parameterCount} Parameter
                                </span>
                                <span>
                                  <Icon name="sign-out-alt" className="mr-1" />
                                  {func.returnValue?.type || 'void'}
                                </span>
                                <span>
                                  <Icon name="list-ol" className="mr-1" />
                                  {func.stepCount} Schritte
                                </span>
                                <span>
                                  <Icon name="exclamation-circle" className="mr-1" />
                                  {func.exceptionCount} Exceptions
                                </span>
                              </div>
                            </div>
                            <Icon name="chevron-right" className="text-gray-300" />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Types List Component
    // ============================================

    const TypesView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});

      useEffect(() => {
        loadTypes();
      }, [instance]);

      const loadTypes = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/types'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
          }
        } catch (err) {
          console.error('Error loading types:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="cube" className="mr-3 text-purple-600" />
                Datentypen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Datentyp suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Type Groups */}
            <div className="space-y-4">
              {Object.entries(filteredGroups).map(([category, items]) => (
                <div key={category} className="bg-white rounded-lg shadow overflow-hidden">
                  <div 
                    className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                    onClick={() => toggleCategory(category)}
                  >
                    <div className="flex items-center gap-3">
                      <Icon 
                        name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                        className="text-gray-400"
                      />
                      <span className="font-semibold text-gray-700">{category}</span>
                      <span className="badge bg-purple-100 text-purple-700 rounded-full">{items.length}</span>
                    </div>
                  </div>

                  {expandedCategories[category] && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                      {items.map(type => (
                        <div 
                          key={type.id}
                          className="item-card p-4 border rounded-lg hover:border-purple-300 cursor-pointer"
                          onClick={() => onSelectItem && onSelectItem('type', type)}
                        >
                          <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                              <Icon name="cube" className="text-purple-600" />
                            </div>
                            <div className="flex-1 min-w-0">
                              <code className="text-purple-600 font-semibold text-sm block truncate">{type.name}</code>
                              <p className="text-xs text-gray-600 mt-1 line-clamp-2">{type.description || 'Keine Beschreibung'}</p>
                              <div className="flex items-center gap-2 mt-2">
                                <span className="text-xs text-gray-500">
                                  <Icon name="layer-group" className="mr-1" />
                                  {type.fieldCount} Felder
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enums List Component
    // ============================================

    const EnumsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');

      useEffect(() => {
        loadEnums();
      }, [instance]);

      const loadEnums = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/enums'));
          const result = await response.json();
          if (result.success) {
            setData(result);
          }
        } catch (err) {
          console.error('Error loading enums:', err);
        }
        setLoading(false);
      };

      const filteredItems = useMemo(() => {
        if (!data?.items) return [];
        if (!searchTerm) return data.items;
        return data.items.filter(item => 
          item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          item.description?.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="list-ol" className="mr-3 text-amber-600" />
                Aufzählungen (Enums)
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Enum suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Enum Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {filteredItems.map(enumItem => (
                <div 
                  key={enumItem.id}
                  className="item-card bg-white rounded-lg shadow overflow-hidden cursor-pointer"
                  onClick={() => onSelectItem && onSelectItem('enum', enumItem)}
                >
                  <div className="p-4 border-b bg-amber-50">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <Icon name="list-ol" className="text-amber-600" />
                      </div>
                      <div>
                        <code className="text-amber-700 font-semibold">{enumItem.name}</code>
                        <div className="text-xs text-gray-500">{enumItem.category}</div>
                      </div>
                    </div>
                  </div>
                  <div className="p-4">
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                      {enumItem.description || 'Keine Beschreibung'}
                    </p>
                    <div className="text-xs font-semibold text-gray-500 mb-2">
                      Werte ({enumItem.valueCount}):
                    </div>
                    <div className="flex flex-wrap gap-1">
                      {enumItem.values.slice(0, 6).map((val, idx) => (
                        <span 
                          key={idx}
                          className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-700 font-mono"
                        >
                          {val.name}
                          {val.numericValue !== undefined && (
                            <span className="text-gray-400 ml-1">({val.numericValue})</span>
                          )}
                        </span>
                      ))}
                      {enumItem.values.length > 6 && (
                        <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500">
                          +{enumItem.values.length - 6}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enum Detail View Component
    // ============================================

    const EnumDetailView = ({ instance, enumId, onBack, onNavigateToEnum }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        loadEnum();
      }, [instance, enumId]);

      const loadEnum = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/enum/${enumId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.enum);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading enum:', err);
          setError('Fehler beim Laden des Enums');
        }
        setLoading(false);
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-4xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-4 flex items-center text-gray-600 hover:text-gray-900 transition-colors"
            >
              <Icon name="arrow-left" className="mr-2" />
              Zurück zur Übersicht
            </button>

            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-amber-500 to-amber-600 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="list-ol" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        {data.category && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.category}
                          </span>
                        )}
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          {data.valueCount} Werte
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description || 'Keine Beschreibung verfügbar.'}</p>
                {data.germanText && (
                  <p className="text-gray-600 mt-2 italic">{data.germanText}</p>
                )}
              </div>
            </div>

            {/* Values Table */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="p-4 bg-gray-50 border-b">
                <h3 className="font-semibold text-gray-800 flex items-center">
                  <Icon name="list" className="mr-2 text-amber-500" />
                  Enumerationswerte
                  <span className="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full">
                    {data.values.length}
                  </span>
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Wert</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Beschreibung</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {data.values.map((val, idx) => (
                      <tr key={idx} className={`hover:bg-gray-50 ${val.deprecated ? 'opacity-60' : ''}`}>
                        <td className="px-4 py-3">
                          <code className="text-amber-700 font-semibold bg-amber-50 px-2 py-0.5 rounded">
                            {val.name}
                          </code>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            {val.numericValue !== undefined && (
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-sm font-mono">
                                {val.numericValue}
                              </span>
                            )}
                            {val.hexValue && (
                              <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
                                {val.hexValue}
                              </span>
                            )}
                            {val.numericValue === undefined && !val.hexValue && (
                              <span className="text-gray-400 text-sm">-</span>
                            )}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                          {val.description || '-'}
                          {val.germanText && (
                            <p className="text-gray-400 text-xs mt-1 italic">{val.germanText}</p>
                          )}
                          {val.usage && (
                            <p className="text-blue-600 text-xs mt-1">
                              <Icon name="lightbulb" className="mr-1" />
                              {val.usage}
                            </p>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          {val.deprecated ? (
                            <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                              <Icon name="exclamation-triangle" className="mr-1" />
                              Veraltet
                            </span>
                          ) : (
                            <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                              <Icon name="check" className="mr-1" />
                              Aktiv
                            </span>
                          )}
                          {val.since && (
                            <span className="block text-gray-400 text-xs mt-1">
                              Seit: {val.since}
                            </span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Additional Info Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Type Info */}
              {data.typeInfo && (data.typeInfo.asn1Type || data.typeInfo.javaType || data.typeInfo.cType) && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="code" className="mr-2 text-purple-500" />
                    Typ-Informationen
                  </h3>
                  <div className="space-y-2">
                    {data.typeInfo.asn1Type && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">ASN.1 Type</span>
                        <code className="text-sm text-purple-600">{data.typeInfo.asn1Type}</code>
                      </div>
                    )}
                    {data.typeInfo.javaType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Java Type</span>
                        <code className="text-sm text-orange-600">{data.typeInfo.javaType}</code>
                      </div>
                    )}
                    {data.typeInfo.cType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">C Type</span>
                        <code className="text-sm text-blue-600">{data.typeInfo.cType}</code>
                      </div>
                    )}
                    {data.typeInfo.encoding && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Encoding</span>
                        <code className="text-sm text-green-600">{data.typeInfo.encoding}</code>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Usage Context */}
              {data.usageContext && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="crosshairs" className="mr-2 text-blue-500" />
                    Verwendungskontext
                  </h3>
                  <p className="text-gray-600 text-sm">{data.usageContext}</p>
                </div>
              )}

              {/* Constraints */}
              {data.constraints && data.constraints.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="lock" className="mr-2 text-red-500" />
                    Einschränkungen
                  </h3>
                  <div className="space-y-2">
                    {data.constraints.map((c, idx) => (
                      <div key={idx} className="p-2 bg-red-50 rounded border-l-2 border-red-300">
                        <span className="font-medium text-red-700 text-sm">{c.type}</span>
                        {c.description && (
                          <p className="text-red-600 text-xs mt-1">{c.description}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Related Enumerations */}
              {data.relatedEnumerations && data.relatedEnumerations.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="link" className="mr-2 text-amber-500" />
                    Verwandte Enums
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {data.relatedEnumerations.map((rel, idx) => (
                      <span 
                        key={idx}
                        className="px-3 py-1 bg-amber-50 text-amber-700 rounded-full text-sm cursor-pointer hover:bg-amber-100 transition-colors"
                        onClick={() => onNavigateToEnum && onNavigateToEnum(rel)}
                      >
                        {rel}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Notes */}
              {data.notes && data.notes.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                    Hinweise
                  </h3>
                  <ul className="space-y-2">
                    {data.notes.map((note, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-start">
                        <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                        {note}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* Metadata Footer */}
            {(data.version || data.lastModified) && (
              <div className="mt-6 p-4 bg-gray-50 rounded-lg border text-sm text-gray-500">
                <div className="flex items-center gap-4">
                  {data.version && (
                    <span>
                      <Icon name="tag" className="mr-1" />
                      Version: {data.version}
                    </span>
                  )}
                  {data.lastModified && (
                    <span>
                      <Icon name="clock" className="mr-1" />
                      Zuletzt geändert: {data.lastModified}
                    </span>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================
    // Exception Detail View Component
    // ============================================

    const ExceptionDetailView = ({ instance, exceptionId, onBack, onNavigateToFunction }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        loadException();
      }, [instance, exceptionId]);

      const loadException = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/exception/${exceptionId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.exception);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading exception:', err);
          setError('Fehler beim Laden der Exception');
        }
        setLoading(false);
      };

      const getSeverityClasses = (severity) => {
        switch (severity) {
          case 'Critical': return 'bg-red-100 text-red-700 border-red-300';
          case 'High': return 'bg-orange-100 text-orange-700 border-orange-300';
          case 'Medium': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
          case 'Low': return 'bg-green-100 text-green-700 border-green-300';
          default: return 'bg-gray-100 text-gray-700 border-gray-300';
        }
      };

      const getSeverityIcon = (severity) => {
        switch (severity) {
          case 'Critical': return 'skull-crossbones';
          case 'High': return 'exclamation-circle';
          case 'Medium': return 'exclamation';
          case 'Low': return 'info-circle';
          default: return 'question-circle';
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-4xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-4 flex items-center text-gray-600 hover:text-gray-900 transition-colors"
            >
              <Icon name="arrow-left" className="mr-2" />
              Zurück zur Übersicht
            </button>

            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-red-600 to-red-700 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="exclamation-triangle" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          {data.category}
                        </span>
                        <span className={`px-3 py-1 rounded-full text-sm flex items-center gap-1 ${
                          data.severity === 'Critical' ? 'bg-red-900 text-red-100' :
                          data.severity === 'High' ? 'bg-orange-600 text-orange-100' :
                          data.severity === 'Medium' ? 'bg-yellow-600 text-yellow-100' :
                          'bg-green-600 text-green-100'
                        }`}>
                          <Icon name={getSeverityIcon(data.severity)} className="text-xs" />
                          {data.severity}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description}</p>
              </div>
            </div>

            {/* Two Column Layout */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Left Column */}
              <div className="space-y-6">
                {/* Javadoc */}
                {data.javadoc && data.javadoc.summary && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="book" className="mr-2 text-indigo-500" />
                      Javadoc
                    </h3>
                    <p className="text-gray-600 text-sm">{data.javadoc.summary}</p>
                    {data.javadoc.description && (
                      <p className="text-gray-600 text-sm mt-2">{data.javadoc.description}</p>
                    )}
                    {data.javadoc.since && (
                      <p className="text-gray-500 text-xs mt-2">
                        <span className="font-medium">Since:</span> {data.javadoc.since}
                      </p>
                    )}
                  </div>
                )}

                {/* Specification */}
                {data.specification && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="file-contract" className="mr-2 text-purple-500" />
                      Spezifikation
                    </h3>
                    <div className="space-y-3">
                      {data.specification.source && (
                        <div>
                          <span className="text-xs font-medium text-gray-500 uppercase">Quelle</span>
                          <p className="text-gray-700">{data.specification.source}</p>
                        </div>
                      )}
                      {data.specification.section && (
                        <div>
                          <span className="text-xs font-medium text-gray-500 uppercase">Abschnitt</span>
                          <p className="text-gray-700">{data.specification.section}</p>
                        </div>
                      )}
                      {data.specification.requirement && (
                        <div>
                          <span className="text-xs font-medium text-gray-500 uppercase">Anforderung</span>
                          <p className="text-gray-700 text-sm">{data.specification.requirement}</p>
                        </div>
                      )}
                      {data.specification.applicability && (
                        <div>
                          <span className="text-xs font-medium text-gray-500 uppercase">Anwendbarkeit</span>
                          <p className="text-gray-700 text-sm">{data.specification.applicability}</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Recovery */}
                {data.recovery && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="first-aid" className="mr-2 text-green-500" />
                      Wiederherstellung
                    </h3>
                    <p className="text-gray-600 text-sm">{data.recovery}</p>
                  </div>
                )}

                {/* Notes */}
                {data.notes && data.notes.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                      Hinweise
                    </h3>
                    <ul className="space-y-2">
                      {data.notes.map((note, idx) => (
                        <li key={idx} className="text-gray-600 text-sm flex items-start">
                          <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                          {note}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>

              {/* Right Column */}
              <div className="space-y-6">
                {/* Thrown By Functions */}
                {data.thrownBy && data.thrownBy.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="code" className="mr-2 text-blue-500" />
                      Wird geworfen von
                      <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                        {data.thrownBy.length}
                      </span>
                    </h3>
                    <div className="space-y-2 max-h-80 overflow-y-auto">
                      {data.thrownBy.map((func, idx) => (
                        <div 
                          key={idx}
                          className="flex items-center justify-between p-2 rounded hover:bg-gray-50 cursor-pointer group transition-colors"
                          onClick={() => onNavigateToFunction && onNavigateToFunction(func)}
                        >
                          <code className="text-blue-600 text-sm">{func}()</code>
                          <Icon name="external-link-alt" className="text-gray-300 group-hover:text-blue-500 text-xs" />
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Related Exceptions */}
                {data.relatedExceptions && data.relatedExceptions.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="link" className="mr-2 text-orange-500" />
                      Verwandte Exceptions
                    </h3>
                    <div className="flex flex-wrap gap-2">
                      {data.relatedExceptions.map((exc, idx) => (
                        <span 
                          key={idx}
                          className="px-3 py-1 bg-red-50 text-red-700 rounded-full text-sm cursor-pointer hover:bg-red-100 transition-colors"
                        >
                          {exc}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {/* Trigger Conditions */}
                {data.triggerConditions && data.triggerConditions.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="bolt" className="mr-2 text-yellow-500" />
                      Auslösebedingungen
                    </h3>
                    <div className="space-y-3">
                      {data.triggerConditions.map((cond, idx) => (
                        <div key={idx} className="p-3 bg-gray-50 rounded-lg">
                          <p className="text-gray-700 text-sm">{cond.description}</p>
                          {cond.trigger && (
                            <p className="text-gray-500 text-xs mt-1">
                              <span className="font-medium">Trigger:</span> {cond.trigger}
                            </p>
                          )}
                          {cond.action && (
                            <p className="text-gray-500 text-xs mt-1">
                              <span className="font-medium">Aktion:</span> {cond.action}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Example */}
                {data.example && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="lightbulb" className="mr-2 text-amber-500" />
                      Beispiel
                    </h3>
                    <pre className="bg-gray-50 p-3 rounded text-sm text-gray-700 overflow-x-auto">
                      {data.example}
                    </pre>
                  </div>
                )}
              </div>
            </div>

            {/* Severity Info Box */}
            <div className={`mt-6 p-4 rounded-lg border ${getSeverityClasses(data.severity)}`}>
              <div className="flex items-center gap-3">
                <Icon name={getSeverityIcon(data.severity)} className="text-xl" />
                <div>
                  <span className="font-semibold">Schweregrad: {data.severity}</span>
                  <p className="text-sm opacity-80">
                    {data.severity === 'Critical' && 'Diese Exception weist auf einen kritischen Fehler hin, der sofortige Aufmerksamkeit erfordert.'}
                    {data.severity === 'High' && 'Diese Exception weist auf einen schwerwiegenden Fehler hin, der zeitnah behandelt werden sollte.'}
                    {data.severity === 'Medium' && 'Diese Exception weist auf einen moderaten Fehler hin, der untersucht werden sollte.'}
                    {data.severity === 'Low' && 'Diese Exception weist auf einen geringfügigen Fehler hin.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Exceptions List Component
    // ============================================

    const ExceptionsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterSeverity, setFilterSeverity] = useState('all');
      const [expandedCategories, setExpandedCategories] = useState({});

      useEffect(() => {
        loadExceptions();
      }, [instance]);

      const loadExceptions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/exceptions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
          }
        } catch (err) {
          console.error('Error loading exceptions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const getSeverityColor = (severity) => {
        const colors = {
          'Critical': 'red',
          'High': 'orange',
          'Medium': 'yellow',
          'Low': 'green'
        };
        return colors[severity] || 'gray';
      };

      const getSeverityClasses = (severity) => {
        switch (severity) {
          case 'Critical': return 'bg-red-100 text-red-700';
          case 'High': return 'bg-orange-100 text-orange-700';
          case 'Medium': return 'bg-yellow-100 text-yellow-700';
          case 'Low': return 'bg-green-100 text-green-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => {
            const matchesSearch = !searchTerm || 
              item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              item.description?.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesSeverity = filterSeverity === 'all' || item.severity === filterSeverity;
            return matchesSearch && matchesSeverity;
          });
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm, filterSeverity]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="exclamation-triangle" className="mr-3 text-red-600" />
                Exceptions
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="flex items-center gap-4">
                {/* Severity Filter */}
                <select
                  value={filterSeverity}
                  onChange={(e) => setFilterSeverity(e.target.value)}
                  className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                >
                  <option value="all">Alle Schweregrade</option>
                  <option value="Critical">Critical</option>
                  <option value="High">High</option>
                  <option value="Medium">Medium</option>
                  <option value="Low">Low</option>
                </select>

                {/* Search */}
                <div className="relative">
                  <input
                    type="text"
                    placeholder="Exception suchen..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  />
                  <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
                </div>
              </div>
            </div>

            {/* Exception Groups */}
            <div className="space-y-4">
              {Object.entries(filteredGroups).map(([category, items]) => (
                <div key={category} className="bg-white rounded-lg shadow overflow-hidden">
                  <div 
                    className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                    onClick={() => toggleCategory(category)}
                  >
                    <div className="flex items-center gap-3">
                      <Icon 
                        name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                        className="text-gray-400"
                      />
                      <span className="font-semibold text-gray-700">{category}</span>
                      <span className="badge bg-red-100 text-red-700 rounded-full">{items.length}</span>
                    </div>
                  </div>

                  {expandedCategories[category] && (
                    <div className="divide-y">
                      {items.map(exc => {
                        return (
                          <div 
                            key={exc.id}
                            className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                            onClick={() => onSelectItem && onSelectItem('exception', exc)}
                          >
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <code className="text-red-600 font-semibold">{exc.name}</code>
                                  <span className={`badge rounded ${getSeverityClasses(exc.severity)}`}>
                                    {exc.severity}
                                  </span>
                                </div>
                                <p className="text-sm text-gray-600 mt-1 line-clamp-2">{exc.description}</p>
                                {exc.thrownByCount > 0 && (
                                  <div className="flex items-center gap-2 mt-2 text-xs text-gray-500">
                                    <Icon name="code" className="mr-1" />
                                    Verwendet in {exc.thrownByCount} Funktion{exc.thrownByCount !== 1 ? 'en' : ''}
                                  </div>
                                )}
                              </div>
                              <Icon name="chevron-right" className="text-gray-300" />
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Main Application Component
    // ============================================

    const InterfaceDesignApp = () => {
      const [instance, setInstance] = useState(getInstance());
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [notification, setNotification] = useState(null);
      const [activeView, setActiveView] = useState('overview');
      const [overview, setOverview] = useState(null);
      const [selectedItem, setSelectedItem] = useState(null);
      
      // Initialize
      useEffect(() => {
        const currentInstance = getInstance();
        setInstance(currentInstance);
        
        if (currentInstance) {
          loadOverview(currentInstance);
        } else {
          setLoading(false);
        }
      }, []);

      const loadOverview = async (inst) => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(inst || instance, '/overview'));
          const data = await response.json();
          if (data.success) {
            setOverview(data.overview);
          }
          setLoading(false);
        } catch (err) {
          setError('Fehler beim Laden der Daten');
          setLoading(false);
        }
      };

      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      const handleSelectItem = (type, item) => {
        setSelectedItem({ type, item });
        if (type === 'exception') {
          setActiveView('exception-detail');
        } else if (type === 'enum') {
          setActiveView('enum-detail');
        }
      };

      const handleBackFromDetail = () => {
        const previousType = selectedItem?.type;
        setSelectedItem(null);
        // Return to the appropriate list view based on type
        if (previousType === 'exception') {
          setActiveView('exceptions');
        } else if (previousType === 'enum') {
          setActiveView('enums');
        }
      };

      const handleNavigateToFunction = (funcName) => {
        // Navigate to function detail (for future implementation)
        console.log('Navigate to function:', funcName);
        setActiveView('functions');
      };

      const handleNavigateToEnum = (enumName) => {
        // Navigate to enum detail
        setSelectedItem({ type: 'enum', item: { id: enumName } });
        setActiveView('enum-detail');
      };

      // Loading state
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-gray-600">Lade Schnittstellenbeschreibung...</p>
            </div>
          </div>
        );
      }

      // No instance selected
      if (!instance) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <Icon name="exclamation-triangle" className="text-6xl text-yellow-500 mb-4" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">Keine Instanz ausgewählt</h1>
              <p className="text-gray-600 mb-4">Bitte wählen Sie zuerst eine Instanz aus.</p>
              <a 
                href="/"
                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
              >
                <Icon name="home" className="mr-2" />
                Zur Instanzauswahl
              </a>
            </div>
          </div>
        );
      }

      // Render the appropriate view
      const renderMainContent = () => {
        switch (activeView) {
          case 'overview':
            return <OverviewView overview={overview} onNavigate={setActiveView} />;
          case 'functions':
            return <FunctionsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'types':
            return <TypesView instance={instance} onSelectItem={handleSelectItem} />;
          case 'enums':
            return <EnumsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'enum-detail':
            return (
              <EnumDetailView 
                instance={instance} 
                enumId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToEnum={handleNavigateToEnum}
              />
            );
          case 'exceptions':
            return <ExceptionsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'exception-detail':
            return (
              <ExceptionDetailView 
                instance={instance} 
                exceptionId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToFunction={handleNavigateToFunction}
              />
            );
          default:
            return <OverviewView overview={overview} onNavigate={setActiveView} />;
        }
      };

      return (
        <div className="h-screen bg-gray-50 flex flex-col overflow-hidden">
          {/* Notification */}
          {notification && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded shadow-lg fade-in ${
              notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
              {notification.message}
            </div>
          )}

          {/* Header */}
          <header className="bg-gradient-to-r from-emerald-700 to-emerald-900 text-white px-6 py-3 shadow-lg flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3">
                  <a 
                    href="/"
                    className="p-1.5 hover:bg-emerald-600 rounded transition-colors"
                    title="Zur Instanzauswahl"
                  >
                    <Icon name="home" />
                  </a>
                  <h1 className="text-xl font-bold flex items-center">
                    <Icon name="project-diagram" className="mr-2" />
                    Schnittstellenbeschreibung
                  </h1>
                  <span className="px-2 py-0.5 bg-emerald-600 rounded text-sm font-normal">
                    {instance}
                  </span>
                </div>
              </div>

              <div className="flex items-center gap-4">
                {/* Link to TestCases */}
                <a
                  href={`/${instance}`}
                  className="flex items-center text-sm text-emerald-200 hover:text-white transition-colors"
                  title="Zum Testcase Manager"
                >
                  <Icon name="flask" className="mr-1" />
                  TestCases
                </a>
                
                {/* Refresh Button */}
                <button
                  onClick={() => loadOverview()}
                  className="p-2 hover:bg-emerald-600 rounded transition-colors"
                  title="Aktualisieren"
                >
                  <Icon name="sync-alt" />
                </button>
              </div>
            </div>
          </header>

          {/* Error Banner */}
          {error && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
              <div className="flex items-center">
                <Icon name="exclamation-triangle" className="mr-2" />
                <p>{error}</p>
                <button
                  onClick={() => setError(null)}
                  className="ml-4 text-red-700 hover:text-red-900"
                >
                  <Icon name="times" />
                </button>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="flex flex-1 overflow-hidden min-h-0">
            {/* Sidebar */}
            <Sidebar 
              activeView={activeView} 
              onViewChange={setActiveView} 
              overview={overview}
              loading={loading}
            />

            {/* Main Area */}
            <main className="flex-1 overflow-y-auto bg-gray-100">
              {renderMainContent()}
            </main>
          </div>
        </div>
      );
    };

    // ============================================
    // Render Application
    // ============================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InterfaceDesignApp />);
  </script>
</body>
</html>
