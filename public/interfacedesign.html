<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interface Design - Schnittstellenbeschreibung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/interfacedesign.css">
  <style>
    /* Additional inline styles for Interface Design module */
    .nav-item {
      transition: all 0.2s ease;
    }
    .nav-item:hover {
      background-color: rgba(16, 185, 129, 0.1);
    }
    .nav-item.active {
      background-color: rgba(16, 185, 129, 0.15);
      border-left: 3px solid #10b981;
    }
    .category-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .item-card {
      transition: all 0.2s ease;
    }
    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    // ============================================
    // Helper Functions
    // ============================================

    // Get instance from URL path
    const getInstance = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      return pathParts[0] || null;
    };

    // API URL helper
    const getApiUrl = (instance, endpoint) => {
      return `/api/${instance}/interfacedesign${endpoint}`;
    };

    // ============================================
    // URL Routing Helpers
    // ============================================

    // Parse the current URL to determine view and item
    const parseUrlRoute = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      // pathParts[0] = instance
      // pathParts[1] = 'interfacedesign'
      // pathParts[2] = view (functions, types, enums, exceptions, function, type, enum, exception)
      // pathParts[3] = id (for detail views)
      
      const instance = pathParts[0] || null;
      const viewPart = pathParts[2] || 'overview';
      const itemId = pathParts[3] || null;
      
      let activeView = 'overview';
      let selectedItem = null;
      
      // Map URL to view
      switch (viewPart) {
        case 'functions':
          activeView = 'functions';
          break;
        case 'function':
          if (itemId) {
            activeView = 'function-detail';
            selectedItem = { type: 'function', item: { id: itemId } };
          } else {
            activeView = 'functions';
          }
          break;
        case 'types':
          activeView = 'types';
          break;
        case 'type':
          if (itemId) {
            activeView = 'type-detail';
            selectedItem = { type: 'type', item: { id: itemId } };
          } else {
            activeView = 'types';
          }
          break;
        case 'enums':
          activeView = 'enums';
          break;
        case 'enum':
          if (itemId) {
            activeView = 'enum-detail';
            selectedItem = { type: 'enum', item: { id: itemId } };
          } else {
            activeView = 'enums';
          }
          break;
        case 'exceptions':
          activeView = 'exceptions';
          break;
        case 'exception':
          if (itemId) {
            activeView = 'exception-detail';
            selectedItem = { type: 'exception', item: { id: itemId } };
          } else {
            activeView = 'exceptions';
          }
          break;
        default:
          activeView = 'overview';
      }
      
      return { instance, activeView, selectedItem };
    };

    // Build URL for a given view and item
    const buildUrl = (instance, view, itemId = null) => {
      let url = `/${instance}/interfacedesign`;
      
      switch (view) {
        case 'overview':
          // No additional path
          break;
        case 'functions':
          url += '/functions';
          break;
        case 'function-detail':
          url += `/function/${itemId}`;
          break;
        case 'types':
          url += '/types';
          break;
        case 'type-detail':
          url += `/type/${itemId}`;
          break;
        case 'enums':
          url += '/enums';
          break;
        case 'enum-detail':
          url += `/enum/${itemId}`;
          break;
        case 'exceptions':
          url += '/exceptions';
          break;
        case 'exception-detail':
          url += `/exception/${itemId}`;
          break;
        default:
          break;
      }
      
      return url;
    };

    // Update browser URL without page reload
    const updateUrl = (instance, view, itemId = null, replace = false) => {
      const url = buildUrl(instance, view, itemId);
      if (replace) {
        window.history.replaceState({ view, itemId }, '', url);
      } else {
        window.history.pushState({ view, itemId }, '', url);
      }
    };

    // ============================================
    // Icon Component
    // ============================================

    const Icon = ({ name, className = '' }) => (
      <i className={`fas fa-${name} ${className}`}></i>
    );

    // ============================================
    // Navigation Items Configuration
    // ============================================

    const NAV_ITEMS = [
      { 
        id: 'functions', 
        label: 'Funktionen', 
        icon: 'code',
        color: 'blue',
        description: 'API-Funktionen der Schnittstelle'
      },
      { 
        id: 'types', 
        label: 'Datentypen', 
        icon: 'cube',
        color: 'purple',
        description: 'Komplexe Datentypen und Strukturen'
      },
      { 
        id: 'enums', 
        label: 'Aufzählungen', 
        icon: 'list-ol',
        color: 'amber',
        description: 'Enumerationen und Konstanten'
      },
      { 
        id: 'exceptions', 
        label: 'Exceptions', 
        icon: 'exclamation-triangle',
        color: 'red',
        description: 'Fehler und Ausnahmen'
      }
    ];

    // ============================================
    // Sidebar Navigation Component
    // ============================================

    const Sidebar = ({ activeView, onViewChange, overview, loading }) => {
      return (
        <aside className="w-72 bg-white border-r flex flex-col flex-shrink-0 overflow-hidden min-h-0">
          <div className="p-4 border-b bg-gray-50">
            <h2 className="font-semibold text-gray-700 flex items-center">
              <Icon name="sitemap" className="mr-2 text-emerald-600" />
              Schnittstellenstruktur
            </h2>
          </div>
          <nav className="flex-1 overflow-y-auto">
            {/* Overview */}
            <div 
              className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 border-b ${activeView === 'overview' ? 'active' : ''}`}
              onClick={() => onViewChange('overview')}
            >
              <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Icon name="th-large" className="text-emerald-600" />
              </div>
              <div className="flex-1">
                <div className="font-medium text-gray-800">Übersicht</div>
                <div className="text-xs text-gray-500">Alle Kategorien</div>
              </div>
            </div>

            {/* Category Navigation */}
            <div className="py-2">
              <div className="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                Kategorien
              </div>
              {NAV_ITEMS.map(item => {
                const count = overview?.[item.id]?.count || 0;
                const categoryCount = overview?.[item.id]?.categories 
                  ? Object.keys(overview[item.id].categories).length 
                  : 0;
                
                const bgColorClass = `bg-${item.color}-100`;
                const textColorClass = `text-${item.color}-600`;
                const badgeBgClass = `bg-${item.color}-100`;
                const badgeTextClass = `text-${item.color}-700`;
                
                return (
                  <div 
                    key={item.id}
                    className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 ${
                      activeView === item.id || 
                      (item.id === 'functions' && activeView === 'function-detail') ||
                      (item.id === 'exceptions' && activeView === 'exception-detail') ||
                      (item.id === 'enums' && activeView === 'enum-detail') ||
                      (item.id === 'types' && activeView === 'type-detail') ? 'active' : ''
                    }`}
                    onClick={() => onViewChange(item.id)}
                  >
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                      item.color === 'blue' ? 'bg-blue-100' :
                      item.color === 'purple' ? 'bg-purple-100' :
                      item.color === 'amber' ? 'bg-amber-100' :
                      item.color === 'red' ? 'bg-red-100' : 'bg-gray-100'
                    }`}>
                      <Icon name={item.icon} className={
                        item.color === 'blue' ? 'text-blue-600' :
                        item.color === 'purple' ? 'text-purple-600' :
                        item.color === 'amber' ? 'text-amber-600' :
                        item.color === 'red' ? 'text-red-600' : 'text-gray-600'
                      } />
                    </div>
                    <div className="flex-1">
                      <div className="font-medium text-gray-800 flex items-center justify-between">
                        {item.label}
                        {!loading && (
                          <span className={`badge rounded-full ${
                            item.color === 'blue' ? 'bg-blue-100 text-blue-700' :
                            item.color === 'purple' ? 'bg-purple-100 text-purple-700' :
                            item.color === 'amber' ? 'bg-amber-100 text-amber-700' :
                            item.color === 'red' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'
                          }`}>
                            {count}
                          </span>
                        )}
                      </div>
                      <div className="text-xs text-gray-500">
                        {loading ? 'Lädt...' : `${categoryCount} Gruppe${categoryCount !== 1 ? 'n' : ''}`}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </nav>

          {/* Footer */}
          <div className="p-3 border-t bg-gray-50 text-xs text-gray-500">
            <div className="flex items-center gap-2">
              <Icon name="info-circle" />
              <span>BSI TR-03151 Schnittstelle</span>
            </div>
          </div>
        </aside>
      );
    };

    // ============================================
    // Overview Component
    // ============================================

    const OverviewView = ({ overview, onNavigate }) => {
      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <Icon name="th-large" className="mr-3 text-emerald-600" />
              Schnittstellenübersicht
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {NAV_ITEMS.map(item => {
                const data = overview?.[item.id] || { count: 0, categories: {} };
                const categories = Object.entries(data.categories || {}).sort((a, b) => b[1] - a[1]);
                
                const gradientClass = 
                  item.color === 'blue' ? 'from-blue-500 to-blue-600' :
                  item.color === 'purple' ? 'from-purple-500 to-purple-600' :
                  item.color === 'amber' ? 'from-amber-500 to-amber-600' :
                  item.color === 'red' ? 'from-red-500 to-red-600' : 'from-gray-500 to-gray-600';
                
                const badgeClass = 
                  item.color === 'blue' ? 'bg-blue-50 text-blue-700' :
                  item.color === 'purple' ? 'bg-purple-50 text-purple-700' :
                  item.color === 'amber' ? 'bg-amber-50 text-amber-700' :
                  item.color === 'red' ? 'bg-red-50 text-red-700' : 'bg-gray-50 text-gray-700';
                
                return (
                  <div 
                    key={item.id}
                    className="item-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer"
                    onClick={() => onNavigate(item.id)}
                  >
                    <div className={`bg-gradient-to-r ${gradientClass} p-4 text-white`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                            <Icon name={item.icon} className="text-2xl" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold">{item.label}</h3>
                            <p className="text-sm opacity-90">{item.description}</p>
                          </div>
                        </div>
                        <div className="text-3xl font-bold">{data.count}</div>
                      </div>
                    </div>
                    <div className="p-4">
                      {categories.length > 0 ? (
                        <div className="space-y-2">
                          <div className="text-xs font-semibold text-gray-500 uppercase">Gruppierung</div>
                          <div className="flex flex-wrap gap-2">
                            {categories.slice(0, 6).map(([cat, count]) => (
                              <span 
                                key={cat}
                                className={`px-2 py-1 text-xs rounded-full ${badgeClass}`}
                              >
                                {cat} ({count})
                              </span>
                            ))}
                            {categories.length > 6 && (
                              <span className="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                +{categories.length - 6} weitere
                              </span>
                            )}
                          </div>
                        </div>
                      ) : (
                        <div className="text-sm text-gray-500">Keine Einträge</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Functions List Component
    // ============================================

    const FunctionsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});
      const [activeCategory, setActiveCategory] = useState(null);
      const categoryRefs = useRef({});

      useEffect(() => {
        loadFunctions();
      }, [instance]);

      const loadFunctions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/functions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            // Expand all categories by default
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
            // Setze erste Kategorie als aktiv
            const cats = Object.keys(result.grouped || {});
            if (cats.length > 0) setActiveCategory(`func-cat-${cats[0].replace(/\s+/g, '-')}`);
          }
        } catch (err) {
          console.error('Error loading functions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm]);

      // Scroll-Spy: Beobachte welche Kategorie gerade sichtbar ist
      useEffect(() => {
        if (!data?.grouped) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                setActiveCategory(entry.target.id);
              }
            });
          },
          {
            root: null,
            rootMargin: '-100px 0px -70% 0px',
            threshold: 0
          }
        );

        // Kurze Verzögerung um sicherzustellen, dass Refs gesetzt sind
        const timer = setTimeout(() => {
          Object.keys(categoryRefs.current).forEach(cat => {
            const el = categoryRefs.current[cat];
            if (el) observer.observe(el);
          });
        }, 100);

        return () => {
          clearTimeout(timer);
          observer.disconnect();
        };
      }, [data, searchTerm]);

      const scrollToCategory = (category) => {
        const catId = `func-cat-${category.replace(/\s+/g, '-')}`;
        const element = categoryRefs.current[catId];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      const getCategoryId = (category) => `func-cat-${category.replace(/\s+/g, '-')}`;

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      const categories = Object.keys(filteredGroups);
      const totalFunctions = Object.values(filteredGroups).flat();
      const functionsWithSystemLog = totalFunctions.filter(f => f.hasSystemLog).length;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="code" className="mr-3 text-blue-600" />
                Funktionen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              {/* Search */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Funktion suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Main Content with TOC Sidebar */}
            <div className="flex gap-6">
              {/* Sticky TOC Sidebar */}
              <div className="hidden lg:block w-64 flex-shrink-0">
                <div className="sticky top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-700 mb-3 flex items-center text-sm">
                      <Icon name="list" className="mr-2 text-blue-500" />
                      Kategorien
                      <span className="ml-auto text-xs text-gray-400">{categories.length}</span>
                    </h3>
                    <nav className="space-y-1 max-h-[calc(100vh-200px)] overflow-y-auto">
                      {categories.map(category => {
                        const catId = getCategoryId(category);
                        const isActive = activeCategory === catId;
                        const itemCount = filteredGroups[category]?.length || 0;
                        
                        return (
                          <button
                            key={category}
                            onClick={() => scrollToCategory(category)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between group ${
                              isActive 
                                ? 'bg-blue-50 text-blue-700 font-medium border-l-3 border-blue-500' 
                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                            }`}
                          >
                            <span className="truncate flex-1">{category}</span>
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${
                              isActive ? 'bg-blue-200 text-blue-800' : 'bg-gray-100 text-gray-500 group-hover:bg-gray-200'
                            }`}>
                              {itemCount}
                            </span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>

                  {/* Quick Stats */}
                  <div className="bg-white rounded-lg shadow p-4 mt-4">
                    <h3 className="font-semibold text-gray-700 mb-3 text-sm">Statistik</h3>
                    <div className="space-y-2">
                      <div className="flex items-center justify-between p-2 bg-blue-50 rounded">
                        <span className="text-sm text-blue-700">Funktionen</span>
                        <span className="font-bold text-blue-800">{totalFunctions.length}</span>
                      </div>
                      <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                        <span className="text-sm text-green-700 flex items-center">
                          <Icon name="file-alt" className="mr-1" />
                          Mit SystemLog
                        </span>
                        <span className="font-bold text-green-800">{functionsWithSystemLog}</span>
                      </div>
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Kategorien</span>
                        <span className="font-bold text-gray-700">{categories.length}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Function List */}
              <div className="flex-1 min-w-0 space-y-4">
                {Object.entries(filteredGroups).map(([category, items]) => {
                  const catId = getCategoryId(category);
                  return (
                    <div 
                      key={category} 
                      id={catId}
                      ref={el => categoryRefs.current[catId] = el}
                      className="bg-white rounded-lg shadow overflow-hidden scroll-mt-4"
                    >
                      {/* Category Header */}
                      <div 
                        className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                        onClick={() => toggleCategory(category)}
                      >
                        <div className="flex items-center gap-3">
                          <Icon 
                            name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                            className="text-gray-400"
                          />
                          <span className="font-semibold text-gray-700">{category}</span>
                          <span className="badge bg-blue-100 text-blue-700 rounded-full">{items.length}</span>
                        </div>
                      </div>

                      {/* Function Items */}
                      {expandedCategories[category] && (
                        <div className="divide-y">
                          {items.map(func => (
                            <div 
                              key={func.id}
                              className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                              onClick={() => onSelectItem && onSelectItem('function', func)}
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <code className="text-blue-600 font-semibold">{func.name}</code>
                                    {func.hasSystemLog && (
                                      <span className="badge bg-green-100 text-green-700 rounded">
                                        <Icon name="file-alt" className="mr-1" />SystemLog
                                      </span>
                                    )}
                                  </div>
                                  <p className="text-sm text-gray-600 mt-1 line-clamp-2">{func.description}</p>
                                  <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    <span>
                                      <Icon name="sign-in-alt" className="mr-1" />
                                      {func.parameterCount} Parameter
                                    </span>
                                    <span>
                                      <Icon name="sign-out-alt" className="mr-1" />
                                      {func.returnValue?.type || 'void'}
                                    </span>
                                    <span>
                                      <Icon name="list-ol" className="mr-1" />
                                      {func.stepCount} Schritte
                                    </span>
                                    <span>
                                      <Icon name="exclamation-circle" className="mr-1" />
                                      {func.exceptionCount} Exceptions
                                    </span>
                                  </div>
                                </div>
                                <Icon name="chevron-right" className="text-gray-300" />
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Function Detail View Component
    // ============================================

    const FunctionDetailView = ({ instance, functionId, onBack, onNavigateToType, onNavigateToEnum, onNavigateToException }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [availableTypes, setAvailableTypes] = useState([]);
      const [availableEnums, setAvailableEnums] = useState([]);
      const [availableExceptions, setAvailableExceptions] = useState([]);
      const [stepViewMode, setStepViewMode] = useState('cards'); // 'cards', 'timeline', 'pseudocode', 'flowchart'
      const [expandedSteps, setExpandedSteps] = useState({});
      const [showOriginalText, setShowOriginalText] = useState(false);

      useEffect(() => {
        loadFunction();
        loadAvailableItems();
      }, [instance, functionId]);

      const loadFunction = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/function/${functionId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.function);
            // Expand all steps by default
            const expanded = {};
            result.function.detailedSteps?.forEach(s => {
              expanded[s.number] = true;
            });
            setExpandedSteps(expanded);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading function:', err);
          setError('Fehler beim Laden der Funktion');
        }
        setLoading(false);
      };

      const loadAvailableItems = async () => {
        try {
          const [typesRes, enumsRes, excRes] = await Promise.all([
            fetch(getApiUrl(instance, '/types')),
            fetch(getApiUrl(instance, '/enums')),
            fetch(getApiUrl(instance, '/exceptions'))
          ]);
          
          const typesResult = await typesRes.json();
          if (typesResult.success) setAvailableTypes(typesResult.items.map(t => t.name));
          
          const enumsResult = await enumsRes.json();
          if (enumsResult.success) setAvailableEnums(enumsResult.items.map(e => e.name));
          
          const excResult = await excRes.json();
          if (excResult.success) setAvailableExceptions(excResult.items.map(e => e.name));
        } catch (err) {
          console.error('Error loading available items:', err);
        }
      };

      // Render a type reference - links to type/enum if available
      const renderTypeReference = (typeName) => {
        if (!typeName || typeName === 'void') {
          return <span className="text-gray-400 font-mono">{typeName || 'void'}</span>;
        }
        
        if (availableTypes.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-sm font-mono cursor-pointer hover:bg-purple-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
              title={`Typ "${typeName}" anzeigen`}
            >
              <Icon name="cube" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        if (availableEnums.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-sm font-mono cursor-pointer hover:bg-amber-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToEnum && onNavigateToEnum(typeName)}
              title={`Enum "${typeName}" anzeigen`}
            >
              <Icon name="list-ol" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        return (
          <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
            {typeName}
          </span>
        );
      };

      // Render an exception reference
      const renderExceptionReference = (excName) => {
        if (availableExceptions.includes(excName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-red-50 text-red-700 rounded text-sm font-mono cursor-pointer hover:bg-red-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToException && onNavigateToException(excName)}
              title={`Exception "${excName}" anzeigen`}
            >
              <Icon name="exclamation-triangle" className="text-xs" />
              {excName}
            </span>
          );
        }
        return (
          <span className="px-2 py-0.5 bg-red-50 text-red-700 rounded text-sm font-mono">
            {excName}
          </span>
        );
      };

      const toggleStep = (stepNum) => {
        setExpandedSteps(prev => ({
          ...prev,
          [stepNum]: !prev[stepNum]
        }));
      };

      const expandAllSteps = () => {
        const expanded = {};
        data?.detailedSteps?.forEach(s => {
          expanded[s.number] = true;
        });
        setExpandedSteps(expanded);
      };

      const collapseAllSteps = () => {
        setExpandedSteps({});
      };

      // Generate Mermaid flowchart from steps
      const generateMermaidFlowchart = () => {
        if (!data?.detailedSteps?.length) return '';
        
        let mermaid = 'flowchart TD\n';
        mermaid += '    Start([Start]) --> Step1\n';
        
        data.detailedSteps.forEach((step, idx) => {
          const stepId = `Step${step.number}`;
          const nextStepId = idx < data.detailedSteps.length - 1 ? `Step${data.detailedSteps[idx + 1].number}` : 'End';
          
          // Truncate text for display
          const shortText = (step.germanText || '').substring(0, 40) + (step.germanText?.length > 40 ? '...' : '');
          mermaid += `    ${stepId}["${step.number}. ${shortText.replace(/"/g, "'")}"]\n`;
          
          // Add error cases as branches
          if (step.errorCases?.length > 0) {
            step.errorCases.forEach((ec, ecIdx) => {
              const errorId = `Error${step.number}_${ecIdx}`;
              mermaid += `    ${stepId} -->|Fehler| ${errorId}[/${ec.exception}/]\n`;
              mermaid += `    ${errorId} --> EndError([Ende mit Fehler])\n`;
            });
          }
          
          // Success path
          if (step.successCases?.length > 0 || idx === data.detailedSteps.length - 1) {
            mermaid += `    ${stepId} -->|OK| ${nextStepId === 'End' ? 'End([Ende])' : nextStepId}\n`;
          } else if (idx < data.detailedSteps.length - 1) {
            mermaid += `    ${stepId} --> ${nextStepId}\n`;
          }
        });
        
        return mermaid;
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-4 flex items-center text-gray-600 hover:text-gray-900 transition-colors"
            >
              <Icon name="arrow-left" className="mr-2" />
              Zurück zur Übersicht
            </button>

            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="code" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold font-mono">{data.name}()</h1>
                      <div className="flex items-center gap-3 mt-2 flex-wrap">
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          {data.category}
                        </span>
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          <Icon name="list-ol" className="mr-1" />
                          {data.stepCount} Schritte
                        </span>
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          <Icon name="exclamation-triangle" className="mr-1" />
                          {data.exceptionCount} Exceptions
                        </span>
                        {data.systemLog && (
                          <span className="px-3 py-1 bg-green-600 rounded-full text-sm">
                            <Icon name="file-alt" className="mr-1" />
                            System-Log
                          </span>
                        )}
                        {data.transactionLog && (
                          <span className="px-3 py-1 bg-yellow-600 rounded-full text-sm">
                            <Icon name="exchange-alt" className="mr-1" />
                            Transaction-Log
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description || 'Keine Beschreibung verfügbar.'}</p>
              </div>
            </div>

            {/* Function Signature Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="p-4 bg-gray-800 text-gray-100 font-mono text-sm">
                <span className="text-purple-400">{data.returnValue?.type || 'void'}</span>
                <span className="text-yellow-300 ml-2">{data.name}</span>
                <span className="text-gray-400">(</span>
                {data.parameters?.map((p, idx) => (
                  <span key={idx}>
                    <span className="text-purple-400">{p.type}</span>
                    <span className="text-blue-300 ml-1">{p.name}</span>
                    {idx < data.parameters.length - 1 && <span className="text-gray-400">, </span>}
                  </span>
                ))}
                <span className="text-gray-400">)</span>
                {data.exceptions?.length > 0 && (
                  <>
                    <span className="text-gray-500 ml-2">throws</span>
                    <span className="text-red-400 ml-1">{data.exceptions.slice(0, 3).join(', ')}</span>
                    {data.exceptions.length > 3 && <span className="text-gray-500">...</span>}
                  </>
                )}
              </div>
            </div>

            {/* Parameters Table */}
            {data.parameters && data.parameters.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div className="p-4 bg-gray-50 border-b">
                  <h3 className="font-semibold text-gray-800 flex items-center">
                    <Icon name="sign-in-alt" className="mr-2 text-blue-500" />
                    Parameter
                    <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                      {data.parameters.length}
                    </span>
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Typ</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Richtung</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Beschreibung</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Pflicht</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {data.parameters.map((param, idx) => (
                        <tr key={idx} className="hover:bg-gray-50">
                          <td className="px-4 py-3">
                            <code className="text-blue-700 font-semibold">{param.name}</code>
                          </td>
                          <td className="px-4 py-3">
                            {renderTypeReference(param.type)}
                          </td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-0.5 rounded text-xs ${
                              param.direction === 'INPUT' ? 'bg-green-100 text-green-700' :
                              param.direction === 'OUTPUT' ? 'bg-orange-100 text-orange-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {param.direction}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                            {param.description || '-'}
                          </td>
                          <td className="px-4 py-3">
                            {param.required ? (
                              <span className="text-green-600"><Icon name="check" /></span>
                            ) : (
                              <span className="text-gray-400"><Icon name="minus" /></span>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Return Value */}
            {data.returnValue && data.returnValue.type !== 'void' && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="sign-out-alt" className="mr-2 text-green-500" />
                  Rückgabewert
                </h3>
                <div className="flex items-center gap-4">
                  {renderTypeReference(data.returnValue.type)}
                  {data.returnValue.description && (
                    <span className="text-gray-600 text-sm">– {data.returnValue.description}</span>
                  )}
                </div>
              </div>
            )}

            {/* Exceptions */}
            {data.exceptions && data.exceptions.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div className="p-4 bg-gray-50 border-b">
                  <h3 className="font-semibold text-gray-800 flex items-center">
                    <Icon name="exclamation-triangle" className="mr-2 text-red-500" />
                    Mögliche Exceptions
                    <span className="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full">
                      {data.exceptions.length}
                    </span>
                  </h3>
                </div>
                <div className="p-4">
                  <div className="flex flex-wrap gap-2">
                    {data.exceptions.map((exc, idx) => (
                      <span key={idx}>
                        {renderExceptionReference(exc)}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Detailed Steps */}
            {data.detailedSteps && data.detailedSteps.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div className="p-4 bg-gray-50 border-b">
                  <div className="flex items-center justify-between">
                    <h3 className="font-semibold text-gray-800 flex items-center">
                      <Icon name="tasks" className="mr-2 text-indigo-500" />
                      Ausführungsschritte
                      <span className="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full">
                        {data.detailedSteps.length}
                      </span>
                    </h3>
                    <div className="flex items-center gap-2">
                      {/* View Mode Buttons */}
                      <div className="flex bg-gray-200 rounded-lg p-0.5">
                        <button
                          onClick={() => setStepViewMode('cards')}
                          className={`px-3 py-1 rounded text-sm transition-colors ${
                            stepViewMode === 'cards' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-800'
                          }`}
                          title="Karten-Ansicht"
                        >
                          <Icon name="th-large" />
                        </button>
                        <button
                          onClick={() => setStepViewMode('timeline')}
                          className={`px-3 py-1 rounded text-sm transition-colors ${
                            stepViewMode === 'timeline' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-800'
                          }`}
                          title="Timeline-Ansicht"
                        >
                          <Icon name="stream" />
                        </button>
                        <button
                          onClick={() => setStepViewMode('pseudocode')}
                          className={`px-3 py-1 rounded text-sm transition-colors ${
                            stepViewMode === 'pseudocode' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-800'
                          }`}
                          title="Pseudocode-Ansicht"
                        >
                          <Icon name="code" />
                        </button>
                        <button
                          onClick={() => setStepViewMode('flowchart')}
                          className={`px-3 py-1 rounded text-sm transition-colors ${
                            stepViewMode === 'flowchart' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-800'
                          }`}
                          title="Flowchart-Ansicht"
                        >
                          <Icon name="project-diagram" />
                        </button>
                      </div>
                      
                      {/* Language Toggle */}
                      <button
                        onClick={() => setShowOriginalText(!showOriginalText)}
                        className={`px-3 py-1 rounded text-sm border transition-colors ${
                          showOriginalText ? 'bg-blue-50 border-blue-300 text-blue-700' : 'border-gray-300 text-gray-600 hover:bg-gray-50'
                        }`}
                        title={showOriginalText ? 'Deutsche Texte anzeigen' : 'Originaltexte anzeigen'}
                      >
                        {showOriginalText ? 'EN' : 'DE'}
                      </button>

                      {/* Expand/Collapse */}
                      {stepViewMode === 'cards' && (
                        <div className="flex gap-1">
                          <button onClick={expandAllSteps} className="px-2 py-1 text-xs text-gray-500 hover:text-gray-700" title="Alle aufklappen">
                            <Icon name="expand-arrows-alt" />
                          </button>
                          <button onClick={collapseAllSteps} className="px-2 py-1 text-xs text-gray-500 hover:text-gray-700" title="Alle zuklappen">
                            <Icon name="compress-arrows-alt" />
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Cards View */}
                {stepViewMode === 'cards' && (
                  <div className="p-4 space-y-3">
                    {data.detailedSteps.map((step, idx) => (
                      <div key={step.number} className="border rounded-lg overflow-hidden">
                        <div 
                          className="p-3 bg-gray-50 cursor-pointer flex items-center justify-between hover:bg-gray-100 transition-colors"
                          onClick={() => toggleStep(step.number)}
                        >
                          <div className="flex items-center gap-3">
                            <span className="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                              {step.number}
                            </span>
                            <span className="font-medium text-gray-800">
                              {(showOriginalText ? step.originalText : step.germanText)?.substring(0, 80)}
                              {((showOriginalText ? step.originalText : step.germanText)?.length || 0) > 80 ? '...' : ''}
                            </span>
                          </div>
                          <div className="flex items-center gap-2">
                            {step.errorCases?.length > 0 && (
                              <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">
                                {step.errorCases.length} Fehler
                              </span>
                            )}
                            {step.successCases?.length > 0 && (
                              <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">
                                Erfolg
                              </span>
                            )}
                            <Icon name={expandedSteps[step.number] ? 'chevron-up' : 'chevron-down'} className="text-gray-400" />
                          </div>
                        </div>
                        
                        {expandedSteps[step.number] && (
                          <div className="p-4 border-t bg-white">
                            <p className="text-gray-700 mb-4">
                              {showOriginalText ? step.originalText : step.germanText}
                            </p>
                            
                            {step.pseudocode && (
                              <div className="mb-4">
                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Pseudocode</h5>
                                <pre className="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto font-mono">
                                  {step.pseudocode}
                                </pre>
                              </div>
                            )}
                            
                            {step.errorCases?.length > 0 && (
                              <div className="mb-4">
                                <h5 className="text-xs font-semibold text-red-600 uppercase mb-2 flex items-center">
                                  <Icon name="times-circle" className="mr-1" />
                                  Fehlerfälle
                                </h5>
                                <div className="space-y-2">
                                  {step.errorCases.map((ec, ecIdx) => (
                                    <div key={ecIdx} className="p-3 bg-red-50 rounded border-l-4 border-red-400">
                                      <div className="flex items-center gap-2 mb-1">
                                        {renderExceptionReference(ec.exception)}
                                      </div>
                                      <p className="text-sm text-red-700"><strong>Auslöser:</strong> {ec.trigger}</p>
                                      {ec.action && <p className="text-sm text-red-600"><strong>Aktion:</strong> {ec.action}</p>}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            {step.successCases?.length > 0 && (
                              <div>
                                <h5 className="text-xs font-semibold text-green-600 uppercase mb-2 flex items-center">
                                  <Icon name="check-circle" className="mr-1" />
                                  Erfolgsfälle
                                </h5>
                                <div className="space-y-2">
                                  {step.successCases.map((sc, scIdx) => (
                                    <div key={scIdx} className="p-3 bg-green-50 rounded border-l-4 border-green-400">
                                      <p className="text-sm text-green-700"><strong>Bedingung:</strong> {sc.condition}</p>
                                      {sc.action && <p className="text-sm text-green-600"><strong>Aktion:</strong> {sc.action}</p>}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Timeline View */}
                {stepViewMode === 'timeline' && (
                  <div className="p-4">
                    <div className="relative">
                      {data.detailedSteps.map((step, idx) => (
                        <div key={step.number} className="flex gap-4 mb-6 last:mb-0">
                          <div className="flex flex-col items-center">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${
                              step.errorCases?.length > 0 ? 'bg-red-500' :
                              step.successCases?.length > 0 ? 'bg-green-500' :
                              'bg-indigo-600'
                            }`}>
                              {step.number}
                            </div>
                            {idx < data.detailedSteps.length - 1 && (
                              <div className="w-0.5 h-full bg-gray-300 mt-2"></div>
                            )}
                          </div>
                          <div className="flex-1 pb-6">
                            <p className="text-gray-800 font-medium mb-2">
                              {showOriginalText ? step.originalText : step.germanText}
                            </p>
                            {step.errorCases?.length > 0 && (
                              <div className="flex flex-wrap gap-1 mt-2">
                                {step.errorCases.map((ec, ecIdx) => (
                                  <span key={ecIdx}>{renderExceptionReference(ec.exception)}</span>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Pseudocode View */}
                {stepViewMode === 'pseudocode' && (
                  <div className="p-4">
                    <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                      <code>
                        <span className="text-purple-400">function</span> <span className="text-yellow-300">{data.name}</span>({data.parameters?.map(p => p.name).join(', ')}) {'{\n'}
                        {data.detailedSteps.map(step => (
                          <span key={step.number}>
                            {`\n  `}<span className="text-gray-500">// Schritt {step.number}</span>{'\n'}
                            {step.pseudocode ? 
                              step.pseudocode.split('\n').map((line, i) => (
                                <span key={i}>{`  ${line}\n`}</span>
                              )) : 
                              `  // ${(showOriginalText ? step.originalText : step.germanText)?.substring(0, 60)}...\n`
                            }
                          </span>
                        ))}
                        {'\n}'}
                      </code>
                    </pre>
                  </div>
                )}

                {/* Flowchart View (Mermaid) */}
                {stepViewMode === 'flowchart' && (
                  <div className="p-4">
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <div className="text-center text-gray-500 mb-4">
                        <Icon name="project-diagram" className="text-4xl mb-2" />
                        <p>Flowchart-Darstellung</p>
                      </div>
                      <pre className="bg-gray-900 text-gray-100 p-4 rounded text-xs overflow-x-auto font-mono">
                        {generateMermaidFlowchart()}
                      </pre>
                      <p className="text-xs text-gray-500 mt-2 text-center">
                        Kopieren Sie den Mermaid-Code und fügen Sie ihn in einen 
                        <a href="https://mermaid.live" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline ml-1">
                          Mermaid Live Editor
                        </a>
                        ein
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Notes */}
            {data.notes && data.notes.length > 0 && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                  Hinweise
                </h3>
                <ul className="space-y-2">
                  {data.notes.map((note, idx) => (
                    <li key={idx} className="text-gray-600 text-sm flex items-start">
                      <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                      {typeof note === 'string' ? note : note.text}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Pre/Post Conditions */}
            {(data.precondition || data.postcondition) && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                {data.precondition && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="door-open" className="mr-2 text-blue-500" />
                      Vorbedingung
                    </h3>
                    <p className="text-gray-600 text-sm">{data.precondition}</p>
                  </div>
                )}
                {data.postcondition && (
                  <div className="bg-white rounded-lg shadow p-5">
                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="door-closed" className="mr-2 text-green-500" />
                      Nachbedingung
                    </h3>
                    <p className="text-gray-600 text-sm">{data.postcondition}</p>
                  </div>
                )}
              </div>
            )}

            {/* Logging Section */}
            {(data.systemLog || data.transactionLog) && (
              <LoggingSection 
                systemLog={data.systemLog} 
                transactionLog={data.transactionLog}
                functionName={data.name}
                onNavigateToType={onNavigateToType}
                availableTypes={availableTypes}
              />
            )}
          </div>
        </div>
      );
    };

    // ============================================
    // Logging Section Component
    // ============================================
    
    const LoggingSection = ({ systemLog, transactionLog, functionName, onNavigateToType, availableTypes }) => {
      const [activeLogTab, setActiveLogTab] = useState(transactionLog ? 'transaction' : 'system');
      const [logViewMode, setLogViewMode] = useState('overview'); // 'overview', 'asn1', 'fields', 'diagram'
      
      const activeLog = activeLogTab === 'transaction' ? transactionLog : systemLog;
      
      // Get origin badge color
      const getOriginColor = (origin) => {
        if (!origin || origin === '-') return 'bg-gray-100 text-gray-600';
        if (origin.includes('device')) return 'bg-blue-100 text-blue-700';
        if (origin.includes('Secure Element')) return 'bg-purple-100 text-purple-700';
        if (origin.includes('External')) return 'bg-green-100 text-green-700';
        return 'bg-gray-100 text-gray-600';
      };

      // Render type reference
      const renderFieldType = (typeName) => {
        if (!typeName) return <span className="text-gray-400">-</span>;
        
        // Check if it's a known type
        if (availableTypes?.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-xs font-mono cursor-pointer hover:bg-purple-100 hover:underline"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
            >
              {typeName}
            </span>
          );
        }
        
        return <span className="font-mono text-xs text-blue-600">{typeName}</span>;
      };

      // Generate simplified ASN.1 diagram
      const generateAsn1Diagram = () => {
        if (!activeLog?.fields) return '';
        
        let diagram = `┌─────────────────────────────────────────────────────────────┐\n`;
        diagram += `│  ${activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} (SEQUENCE)\n`;
        diagram += `├─────────────────────────────────────────────────────────────┤\n`;
        
        activeLog.fields.forEach((field, idx) => {
          const reqMarker = field.required ? '●' : '○';
          const tagInfo = field.tag ? ` ${field.tag}` : '';
          diagram += `│ ${reqMarker} ${field.name.padEnd(25)} : ${field.type}${tagInfo}\n`;
        });
        
        diagram += `└─────────────────────────────────────────────────────────────┘`;
        return diagram;
      };

      if (!activeLog) return null;

      return (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
          {/* Header with tabs */}
          <div className="bg-gradient-to-r from-emerald-600 to-teal-600 p-4">
            <div className="flex items-center justify-between">
              <h3 className="text-white font-semibold flex items-center text-lg">
                <Icon name="file-alt" className="mr-2" />
                Logging-Anforderungen
              </h3>
              
              {/* Log Type Tabs */}
              {systemLog && transactionLog && (
                <div className="flex bg-white/20 rounded-lg p-0.5">
                  <button
                    onClick={() => setActiveLogTab('transaction')}
                    className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${
                      activeLogTab === 'transaction' 
                        ? 'bg-white text-emerald-700' 
                        : 'text-white hover:bg-white/10'
                    }`}
                  >
                    <Icon name="exchange-alt" className="mr-1" />
                    Transaction-Log
                  </button>
                  <button
                    onClick={() => setActiveLogTab('system')}
                    className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${
                      activeLogTab === 'system' 
                        ? 'bg-white text-emerald-700' 
                        : 'text-white hover:bg-white/10'
                    }`}
                  >
                    <Icon name="cog" className="mr-1" />
                    System-Log
                  </button>
                </div>
              )}
            </div>
            
            {/* Log Type Badge */}
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                activeLogTab === 'transaction' 
                  ? 'bg-yellow-500 text-yellow-900' 
                  : 'bg-blue-500 text-blue-100'
              }`}>
                {activeLog.logType}
              </span>
              <span className="px-3 py-1 bg-white/20 rounded-full text-white text-sm">
                {activeLog.requirement}
              </span>
              {activeLog.fields && (
                <span className="px-3 py-1 bg-white/20 rounded-full text-white text-sm">
                  {activeLog.fields.length} Felder
                </span>
              )}
            </div>
          </div>

          {/* View Mode Switcher */}
          <div className="p-4 bg-gray-50 border-b flex items-center justify-between">
            <div className="flex bg-gray-200 rounded-lg p-0.5">
              <button
                onClick={() => setLogViewMode('overview')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'overview' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="th-large" className="mr-1" />
                Übersicht
              </button>
              <button
                onClick={() => setLogViewMode('fields')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'fields' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="table" className="mr-1" />
                Felder
              </button>
              <button
                onClick={() => setLogViewMode('asn1')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'asn1' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="code" className="mr-1" />
                ASN.1
              </button>
              <button
                onClick={() => setLogViewMode('diagram')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'diagram' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="sitemap" className="mr-1" />
                Struktur
              </button>
            </div>
          </div>

          {/* Overview Mode */}
          {logViewMode === 'overview' && (
            <div className="p-6">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Quick Info Cards */}
                <div className="space-y-4">
                  <div className="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                    <h4 className="font-semibold text-blue-800 mb-2 flex items-center">
                      <Icon name="info-circle" className="mr-2" />
                      Log-Typ
                    </h4>
                    <p className="text-blue-700">{activeLog.logType}</p>
                  </div>
                  
                  <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
                    <h4 className="font-semibold text-green-800 mb-2 flex items-center">
                      <Icon name="check-circle" className="mr-2" />
                      Anforderung
                    </h4>
                    <p className="text-green-700 text-sm">{activeLog.requirement}</p>
                  </div>

                  {/* Required Fields Summary */}
                  {activeLog.fields && (
                    <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-100">
                      <h4 className="font-semibold text-purple-800 mb-2 flex items-center">
                        <Icon name="asterisk" className="mr-2" />
                        Pflichtfelder
                      </h4>
                      <div className="flex flex-wrap gap-1">
                        {activeLog.fields.filter(f => f.required).map((field, idx) => (
                          <span key={idx} className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-mono">
                            {field.name}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Field Origin Distribution */}
                {activeLog.fields && (
                  <div className="p-4 bg-gray-50 rounded-lg border">
                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="sitemap" className="mr-2 text-gray-500" />
                      Feld-Herkunft
                    </h4>
                    <div className="space-y-2">
                      {(() => {
                        const origins = {};
                        activeLog.fields.forEach(f => {
                          const origin = f.origin || 'Unbekannt';
                          origins[origin] = (origins[origin] || 0) + 1;
                        });
                        return Object.entries(origins).map(([origin, count], idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <span className={`px-2 py-1 rounded text-xs ${getOriginColor(origin)}`}>
                              {origin}
                            </span>
                            <span className="text-gray-500 text-sm">{count} Felder</span>
                          </div>
                        ));
                      })()}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Fields Table Mode */}
          {logViewMode === 'fields' && activeLog.fields && (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Feld</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Typ</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Tag</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Pflicht</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Standard</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Beschreibung</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Herkunft</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {activeLog.fields.map((field, idx) => (
                    <tr key={idx} className={`hover:bg-gray-50 ${field.note === 'RFU' ? 'opacity-50' : ''}`}>
                      <td className="px-4 py-3">
                        <code className="text-emerald-700 font-semibold bg-emerald-50 px-2 py-0.5 rounded text-sm">
                          {field.name}
                        </code>
                        {field.note && (
                          <span className="ml-2 px-1.5 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">
                            {field.note}
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {renderFieldType(field.type)}
                      </td>
                      <td className="px-4 py-3">
                        {field.tag ? (
                          <code className="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">
                            {field.tag}
                          </code>
                        ) : (
                          <span className="text-gray-300">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {field.required ? (
                          <span className="text-green-600"><Icon name="check-circle" /></span>
                        ) : (
                          <span className="text-gray-300"><Icon name="minus" /></span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {field.defaultValue ? (
                          <code className="text-xs text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded">
                            {field.defaultValue}
                          </code>
                        ) : (
                          <span className="text-gray-300">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        {field.description || '-'}
                      </td>
                      <td className="px-4 py-3">
                        <span className={`px-2 py-0.5 rounded text-xs ${getOriginColor(field.origin)}`}>
                          {field.origin || '-'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* ASN.1 Mode */}
          {logViewMode === 'asn1' && activeLog.asn1Structure && (
            <div className="p-6 space-y-6">
              {/* LogMessage Structure */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                  <Icon name="file-code" className="mr-2 text-blue-500" />
                  LogMessage Struktur
                </h4>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  <code>{activeLog.asn1Structure.logMessage}</code>
                </pre>
              </div>
              
              {/* Specific Log Message Structure */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                  <Icon name="file-code" className="mr-2 text-purple-500" />
                  {activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} Struktur
                </h4>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  <code>
                    {activeLogTab === 'transaction' 
                      ? activeLog.asn1Structure.transactionLogMessage 
                      : activeLog.asn1Structure.systemLogMessage}
                  </code>
                </pre>
              </div>
            </div>
          )}

          {/* Structure Diagram Mode */}
          {logViewMode === 'diagram' && activeLog.fields && (
            <div className="p-6">
              {/* Visual Structure */}
              <div className="space-y-4">
                <h4 className="font-semibold text-gray-700 mb-3 flex items-center">
                  <Icon name="project-diagram" className="mr-2 text-indigo-500" />
                  Visuelle Feldstruktur
                </h4>
                
                {/* Nested Structure Visualization */}
                <div className="bg-gray-50 rounded-lg p-4 border">
                  <div className="font-mono text-sm">
                    <div className="text-purple-600 font-bold mb-2">
                      {activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} ::= SEQUENCE {'{'}
                    </div>
                    <div className="ml-4 space-y-1">
                      {activeLog.fields.map((field, idx) => (
                        <div key={idx} className={`flex items-start gap-2 py-1 px-2 rounded ${
                          field.required ? 'bg-green-50' : 'bg-gray-100'
                        } ${field.note === 'RFU' ? 'opacity-50' : ''}`}>
                          <span className={`w-4 h-4 rounded-full flex-shrink-0 mt-0.5 flex items-center justify-center text-xs ${
                            field.required ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'
                          }`}>
                            {field.required ? '●' : '○'}
                          </span>
                          <div className="flex-1">
                            <span className="text-blue-600">{field.name}</span>
                            {field.tag && <span className="text-gray-400 ml-2">{field.tag}</span>}
                            <span className="text-gray-500 mx-2">:</span>
                            <span className="text-purple-600">{field.type}</span>
                            {!field.required && <span className="text-orange-500 ml-2">OPTIONAL</span>}
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="text-purple-600 font-bold mt-2">{'}'}</div>
                  </div>
                </div>

                {/* ASCII Diagram */}
                <div>
                  <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                    <Icon name="terminal" className="mr-2 text-gray-500" />
                    ASCII-Darstellung
                  </h4>
                  <pre className="bg-gray-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto font-mono">
                    {generateAsn1Diagram()}
                  </pre>
                </div>

                {/* Legend */}
                <div className="flex items-center gap-6 text-sm text-gray-600 mt-4 p-3 bg-gray-100 rounded-lg">
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-green-500"></span> Pflichtfeld
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-gray-300"></span> Optional
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="opacity-50">Ausgegraut</span> = RFU (Reserved for Future Use)
                  </span>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // Types List Component
    // ============================================

    const TypesView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});

      useEffect(() => {
        loadTypes();
      }, [instance]);

      const loadTypes = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/types'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
          }
        } catch (err) {
          console.error('Error loading types:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="cube" className="mr-3 text-purple-600" />
                Datentypen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Datentyp suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Type Groups */}
            <div className="space-y-4">
              {Object.entries(filteredGroups).map(([category, items]) => (
                <div key={category} className="bg-white rounded-lg shadow overflow-hidden">
                  <div 
                    className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                    onClick={() => toggleCategory(category)}
                  >
                    <div className="flex items-center gap-3">
                      <Icon 
                        name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                        className="text-gray-400"
                      />
                      <span className="font-semibold text-gray-700">{category}</span>
                      <span className="badge bg-purple-100 text-purple-700 rounded-full">{items.length}</span>
                    </div>
                  </div>

                  {expandedCategories[category] && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                      {items.map(type => (
                        <div 
                          key={type.id}
                          className="item-card p-4 border rounded-lg hover:border-purple-300 cursor-pointer"
                          onClick={() => onSelectItem && onSelectItem('type', type)}
                        >
                          <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                              <Icon name="cube" className="text-purple-600" />
                            </div>
                            <div className="flex-1 min-w-0">
                              <code className="text-purple-600 font-semibold text-sm block truncate">{type.name}</code>
                              <p className="text-xs text-gray-600 mt-1 line-clamp-2">{type.description || 'Keine Beschreibung'}</p>
                              <div className="flex items-center gap-2 mt-2">
                                <span className="text-xs text-gray-500">
                                  <Icon name="layer-group" className="mr-1" />
                                  {type.fieldCount} Felder
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Type Detail View Component
    // ============================================

    const TypeDetailView = ({ instance, typeId, onBack, onNavigateToType, onNavigateToEnum }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [availableTypes, setAvailableTypes] = useState([]);
      const [availableEnums, setAvailableEnums] = useState([]);

      useEffect(() => {
        loadType();
        loadAvailableTypesAndEnums();
      }, [instance, typeId]);

      const loadType = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/type/${typeId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.type);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading type:', err);
          setError('Fehler beim Laden des Typs');
        }
        setLoading(false);
      };

      const loadAvailableTypesAndEnums = async () => {
        try {
          // Load types
          const typesResponse = await fetch(getApiUrl(instance, '/types'));
          const typesResult = await typesResponse.json();
          if (typesResult.success) {
            setAvailableTypes(typesResult.items.map(t => t.name));
          }
          
          // Load enums
          const enumsResponse = await fetch(getApiUrl(instance, '/enums'));
          const enumsResult = await enumsResponse.json();
          if (enumsResult.success) {
            setAvailableEnums(enumsResult.items.map(e => e.name));
          }
        } catch (err) {
          console.error('Error loading available types/enums:', err);
        }
      };

      const getTypeKindInfo = (kind) => {
        switch (kind) {
          case 'simple': return { label: 'Einfacher Typ', icon: 'tag', color: 'green' };
          case 'result': return { label: 'Ergebnis-Typ', icon: 'check-circle', color: 'blue' };
          case 'eventData': return { label: 'Event-Daten', icon: 'bolt', color: 'yellow' };
          default: return { label: 'Komplexer Typ', icon: 'cubes', color: 'purple' };
        }
      };

      // Render a type reference - links to type/enum if available
      const renderTypeReference = (typeName) => {
        if (!typeName) return <span className="text-gray-400">-</span>;
        
        // Check if it's an available type
        if (availableTypes.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-sm font-mono cursor-pointer hover:bg-purple-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
              title={`Typ "${typeName}" anzeigen`}
            >
              <Icon name="cube" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        // Check if it's an available enum
        if (availableEnums.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-sm font-mono cursor-pointer hover:bg-amber-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToEnum && onNavigateToEnum(typeName)}
              title={`Enum "${typeName}" anzeigen`}
            >
              <Icon name="list-ol" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        // Standard type (not linkable)
        return (
          <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
            {typeName}
          </span>
        );
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      const kindInfo = getTypeKindInfo(data.typeKind);

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-4 flex items-center text-gray-600 hover:text-gray-900 transition-colors"
            >
              <Icon name="arrow-left" className="mr-2" />
              Zurück zur Übersicht
            </button>

            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="cube" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        {data.category && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.category}
                          </span>
                        )}
                        <span className={`px-3 py-1 rounded-full text-sm flex items-center gap-1 ${
                          kindInfo.color === 'green' ? 'bg-green-600 text-green-100' :
                          kindInfo.color === 'blue' ? 'bg-blue-600 text-blue-100' :
                          kindInfo.color === 'yellow' ? 'bg-yellow-600 text-yellow-100' :
                          'bg-purple-800 text-purple-100'
                        }`}>
                          <Icon name={kindInfo.icon} className="text-xs" />
                          {kindInfo.label}
                        </span>
                        {data.fieldCount > 0 && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.fieldCount} Felder
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description || 'Keine Beschreibung verfügbar.'}</p>
              </div>
            </div>

            {/* Base Type (for simple types) */}
            {data.baseType && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="link" className="mr-2 text-green-500" />
                  Basistyp
                </h3>
                <code className="text-lg text-green-700 bg-green-50 px-3 py-1 rounded">{data.baseType}</code>
              </div>
            )}

            {/* ASN.1 Definition */}
            {data.asn1Definition && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="code" className="mr-2 text-indigo-500" />
                  ASN.1 Definition
                </h3>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  {data.asn1Definition}
                </pre>
              </div>
            )}

            {/* Fields Table */}
            {data.fields && data.fields.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div className="p-4 bg-gray-50 border-b">
                  <h3 className="font-semibold text-gray-800 flex items-center">
                    <Icon name="layer-group" className="mr-2 text-purple-500" />
                    Felder
                    <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">
                      {data.fields.length}
                    </span>
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Typ</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Beschreibung</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {data.fields.map((field, idx) => (
                        <tr key={idx} className="hover:bg-gray-50">
                          <td className="px-4 py-3">
                            <code className="text-purple-700 font-semibold bg-purple-50 px-2 py-0.5 rounded">
                              {field.name}
                            </code>
                            {field.getter && (
                              <span className="block text-xs text-gray-400 mt-1 font-mono">
                                {field.getter}
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            {renderTypeReference(field.type)}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                            {field.description || '-'}
                            {field.defaultValue && (
                              <p className="text-gray-400 text-xs mt-1">
                                Standard: <code>{field.defaultValue}</code>
                              </p>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            {field.optional ? (
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">
                                Optional
                              </span>
                            ) : (
                              <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                                <Icon name="check" className="mr-1" />
                                Pflicht
                              </span>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Additional Info Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Usage */}
              {data.usage && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="crosshairs" className="mr-2 text-blue-500" />
                    Verwendung
                  </h3>
                  <p className="text-gray-600 text-sm">{data.usage}</p>
                </div>
              )}

              {/* Constraints */}
              {data.constraints && data.constraints.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="lock" className="mr-2 text-red-500" />
                    Einschränkungen
                  </h3>
                  <div className="space-y-2">
                    {data.constraints.map((c, idx) => (
                      <div key={idx} className="p-3 bg-red-50 rounded border-l-2 border-red-300">
                        <span className="font-medium text-red-700 text-sm">{c.type}</span>
                        {c.description && (
                          <p className="text-red-600 text-xs mt-1">{c.description}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Notes */}
              {data.notes && data.notes.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                    Hinweise
                  </h3>
                  <ul className="space-y-2">
                    {data.notes.map((note, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-start">
                        <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                        {note}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* Type Kind Info Box */}
            <div className={`mt-6 p-4 rounded-lg border ${
              kindInfo.color === 'green' ? 'bg-green-50 border-green-200 text-green-800' :
              kindInfo.color === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-800' :
              kindInfo.color === 'yellow' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
              'bg-purple-50 border-purple-200 text-purple-800'
            }`}>
              <div className="flex items-center gap-3">
                <Icon name={kindInfo.icon} className="text-xl" />
                <div>
                  <span className="font-semibold">{kindInfo.label}</span>
                  <p className="text-sm opacity-80">
                    {data.typeKind === 'simple' && 'Dieser Typ ist eine einfache Typ-Definition basierend auf einem Basistyp.'}
                    {data.typeKind === 'result' && 'Dieser Typ wird als Rückgabewert von API-Funktionen verwendet.'}
                    {data.typeKind === 'eventData' && 'Dieser Typ enthält Event-spezifische Daten für System-Log-Einträge.'}
                    {data.typeKind === 'complex' && 'Dieser Typ ist eine komplexe Datenstruktur mit mehreren Feldern.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enums List Component
    // ============================================

    const EnumsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');

      useEffect(() => {
        loadEnums();
      }, [instance]);

      const loadEnums = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/enums'));
          const result = await response.json();
          if (result.success) {
            setData(result);
          }
        } catch (err) {
          console.error('Error loading enums:', err);
        }
        setLoading(false);
      };

      const filteredItems = useMemo(() => {
        if (!data?.items) return [];
        if (!searchTerm) return data.items;
        return data.items.filter(item => 
          item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          item.description?.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="list-ol" className="mr-3 text-amber-600" />
                Aufzählungen (Enums)
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Enum suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Enum Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {filteredItems.map(enumItem => (
                <div 
                  key={enumItem.id}
                  className="item-card bg-white rounded-lg shadow overflow-hidden cursor-pointer"
                  onClick={() => onSelectItem && onSelectItem('enum', enumItem)}
                >
                  <div className="p-4 border-b bg-amber-50">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <Icon name="list-ol" className="text-amber-600" />
                      </div>
                      <div>
                        <code className="text-amber-700 font-semibold">{enumItem.name}</code>
                        <div className="text-xs text-gray-500">{enumItem.category}</div>
                      </div>
                    </div>
                  </div>
                  <div className="p-4">
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                      {enumItem.description || 'Keine Beschreibung'}
                    </p>
                    <div className="text-xs font-semibold text-gray-500 mb-2">
                      Werte ({enumItem.valueCount}):
                    </div>
                    <div className="flex flex-wrap gap-1">
                      {enumItem.values.slice(0, 6).map((val, idx) => (
                        <span 
                          key={idx}
                          className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-700 font-mono"
                        >
                          {val.name}
                          {val.numericValue !== undefined && (
                            <span className="text-gray-400 ml-1">({val.numericValue})</span>
                          )}
                        </span>
                      ))}
                      {enumItem.values.length > 6 && (
                        <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500">
                          +{enumItem.values.length - 6}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enum Detail View Component
    // ============================================

    const EnumDetailView = ({ instance, enumId, onBack, onNavigateToEnum }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        loadEnum();
      }, [instance, enumId]);

      const loadEnum = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/enum/${enumId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.enum);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading enum:', err);
          setError('Fehler beim Laden des Enums');
        }
        setLoading(false);
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-4 flex items-center text-gray-600 hover:text-gray-900 transition-colors"
            >
              <Icon name="arrow-left" className="mr-2" />
              Zurück zur Übersicht
            </button>

            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-amber-500 to-amber-600 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="list-ol" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        {data.category && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.category}
                          </span>
                        )}
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          {data.valueCount} Werte
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description || 'Keine Beschreibung verfügbar.'}</p>
                {data.germanText && (
                  <p className="text-gray-600 mt-2 italic">{data.germanText}</p>
                )}
              </div>
            </div>

            {/* Values Table */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="p-4 bg-gray-50 border-b">
                <h3 className="font-semibold text-gray-800 flex items-center">
                  <Icon name="list" className="mr-2 text-amber-500" />
                  Enumerationswerte
                  <span className="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full">
                    {data.values.length}
                  </span>
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Wert</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Beschreibung</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {data.values.map((val, idx) => (
                      <tr key={idx} className={`hover:bg-gray-50 ${val.deprecated ? 'opacity-60' : ''}`}>
                        <td className="px-4 py-3">
                          <code className="text-amber-700 font-semibold bg-amber-50 px-2 py-0.5 rounded">
                            {val.name}
                          </code>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            {val.numericValue !== undefined && (
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-sm font-mono">
                                {val.numericValue}
                              </span>
                            )}
                            {val.hexValue && (
                              <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
                                {val.hexValue}
                              </span>
                            )}
                            {val.numericValue === undefined && !val.hexValue && (
                              <span className="text-gray-400 text-sm">-</span>
                            )}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                          {val.description || '-'}
                          {val.germanText && (
                            <p className="text-gray-400 text-xs mt-1 italic">{val.germanText}</p>
                          )}
                          {val.usage && (
                            <p className="text-blue-600 text-xs mt-1">
                              <Icon name="lightbulb" className="mr-1" />
                              {val.usage}
                            </p>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          {val.deprecated ? (
                            <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                              <Icon name="exclamation-triangle" className="mr-1" />
                              Veraltet
                            </span>
                          ) : (
                            <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                              <Icon name="check" className="mr-1" />
                              Aktiv
                            </span>
                          )}
                          {val.since && (
                            <span className="block text-gray-400 text-xs mt-1">
                              Seit: {val.since}
                            </span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Additional Info Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Type Info */}
              {data.typeInfo && (data.typeInfo.asn1Type || data.typeInfo.javaType || data.typeInfo.cType) && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="code" className="mr-2 text-purple-500" />
                    Typ-Informationen
                  </h3>
                  <div className="space-y-2">
                    {data.typeInfo.asn1Type && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">ASN.1 Type</span>
                        <code className="text-sm text-purple-600">{data.typeInfo.asn1Type}</code>
                      </div>
                    )}
                    {data.typeInfo.javaType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Java Type</span>
                        <code className="text-sm text-orange-600">{data.typeInfo.javaType}</code>
                      </div>
                    )}
                    {data.typeInfo.cType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">C Type</span>
                        <code className="text-sm text-blue-600">{data.typeInfo.cType}</code>
                      </div>
                    )}
                    {data.typeInfo.encoding && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Encoding</span>
                        <code className="text-sm text-green-600">{data.typeInfo.encoding}</code>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Usage Context */}
              {data.usageContext && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="crosshairs" className="mr-2 text-blue-500" />
                    Verwendungskontext
                  </h3>
                  <p className="text-gray-600 text-sm">{data.usageContext}</p>
                </div>
              )}

              {/* Constraints */}
              {data.constraints && data.constraints.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="lock" className="mr-2 text-red-500" />
                    Einschränkungen
                  </h3>
                  <div className="space-y-2">
                    {data.constraints.map((c, idx) => (
                      <div key={idx} className="p-2 bg-red-50 rounded border-l-2 border-red-300">
                        <span className="font-medium text-red-700 text-sm">{c.type}</span>
                        {c.description && (
                          <p className="text-red-600 text-xs mt-1">{c.description}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Related Enumerations */}
              {data.relatedEnumerations && data.relatedEnumerations.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="link" className="mr-2 text-amber-500" />
                    Verwandte Enums
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {data.relatedEnumerations.map((rel, idx) => (
                      <span 
                        key={idx}
                        className="px-3 py-1 bg-amber-50 text-amber-700 rounded-full text-sm cursor-pointer hover:bg-amber-100 transition-colors"
                        onClick={() => onNavigateToEnum && onNavigateToEnum(rel)}
                      >
                        {rel}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Notes */}
              {data.notes && data.notes.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                    Hinweise
                  </h3>
                  <ul className="space-y-2">
                    {data.notes.map((note, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-start">
                        <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                        {note}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* Metadata Footer */}
            {(data.version || data.lastModified) && (
              <div className="mt-6 p-4 bg-gray-50 rounded-lg border text-sm text-gray-500">
                <div className="flex items-center gap-4">
                  {data.version && (
                    <span>
                      <Icon name="tag" className="mr-1" />
                      Version: {data.version}
                    </span>
                  )}
                  {data.lastModified && (
                    <span>
                      <Icon name="clock" className="mr-1" />
                      Zuletzt geändert: {data.lastModified}
                    </span>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================
    // Exception Detail View Component
    // ============================================

    const ExceptionDetailView = ({ instance, exceptionId, onBack, onNavigateToFunction, onNavigateToException }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('overview');

      useEffect(() => {
        loadException();
      }, [instance, exceptionId]);

      const loadException = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/exception/${exceptionId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.exception);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading exception:', err);
          setError('Fehler beim Laden der Exception');
        }
        setLoading(false);
      };

      const getSeverityColor = (severity) => {
        switch (severity) {
          case 'Critical': return { bg: 'bg-red-500', light: 'bg-red-100', text: 'text-red-700', border: 'border-red-300' };
          case 'High': return { bg: 'bg-orange-500', light: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-300' };
          case 'Medium': return { bg: 'bg-yellow-500', light: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-300' };
          case 'Low': return { bg: 'bg-green-500', light: 'bg-green-100', text: 'text-green-700', border: 'border-green-300' };
          default: return { bg: 'bg-gray-500', light: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-300' };
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      const severityColor = getSeverityColor(data.severity);

      const tabs = [
        { id: 'overview', label: 'Übersicht', icon: 'info-circle' },
        { id: 'trigger', label: 'Auslöser', icon: 'bolt' },
        { id: 'handling', label: 'Behandlung', icon: 'first-aid' },
        { id: 'scenarios', label: 'Szenarien', icon: 'flask' }
      ];

      return (
        <div className="p-4 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Back Button */}
            <button
              onClick={onBack}
              className="mb-3 flex items-center text-gray-600 hover:text-gray-900 transition-colors text-sm"
            >
              <Icon name="arrow-left" className="mr-1" />
              Zurück
            </button>

            {/* Compact Header */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-4">
              <div className={`${severityColor.bg} p-4 text-white`}>
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                      <Icon name="exclamation-triangle" className="text-2xl" />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-2 mt-1 flex-wrap">
                        <span className="px-2 py-0.5 bg-white/20 rounded text-xs">{data.category}</span>
                        {data.subcategory && (
                          <span className="px-2 py-0.5 bg-white/10 rounded text-xs">{data.subcategory}</span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
                      {data.severity}
                    </span>
                    {data.thrownBy && data.thrownBy.length > 0 && (
                      <span className="px-3 py-1 bg-white/10 rounded-full text-xs">
                        {data.thrownBy.length} Funktionen
                      </span>
                    )}
                  </div>
                </div>
              </div>

              {/* Description - compact */}
              <div className="p-4 bg-gray-50 border-b">
                <p className="text-gray-700 text-sm leading-relaxed">{data.description}</p>
              </div>

              {/* Tabs */}
              <div className="flex border-b bg-white overflow-x-auto">
                {tabs.map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors whitespace-nowrap ${
                      activeTab === tab.id
                        ? `${severityColor.text} border-current`
                        : 'text-gray-500 border-transparent hover:text-gray-700'
                    }`}
                  >
                    <Icon name={tab.icon} />
                    {tab.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Main Content with Sidebar */}
            <div className="flex gap-4 flex-col lg:flex-row">
              {/* Main Content Area */}
              <div className="flex-1 min-w-0">
                {/* Tab: Overview */}
                {activeTab === 'overview' && (
                  <div className="space-y-4">
                    {/* Javadoc */}
                    {data.javadoc && (data.javadoc.summary || data.javadoc.description) && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                          <Icon name="book" className="mr-2 text-indigo-500" />
                          Javadoc
                        </h3>
                        {data.javadoc.summary && (
                          <p className="text-gray-600 text-sm">{data.javadoc.summary}</p>
                        )}
                        {data.javadoc.description && data.javadoc.description !== data.javadoc.summary && (
                          <p className="text-gray-500 text-xs mt-2">{data.javadoc.description}</p>
                        )}
                        {data.javadoc.constructors && data.javadoc.constructors.length > 0 && (
                          <details className="mt-3">
                            <summary className="text-xs font-medium text-indigo-600 cursor-pointer hover:text-indigo-800">
                              {data.javadoc.constructors.length} Konstruktoren anzeigen
                            </summary>
                            <div className="mt-2 space-y-2 pl-3 border-l-2 border-indigo-100">
                              {data.javadoc.constructors.map((con, idx) => (
                                <div key={idx} className="text-xs">
                                  <code className="text-purple-600 bg-purple-50 px-1 rounded">{con.signature}</code>
                                  {con.description && <p className="text-gray-500 mt-1">{con.description}</p>}
                                </div>
                              ))}
                            </div>
                          </details>
                        )}
                      </div>
                    )}

                    {/* Specification */}
                    {data.specification && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                          <Icon name="file-contract" className="mr-2 text-purple-500" />
                          Spezifikation
                        </h3>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          {data.specification.source && (
                            <div>
                              <span className="text-xs text-gray-400 uppercase">Quelle</span>
                              <p className="text-gray-700">{data.specification.source}</p>
                            </div>
                          )}
                          {data.specification.section && (
                            <div>
                              <span className="text-xs text-gray-400 uppercase">Abschnitt</span>
                              <p className="text-gray-700 font-mono text-xs">{data.specification.section}</p>
                            </div>
                          )}
                        </div>
                        {data.specification.requirement && (
                          <div className="mt-3 p-2 bg-purple-50 rounded text-xs text-gray-700 border-l-2 border-purple-400">
                            {data.specification.requirement}
                          </div>
                        )}
                        {data.specification.applicability && (
                          <p className="mt-2 text-xs text-gray-500">
                            <span className="font-medium">Anwendbarkeit:</span> {data.specification.applicability}
                          </p>
                        )}
                      </div>
                    )}

                    {/* Notes & Implementation Context combined */}
                    {((data.notes && data.notes.length > 0) || (data.implementationContext && data.implementationContext.length > 0)) && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                          <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                          Hinweise & Kontext
                        </h3>
                        <div className="space-y-2">
                          {data.notes && data.notes.map((note, idx) => (
                            <div key={`note-${idx}`} className="flex items-start gap-2 text-xs text-gray-600">
                              <Icon name="angle-right" className="text-yellow-400 mt-0.5 flex-shrink-0" />
                              <span>{note}</span>
                            </div>
                          ))}
                          {data.implementationContext && data.implementationContext.map((note, idx) => (
                            <div key={`impl-${idx}`} className="flex items-start gap-2 text-xs text-gray-500">
                              <Icon name="cog" className="text-teal-400 mt-0.5 flex-shrink-0" />
                              <span>{note}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Tab: Trigger */}
                {activeTab === 'trigger' && (
                  <div className="space-y-4">
                    {/* Trigger Conditions */}
                    {data.triggerConditions && data.triggerConditions.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="bolt" className="mr-2 text-yellow-500" />
                          Auslösebedingungen
                          <span className="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">
                            {data.triggerConditions.length}
                          </span>
                        </h3>
                        <div className="space-y-3">
                          {data.triggerConditions.map((cond, idx) => (
                            <div key={idx} className="p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-l-3 border-yellow-400">
                              {cond.scenario && (
                                <div className="font-medium text-yellow-800 text-sm mb-1">{cond.scenario}</div>
                              )}
                              <p className="text-gray-700 text-xs">{cond.description}</p>
                              {cond.trigger && (
                                <div className="mt-2 p-2 bg-white/60 rounded text-xs text-gray-600">
                                  <span className="font-medium text-orange-600">Trigger:</span> {cond.trigger}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Execution Sequence */}
                    {data.executionSequence && data.executionSequence.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="list-ol" className="mr-2 text-indigo-500" />
                          Ausführungssequenz
                          <span className="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full">
                            {data.executionSequence.length} Schritte
                          </span>
                        </h3>
                        <div className="space-y-1">
                          {data.executionSequence.map((step, idx) => {
                            const isError = step.description.toLowerCase().includes('error') || 
                                           step.description.includes('→') ||
                                           (step.number && step.number.includes('a'));
                            return (
                              <div 
                                key={idx} 
                                className={`flex items-start gap-2 p-2 rounded text-xs ${
                                  isError ? 'bg-red-50 text-red-700' : 'bg-gray-50 text-gray-700'
                                }`}
                              >
                                <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                                  isError ? 'bg-red-200 text-red-800' : 'bg-indigo-100 text-indigo-700'
                                }`}>
                                  {step.number || idx + 1}
                                </span>
                                <div className="flex-1">
                                  {step.name && <span className="font-medium">{step.name}: </span>}
                                  {step.description}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Tab: Handling */}
                {activeTab === 'handling' && (
                  <div className="space-y-4">
                    {/* Recovery */}
                    {data.recovery && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="first-aid" className="mr-2 text-green-500" />
                          Wiederherstellung
                        </h3>
                        
                        {data.recovery.description && (
                          <p className="text-gray-600 text-sm mb-3">{data.recovery.description}</p>
                        )}
                        
                        {data.recovery.action && (
                          <div className="p-2 bg-green-50 rounded border-l-2 border-green-400 mb-2">
                            <span className="text-xs font-medium text-green-700">Empfohlene Aktion:</span>
                            <p className="text-gray-700 text-xs mt-1">{data.recovery.action}</p>
                          </div>
                        )}
                        
                        {data.recovery.alternativePath && (
                          <div className="p-2 bg-blue-50 rounded border-l-2 border-blue-400 mb-2">
                            <span className="text-xs font-medium text-blue-700">Alternativer Pfad:</span>
                            <p className="text-gray-700 text-xs mt-1">{data.recovery.alternativePath}</p>
                          </div>
                        )}
                        
                        {data.recovery.steps && data.recovery.steps.length > 0 && (
                          <ol className="space-y-1">
                            {data.recovery.steps.map((step, idx) => (
                              <li key={idx} className="flex items-start gap-2 text-xs text-gray-700">
                                <span className="flex-shrink-0 w-5 h-5 rounded-full bg-green-100 text-green-700 flex items-center justify-center text-xs font-medium">
                                  {idx + 1}
                                </span>
                                <span>{step}</span>
                              </li>
                            ))}
                          </ol>
                        )}
                      </div>
                    )}

                    {/* Postconditionality */}
                    {data.postconditionality && data.postconditionality.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="flag-checkered" className="mr-2 text-purple-500" />
                          Zustand nach Exception
                          <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">
                            {data.postconditionality.length}
                          </span>
                        </h3>
                        <div className="space-y-2">
                          {data.postconditionality.map((state, idx) => (
                            <div key={idx} className="p-2 bg-purple-50 rounded border-l-2 border-purple-400">
                              {state.name && (
                                <span className="text-xs font-semibold text-purple-700 block mb-1">{state.name}</span>
                              )}
                              <span className="text-gray-700 text-xs">{state.description || state}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Related Exceptions */}
                    {data.relatedExceptions && data.relatedExceptions.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="link" className="mr-2 text-orange-500" />
                          Verwandte Exceptions
                        </h3>
                        <div className="flex flex-wrap gap-2">
                          {data.relatedExceptions.map((exc, idx) => (
                            <span 
                              key={idx}
                              onClick={() => onNavigateToException && onNavigateToException(typeof exc === 'string' ? exc : exc.name)}
                              className="px-2 py-1 bg-red-50 text-red-700 rounded text-xs cursor-pointer hover:bg-red-100 transition-colors"
                            >
                              {typeof exc === 'string' ? exc : exc.name}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Tab: Scenarios */}
                {activeTab === 'scenarios' && (
                  <div className="space-y-4">
                    {/* Usage Scenarios */}
                    {data.usage && data.usage.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-sm">
                          <Icon name="flask" className="mr-2 text-cyan-500" />
                          Anwendungsszenarien
                          <span className="ml-2 px-2 py-0.5 bg-cyan-100 text-cyan-700 text-xs rounded-full">
                            {data.usage.length}
                          </span>
                        </h3>
                        <div className="space-y-3">
                          {data.usage.map((scenario, idx) => (
                            <div key={idx} className="p-3 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-lg border border-cyan-100">
                              <h4 className="font-medium text-cyan-800 text-sm mb-2">{scenario.name}</h4>
                              <p className="text-gray-700 text-xs mb-2">{scenario.description}</p>
                              
                              {scenario.relatedFunctions && (
                                <div className="flex flex-wrap gap-1 mb-2">
                                  {scenario.relatedFunctions.split(',').map((func, fIdx) => (
                                    <span key={fIdx} className="px-1.5 py-0.5 bg-cyan-100 text-cyan-700 rounded text-xs font-mono">
                                      {func.trim()}
                                    </span>
                                  ))}
                                </div>
                              )}
                              
                              {scenario.errorContext && (
                                <p className="text-xs text-orange-600 italic">
                                  <Icon name="exclamation-triangle" className="mr-1" />
                                  {scenario.errorContext}
                                </p>
                              )}
                              
                              {scenario.example && (
                                <pre className="mt-2 bg-gray-900 rounded p-2 overflow-x-auto">
                                  <code className="text-green-400 text-xs">{scenario.example}</code>
                                </pre>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Example (if exists) */}
                    {data.example && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                          <Icon name="code" className="mr-2 text-amber-500" />
                          Beispielcode
                        </h3>
                        <pre className="bg-gray-900 rounded p-3 overflow-x-auto">
                          <code className="text-green-400 text-xs">{data.example}</code>
                        </pre>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Sidebar */}
              <div className="lg:w-64 flex-shrink-0 space-y-4">
                {/* Thrown By */}
                {data.thrownBy && data.thrownBy.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                      <Icon name="code" className="mr-2 text-blue-500" />
                      Funktionen
                      <span className="ml-auto px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                        {data.thrownBy.length}
                      </span>
                    </h3>
                    <div className="max-h-48 overflow-y-auto space-y-1">
                      {data.thrownBy.map((func, idx) => (
                        <div 
                          key={idx}
                          onClick={() => onNavigateToFunction && onNavigateToFunction(func)}
                          className="flex items-center justify-between p-1.5 rounded hover:bg-blue-50 cursor-pointer text-xs group"
                        >
                          <code className="text-blue-600">{func}</code>
                          <Icon name="chevron-right" className="text-gray-300 group-hover:text-blue-500" />
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Quick Stats */}
                <div className={`rounded-lg p-4 ${severityColor.light} ${severityColor.border} border`}>
                  <div className="text-center">
                    <div className={`text-2xl font-bold ${severityColor.text}`}>{data.severity}</div>
                    <div className="text-xs text-gray-500 mt-1">Schweregrad</div>
                  </div>
                  <div className="mt-3 pt-3 border-t border-current/10 grid grid-cols-2 gap-2 text-center">
                    <div>
                      <div className="text-lg font-semibold text-gray-700">{data.thrownBy?.length || 0}</div>
                      <div className="text-xs text-gray-500">Funktionen</div>
                    </div>
                    <div>
                      <div className="text-lg font-semibold text-gray-700">{data.relatedExceptions?.length || 0}</div>
                      <div className="text-xs text-gray-500">Verwandt</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };


    // ============================================
    // Exceptions List Component
    // ============================================

    const ExceptionsView = ({ instance, onSelectItem }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterSeverity, setFilterSeverity] = useState('all');
      const [expandedCategories, setExpandedCategories] = useState({});
      const [activeCategory, setActiveCategory] = useState(null);
      const contentRef = useRef(null);
      const categoryRefs = useRef({});

      useEffect(() => {
        loadExceptions();
      }, [instance]);

      const loadExceptions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/exceptions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
            // Setze erste Kategorie als aktiv
            const cats = Object.keys(result.grouped || {});
            if (cats.length > 0) setActiveCategory(`cat-${cats[0].replace(/\s+/g, '-')}`);
          }
        } catch (err) {
          console.error('Error loading exceptions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const getSeverityColor = (severity) => {
        const colors = {
          'Critical': 'red',
          'High': 'orange',
          'Medium': 'yellow',
          'Low': 'green'
        };
        return colors[severity] || 'gray';
      };

      const getSeverityClasses = (severity) => {
        switch (severity) {
          case 'Critical': return 'bg-red-100 text-red-700';
          case 'High': return 'bg-orange-100 text-orange-700';
          case 'Medium': return 'bg-yellow-100 text-yellow-700';
          case 'Low': return 'bg-green-100 text-green-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => {
            const matchesSearch = !searchTerm || 
              item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              item.description?.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesSeverity = filterSeverity === 'all' || item.severity === filterSeverity;
            return matchesSearch && matchesSeverity;
          });
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm, filterSeverity]);

      // Scroll-Spy: Beobachte welche Kategorie gerade sichtbar ist
      useEffect(() => {
        if (!data?.grouped) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                setActiveCategory(entry.target.id);
              }
            });
          },
          {
            root: null,
            rootMargin: '-100px 0px -70% 0px',
            threshold: 0
          }
        );

        // Kurze Verzögerung um sicherzustellen, dass Refs gesetzt sind
        const timer = setTimeout(() => {
          Object.keys(categoryRefs.current).forEach(cat => {
            const el = categoryRefs.current[cat];
            if (el) observer.observe(el);
          });
        }, 100);

        return () => {
          clearTimeout(timer);
          observer.disconnect();
        };
      }, [data, searchTerm, filterSeverity]);

      const scrollToCategory = (category) => {
        const catId = `cat-${category.replace(/\s+/g, '-')}`;
        const element = categoryRefs.current[catId];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      const getCategoryId = (category) => `cat-${category.replace(/\s+/g, '-')}`;

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      const categories = Object.keys(filteredGroups);

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="exclamation-triangle" className="mr-3 text-red-600" />
                Exceptions
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="flex items-center gap-4">
                {/* Severity Filter */}
                <select
                  value={filterSeverity}
                  onChange={(e) => setFilterSeverity(e.target.value)}
                  className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                >
                  <option value="all">Alle Schweregrade</option>
                  <option value="Critical">Critical</option>
                  <option value="High">High</option>
                  <option value="Medium">Medium</option>
                  <option value="Low">Low</option>
                </select>

                {/* Search */}
                <div className="relative">
                  <input
                    type="text"
                    placeholder="Exception suchen..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  />
                  <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
                </div>
              </div>
            </div>

            {/* Main Content with TOC Sidebar */}
            <div className="flex gap-6">
              {/* Sticky TOC Sidebar */}
              <div className="hidden lg:block w-64 flex-shrink-0">
                <div className="sticky top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-700 mb-3 flex items-center text-sm">
                      <Icon name="list" className="mr-2 text-red-500" />
                      Kategorien
                      <span className="ml-auto text-xs text-gray-400">{categories.length}</span>
                    </h3>
                    <nav className="space-y-1 max-h-[calc(100vh-200px)] overflow-y-auto">
                      {categories.map(category => {
                        const catId = getCategoryId(category);
                        const isActive = activeCategory === catId;
                        const itemCount = filteredGroups[category]?.length || 0;
                        
                        return (
                          <button
                            key={category}
                            onClick={() => scrollToCategory(category)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between group ${
                              isActive 
                                ? 'bg-red-50 text-red-700 font-medium border-l-3 border-red-500' 
                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                            }`}
                          >
                            <span className="truncate flex-1">{category}</span>
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${
                              isActive ? 'bg-red-200 text-red-800' : 'bg-gray-100 text-gray-500 group-hover:bg-gray-200'
                            }`}>
                              {itemCount}
                            </span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>

                  {/* Quick Stats */}
                  <div className="bg-white rounded-lg shadow p-4 mt-4">
                    <h3 className="font-semibold text-gray-700 mb-3 text-sm">Statistik</h3>
                    <div className="grid grid-cols-2 gap-2 text-center">
                      {['Critical', 'High', 'Medium', 'Low'].map(sev => {
                        const count = Object.values(filteredGroups).flat().filter(e => e.severity === sev).length;
                        if (count === 0) return null;
                        return (
                          <div key={sev} className={`p-2 rounded ${getSeverityClasses(sev)}`}>
                            <div className="text-lg font-bold">{count}</div>
                            <div className="text-xs">{sev}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              {/* Exception List */}
              <div className="flex-1 min-w-0 space-y-4" ref={contentRef}>
                {Object.entries(filteredGroups).map(([category, items]) => {
                  const catId = getCategoryId(category);
                  return (
                    <div 
                      key={category} 
                      id={catId}
                      ref={el => categoryRefs.current[catId] = el}
                      className="bg-white rounded-lg shadow overflow-hidden scroll-mt-4"
                    >
                      <div 
                        className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                        onClick={() => toggleCategory(category)}
                      >
                        <div className="flex items-center gap-3">
                          <Icon 
                            name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                            className="text-gray-400"
                          />
                          <span className="font-semibold text-gray-700">{category}</span>
                          <span className="badge bg-red-100 text-red-700 rounded-full">{items.length}</span>
                        </div>
                      </div>

                      {expandedCategories[category] && (
                        <div className="divide-y">
                          {items.map(exc => {
                            return (
                              <div 
                                key={exc.id}
                                className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                                onClick={() => onSelectItem && onSelectItem('exception', exc)}
                              >
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <code className="text-red-600 font-semibold">{exc.name}</code>
                                      <span className={`badge rounded ${getSeverityClasses(exc.severity)}`}>
                                        {exc.severity}
                                      </span>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-1 line-clamp-2">{exc.description}</p>
                                    {exc.thrownByCount > 0 && (
                                      <div className="flex items-center gap-2 mt-2 text-xs text-gray-500">
                                        <Icon name="code" className="mr-1" />
                                        Verwendet in {exc.thrownByCount} Funktion{exc.thrownByCount !== 1 ? 'en' : ''}
                                      </div>
                                    )}
                                  </div>
                                  <Icon name="chevron-right" className="text-gray-300" />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Main Application Component
    // ============================================

    const InterfaceDesignApp = () => {
      // Parse initial state from URL
      const initialRoute = parseUrlRoute();
      
      const [instance, setInstance] = useState(initialRoute.instance);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [notification, setNotification] = useState(null);
      const [activeView, setActiveView] = useState(initialRoute.activeView);
      const [overview, setOverview] = useState(null);
      const [hasTestCases, setHasTestCases] = useState(false);
      const [selectedItem, setSelectedItem] = useState(initialRoute.selectedItem);
      
      // Initialize
      useEffect(() => {
        const route = parseUrlRoute();
        setInstance(route.instance);
        setActiveView(route.activeView);
        setSelectedItem(route.selectedItem);
        
        if (route.instance) {
          loadOverview(route.instance);
        } else {
          setLoading(false);
        }

        // Handle browser back/forward buttons
        const handlePopState = (event) => {
          const route = parseUrlRoute();
          setActiveView(route.activeView);
          setSelectedItem(route.selectedItem);
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      // Update URL when view changes
      const navigateToView = useCallback((view, itemId = null, replace = false) => {
        setActiveView(view);
        if (itemId) {
          setSelectedItem({ type: view.replace('-detail', ''), item: { id: itemId } });
        } else if (!view.includes('-detail')) {
          setSelectedItem(null);
        }
        updateUrl(instance, view, itemId, replace);
      }, [instance]);

      const loadOverview = async (inst) => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(inst || instance, '/overview'));
          const data = await response.json();
          if (data.success) {
            setOverview(data.overview);
            setHasTestCases(data.hasTestCases || false);
          }
          setLoading(false);
        } catch (err) {
          setError('Fehler beim Laden der Daten');
          setLoading(false);
        }
      };

      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      const handleSelectItem = (type, item) => {
        const detailView = `${type}-detail`;
        setSelectedItem({ type, item });
        setActiveView(detailView);
        updateUrl(instance, detailView, item.id);
      };

      const handleBackFromDetail = () => {
        const previousType = selectedItem?.type;
        setSelectedItem(null);
        // Return to the appropriate list view based on type
        let listView = 'overview';
        if (previousType === 'exception') {
          listView = 'exceptions';
        } else if (previousType === 'enum') {
          listView = 'enums';
        } else if (previousType === 'function') {
          listView = 'functions';
        } else if (previousType === 'type') {
          listView = 'types';
        }
        setActiveView(listView);
        updateUrl(instance, listView);
      };

      const handleNavigateToFunction = (funcName) => {
        setSelectedItem({ type: 'function', item: { id: funcName } });
        setActiveView('function-detail');
        updateUrl(instance, 'function-detail', funcName);
      };

      const handleNavigateToEnum = (enumName) => {
        setSelectedItem({ type: 'enum', item: { id: enumName } });
        setActiveView('enum-detail');
        updateUrl(instance, 'enum-detail', enumName);
      };

      const handleNavigateToException = (excName) => {
        setSelectedItem({ type: 'exception', item: { id: excName } });
        setActiveView('exception-detail');
        updateUrl(instance, 'exception-detail', excName);
      };

      const handleNavigateToType = (typeName) => {
        setSelectedItem({ type: 'type', item: { id: typeName } });
        setActiveView('type-detail');
        updateUrl(instance, 'type-detail', typeName);
      };

      // Handle navigation from sidebar and overview
      const handleViewChange = (view) => {
        setActiveView(view);
        setSelectedItem(null);
        updateUrl(instance, view);
      };

      // Loading state
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-gray-600">Lade Schnittstellenbeschreibung...</p>
            </div>
          </div>
        );
      }

      // No instance selected
      if (!instance) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <Icon name="exclamation-triangle" className="text-6xl text-yellow-500 mb-4" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">Keine Instanz ausgewählt</h1>
              <p className="text-gray-600 mb-4">Bitte wählen Sie zuerst eine Instanz aus.</p>
              <a 
                href="/"
                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
              >
                <Icon name="home" className="mr-2" />
                Zur Instanzauswahl
              </a>
            </div>
          </div>
        );
      }

      // Render the appropriate view
      const renderMainContent = () => {
        switch (activeView) {
          case 'overview':
            return <OverviewView overview={overview} onNavigate={handleViewChange} />;
          case 'functions':
            return <FunctionsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'function-detail':
            return (
              <FunctionDetailView 
                instance={instance} 
                functionId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToType={handleNavigateToType}
                onNavigateToEnum={handleNavigateToEnum}
                onNavigateToException={handleNavigateToException}
              />
            );
          case 'types':
            return <TypesView instance={instance} onSelectItem={handleSelectItem} />;
          case 'type-detail':
            return (
              <TypeDetailView 
                instance={instance} 
                typeId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToType={handleNavigateToType}
                onNavigateToEnum={handleNavigateToEnum}
              />
            );
          case 'enums':
            return <EnumsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'enum-detail':
            return (
              <EnumDetailView 
                instance={instance} 
                enumId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToEnum={handleNavigateToEnum}
              />
            );
          case 'exceptions':
            return <ExceptionsView instance={instance} onSelectItem={handleSelectItem} />;
          case 'exception-detail':
            return (
              <ExceptionDetailView 
                instance={instance} 
                exceptionId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToFunction={handleNavigateToFunction}
                onNavigateToException={handleNavigateToException}
              />
            );
          default:
            return <OverviewView overview={overview} onNavigate={handleViewChange} />;
        }
      };

      return (
        <div className="h-screen bg-gray-50 flex flex-col overflow-hidden">
          {/* Notification */}
          {notification && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded shadow-lg fade-in ${
              notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
              {notification.message}
            </div>
          )}

          {/* Header */}
          <header className="bg-gradient-to-r from-emerald-700 to-emerald-900 text-white px-6 py-3 shadow-lg flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3">
                  <a 
                    href="/"
                    className="p-1.5 hover:bg-emerald-600 rounded transition-colors"
                    title="Zur Instanzauswahl"
                  >
                    <Icon name="home" />
                  </a>
                  <h1 className="text-xl font-bold flex items-center">
                    <Icon name="project-diagram" className="mr-2" />
                    Schnittstellenbeschreibung
                  </h1>
                  <span className="px-2 py-0.5 bg-emerald-600 rounded text-sm font-normal">
                    {instance}
                  </span>
                </div>
              </div>

              <div className="flex items-center gap-4">
                {/* Link to TestCases - only show if testcases module is active */}
                {hasTestCases && (
                  <a
                    href={`/${instance}`}
                    className="flex items-center text-sm text-emerald-200 hover:text-white transition-colors"
                    title="Zum Testcase Manager"
                  >
                    <Icon name="flask" className="mr-1" />
                    TestCases
                  </a>
                )}
                
                {/* Refresh Button */}
                <button
                  onClick={() => loadOverview()}
                  className="p-2 hover:bg-emerald-600 rounded transition-colors"
                  title="Aktualisieren"
                >
                  <Icon name="sync-alt" />
                </button>
              </div>
            </div>
          </header>

          {/* Error Banner */}
          {error && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
              <div className="flex items-center">
                <Icon name="exclamation-triangle" className="mr-2" />
                <p>{error}</p>
                <button
                  onClick={() => setError(null)}
                  className="ml-4 text-red-700 hover:text-red-900"
                >
                  <Icon name="times" />
                </button>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="flex flex-1 overflow-hidden min-h-0">
            {/* Sidebar */}
            <Sidebar 
              activeView={activeView} 
              onViewChange={handleViewChange} 
              overview={overview}
              loading={loading}
            />

            {/* Main Area */}
            <main className="flex-1 overflow-y-auto bg-gray-100">
              {renderMainContent()}
            </main>
          </div>
        </div>
      );
    };

    // ============================================
    // Render Application
    // ============================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InterfaceDesignApp />);
  </script>
</body>
</html>
