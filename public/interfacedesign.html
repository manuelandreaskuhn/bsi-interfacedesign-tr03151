<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interface Design - Schnittstellenbeschreibung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Mermaid 11 for Flowchart rendering (ESM) -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    window.mermaid = mermaid;
    mermaid.initialize({ startOnLoad: false });
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/interfacedesign.css">
  <style>
    /* Additional inline styles for Interface Design module */
    .nav-item {
      transition: all 0.2s ease;
    }
    .nav-item:hover {
      background-color: rgba(16, 185, 129, 0.1);
    }
    .nav-item.active {
      background-color: rgba(16, 185, 129, 0.15);
      border-left: 3px solid #10b981;
    }
    .category-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .item-card {
      transition: all 0.2s ease;
    }
    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
    }
    /* Mermaid Flowchart Styles */
    .mermaid-container {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 8px;
    }
    .mermaid-container svg {
      max-width: 100%;
      height: auto;
    }
    .mermaid-container .node rect,
    .mermaid-container .node circle,
    .mermaid-container .node ellipse,
    .mermaid-container .node polygon,
    .mermaid-container .node path {
      stroke-width: 2px;
    }
    .mermaid-container .edgeLabel {
      background-color: white;
      padding: 2px 4px;
      border-radius: 4px;
    }
    /* Fix for Tailwind CSS interference with Mermaid edge labels */
    .mermaid-container .edgeLabel foreignObject {
      overflow: visible !important;
    }
    .mermaid-container .edgeLabel foreignObject > div,
    .mermaid-container .edgeLabel .labelBkg {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      line-height: 1.2 !important;
      min-height: auto !important;
      height: auto !important;
    }
    .mermaid-container .edgeLabel span {
      line-height: 1.2 !important;
    }
    .mermaid-container .flowchart-link {
      stroke-width: 2px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    // ============================================
    // Helper Functions
    // ============================================

    // Get instance from URL path
    const getInstance = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      return pathParts[0] || null;
    };

    // API URL helper
    const getApiUrl = (instance, endpoint) => {
      return `/api/${instance}/interfacedesign${endpoint}`;
    };

    /**
     * Get text for a specific language from a multilingual object
     * Supports: { de: "...", en: "...", _default: "..." } or plain string
     * @param {Object|string} obj - Multilingual object or plain string
     * @param {string} lang - Language code ('de' or 'en')
     * @returns {string} - Text in requested language or fallback
     */
    const getText = (obj, lang = 'de') => {
      if (!obj) return '';
      if (typeof obj === 'string') return obj;
      return obj[lang] || obj._default || obj.de || obj.en || '';
    };

    // ============================================
    // URL Routing Helpers
    // ============================================

    // Parse the current URL to determine view and item
    const parseUrlRoute = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      // pathParts[0] = instance
      // pathParts[1] = 'interfacedesign'
      // pathParts[2] = view (functions, types, enums, exceptions, processes, function, type, enum, exception, process)
      // pathParts[3] = id (for detail views) or actor (for process)
      // pathParts[4] = type (for process detail - flow/sequenz)
      // pathParts[5] = id (for process detail)
      
      const instance = pathParts[0] || null;
      const viewPart = pathParts[2] || 'overview';
      const itemId = pathParts[3] || null;
      
      let activeView = 'overview';
      let selectedItem = null;
      
      // Map URL to view
      switch (viewPart) {
        case 'functions':
          activeView = 'functions';
          break;
        case 'function':
          if (itemId) {
            activeView = 'function-detail';
            selectedItem = { type: 'function', item: { id: itemId } };
          } else {
            activeView = 'functions';
          }
          break;
        case 'types':
          activeView = 'types';
          break;
        case 'type':
          if (itemId) {
            activeView = 'type-detail';
            selectedItem = { type: 'type', item: { id: itemId } };
          } else {
            activeView = 'types';
          }
          break;
        case 'enums':
          activeView = 'enums';
          break;
        case 'enum':
          if (itemId) {
            activeView = 'enum-detail';
            selectedItem = { type: 'enum', item: { id: itemId } };
          } else {
            activeView = 'enums';
          }
          break;
        case 'exceptions':
          activeView = 'exceptions';
          break;
        case 'exception':
          if (itemId) {
            activeView = 'exception-detail';
            selectedItem = { type: 'exception', item: { id: itemId } };
          } else {
            activeView = 'exceptions';
          }
          break;
        case 'processes':
          activeView = 'processes';
          break;
        case 'process':
          // URL: /instance/interfacedesign/process/actor/type/id
          const actor = pathParts[3] || null;
          const diagramType = pathParts[4] || null;
          const processId = pathParts[5] || null;
          if (actor && diagramType && processId) {
            activeView = 'process-detail';
            selectedItem = { 
              type: 'process', 
              item: { 
                id: processId,
                actor: actor,
                diagramType: diagramType
              } 
            };
          } else {
            activeView = 'processes';
          }
          break;
        case 'processchains':
          activeView = 'processchains';
          break;
        case 'processchain':
          // URL: /instance/interfacedesign/processchain/id
          const chainId = pathParts[3] || null;
          if (chainId) {
            activeView = 'processchain-detail';
            selectedItem = { 
              type: 'processchain', 
              item: { id: chainId } 
            };
          } else {
            activeView = 'processchains';
          }
          break;
        case 'processmap':
          activeView = 'processmap';
          break;
        default:
          activeView = 'overview';
      }
      
      return { instance, activeView, selectedItem };
    };

    // Build URL for a given view and item
    const buildUrl = (instance, view, itemId = null, processInfo = null) => {
      let url = `/${instance}/interfacedesign`;
      
      switch (view) {
        case 'overview':
          // No additional path
          break;
        case 'functions':
          url += '/functions';
          break;
        case 'function-detail':
          url += `/function/${itemId}`;
          break;
        case 'types':
          url += '/types';
          break;
        case 'type-detail':
          url += `/type/${itemId}`;
          break;
        case 'enums':
          url += '/enums';
          break;
        case 'enum-detail':
          url += `/enum/${itemId}`;
          break;
        case 'exceptions':
          url += '/exceptions';
          break;
        case 'exception-detail':
          url += `/exception/${itemId}`;
          break;
        case 'processes':
          url += '/processes';
          break;
        case 'process-detail':
          if (processInfo) {
            url += `/process/${processInfo.actor}/${processInfo.diagramType}/${itemId}`;
          }
          break;
        case 'processchains':
          url += '/processchains';
          break;
        case 'processchain-detail':
          url += `/processchain/${itemId}`;
          break;
        case 'processmap':
          url += '/processmap';
          break;
        default:
          break;
      }
      
      return url;
    };

    // Update browser URL without page reload
    const updateUrl = (instance, view, itemId = null, replace = false, processInfo = null) => {
      const url = buildUrl(instance, view, itemId, processInfo);
      if (replace) {
        window.history.replaceState({ view, itemId, processInfo }, '', url);
      } else {
        window.history.pushState({ view, itemId, processInfo }, '', url);
      }
    };

    // ============================================
    // Icon Component
    // ============================================

    const Icon = ({ name, className = '' }) => (
      <i className={`fas fa-${name} ${className}`}></i>
    );

    // ============================================
    // Page Title Hook
    // ============================================
    
    const usePageTitle = (title) => {
      useEffect(() => {
        const baseTitle = 'Interface Design - Schnittstellenbeschreibung';
        document.title = title ? `${title} - ${baseTitle}` : baseTitle;
        return () => {
          document.title = baseTitle;
        };
      }, [title]);
    };

    // ============================================
    // Detail Navigation Component
    // ============================================

    const DetailNavigation = ({ 
      category,           // 'functions', 'types', 'enums', 'exceptions', 'processes', 'processchains'
      currentId,          // Current item ID
      currentName,        // Current item name for display
      items,              // All items in the category (flat or grouped)
      groupedItems,       // Grouped items { groupName: [items] }
      currentGroup,       // Current group name (optional)
      onBack,             // Go back to category list
      onNavigate,         // Navigate to specific item
      onHistoryBack,      // Go back in history (optional)
      previousPage,       // Previous page info { title, view } (optional)
      language = 'de'
    }) => {
      const [prevItem, setPrevItem] = useState(null);
      const [nextItem, setNextItem] = useState(null);

      // Category labels
      const categoryLabels = {
        functions: { de: 'Funktionen', en: 'Functions' },
        types: { de: 'Datentypen', en: 'Types' },
        enums: { de: 'Aufzählungen', en: 'Enumerations' },
        exceptions: { de: 'Exceptions', en: 'Exceptions' },
        processes: { de: 'Prozesse', en: 'Processes' },
        processchains: { de: 'Prozessketten', en: 'Process Chains' }
      };

      const categoryLabel = categoryLabels[category]?.[language] || category;

      // Calculate prev/next items
      useEffect(() => {
        if (!currentId) return;

        let flatItems = [];
        
        if (groupedItems && Object.keys(groupedItems).length > 0) {
          // For grouped items, flatten them in order
          Object.keys(groupedItems).sort().forEach(groupName => {
            const groupItems = groupedItems[groupName] || [];
            // Sort items within group
            const sorted = [...groupItems].sort((a, b) => {
              if(category === "processes") {
                const aId = (a.baseName || a.id || '');
                const bId = (b.baseName || b.id || '');
                return aId.localeCompare(bId);
              }
              const aName = getText(a.name || a.baseName || a.id || '', language);
              const bName = getText(b.name || b.baseName || b.id || '', language);
              return aName.localeCompare(bName);
            });
            flatItems.push(...sorted.map(item => ({ ...item, _group: groupName })));
          });
        } else if (items && items.length > 0) {
          // For non-grouped items
          flatItems = [...items].sort((a, b) => {
            if(category === 'processchains') {
              const aChainId = (a.chainId || a.id || '');
              const bChainId = (b.chainId || b.id || '');
              return aChainId.localeCompare(bChainId);
            }

            const aName = getText(a.name || a.baseName || a.chainId || a.id || '', language);
            const bName = getText(b.name || b.baseName || b.chainId || b.id || '', language);
            return aName.localeCompare(bName);
          });
        }

        // Find current index
        const currentIndex = flatItems.findIndex(item => {
          const itemId = getText(item.baseName || item.chainId || item.id || item.name, language);
          return itemId === currentId;
        });

        if (currentIndex > 0) {
          setPrevItem(flatItems[currentIndex - 1]);
        } else {
          setPrevItem(null);
        }

        if (currentIndex >= 0 && currentIndex < flatItems.length - 1) {
          setNextItem(flatItems[currentIndex + 1]);
        } else {
          setNextItem(null);
        }
      }, [currentId, items, groupedItems]);

      const getItemDisplayName = (item) => {
        if (!item) return '';
        return getText(item.name || item.baseName || item.chainId || item.id || '', language);
      };

      const handleNavigate = (item) => {
        if (item && onNavigate) {
          onNavigate(item);
        }
      };

      return (
        <div className="bg-white border-b sticky top-0 z-10 shadow-sm">
          <div className="max-w-7xl mx-auto px-4 py-2">
            <div className="flex items-center justify-between flex-wrap gap-2">
              {/* Left side: Back buttons */}
              <div className="flex items-center gap-2">
                {/* History back */}
                {onHistoryBack && (
                  <button
                    onClick={onHistoryBack}
                    className="flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                    title={language === 'de' ? 'Zurück' : 'Back'}
                  >
                    <Icon name="arrow-left" />
                    {previousPage?.title && (
                      <span className="hidden sm:inline max-w-[150px] truncate">{previousPage.title}</span>
                    )}
                  </button>
                )}
                
                {/* Back to category list */}
                <button
                  onClick={onBack}
                  className="flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors border-l border-gray-200 ml-1 pl-3"
                >
                  <Icon name="th-list" />
                  <span className="hidden sm:inline">{categoryLabel}</span>
                </button>
              </div>

              {/* Center: Current position info */}
              <div className="hidden md:flex items-center text-sm text-gray-500">
                {currentGroup && (
                  <span className="px-2 py-0.5 bg-gray-100 rounded text-xs mr-2">
                    {currentGroup}
                  </span>
                )}
                <span className="font-medium text-gray-700">{currentName}</span>
              </div>

              {/* Right side: Prev/Next navigation */}
              <div className="flex items-center gap-1">
                <button
                  onClick={() => handleNavigate(prevItem)}
                  disabled={!prevItem}
                  className={`flex items-center gap-1 px-3 py-1.5 text-sm rounded transition-colors ${
                    prevItem 
                      ? 'text-gray-600 hover:text-gray-800 hover:bg-gray-100' 
                      : 'text-gray-300 cursor-not-allowed'
                  }`}
                  title={prevItem ? getItemDisplayName(prevItem) : (language === 'de' ? 'Kein vorheriger Eintrag' : 'No previous entry')}
                >
                  <Icon name="chevron-left" />
                  <span className="hidden sm:inline max-w-[150px] truncate">
                    {prevItem ? getItemDisplayName(prevItem) : (language === 'de' ? 'Vorheriger' : 'Previous')}
                  </span>
                </button>
                
                <div className="w-px h-4 bg-gray-200" />
                
                <button
                  onClick={() => handleNavigate(nextItem)}
                  disabled={!nextItem}
                  className={`flex items-center gap-1 px-3 py-1.5 text-sm rounded transition-colors ${
                    nextItem 
                      ? 'text-gray-600 hover:text-gray-800 hover:bg-gray-100' 
                      : 'text-gray-300 cursor-not-allowed'
                  }`}
                  title={nextItem ? getItemDisplayName(nextItem) : (language === 'de' ? 'Kein nächster Eintrag' : 'No next entry')}
                >
                  <span className="hidden sm:inline max-w-[150px] truncate">
                    {nextItem ? getItemDisplayName(nextItem) : (language === 'de' ? 'Nächster' : 'Next')}
                  </span>
                  <Icon name="chevron-right" />
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Navigation Items Configuration
    // ============================================

    const NAV_ITEMS = [
      { 
        id: 'processmap', 
        label: 'Prozesslandkarte', 
        label_en: 'Process Map',
        icon: 'map',
        color: 'emerald',
        description: 'Übersicht aller Prozesse und Prozessketten',
        description_en: 'Overview of all processes and process chains'
      },
      { 
        id: 'functions', 
        label: 'Funktionen', 
        label_en: 'Functions',
        icon: 'code',
        color: 'blue',
        description: 'API-Funktionen der Schnittstelle',
        description_en: 'API functions of the interface'
      },
      { 
        id: 'types', 
        label: 'Datentypen', 
        label_en: 'Data Types',
        icon: 'cube',
        color: 'purple',
        description: 'Komplexe Datentypen und Strukturen',
        description_en: 'Complex data types and structures'
      },
      { 
        id: 'enums', 
        label: 'Aufzählungen', 
        label_en: 'Enumerations',
        icon: 'list-ol',
        color: 'amber',
        description: 'Enumerationen und Konstanten',
        description_en: 'Enumerations and constants'
      },
      { 
        id: 'exceptions', 
        label: 'Exceptions', 
        label_en: 'Exceptions',
        icon: 'exclamation-triangle',
        color: 'red',
        description: 'Fehler und Ausnahmen',
        description_en: 'Errors and exceptions'
      },
      { 
        id: 'processes', 
        label: 'Prozesse', 
        label_en: 'Processes',
        icon: 'project-diagram',
        color: 'teal',
        description: 'Ablaufdiagramme und Prozessbeschreibungen',
        description_en: 'Flowcharts and process descriptions'
      },
      { 
        id: 'processchains', 
        label: 'Prozessketten', 
        label_en: 'Process Chains',
        icon: 'link',
        color: 'indigo',
        description: 'Verkettete Prozessabläufe und Workflows',
        description_en: 'Chained process flows and workflows'
      }
    ];

    // ============================================
    // Sidebar Navigation Component
    // ============================================

    const Sidebar = ({ activeView, onViewChange, overview, loading, language }) => {
      return (
        <aside className="w-72 bg-white border-r flex flex-col flex-shrink-0 overflow-hidden min-h-0">
          <div className="p-4 border-b bg-gray-50">
            <h2 className="font-semibold text-gray-700 flex items-center">
              <Icon name="sitemap" className="mr-2 text-emerald-600" />
              {language === 'de' ? 'Schnittstellen-Navigation' : 'Interface Navigation'}
            </h2>
          </div>
          <nav className="flex-1 overflow-y-auto">
            {/* Overview */}
            <div 
              className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 border-b ${activeView === 'overview' ? 'active' : ''}`}
              onClick={() => onViewChange('overview')}
            >
              <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Icon name="th-large" className="text-emerald-600" />
              </div>
              <div className="flex-1">
                <div className="font-medium text-gray-800">{language === 'de' ? 'Übersicht' : 'Overview'}</div>
                <div className="text-xs text-gray-500">{language === 'de' ? 'Alle Kategorien' : 'All Categories'}</div>
              </div>
            </div>

            {/* Category Navigation */}
            <div className="py-2">
              <div className="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                Kategorien
              </div>
              {NAV_ITEMS.map(item => {
                const count = overview?.[item.id]?.count || 0;
                const categoryCount = overview?.[item.id]?.categories 
                  ? Object.keys(overview[item.id].categories).length 
                  : 0;
                
                // processmap doesn't have a count, it's a special navigation item
                const showCount = item.id !== 'processmap';
                const showGroups = item.id !== 'processmap' && item.id !== "processchains";
                
                const bgColorClass = `bg-${item.color}-100`;
                const textColorClass = `text-${item.color}-600`;
                const badgeBgClass = `bg-${item.color}-100`;
                const badgeTextClass = `text-${item.color}-700`;
                
                return (
                  <div 
                    key={item.id}
                    className={`nav-item px-4 py-3 cursor-pointer flex items-center gap-3 ${
                      activeView === item.id || 
                      (item.id === 'functions' && activeView === 'function-detail') ||
                      (item.id === 'exceptions' && activeView === 'exception-detail') ||
                      (item.id === 'enums' && activeView === 'enum-detail') ||
                      (item.id === 'types' && activeView === 'type-detail') ||
                      (item.id === 'processes' && activeView === 'process-detail') ||
                      (item.id === 'processchains' && activeView === 'processchain-detail') ? 'active' : ''
                    }`}
                    onClick={() => onViewChange(item.id)}
                  >
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                      item.color === 'blue' ? 'bg-blue-100' :
                      item.color === 'purple' ? 'bg-purple-100' :
                      item.color === 'amber' ? 'bg-amber-100' :
                      item.color === 'red' ? 'bg-red-100' :
                      item.color === 'teal' ? 'bg-teal-100' :
                      item.color === 'indigo' ? 'bg-indigo-100' :
                      item.color === 'emerald' ? 'bg-emerald-100' : 'bg-gray-100'
                    }`}>
                      <Icon name={item.icon} className={
                        item.color === 'blue' ? 'text-blue-600' :
                        item.color === 'purple' ? 'text-purple-600' :
                        item.color === 'amber' ? 'text-amber-600' :
                        item.color === 'red' ? 'text-red-600' :
                        item.color === 'teal' ? 'text-teal-600' :
                        item.color === 'indigo' ? 'text-indigo-600' :
                        item.color === 'emerald' ? 'text-emerald-600' : 'text-gray-600'
                      } />
                    </div>
                    <div className="flex-1">
                      <div className="font-medium text-gray-800 flex items-center justify-between">
                        <span>{language === 'de' ? item.label : item.label_en}</span>
                        {!loading && showCount && (
                          <span className={`badge rounded-full ${
                            item.color === 'blue' ? 'bg-blue-100 text-blue-700' :
                            item.color === 'purple' ? 'bg-purple-100 text-purple-700' :
                            item.color === 'amber' ? 'bg-amber-100 text-amber-700' :
                            item.color === 'red' ? 'bg-red-100 text-red-700' :
                            item.color === 'teal' ? 'bg-teal-100 text-teal-700' :
                            item.color === 'indigo' ? 'bg-indigo-100 text-indigo-700' :
                            item.color === 'emerald' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-700'
                          }`}>
                            {count}
                          </span>
                        )}
                      </div>
                      <div className="text-xs text-gray-500">
                        {loading ? (language === 'de' ? 'Lädt...' : 'Loading...') : showGroups ? `${categoryCount} ${language === 'de' ? 'Gruppe' : 'Group'}${categoryCount !== 1 ? (language === 'de' ? 'n' : 's') : ''}` : (language === 'de' ? item.description : item.description_en)}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </nav>

          {/* Footer */}
          <div className="p-3 border-t bg-gray-50 text-xs text-gray-500">
            <div className="flex items-center gap-2">
              <Icon name="info-circle" />
              <span>BSI TR-03151 Schnittstelle</span>
            </div>
          </div>
        </aside>
      );
    };

    // ============================================
    // Overview Component
    // ============================================

    const OverviewView = ({ overview, onNavigate, language }) => {
      // Filter out processmap from overview - it's a special navigation item
      const overviewItems = NAV_ITEMS.filter(item => item.id !== 'processmap');

      // Set page title
      usePageTitle(`${language === 'de' ? 'Übersicht' : 'Overview'}`);
      
      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <Icon name="th-large" className="mr-3 text-emerald-600" />
              {language === 'de' ? 'Schnittstellenübersicht' : 'Interface Overview'}
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {overviewItems.map(item => {
                const data = overview?.[item.id] || { count: 0, categories: {} };
                const categories = Object.entries(data.categories || {}).sort((a, b) => b[1] - a[1]);
                
                const gradientClass = 
                  item.color === 'blue' ? 'from-blue-500 to-blue-600' :
                  item.color === 'purple' ? 'from-purple-500 to-purple-600' :
                  item.color === 'amber' ? 'from-amber-500 to-amber-600' :
                  item.color === 'red' ? 'from-red-500 to-red-600' :
                  item.color === 'teal' ? 'from-teal-500 to-teal-600' :
                  item.color === 'indigo' ? 'from-indigo-500 to-indigo-600' :
                  item.color === 'emerald' ? 'from-emerald-500 to-emerald-600' : 'from-gray-500 to-gray-600';
                
                const badgeClass = 
                  item.color === 'blue' ? 'bg-blue-50 text-blue-700' :
                  item.color === 'purple' ? 'bg-purple-50 text-purple-700' :
                  item.color === 'amber' ? 'bg-amber-50 text-amber-700' :
                  item.color === 'red' ? 'bg-red-50 text-red-700' :
                  item.color === 'teal' ? 'bg-teal-50 text-teal-700' :
                  item.color === 'indigo' ? 'bg-indigo-50 text-indigo-700' :
                  item.color === 'emerald' ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-50 text-gray-700';
                
                return (
                  <div 
                    key={item.id}
                    className="item-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer"
                    onClick={() => onNavigate(item.id)}
                  >
                    <div className={`bg-gradient-to-r ${gradientClass} p-4 text-white`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                            <Icon name={item.icon} className="text-2xl" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold">{language === 'de' ? item.label : item.label_en}</h3>
                            <p className="text-sm opacity-90">{language === 'de' ? item.description : item.description_en}</p>
                          </div>
                        </div>
                        <div className="text-3xl font-bold">{data.count}</div>
                      </div>
                    </div>
                    <div className="p-4">
                      {categories.length > 0 ? (
                        <div className="space-y-2">
                          <div className="text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Gruppierung' : 'Grouping'}</div>
                          <div className="flex flex-wrap gap-2">
                            {categories.slice(0, 6).map(([cat, count]) => (
                              <span 
                                key={cat}
                                className={`px-2 py-1 text-xs rounded-full ${badgeClass}`}
                              >
                                {cat} ({count})
                              </span>
                            ))}
                            {categories.length > 6 && (
                              <span className="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                +{categories.length - 6} {language === 'de' ? ' weitere' : ' more'}
                              </span>
                            )}
                          </div>
                        </div>
                      ) : (
                        <div className="text-sm text-gray-500">{language === 'de' ? 'Keine Einträge' : 'No entries'}</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Functions List Component
    // ============================================

    const FunctionsView = ({ instance, onSelectItem, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});
      const [activeCategory, setActiveCategory] = useState(null);
      const categoryRefs = useRef({});

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(`${language === 'de' ? 'Funktionen' : 'Functions'}`);

      useEffect(() => {
        loadFunctions();
      }, [instance]);

      const loadFunctions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/functions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            // Expand all categories by default
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
            // Setze erste Kategorie als aktiv
            const cats = Object.keys(result.grouped || {});
            if (cats.length > 0) setActiveCategory(`func-cat-${cats[0].replace(/\s+/g, '-')}`);
          }
        } catch (err) {
          console.error('Error loading functions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => {
            const descText = getText(item.description, language);
            return item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              descText.toLowerCase().includes(searchTerm.toLowerCase());
          });
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm, language]);

      // Scroll-Spy: Beobachte welche Kategorie gerade sichtbar ist
      useEffect(() => {
        if (!data?.grouped) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                setActiveCategory(entry.target.id);
              }
            });
          },
          {
            root: null,
            rootMargin: '-100px 0px -70% 0px',
            threshold: 0
          }
        );

        // Kurze Verzögerung um sicherzustellen, dass Refs gesetzt sind
        const timer = setTimeout(() => {
          Object.keys(categoryRefs.current).forEach(cat => {
            const el = categoryRefs.current[cat];
            if (el) observer.observe(el);
          });
        }, 100);

        return () => {
          clearTimeout(timer);
          observer.disconnect();
        };
      }, [data, searchTerm]);

      const scrollToCategory = (category) => {
        const catId = `func-cat-${category.replace(/\s+/g, '-')}`;
        const element = categoryRefs.current[catId];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      const getCategoryId = (category) => `func-cat-${category.replace(/\s+/g, '-')}`;

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      const categories = Object.keys(filteredGroups);
      const totalFunctions = Object.values(filteredGroups).flat();
      const functionsWithSystemLog = totalFunctions.filter(f => f.hasSystemLog).length;

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="code" className="mr-3 text-blue-600" />
                Funktionen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              {/* Search */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Funktion suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Main Content with TOC Sidebar */}
            <div className="flex gap-6">
              {/* Sticky TOC Sidebar */}
              <div className="hidden lg:block w-64 flex-shrink-0">
                <div className="sticky top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-700 mb-3 flex items-center text-sm">
                      <Icon name="list" className="mr-2 text-blue-500" />
                      Kategorien
                      <span className="ml-auto text-xs text-gray-400">{categories.length}</span>
                    </h3>
                    <nav className="space-y-1 max-h-[calc(100vh-200px)] overflow-y-auto">
                      {categories.map(category => {
                        const catId = getCategoryId(category);
                        const isActive = activeCategory === catId;
                        const itemCount = filteredGroups[category]?.length || 0;
                        
                        return (
                          <button
                            key={category}
                            onClick={() => scrollToCategory(category)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between group ${
                              isActive 
                                ? 'bg-blue-50 text-blue-700 font-medium border-l-3 border-blue-500' 
                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                            }`}
                          >
                            <span className="truncate flex-1">{category}</span>
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${
                              isActive ? 'bg-blue-200 text-blue-800' : 'bg-gray-100 text-gray-500 group-hover:bg-gray-200'
                            }`}>
                              {itemCount}
                            </span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>

                  {/* Quick Stats */}
                  <div className="bg-white rounded-lg shadow p-4 mt-4">
                    <h3 className="font-semibold text-gray-700 mb-3 text-sm">Statistik</h3>
                    <div className="space-y-2">
                      <div className="flex items-center justify-between p-2 bg-blue-50 rounded">
                        <span className="text-sm text-blue-700">Funktionen</span>
                        <span className="font-bold text-blue-800">{totalFunctions.length}</span>
                      </div>
                      <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                        <span className="text-sm text-green-700 flex items-center">
                          <Icon name="file-alt" className="mr-1" />
                          Mit SystemLog
                        </span>
                        <span className="font-bold text-green-800">{functionsWithSystemLog}</span>
                      </div>
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Kategorien</span>
                        <span className="font-bold text-gray-700">{categories.length}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Function List */}
              <div className="flex-1 min-w-0 space-y-4">
                {Object.entries(filteredGroups).map(([category, items]) => {
                  const catId = getCategoryId(category);
                  return (
                    <div 
                      key={category} 
                      id={catId}
                      ref={el => categoryRefs.current[catId] = el}
                      className="bg-white rounded-lg shadow overflow-hidden scroll-mt-4"
                    >
                      {/* Category Header */}
                      <div 
                        className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                        onClick={() => toggleCategory(category)}
                      >
                        <div className="flex items-center gap-3">
                          <Icon 
                            name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                            className="text-gray-400"
                          />
                          <span className="font-semibold text-gray-700">{category}</span>
                          <span className="badge bg-blue-100 text-blue-700 rounded-full">{items.length}</span>
                        </div>
                      </div>

                      {/* Function Items */}
                      {expandedCategories[category] && (
                        <div className="divide-y">
                          {items.map(func => (
                            <div 
                              key={func.id}
                              className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                              onClick={() => onSelectItem && onSelectItem('function', func)}
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <code className="text-blue-600 font-semibold">{func.name}</code>
                                    {func.hasSystemLog && (
                                      <span className="badge bg-green-100 text-green-700 rounded">
                                        <Icon name="file-alt" className="mr-1" />SystemLog
                                      </span>
                                    )}
                                  </div>
                                  <p className="text-sm text-gray-600 mt-1 line-clamp-2">{t(func.description)}</p>
                                  <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    <span>
                                      <Icon name="sign-in-alt" className="mr-1" />
                                      {func.parameterCount} Parameter
                                    </span>
                                    <span>
                                      <Icon name="sign-out-alt" className="mr-1" />
                                      {func.returnValue?.type || 'void'}
                                    </span>
                                    <span>
                                      <Icon name="list-ol" className="mr-1" />
                                      {func.stepCount} {language === 'de' ? 'Schritte' : 'Steps'}
                                    </span>
                                    <span>
                                      <Icon name="exclamation-circle" className="mr-1" />
                                      {func.exceptionCount} Exceptions
                                    </span>
                                  </div>
                                </div>
                                <Icon name="chevron-right" className="text-gray-300" />
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Mermaid Flowchart View Component
    // ============================================

    const MermaidFlowchartView = ({ mermaidCode, language = 'de', type = '' }) => {
      const [showCode, setShowCode] = useState(false);
      const [renderError, setRenderError] = useState(null);
      const [isRendering, setIsRendering] = useState(true);
      const [mermaidReady, setMermaidReady] = useState(false);
      const [isFullscreen, setIsFullscreen] = useState(false);
      const [zoomLevel, setZoomLevel] = useState(100);
      const [renderedSvg, setRenderedSvg] = useState(''); // Store SVG in state for fullscreen
      const renderIdRef = useRef(0);

      // Wait for mermaid to be available (loaded via ESM)
      useEffect(() => {
        const checkMermaid = () => {
          if (window.mermaid) {
            setMermaidReady(true);
          } else {
            setTimeout(checkMermaid, 100);
          }
        };
        checkMermaid();
      }, []);

      // Handle ESC key to exit fullscreen
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'Escape' && isFullscreen) {
            setIsFullscreen(false);
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [isFullscreen]);

      // Lock body scroll when fullscreen
      useEffect(() => {
        if (isFullscreen) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
        return () => {
          document.body.style.overflow = '';
        };
      }, [isFullscreen]);

      useEffect(() => {
        if (!mermaidCode || !mermaidReady) return;

        const renderMermaid = async () => {
          setIsRendering(true);
          setRenderError(null);
          renderIdRef.current += 1;
          const currentRenderId = renderIdRef.current;
          
          try {
            // Initialize mermaid with config (Mermaid v11 API)
            window.mermaid.initialize({
              startOnLoad: false,
              theme: 'default',
              securityLevel: 'loose',
              flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 15,
                nodeSpacing: 30,
                rankSpacing: 50,
                diagramPadding: 8
              },
              themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2563eb',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f8fafc'
              }
            });
            
            // Generate unique ID for this render
            const id = `mermaid-diagram-${Date.now()}-${currentRenderId}`;
            
            // Render the diagram using Mermaid v11 API
            const { svg } = await window.mermaid.render(id, mermaidCode);
            
            // Only update if this is still the current render
            if (currentRenderId === renderIdRef.current) {
              setRenderedSvg(svg);
            }
          } catch (err) {
            console.error('Mermaid render error:', err);
            if (currentRenderId === renderIdRef.current) {
              setRenderError(err.message || (language === 'de' ? 'Fehler beim Rendern des Flowcharts' : 'Error rendering flowchart'));
            }
          } finally {
            if (currentRenderId === renderIdRef.current) {
              setIsRendering(false);
            }
          }
        };

        renderMermaid();
      }, [mermaidCode, mermaidReady, language]);

      const copyToClipboard = () => {
        navigator.clipboard.writeText(mermaidCode).then(() => {
          alert(language === 'de' ? 'Code kopiert!' : 'Code copied!');
        });
      };

      const downloadSvg = () => {
        if (renderedSvg) {
          const blob = new Blob([renderedSvg], { type: 'image/svg+xml' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'flowchart.svg';
          a.click();
          URL.revokeObjectURL(url);
        }
      };

      const handleZoomIn = () => setZoomLevel(prev => Math.min(prev + 25, 300));
      const handleZoomOut = () => setZoomLevel(prev => Math.max(prev - 25, 25));
      const handleZoomReset = () => setZoomLevel(100);

      // Show loading state while waiting for mermaid
      if (!mermaidReady) {
        return (
          <div className="bg-white rounded-lg border border-gray-200 p-8">
            <div className="flex items-center justify-center">
              <div className="text-center">
                <div className="loading-spinner mx-auto mb-3"></div>
                <p className="text-gray-500 text-sm">
                  {language === 'de' ? 'Lade Mermaid-Bibliothek...' : 'Loading Mermaid library...'}
                </p>
              </div>
            </div>
          </div>
        );
      }

      // Render content (used in both normal and fullscreen modes)
      const renderContent = (inFullscreen = false) => (
        <div className={`bg-white ${inFullscreen ? 'h-full flex flex-col' : 'rounded-lg border border-gray-200'} overflow-hidden`}>
          {/* Toolbar */}
          <div className={`flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-200 ${inFullscreen ? 'flex-shrink-0' : ''}`}>
            <div className="flex items-center gap-2">
              <Icon name="project-diagram" className="text-blue-600" />
              <span className="font-medium text-gray-700">
                {language === 'de' ? 'Flowchart-Darstellung' : 'Flowchart View'}
              </span>
            </div>
            <div className="flex items-center gap-2">
              {/* Zoom Controls */}
              <div className="flex items-center gap-1 bg-gray-200 rounded px-1">
                <button
                  onClick={handleZoomOut}
                  className="p-1.5 text-gray-600 hover:text-gray-900 transition-colors"
                  title={language === 'de' ? 'Verkleinern' : 'Zoom out'}
                >
                  <Icon name="search-minus" />
                </button>
                <span className="text-xs text-gray-600 w-12 text-center font-medium">{zoomLevel}%</span>
                <button
                  onClick={handleZoomIn}
                  className="p-1.5 text-gray-600 hover:text-gray-900 transition-colors"
                  title={language === 'de' ? 'Vergrößern' : 'Zoom in'}
                >
                  <Icon name="search-plus" />
                </button>
                <button
                  onClick={handleZoomReset}
                  className="p-1.5 text-gray-600 hover:text-gray-900 transition-colors border-l border-gray-300"
                  title={language === 'de' ? 'Zurücksetzen' : 'Reset'}
                >
                  <Icon name="undo" />
                </button>
              </div>

              <div className="w-px h-6 bg-gray-300"></div>

              <button
                onClick={() => setShowCode(!showCode)}
                className={`px-3 py-1.5 rounded text-sm flex items-center gap-1.5 transition-colors ${
                  showCode 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                <Icon name="code" />
                Code
              </button>
              <button
                onClick={copyToClipboard}
                className="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm flex items-center gap-1.5 hover:bg-gray-300 transition-colors"
                title={language === 'de' ? 'Code kopieren' : 'Copy code'}
              >
                <Icon name="copy" />
              </button>
              <button
                onClick={downloadSvg}
                className="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm flex items-center gap-1.5 hover:bg-gray-300 transition-colors"
                title={language === 'de' ? 'Als SVG herunterladen' : 'Download as SVG'}
              >
                <Icon name="download" />
              </button>
              
              <div className="w-px h-6 bg-gray-300"></div>
              
              <button
                onClick={() => setIsFullscreen(!isFullscreen)}
                className={`px-3 py-1.5 rounded text-sm flex items-center gap-1.5 transition-colors ${
                  inFullscreen
                    ? 'bg-red-600 text-white hover:bg-red-700'
                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                }`}
                title={inFullscreen ? (language === 'de' ? 'Vollbild beenden (ESC)' : 'Exit fullscreen (ESC)') : (language === 'de' ? 'Vollbild' : 'Fullscreen')}
              >
                <Icon name={inFullscreen ? 'compress' : 'expand'} />
                {inFullscreen ? (language === 'de' ? 'Schließen' : 'Close') : (language === 'de' ? 'Vollbild' : 'Fullscreen')}
              </button>
            </div>
          </div>

          {/* Mermaid Code View (toggleable) */}
          {showCode && (
            <div className="border-b border-gray-200 flex-shrink-0">
              <pre className="bg-gray-900 text-gray-100 p-4 text-xs overflow-x-auto font-mono max-h-48 overflow-y-auto">
                {mermaidCode}
              </pre>
            </div>
          )}

          {/* Rendered Flowchart */}
          <div className={`bg-gradient-to-br from-gray-50 to-white overflow-auto ${inFullscreen ? 'flex-1 p-4' : 'min-h-[400px] p-2'}`}>
            {isRendering && (
              <div className="flex items-center justify-center h-64">
                <div className="text-center">
                  <div className="loading-spinner mx-auto mb-3"></div>
                  <p className="text-gray-500 text-sm">
                    {language === 'de' ? 'Rendere Flowchart...' : 'Rendering flowchart...'}
                  </p>
                </div>
              </div>
            )}
            
            {renderError && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 mb-4">
                <div className="flex items-start gap-2">
                  <Icon name="exclamation-triangle" className="mt-0.5" />
                  <div>
                    <p className="font-medium">
                      {language === 'de' ? 'Fehler beim Rendern' : 'Render Error'}
                    </p>
                    <p className="text-sm mt-1">{renderError}</p>
                  </div>
                </div>
              </div>
            )}
            
            {!isRendering && renderedSvg && (
              <div 
                className="mermaid-container flex justify-center items-start overflow-auto transition-transform duration-200"
                style={{ 
                  transform: `scale(${zoomLevel / 100})`,
                  transformOrigin: 'top center'
                }}
                dangerouslySetInnerHTML={{ __html: renderedSvg }}
              />
            )}
          </div>

          {/* Legend */}
          {type === 'function' && (
          <div className={`px-4 py-2 bg-gray-50 border-t border-gray-200 ${inFullscreen ? 'flex-shrink-0' : ''}`}>
            <div className="flex flex-wrap items-center gap-4 text-xs text-gray-600">
              <span className="font-medium">{language === 'de' ? 'Legende:' : 'Legend:'}</span>
              <div className="flex items-center gap-1.5">
                <span className="w-3 h-3 rounded bg-emerald-500"></span>
                <span>{language === 'de' ? 'Start/Ende' : 'Start/End'}</span>
              </div>
              <div className="flex items-center gap-1.5">
                <span className="w-3 h-3 rounded bg-blue-500"></span>
                <span>{language === 'de' ? 'Schritt' : 'Step'}</span>
              </div>
              <div className="flex items-center gap-1.5">
                <span className="w-3 h-3 rounded bg-red-500"></span>
                <span>{language === 'de' ? 'Fehler' : 'Error'}</span>
              </div>
              <div className="flex items-center gap-1.5">
                <span className="w-3 h-1 border-t-2 border-dashed border-gray-500"></span>
                <span>{language === 'de' ? 'Fehlerpfad' : 'Error path'}</span>
              </div>
              {inFullscreen && (
                <span className="ml-auto text-gray-400">
                  <Icon name="keyboard" className="mr-1" />
                  ESC {language === 'de' ? 'zum Schließen' : 'to close'}
                </span>
              )}
            </div>
          </div>
          )}
        </div>
      );

      return (
        <>
          {/* Normal View */}
          {!isFullscreen && renderContent(false)}

          {/* Fullscreen Overlay */}
          {isFullscreen && (
            <div 
              className="fixed inset-0 z-50 bg-white"
              style={{ top: 0, left: 0, right: 0, bottom: 0 }}
            >
              {renderContent(true)}
            </div>
          )}
        </>
      );
    };

    // ============================================
    // Function Detail View Component
    // ============================================

    const FunctionDetailView = ({ instance, functionId, onBack, onNavigateToType, onNavigateToEnum, onNavigateToException, onNavigateToFunction, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [availableTypes, setAvailableTypes] = useState([]);
      const [availableEnums, setAvailableEnums] = useState([]);
      const [availableExceptions, setAvailableExceptions] = useState([]);
      const [stepViewMode, setStepViewMode] = useState('overview'); // 'overview', 'signature', 'steps', 'diagrams', 'logging'
      const [expandedSteps, setExpandedSteps] = useState({});
      const [relatedProcesses, setRelatedProcesses] = useState([]);
      const [selectedDiagram, setSelectedDiagram] = useState('function'); // 'function' or process id
      const [processMermaidContent, setProcessMermaidContent] = useState(null);
      const [loadingDiagram, setLoadingDiagram] = useState(false);
      const [allFunctions, setAllFunctions] = useState([]);
      const [groupedFunctions, setGroupedFunctions] = useState({});
      const [currentGroup, setCurrentGroup] = useState(null);

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(data ? `${data.name} - ${language === 'de' ? 'Funktion' : 'Function'}` : null);

      useEffect(() => {
        loadFunction();
        loadAvailableItems();
        loadRelatedProcesses();
        loadAllFunctions();
      }, [instance, functionId]);

      // Reset selected diagram when switching to diagrams tab
      useEffect(() => {
        if (stepViewMode === 'diagrams') {
          setSelectedDiagram('function');
          setProcessMermaidContent(null);
        }
      }, [stepViewMode]);

      const loadAllFunctions = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/functions'));
          const result = await response.json();
          if (result.success) {
            setAllFunctions(result.items || []);
            setGroupedFunctions(result.grouped || {});
            // Find current group
            Object.entries(result.grouped || {}).forEach(([groupName, items]) => {
              if (items.some(item => item.name === functionId)) {
                setCurrentGroup(groupName);
              }
            });
          }
        } catch (err) {
          console.error('Error loading all functions:', err);
        }
      };

      const loadFunction = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/function/${functionId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.function);
            // Expand all steps by default
            const expanded = {};
            result.function.detailedSteps?.forEach(s => {
              expanded[s.number] = true;
            });
            setExpandedSteps(expanded);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading function:', err);
          setError('Fehler beim Laden der Funktion');
        }
        setLoading(false);
      };

      const loadRelatedProcesses = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/processes'));
          const result = await response.json();
          if (result.success) {
            // Filter processes that use this function
            const related = result.items.filter(proc => 
              proc.interfaceFunctions && proc.interfaceFunctions.includes(functionId)
            );
            setRelatedProcesses(related);
          }
        } catch (err) {
          console.error('Error loading related processes:', err);
        }
      };

      const loadProcessDiagram = async (proc) => {
        setLoadingDiagram(true);
        try {
          const response = await fetch(getApiUrl(instance, `/process/${proc.actor}/${proc.diagramType}/${proc.id}`));
          const result = await response.json();
          // mermaidContent is now an object with de/en properties
          if (result.success && result.process.mermaidContent) {
            setProcessMermaidContent(result.process.mermaidContent);
          } else {
            setProcessMermaidContent(null);
          }
        } catch (err) {
          console.error('Error loading process diagram:', err);
          setProcessMermaidContent(null);
        }
        setLoadingDiagram(false);
      };

      const handleDiagramSelect = (diagramId) => {
        setSelectedDiagram(diagramId);
        if (diagramId === 'function') {
          setProcessMermaidContent(null);
        } else {
          const proc = relatedProcesses.find(p => `${p.actor}-${p.diagramType}-${p.id}` === diagramId);
          if (proc) {
            loadProcessDiagram(proc);
          }
        }
      };

      const handleNavigateToOtherFunction = (func) => {
        if (onNavigateToFunction) {
          onNavigateToFunction(func);
        }
      };

      const loadAvailableItems = async () => {
        try {
          const [typesRes, enumsRes, excRes] = await Promise.all([
            fetch(getApiUrl(instance, '/types')),
            fetch(getApiUrl(instance, '/enums')),
            fetch(getApiUrl(instance, '/exceptions'))
          ]);
          
          const typesResult = await typesRes.json();
          if (typesResult.success) setAvailableTypes(typesResult.items.map(t => t.name));
          
          const enumsResult = await enumsRes.json();
          if (enumsResult.success) setAvailableEnums(enumsResult.items.map(e => e.name));
          
          const excResult = await excRes.json();
          if (excResult.success) setAvailableExceptions(excResult.items.map(e => e.name));
        } catch (err) {
          console.error('Error loading available items:', err);
        }
      };

      // Render a type reference - links to type/enum if available
      const renderTypeReference = (typeName) => {
        if (!typeName || typeName === 'void') {
          return <span className="text-gray-400 font-mono">{typeName || 'void'}</span>;
        }
        
        if (availableTypes.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-sm font-mono cursor-pointer hover:bg-purple-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
              title={`Typ "${typeName}" anzeigen`}
            >
              <Icon name="cube" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        if (availableEnums.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-sm font-mono cursor-pointer hover:bg-amber-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToEnum && onNavigateToEnum(typeName)}
              title={`Enum "${typeName}" anzeigen`}
            >
              <Icon name="list-ol" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        return (
          <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
            {typeName}
          </span>
        );
      };

      // Render an exception reference
      const renderExceptionReference = (excName) => {
        if (availableExceptions.includes(excName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-red-50 text-red-700 rounded text-sm font-mono cursor-pointer hover:bg-red-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToException && onNavigateToException(excName)}
              title={`Exception "${excName}" anzeigen`}
            >
              <Icon name="exclamation-triangle" className="text-xs" />
              {excName}
            </span>
          );
        }
        return (
          <span className="px-2 py-0.5 bg-red-50 text-red-700 rounded text-sm font-mono">
            {excName}
          </span>
        );
      };

      const toggleStep = (stepNum) => {
        setExpandedSteps(prev => ({
          ...prev,
          [stepNum]: !prev[stepNum]
        }));
      };

      const expandAllSteps = () => {
        const expanded = {};
        data?.detailedSteps?.forEach(s => {
          expanded[s.number] = true;
        });
        setExpandedSteps(expanded);
      };

      const collapseAllSteps = () => {
        setExpandedSteps({});
      };

      // Generate Mermaid flowchart from steps - optimized for vertical layout with tooltips
      const generateMermaidFlowchart = () => {
        if (!data?.detailedSteps?.length) return '';
        
        // Escape special characters for Mermaid
        const escapeText = (text) => {
          if (!text) return '';
          return text
            .replace(/"/g, "'")
            .replace(/\[/g, '(')
            .replace(/\]/g, ')')
            .replace(/\{/g, '(')
            .replace(/\}/g, ')')
            .replace(/</g, '‹')
            .replace(/>/g, '›')
            .replace(/&/g, '+')
            .replace(/\n/g, ' ')
            .trim();
        };

        // Wrap text with <br/> for multi-line display (no truncation)
        const wrapText = (text, maxLen = 50) => {
          if (!text) return '';
          const words = text.split(' ');
          let lines = [];
          let currentLine = '';
          
          for (const word of words) {
            if ((currentLine + ' ' + word).trim().length <= maxLen) {
              currentLine = (currentLine + ' ' + word).trim();
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
          }
          if (currentLine) lines.push(currentLine);
          
          return lines.join('<br/>');
        };
        
        // Use TB (Top to Bottom) for strict vertical layout
        let mermaid = 'flowchart TB\n';
        
        // Define compact styles - subtle and clean design
        mermaid += '    %% Styles\n';
        mermaid += '    classDef startEnd fill:#10b981,stroke:#059669,color:#fff,stroke-width:2px,rx:20,ry:20\n';
        mermaid += '    classDef step fill:#f0f9ff,stroke:#0284c7,color:#0c4a6e,stroke-width:1.5px\n';
        mermaid += '    classDef stepSuccess fill:#f0fdf4,stroke:#16a34a,color:#166534,stroke-width:1.5px\n';
        mermaid += '    classDef stepWithError fill:#fef2f2,stroke:#dc2626,color:#7f1d1d,stroke-width:2px\n';
        mermaid += '    classDef errorEnd fill:#fee2e2,stroke:#dc2626,color:#991b1b,stroke-width:2px,rx:20,ry:20\n';
        mermaid += '    linkStyle default stroke:#cbd5e1,stroke-width:2px\n\n';
        
        // Start node - language aware
        const startLabel = language === 'de' ? 'Start' : 'Start';
        mermaid += `    Start(["▶ ${startLabel}"]):::startEnd\n`;
        mermaid += '    Start --> Step1\n\n';
        
        // Track error link indices for styling
        let linkIndex = 1; // Start at 1 because of Start --> Step1
        const errorLinkIndices = [];
        
        // Generate all steps in a single vertical flow
        data.detailedSteps.forEach((step, idx) => {
          const stepId = `Step${step.number}`;
          const nextStepId = idx < data.detailedSteps.length - 1 ? `Step${data.detailedSteps[idx + 1].number}` : 'Success';
          
          // Get step description with language support
          const stepText = getText(step.description, language) || step.germanText || step.originalText || '';
          const wrappedText = wrapText(escapeText(stepText), 50);
          const hasErrors = step.errorCases?.length > 0;
          const hasSuccess = step.successCases?.length > 0;
          
          // Step node - use different style based on status
          let stepClass = 'step';
          if (hasSuccess) stepClass = 'stepSuccess';
          
          // Step label with number prefix
          const stepLabel = language === 'de' ? 'Schritt' : 'Step';
          mermaid += `    ${stepId}["<b>${stepLabel} ${step.number}</b><br/>${wrappedText}"]:::${stepClass}\n`;
          
          // Connect to next step (success path)
          mermaid += `    ${stepId} --> ${nextStepId}\n`;
          linkIndex++;
          
          // Add error path directly to ErrorEnd with exception names as label
          // No separate exception nodes - keeps diagram narrow
          if (hasErrors) {
            // Collect exception names for this step
            const stepExceptions = step.errorCases.map(ec => escapeText(ec.exception || 'Error'));
            
            // Create label based on number of exceptions
            let errorLabel;
            if (stepExceptions.length === 1) {
              errorLabel = stepExceptions[0];
            } else if (stepExceptions.length === 2) {
              errorLabel = stepExceptions.join(', ');
            } else {
              // Show first exception + count of others
              errorLabel = `${stepExceptions[0]} +${stepExceptions.length - 1}`;
            }
            
            // Single dotted line from step to ErrorEnd with exception label
            mermaid += `    ${stepId} -.->|"${errorLabel}"| ErrorEnd\n`;
            errorLinkIndices.push(linkIndex);
            linkIndex++;
          }
          
          mermaid += '\n';
        });
        
        // Success end node - language aware
        const successLabel = language === 'de' ? 'Erfolg' : 'Success';
        mermaid += `    Success(["✅ ${successLabel}"]):::startEnd\n`;
        
        // Error end node (only if there are errors) - language aware
        const hasAnyErrors = data.detailedSteps.some(s => s.errorCases?.length > 0);
        if (hasAnyErrors) {
          const abortLabel = language === 'de' ? 'Abbruch' : 'Abort';
          mermaid += `    ErrorEnd(["❌ ${abortLabel}"]):::errorEnd\n`;
          
          // Style error links in red
          if (errorLinkIndices.length > 0) {
            mermaid += `    linkStyle ${errorLinkIndices.join(',')} stroke:#ef4444,stroke-width:2px,stroke-dasharray:5\n`;
          }
        }
        
        return mermaid;
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      // Define tabs for the function detail view
      const tabs = [
        { id: 'overview', label: language === 'de' ? 'Übersicht' : 'Overview', icon: 'info-circle' },
        { id: 'signature', label: language === 'de' ? 'Signatur' : 'Signature', icon: 'code' },
        { id: 'steps', label: language === 'de' ? 'Ablauf' : 'Flow', icon: 'tasks', badge: data.stepCount },
        { id: 'diagrams', label: language === 'de' ? 'Diagramme' : 'Diagrams', icon: 'project-diagram', badge: 1 + relatedProcesses.length },
        ...(data.systemLog || data.transactionLog ? [{ id: 'logging', label: 'Logging', icon: 'file-alt' }] : [])
      ];

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="functions"
            currentId={functionId}
            currentName={data?.name || functionId}
            groupedItems={groupedFunctions}
            currentGroup={currentGroup}
            onBack={onBack}
            onNavigate={handleNavigateToOtherFunction}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-4">
          <div className="max-w-7xl mx-auto">
            {/* Compact Header with integrated Tabs */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-4">
              {/* Header */}
              <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-4 text-white">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                      <Icon name="code" className="text-2xl" />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold font-mono">{data.name}()</h1>
                      <div className="flex items-center gap-2 mt-1 flex-wrap">
                        <span className="px-2 py-0.5 bg-white/20 rounded text-xs">{data.category}</span>
                        <span className="px-2 py-0.5 bg-white/20 rounded text-xs">
                          <Icon name="list-ol" className="mr-1" />
                          {data.stepCount} {language === 'de' ? 'Schritte' : 'Steps'}
                        </span>
                        <span className="px-2 py-0.5 bg-white/20 rounded text-xs">
                          <Icon name="exclamation-triangle" className="mr-1" />
                          {data.exceptionCount} {language === 'de' ? 'Ausnahmen' : 'Exceptions'}
                        </span>
                        {data.systemLog && (
                          <span className="px-2 py-0.5 bg-green-600 rounded text-xs">
                            <Icon name="file-alt" className="mr-1" />
                            {language === 'de' ? 'System-Log' : 'System Log'}
                          </span>
                        )}
                        {data.transactionLog && (
                          <span className="px-2 py-0.5 bg-yellow-600 rounded text-xs">
                            <Icon name="exchange-alt" className="mr-1" />
                            {language === 'de' ? 'Transaktions-Log' : 'Transaction Log'}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description - compact */}
              <div className="p-3 bg-gray-50 border-b text-sm">
                <p className="text-gray-700 leading-relaxed">{t(data.description) || (language === 'de' ? 'Keine Beschreibung verfügbar.' : 'No description available.')}</p>
              </div>

              {/* Tabs */}
              <div className="flex border-b bg-white overflow-x-auto">
                {tabs.map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setStepViewMode(tab.id)}
                    className={`px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors whitespace-nowrap ${
                      stepViewMode === tab.id
                        ? 'text-blue-600 border-blue-600'
                        : 'text-gray-500 border-transparent hover:text-gray-700'
                    }`}
                  >
                    <Icon name={tab.icon} />
                    {tab.label}
                    {tab.badge && (
                      <span className={`ml-1 px-1.5 py-0.5 text-xs rounded-full ${
                        stepViewMode === tab.id ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'
                      }`}>
                        {tab.badge}
                      </span>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Tab Content */}
            <div className="space-y-4">
              {/* Overview Tab */}
              {stepViewMode === 'overview' && (
                <div className="space-y-4">
                  {/* Function Signature */}
                  <div className="bg-white rounded-lg shadow overflow-hidden">
                    <div className="p-3 bg-gray-800 text-gray-100 font-mono text-sm">
                      <span className="text-purple-400">{data.returnValue?.type || 'void'}</span>
                      <span className="text-yellow-300 ml-2">{data.name}</span>
                      <span className="text-gray-400">(</span>
                      {data.parameters?.map((p, idx) => (
                        <span key={idx}>
                          <span className="text-purple-400">{p.type}</span>
                          <span className="text-blue-300 ml-1">{p.name}</span>
                          {idx < data.parameters.length - 1 && <span className="text-gray-400">, </span>}
                        </span>
                      ))}
                      <span className="text-gray-400">)</span>
                      {data.exceptions?.length > 0 && (
                        <>
                          <span className="text-gray-500 ml-2">throws</span>
                          <span className="text-red-400 ml-1">{data.exceptions.join(', ')}</span>
                        </>
                      )}
                    </div>
                  </div>

                  {/* Parameters */}
                  {data.parameters && data.parameters.length > 0 && (
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <div className="p-3 bg-gray-50 border-b">
                        <h3 className="font-semibold text-gray-800 flex items-center text-sm">
                          <Icon name="sign-in-alt" className="mr-2 text-blue-500" />
                          Parameter
                          <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                            {data.parameters.length}
                          </span>
                        </h3>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50 border-b">
                            <tr>
                              <th className="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                              <th className="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Typ</th>
                              <th className="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Dir</th>
                              <th className="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Beschreibung</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {data.parameters.map((param, idx) => (
                              <tr key={idx} className="hover:bg-gray-50">
                                <td className="px-3 py-2">
                                  <code className="text-blue-700 font-semibold">{param.name}</code>
                                </td>
                                <td className="px-3 py-2">{renderTypeReference(param.type)}</td>
                                <td className="px-3 py-2">
                                  <span className={`px-1.5 py-0.5 rounded text-xs ${
                                    param.direction === 'INPUT' ? 'bg-green-100 text-green-700' :
                                    param.direction === 'OUTPUT' ? 'bg-orange-100 text-orange-700' :
                                    'bg-gray-100 text-gray-700'
                                  }`}>
                                    {param.direction}
                                  </span>
                                </td>
                                <td className="px-3 py-2 text-gray-600 max-w-xs truncate">{t(param.description) || '-'}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {/* Return Value */}
                  {data.returnValue && data.returnValue.type !== 'void' && (
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                        <Icon name="sign-out-alt" className="mr-2 text-green-500" />
                        {language === 'de' ? 'Rückgabewert' : 'Return Value'}
                      </h3>
                      <div className="flex items-center gap-3">
                        {renderTypeReference(data.returnValue.type)}
                        {t(data.returnValue.description) && (
                          <span className="text-gray-600 text-sm">– {t(data.returnValue.description)}</span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Exceptions */}
                  {data.exceptions && data.exceptions.length > 0 && (
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <div className="p-3 bg-gray-50 border-b">
                        <h3 className="font-semibold text-gray-800 flex items-center text-sm">
                          <Icon name="exclamation-triangle" className="mr-2 text-red-500" />
                          {language === 'de' ? 'Mögliche Exceptions' : 'Possible Exceptions'}
                          <span className="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full">
                            {data.exceptions.length}
                          </span>
                        </h3>
                      </div>
                      <div className="p-3">
                        <div className="flex flex-wrap gap-2">
                          {data.exceptions.map((exc, idx) => (
                            <span key={idx}>{renderExceptionReference(exc)}</span>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Pre/Post Conditions */}
                  {(data.precondition || data.postcondition) && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {data.precondition && (
                        <div className="bg-white rounded-lg shadow p-4">
                          <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                            <Icon name="door-open" className="mr-2 text-blue-500" />
                            {language === 'de' ? 'Vorbedingung' : 'Precondition'}
                          </h3>
                          <p className="text-gray-600 text-sm">{data.precondition}</p>
                        </div>
                      )}
                      {data.postcondition && (
                        <div className="bg-white rounded-lg shadow p-4">
                          <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                            <Icon name="door-closed" className="mr-2 text-green-500" />
                            {language === 'de' ? 'Nachbedingung' : 'Postcondition'}
                          </h3>
                          <p className="text-gray-600 text-sm">{data.postcondition}</p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Notes */}
                  {data.notes && data.notes.length > 0 && (
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                        <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                        {language === 'de' ? 'Hinweise' : 'Notes'}
                      </h3>
                      <ul className="space-y-1">
                        {data.notes.map((note, idx) => (
                          <li key={idx} className="text-gray-600 text-sm flex items-start">
                            <Icon name="angle-right" className="mr-2 mt-0.5 text-gray-400" />
                            {typeof note === 'string' ? note : note.text}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}

              {/* Signature Tab */}
              {stepViewMode === 'signature' && (
                <div className="bg-white rounded-lg shadow overflow-hidden">
                  <div className="p-4 bg-gray-800 text-gray-100 font-mono text-sm">
                    <span className="text-purple-400">{data.returnValue?.type || 'void'}</span>
                    <span className="text-yellow-300 ml-2">{data.name}</span>
                    <span className="text-gray-400">(</span>
                    {data.parameters?.map((p, idx) => (
                      <span key={idx}>
                        <span className="text-purple-400">{p.type}</span>
                        <span className="text-blue-300 ml-1">{p.name}</span>
                        {idx < data.parameters.length - 1 && <span className="text-gray-400">, </span>}
                      </span>
                    ))}
                    <span className="text-gray-400">)</span>
                    {data.exceptions?.length > 0 && (
                      <>
                        <span className="text-gray-500 ml-2">throws</span>
                        <span className="text-red-400 ml-1">{data.exceptions.join(', ')}</span>
                      </>
                    )}
                  </div>
                  
                  {/* Pseudocode */}
                  {data.detailedSteps && data.detailedSteps.length > 0 && (
                    <div className="p-4 border-t">
                      <h4 className="text-sm font-semibold text-gray-700 mb-2">Pseudocode</h4>
                      <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                        <code>
                          <span className="text-purple-400">function</span> <span className="text-yellow-300">{data.name}</span>({data.parameters?.map(p => p.name).join(', ')}) {'{\n'}
                          {data.detailedSteps.map(step => {
                            const pseudoText = t(step.pseudocode) || (typeof step.pseudocode === 'string' ? step.pseudocode : '');
                            const descText = t(step.description) || (language === 'en' ? step.originalText : step.germanText) || '';
                            return (
                            <span key={step.number}>
                              {`\n  `}<span className="text-gray-500">// {language === 'de' ? 'Schritt' : 'Step'} {step.number}</span>{'\n'}
                              {pseudoText ? 
                                pseudoText.split('\n').map((line, i) => (
                                  <span key={i}>{`  ${line}\n`}</span>
                                )) : 
                                `  // ${descText.substring(0, 60)}...\n`
                              }
                            </span>
                          )})}
                          {'\n}'}
                        </code>
                      </pre>
                    </div>
                  )}
                </div>
              )}

              {/* Steps Tab */}
              {stepViewMode === 'steps' && data.detailedSteps && data.detailedSteps.length > 0 && (
                <div className="bg-white rounded-lg shadow overflow-hidden">
                  <div className="p-3 bg-gray-50 border-b flex items-center justify-between">
                    <h3 className="font-semibold text-gray-800 flex items-center text-sm">
                      <Icon name="tasks" className="mr-2 text-indigo-500" />
                      {language === 'de' ? 'Ausführungsschritte' : 'Execution Steps'}
                    </h3>
                    <div className="flex gap-1">
                      <button onClick={expandAllSteps} className="px-2 py-1 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title={language === 'de' ? 'Alle aufklappen' : 'Expand all'}>
                        <Icon name="expand-arrows-alt" />
                      </button>
                      <button onClick={collapseAllSteps} className="px-2 py-1 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title={language === 'de' ? 'Alle zuklappen' : 'Collapse all'}>
                        <Icon name="compress-arrows-alt" />
                      </button>
                    </div>
                  </div>
                  <div className="p-4 space-y-3">
                    {data.detailedSteps.map((step, idx) => {
                      const stepDescText = t(step.description) || (language === 'en' ? step.originalText : step.germanText) || '';
                      const pseudocodeText = t(step.pseudocode) || (typeof step.pseudocode === 'string' ? step.pseudocode : '');
                      const hasErrors = step.errorCases?.length > 0;
                      const hasSuccess = step.successCases?.length > 0;
                      
                      // Determine bubble color: red for errors, green for success, indigo for neutral
                      const bubbleColor = hasErrors ? 'bg-red-500' : hasSuccess ? 'bg-green-500' : 'bg-indigo-600';
                      
                      return (
                      <div key={step.number} className="border rounded-lg overflow-hidden">
                        <div 
                          className="p-3 bg-gray-50 cursor-pointer flex items-start justify-between hover:bg-gray-100 transition-colors gap-3"
                          onClick={() => toggleStep(step.number)}
                        >
                          <div className="flex items-start gap-3 flex-1 min-w-0">
                            <span className={`w-7 h-7 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0 ${bubbleColor}`}>
                              {step.number}
                            </span>
                            <span className="font-medium text-gray-800 text-sm leading-relaxed">
                              {stepDescText}
                            </span>
                          </div>
                          <div className="flex items-center gap-2 flex-shrink-0">
                            {hasSuccess && !hasErrors && (
                              <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">
                                <Icon name="check" className="mr-1" />
                                {language === 'de' ? 'Erfolg' : 'Success'}
                              </span>
                            )}
                            {hasErrors && (
                              <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">
                                {step.errorCases.length} {language === 'de' ? 'Fehler' : 'Errors'}
                              </span>
                            )}
                            <Icon name={expandedSteps[step.number] ? 'chevron-up' : 'chevron-down'} className="text-gray-400" />
                          </div>
                        </div>
                        
                        {expandedSteps[step.number] && (
                          <div className="p-4 border-t bg-white text-sm">
                            <p className="text-gray-700 mb-3 leading-relaxed" style={{ maxWidth: 'calc(100% - 2rem)' }}>{stepDescText}</p>
                            
                            {pseudocodeText && (
                              <div className="mb-3">
                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-1">Pseudocode</h5>
                                <pre className="bg-gray-900 text-gray-100 p-2 rounded text-xs overflow-x-auto font-mono">
                                  {pseudocodeText}
                                </pre>
                              </div>
                            )}
                            
                            {step.errorCases?.length > 0 && (
                              <div className="mb-3">
                                <h5 className="text-xs font-semibold text-red-600 uppercase mb-1 flex items-center">
                                  <Icon name="times-circle" className="mr-1" />
                                  {language === 'de' ? 'Fehlerfälle' : 'Error Cases'}
                                </h5>
                                <div className="space-y-2">
                                  {step.errorCases.map((ec, ecIdx) => (
                                    <div key={ecIdx} className="p-2 bg-red-50 rounded border-l-3 border-red-400">
                                      <div className="flex items-center gap-2 mb-1">
                                        {renderExceptionReference(ec.exception)}
                                      </div>
                                      <p className="text-xs text-red-700"><strong>{language === 'de' ? 'Auslöser' : 'Trigger'}:</strong> {t(ec.trigger)}</p>
                                      {t(ec.action) && <p className="text-xs text-red-600"><strong>{language === 'de' ? 'Aktion' : 'Action'}:</strong> {t(ec.action)}</p>}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            {step.successCases?.length > 0 && (
                              <div>
                                <h5 className="text-xs font-semibold text-green-600 uppercase mb-1 flex items-center">
                                  <Icon name="check-circle" className="mr-1" />
                                  {language === 'de' ? 'Erfolgsfälle' : 'Success Cases'}
                                </h5>
                                <div className="space-y-2">
                                  {step.successCases.map((sc, scIdx) => (
                                    <div key={scIdx} className="p-2 bg-green-50 rounded border-l-3 border-green-400">
                                      <p className="text-xs text-green-700"><strong>{language === 'de' ? 'Bedingung' : 'Condition'}:</strong> {t(sc.condition)}</p>
                                      {t(sc.action) && <p className="text-xs text-green-600"><strong>{language === 'de' ? 'Aktion' : 'Action'}:</strong> {t(sc.action)}</p>}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )})}
                  </div>
                </div>
              )}

              {/* Diagrams Tab */}
              {stepViewMode === 'diagrams' && (
                <div className="fade-in">
                  {/* Diagram Selection */}
                  <div className="flex gap-4 mb-4">
                    {/* Diagram List - Sidebar */}
                    <div className="w-72 flex-shrink-0">
                      <div className="bg-white rounded-lg border shadow-sm overflow-hidden">
                        <div className="bg-gray-50 px-4 py-3 border-b">
                          <h3 className="font-semibold text-gray-700 flex items-center text-sm">
                            <Icon name="list" className="mr-2 text-blue-600" />
                            {language === 'de' ? 'Verfügbare Diagramme' : 'Available Diagrams'}
                          </h3>
                        </div>
                        <div className="divide-y max-h-96 overflow-y-auto">
                          {/* Function Flowchart */}
                          <button
                            onClick={() => handleDiagramSelect('function')}
                            className={`w-full text-left p-3 hover:bg-gray-50 transition-colors ${
                              selectedDiagram === 'function' ? 'bg-blue-50 border-l-4 border-blue-500' : ''
                            }`}
                          >
                            <div className="flex items-center gap-2">
                              <div className={`w-8 h-8 rounded flex items-center justify-center ${
                                selectedDiagram === 'function' ? 'bg-blue-100' : 'bg-gray-100'
                              }`}>
                                <Icon name="sitemap" className={selectedDiagram === 'function' ? 'text-blue-600' : 'text-gray-500'} />
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm text-gray-800 truncate">
                                  {language === 'de' ? 'Funktions-Flowchart' : 'Function Flowchart'}
                                </div>
                                <div className="text-xs text-gray-500">
                                  {language === 'de' ? 'Generiert aus Ablaufschritten' : 'Generated from flow steps'}
                                </div>
                              </div>
                            </div>
                          </button>

                          {/* Related Process Diagrams */}
                          {relatedProcesses.length > 0 && (
                            <>
                              <div className="px-3 py-2 bg-gray-50 text-xs font-semibold text-gray-500 uppercase">
                                {language === 'de' ? 'Prozessdiagramme' : 'Process Diagrams'}
                              </div>
                              {relatedProcesses.map(proc => {
                                const procKey = `${proc.actor}-${proc.diagramType}-${proc.id}`;
                                const isSelected = selectedDiagram === procKey;
                                return (
                                  <button
                                    key={procKey}
                                    onClick={() => handleDiagramSelect(procKey)}
                                    className={`w-full text-left p-3 hover:bg-gray-50 transition-colors ${
                                      isSelected ? 'bg-teal-50 border-l-4 border-teal-500' : ''
                                    }`}
                                  >
                                    <div className="flex items-center gap-2">
                                      <div className={`w-8 h-8 rounded flex items-center justify-center ${
                                        proc.diagramType === 'flow' 
                                          ? (isSelected ? 'bg-blue-100' : 'bg-blue-50')
                                          : (isSelected ? 'bg-purple-100' : 'bg-purple-50')
                                      }`}>
                                        <Icon 
                                          name={proc.diagramType === 'flow' ? 'sitemap' : 'exchange-alt'} 
                                          className={proc.diagramType === 'flow' ? 'text-blue-600' : 'text-purple-600'}
                                        />
                                      </div>
                                      <div className="flex-1 min-w-0">
                                        <div className="font-medium text-sm text-gray-800 truncate">
                                          {t(proc.name)}
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-gray-500">
                                          <span className="capitalize">{proc.actor}</span>
                                          <span>•</span>
                                          <span>{proc.diagramType === 'flow' ? 'Flow' : 'Sequenz'}</span>
                                        </div>
                                      </div>
                                    </div>
                                  </button>
                                );
                              })}
                            </>
                          )}

                          {relatedProcesses.length === 0 && (
                            <div className="p-3 text-sm text-gray-500 text-center">
                              <Icon name="info-circle" className="mr-1" />
                              {language === 'de' 
                                ? 'Keine Prozesse verwenden diese Funktion' 
                                : 'No processes use this function'}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Diagram Display - Full Width */}
                    <div className="flex-1 min-w-0">
                      {loadingDiagram ? (
                        <div className="bg-white rounded-lg border shadow-sm p-8 flex items-center justify-center">
                          <div className="loading-spinner mr-2"></div>
                          <span className="text-gray-500">
                            {language === 'de' ? 'Lade Diagramm...' : 'Loading diagram...'}
                          </span>
                        </div>
                      ) : selectedDiagram === 'function' ? (
                        <MermaidFlowchartView 
                          mermaidCode={generateMermaidFlowchart()} 
                          language={language}
                          type="function"
                        />
                      ) : (processMermaidContent?.[language] || processMermaidContent?.de || processMermaidContent) ? (
                        <MermaidFlowchartView 
                          mermaidCode={processMermaidContent?.[language] || processMermaidContent?.de || processMermaidContent} 
                          language={language}
                          type="process"
                        />
                      ) : (
                        <div className="bg-white rounded-lg border shadow-sm p-8 text-center text-gray-500">
                          <Icon name="exclamation-circle" className="text-2xl mb-2" />
                          <p>{language === 'de' ? 'Kein Diagramm verfügbar' : 'No diagram available'}</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Logging Tab */}
              {stepViewMode === 'logging' && (data.systemLog || data.transactionLog) && (
                <LoggingSection 
                  systemLog={data.systemLog} 
                  transactionLog={data.transactionLog}
                  functionName={data.name}
                  onNavigateToType={onNavigateToType}
                  availableTypes={availableTypes}
                  language={language}
                />
              )}
            </div>
          </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Logging Section Component
    // ============================================
    
    const LoggingSection = ({ systemLog, transactionLog, functionName, onNavigateToType, availableTypes, language = 'de' }) => {
      const [activeLogTab, setActiveLogTab] = useState(transactionLog ? 'transaction' : 'system');
      const [logViewMode, setLogViewMode] = useState('overview'); // 'overview', 'asn1', 'fields', 'diagram'
      
      const activeLog = activeLogTab === 'transaction' ? transactionLog : systemLog;

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);
      
      // Get origin badge color
      const getOriginColor = (origin) => {
        if (!origin || origin === '-') return 'bg-gray-100 text-gray-600';
        if (origin.includes('device')) return 'bg-blue-100 text-blue-700';
        if (origin.includes('Secure Element')) return 'bg-purple-100 text-purple-700';
        if (origin.includes('External')) return 'bg-green-100 text-green-700';
        return 'bg-gray-100 text-gray-600';
      };

      // Render type reference
      const renderFieldType = (typeName) => {
        if (!typeName) return <span className="text-gray-400">-</span>;
        
        // Check if it's a known type
        if (availableTypes?.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-xs font-mono cursor-pointer hover:bg-purple-100 hover:underline"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
            >
              {typeName}
            </span>
          );
        }
        
        return <span className="font-mono text-xs text-blue-600">{typeName}</span>;
      };

      // Generate simplified ASN.1 diagram
      const generateAsn1Diagram = () => {
        if (!activeLog?.fields) return '';
        
        let diagram = `┌─────────────────────────────────────────────────────────────┐\n`;
        diagram += `│  ${activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} (SEQUENCE)\n`;
        diagram += `├─────────────────────────────────────────────────────────────┤\n`;
        
        activeLog.fields.forEach((field, idx) => {
          const reqMarker = field.required ? '●' : '○';
          const tagInfo = field.tag ? ` ${field.tag}` : '';
          diagram += `│ ${reqMarker} ${field.name.padEnd(25)} : ${field.type}${tagInfo}\n`;
        });
        
        diagram += `└─────────────────────────────────────────────────────────────┘`;
        return diagram;
      };

      if (!activeLog) return null;

      return (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
          {/* Header with tabs */}
          <div className="bg-gradient-to-r from-emerald-600 to-teal-600 p-4">
            <div className="flex items-center justify-between">
              <h3 className="text-white font-semibold flex items-center text-lg">
                <Icon name="file-alt" className="mr-2" />
                {language === 'de' ? 'Logging-Anforderungen' : 'Logging Requirements'}
              </h3>
              
              {/* Log Type Tabs */}
              {systemLog && transactionLog && (
                <div className="flex bg-white/20 rounded-lg p-0.5">
                  <button
                    onClick={() => setActiveLogTab('transaction')}
                    className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${
                      activeLogTab === 'transaction' 
                        ? 'bg-white text-emerald-700' 
                        : 'text-white hover:bg-white/10'
                    }`}
                  >
                    <Icon name="exchange-alt" className="mr-1" />
                    Transaction-Log
                  </button>
                  <button
                    onClick={() => setActiveLogTab('system')}
                    className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${
                      activeLogTab === 'system' 
                        ? 'bg-white text-emerald-700' 
                        : 'text-white hover:bg-white/10'
                    }`}
                  >
                    <Icon name="cog" className="mr-1" />
                    System-Log
                  </button>
                </div>
              )}
            </div>
            
            {/* Log Type Badge */}
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                activeLogTab === 'transaction' 
                  ? 'bg-yellow-500 text-yellow-900' 
                  : 'bg-blue-500 text-blue-100'
              }`}>
                {activeLog.logType}
              </span>
              <span className="px-3 py-1 bg-white/20 rounded-full text-white text-sm">
                {activeLog.requirement}
              </span>
              {activeLog.fields && (
                <span className="px-3 py-1 bg-white/20 rounded-full text-white text-sm">
                  {activeLog.fields.length} {language === 'de' ? 'Felder' : 'Fields'}
                </span>
              )}
            </div>
          </div>

          {/* View Mode Switcher */}
          <div className="p-4 bg-gray-50 border-b flex items-center justify-between">
            <div className="flex bg-gray-200 rounded-lg p-0.5">
              <button
                onClick={() => setLogViewMode('overview')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'overview' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="th-large" className="mr-1" />
                {language === 'de' ? 'Übersicht' : 'Overview'}
              </button>
              <button
                onClick={() => setLogViewMode('fields')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'fields' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="table" className="mr-1" />
                {language === 'de' ? 'Felder' : 'Fields'}
              </button>
              <button
                onClick={() => setLogViewMode('asn1')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'asn1' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="code" className="mr-1" />
                ASN.1
              </button>
              <button
                onClick={() => setLogViewMode('diagram')}
                className={`px-3 py-1.5 rounded text-sm transition-colors ${
                  logViewMode === 'diagram' ? 'bg-white shadow text-emerald-600' : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <Icon name="sitemap" className="mr-1" />
                {language === 'de' ? 'Struktur' : 'Structure'}
              </button>
            </div>
          </div>

          {/* Overview Mode */}
          {logViewMode === 'overview' && (
            <div className="p-6">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Quick Info Cards */}
                <div className="space-y-4">
                  <div className="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                    <h4 className="font-semibold text-blue-800 mb-2 flex items-center">
                      <Icon name="info-circle" className="mr-2" />
                      {language === 'de' ? 'Log-Typ' : 'Log Type'}
                    </h4>
                    <p className="text-blue-700">{activeLog.logType}</p>
                  </div>
                  
                  <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
                    <h4 className="font-semibold text-green-800 mb-2 flex items-center">
                      <Icon name="check-circle" className="mr-2" />
                      {language === 'de' ? 'Anforderung' : 'Requirement'}
                    </h4>
                    <p className="text-green-700 text-sm">{activeLog.requirement}</p>
                  </div>

                  {/* Required Fields Summary */}
                  {activeLog.fields && (
                    <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-100">
                      <h4 className="font-semibold text-purple-800 mb-2 flex items-center">
                        <Icon name="asterisk" className="mr-2" />
                        {language === 'de' ? 'Pflichtfelder' : 'Required Fields'}
                      </h4>
                      <div className="flex flex-wrap gap-1">
                        {activeLog.fields.filter(f => f.required).map((field, idx) => (
                          <span key={idx} className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-mono">
                            {field.name}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Field Origin Distribution */}
                {activeLog.fields && (
                  <div className="p-4 bg-gray-50 rounded-lg border">
                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                      <Icon name="sitemap" className="mr-2 text-gray-500" />
                      {language === 'de' ? 'Feld-Herkunft' : 'Field Origin'}
                    </h4>
                    <div className="space-y-2">
                      {(() => {
                        const origins = {};
                        activeLog.fields.forEach(f => {
                          const origin = f.origin || (language === 'de' ? 'Unbekannt' : 'Unknown');
                          origins[origin] = (origins[origin] || 0) + 1;
                        });
                        return Object.entries(origins).map(([origin, count], idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <span className={`px-2 py-1 rounded text-xs ${getOriginColor(origin)}`}>
                              {origin}
                            </span>
                            <span className="text-gray-500 text-sm">{count} {language === 'de' ? 'Felder' : 'Fields'}</span>
                          </div>
                        ));
                      })()}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Fields Table Mode */}
          {logViewMode === 'fields' && activeLog.fields && (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Feld' : 'Field'}</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Typ' : 'Type'}</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Tag</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Pflicht' : 'Required'}</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Standard' : 'Default'}</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Beschreibung' : 'Description'}</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">{language === 'de' ? 'Herkunft' : 'Origin'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {activeLog.fields.map((field, idx) => (
                    <tr key={idx} className={`hover:bg-gray-50 ${field.note === 'RFU' ? 'opacity-50' : ''}`}>
                      <td className="px-4 py-3">
                        <code className="text-emerald-700 font-semibold bg-emerald-50 px-2 py-0.5 rounded text-sm">
                          {field.name}
                        </code>
                        {field.note && (
                          <span className="ml-2 px-1.5 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">
                            {field.note}
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {renderFieldType(field.type)}
                      </td>
                      <td className="px-4 py-3">
                        {field.tag ? (
                          <code className="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">
                            {field.tag}
                          </code>
                        ) : (
                          <span className="text-gray-300">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {field.required ? (
                          <span className="text-green-600"><Icon name="check-circle" /></span>
                        ) : (
                          <span className="text-gray-300"><Icon name="minus" /></span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {field.defaultValue ? (
                          <code className="text-xs text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded">
                            {field.defaultValue}
                          </code>
                        ) : (
                          <span className="text-gray-300">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-600 max-w-xs">
                        {t(field.description) || '-'}
                      </td>
                      <td className="px-4 py-3">
                        <span className={`px-2 py-0.5 rounded text-xs ${getOriginColor(field.origin)}`}>
                          {field.origin || '-'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* ASN.1 Mode */}
          {logViewMode === 'asn1' && activeLog.asn1Structure && (
            <div className="p-6 space-y-6">
              {/* LogMessage Structure */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                  <Icon name="file-code" className="mr-2 text-blue-500" />
                  LogMessage {language === 'de' ? 'Struktur' : 'Structure'}
                </h4>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  <code>{activeLog.asn1Structure.logMessage}</code>
                </pre>
              </div>
              
              {/* Specific Log Message Structure */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                  <Icon name="file-code" className="mr-2 text-purple-500" />
                  {activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} {language === 'de' ? 'Struktur' : 'Structure'}
                </h4>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  <code>
                    {activeLogTab === 'transaction' 
                      ? activeLog.asn1Structure.transactionLogMessage 
                      : activeLog.asn1Structure.systemLogMessage}
                  </code>
                </pre>
              </div>
            </div>
          )}

          {/* Structure Diagram Mode */}
          {logViewMode === 'diagram' && activeLog.fields && (
            <div className="p-6">
              {/* Visual Structure */}
              <div className="space-y-4">
                <h4 className="font-semibold text-gray-700 mb-3 flex items-center">
                  <Icon name="project-diagram" className="mr-2 text-indigo-500" />
                  {language === 'de' ? 'Visuelle Feldstruktur' : 'Visual Field Structure'}
                </h4>
                
                {/* Nested Structure Visualization */}
                <div className="bg-gray-50 rounded-lg p-4 border">
                  <div className="font-mono text-sm">
                    <div className="text-purple-600 font-bold mb-2">
                      {activeLogTab === 'transaction' ? 'TransactionLogMessage' : 'SystemLogMessage'} ::= SEQUENCE {'{'}
                    </div>
                    <div className="ml-4 space-y-1">
                      {activeLog.fields.map((field, idx) => (
                        <div key={idx} className={`flex items-start gap-2 py-1 px-2 rounded ${
                          field.required ? 'bg-green-50' : 'bg-gray-100'
                        } ${field.note === 'RFU' ? 'opacity-50' : ''}`}>
                          <span className={`w-4 h-4 rounded-full flex-shrink-0 mt-0.5 flex items-center justify-center text-xs ${
                            field.required ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'
                          }`}>
                            {field.required ? '●' : '○'}
                          </span>
                          <div className="flex-1">
                            <span className="text-blue-600">{field.name}</span>
                            {field.tag && <span className="text-gray-400 ml-2">{field.tag}</span>}
                            <span className="text-gray-500 mx-2">:</span>
                            <span className="text-purple-600">{field.type}</span>
                            {!field.required && <span className="text-orange-500 ml-2">OPTIONAL</span>}
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="text-purple-600 font-bold mt-2">{'}'}</div>
                  </div>
                </div>

                {/* ASCII Diagram */}
                <div>
                  <h4 className="font-semibold text-gray-700 mb-2 flex items-center">
                    <Icon name="terminal" className="mr-2 text-gray-500" />
                    {language === 'de' ? 'ASCII-Darstellung' : 'ASCII Representation'}
                  </h4>
                  <pre className="bg-gray-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto font-mono">
                    {generateAsn1Diagram()}
                  </pre>
                </div>

                {/* Legend */}
                <div className="flex items-center gap-6 text-sm text-gray-600 mt-4 p-3 bg-gray-100 rounded-lg">
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-green-500"></span> {language === 'de' ? 'Pflichtfeld' : 'Required'}
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-gray-300"></span> {language === 'de' ? 'Optional' : 'Optional'}
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="opacity-50">{language === 'de' ? 'Ausgegraut' : 'Grayed out'}</span> = RFU ({language === 'de' ? 'Reserviert für zukünftige Verwendung' : 'Reserved for Future Use'})
                  </span>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // Types List Component
    // ============================================

    const TypesView = ({ instance, onSelectItem, language }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedCategories, setExpandedCategories] = useState({});

      // Set page title
      usePageTitle(`${language === 'de' ? 'Datentypen' : 'Types'}`);

      useEffect(() => {
        loadTypes();
      }, [instance]);

      const loadTypes = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/types'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
          }
        } catch (err) {
          console.error('Error loading types:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};
        if (!searchTerm) return data.grouped;

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="cube" className="mr-3 text-purple-600" />
                Datentypen
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Datentyp suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Type Groups */}
            <div className="space-y-4">
              {Object.entries(filteredGroups).map(([category, items]) => (
                <div key={category} className="bg-white rounded-lg shadow overflow-hidden">
                  <div 
                    className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                    onClick={() => toggleCategory(category)}
                  >
                    <div className="flex items-center gap-3">
                      <Icon 
                        name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                        className="text-gray-400"
                      />
                      <span className="font-semibold text-gray-700">{category}</span>
                      <span className="badge bg-purple-100 text-purple-700 rounded-full">{items.length}</span>
                    </div>
                  </div>

                  {expandedCategories[category] && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                      {items.map(type => (
                        <div 
                          key={type.id}
                          className="item-card p-4 border rounded-lg hover:border-purple-300 cursor-pointer"
                          onClick={() => onSelectItem && onSelectItem('type', type)}
                        >
                          <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                              <Icon name="cube" className="text-purple-600" />
                            </div>
                            <div className="flex-1 min-w-0">
                              <code className="text-purple-600 font-semibold text-sm block truncate">{type.name}</code>
                              <p className="text-xs text-gray-600 mt-1 line-clamp-2">{type.description || 'Keine Beschreibung'}</p>
                              <div className="flex items-center gap-2 mt-2">
                                <span className="text-xs text-gray-500">
                                  <Icon name="layer-group" className="mr-1" />
                                  {type.fieldCount} Felder
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Type Detail View Component
    // ============================================

    const TypeDetailView = ({ instance, typeId, onBack, onNavigateToType, onNavigateToEnum, onNavigateToOtherType, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [availableTypes, setAvailableTypes] = useState([]);
      const [availableEnums, setAvailableEnums] = useState([]);
      const [allTypes, setAllTypes] = useState([]);
      const [groupedTypes, setGroupedTypes] = useState({});
      const [currentGroup, setCurrentGroup] = useState(null);

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(data ? `${data.name} - ${language === 'de' ? 'Datentyp' : 'Type'}` : null);

      useEffect(() => {
        loadType();
        loadAvailableTypesAndEnums();
      }, [instance, typeId]);

      const loadType = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/type/${typeId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.type);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading type:', err);
          setError('Fehler beim Laden des Typs');
        }
        setLoading(false);
      };

      const loadAvailableTypesAndEnums = async () => {
        try {
          // Load types
          const typesResponse = await fetch(getApiUrl(instance, '/types'));
          const typesResult = await typesResponse.json();
          if (typesResult.success) {
            setAvailableTypes(typesResult.items.map(t => t.name));
            setAllTypes(typesResult.items || []);
            setGroupedTypes(typesResult.grouped || {});
            // Find current group
            Object.entries(typesResult.grouped || {}).forEach(([groupName, items]) => {
              if (items.some(item => item.name === typeId)) {
                setCurrentGroup(groupName);
              }
            });
          }
          
          // Load enums
          const enumsResponse = await fetch(getApiUrl(instance, '/enums'));
          const enumsResult = await enumsResponse.json();
          if (enumsResult.success) {
            setAvailableEnums(enumsResult.items.map(e => e.name));
          }
        } catch (err) {
          console.error('Error loading available types/enums:', err);
        }
      };

      const handleNavigateToOtherType = (type) => {
        if (onNavigateToOtherType) {
          onNavigateToOtherType(type);
        } else if (onNavigateToType) {
          onNavigateToType(type.name);
        }
      };

      const getTypeKindInfo = (kind) => {
        switch (kind) {
          case 'simple': return { label: 'Einfacher Typ', icon: 'tag', color: 'green' };
          case 'result': return { label: 'Ergebnis-Typ', icon: 'check-circle', color: 'blue' };
          case 'eventData': return { label: 'Event-Daten', icon: 'bolt', color: 'yellow' };
          default: return { label: 'Komplexer Typ', icon: 'cubes', color: 'purple' };
        }
      };

      // Render a type reference - links to type/enum if available
      const renderTypeReference = (typeName) => {
        if (!typeName) return <span className="text-gray-400">-</span>;
        
        // Check if it's an available type
        if (availableTypes.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded text-sm font-mono cursor-pointer hover:bg-purple-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToType && onNavigateToType(typeName)}
              title={`Typ "${typeName}" anzeigen`}
            >
              <Icon name="cube" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        // Check if it's an available enum
        if (availableEnums.includes(typeName)) {
          return (
            <span 
              className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-sm font-mono cursor-pointer hover:bg-amber-100 hover:underline transition-colors inline-flex items-center gap-1"
              onClick={() => onNavigateToEnum && onNavigateToEnum(typeName)}
              title={`Enum "${typeName}" anzeigen`}
            >
              <Icon name="list-ol" className="text-xs" />
              {typeName}
            </span>
          );
        }
        
        // Standard type (not linkable)
        return (
          <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
            {typeName}
          </span>
        );
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      const kindInfo = getTypeKindInfo(data.typeKind);

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="types"
            currentId={typeId}
            currentName={data?.name || typeId}
            groupedItems={groupedTypes}
            currentGroup={currentGroup}
            onBack={onBack}
            onNavigate={handleNavigateToOtherType}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="cube" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        {data.category && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.category}
                          </span>
                        )}
                        <span className={`px-3 py-1 rounded-full text-sm flex items-center gap-1 ${
                          kindInfo.color === 'green' ? 'bg-green-600 text-green-100' :
                          kindInfo.color === 'blue' ? 'bg-blue-600 text-blue-100' :
                          kindInfo.color === 'yellow' ? 'bg-yellow-600 text-yellow-100' :
                          'bg-purple-800 text-purple-100'
                        }`}>
                          <Icon name={kindInfo.icon} className="text-xs" />
                          {kindInfo.label}
                        </span>
                        {data.fieldCount > 0 && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.fieldCount} {language === 'de' ? 'Felder' : 'Fields'}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  {language === 'de' ? 'Beschreibung' : 'Description'}
                </h2>
                <p className="text-gray-700 leading-relaxed">{t(data.description) || (language === 'de' ? 'Keine Beschreibung verfügbar.' : 'No description available.')}</p>
              </div>
            </div>

            {/* Base Type (for simple types) */}
            {data.baseType && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="link" className="mr-2 text-green-500" />
                  Basistyp
                </h3>
                <code className="text-lg text-green-700 bg-green-50 px-3 py-1 rounded">{data.baseType}</code>
              </div>
            )}

            {/* ASN.1 Definition */}
            {data.asn1Definition && (
              <div className="bg-white rounded-lg shadow p-5 mb-6">
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="code" className="mr-2 text-indigo-500" />
                  ASN.1 Definition
                </h3>
                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                  {data.asn1Definition}
                </pre>
              </div>
            )}

            {/* Fields Table */}
            {data.fields && data.fields.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div className="p-4 bg-gray-50 border-b">
                  <h3 className="font-semibold text-gray-800 flex items-center">
                    <Icon name="layer-group" className="mr-2 text-purple-500" />
                    Felder
                    <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">
                      {data.fields.length}
                    </span>
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Typ</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Beschreibung</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {data.fields.map((field, idx) => (
                        <tr key={idx} className="hover:bg-gray-50">
                          <td className="px-4 py-3">
                            <code className="text-purple-700 font-semibold bg-purple-50 px-2 py-0.5 rounded">
                              {field.name}
                            </code>
                            {field.getter && (
                              <span className="block text-xs text-gray-400 mt-1 font-mono">
                                {field.getter}
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            {renderTypeReference(field.type)}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                            {field.description || '-'}
                            {field.defaultValue && (
                              <p className="text-gray-400 text-xs mt-1">
                                Default: <code>{field.defaultValue}</code>
                              </p>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            {field.optional ? (
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">
                                Optional
                              </span>
                            ) : (
                              <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                                <Icon name="check" className="mr-1" />
                                Required
                              </span>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Additional Info Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Usage */}
              {data.usage && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="crosshairs" className="mr-2 text-blue-500" />
                    Verwendung
                  </h3>
                  <p className="text-gray-600 text-sm">{data.usage}</p>
                </div>
              )}

              {/* Constraints */}
              {data.constraints && data.constraints.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="lock" className="mr-2 text-red-500" />
                    Einschränkungen
                  </h3>
                  <div className="space-y-2">
                    {data.constraints.map((c, idx) => (
                      <div key={idx} className="p-3 bg-red-50 rounded border-l-2 border-red-300">
                        <span className="font-medium text-red-700 text-sm">{c.type}</span>
                        {c.description && (
                          <p className="text-red-600 text-xs mt-1">{c.description}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Notes */}
              {data.notes && data.notes.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                    Hinweise
                  </h3>
                  <ul className="space-y-2">
                    {data.notes.map((note, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-start">
                        <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                        {note}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* Type Kind Info Box */}
            <div className={`mt-6 p-4 rounded-lg border ${
              kindInfo.color === 'green' ? 'bg-green-50 border-green-200 text-green-800' :
              kindInfo.color === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-800' :
              kindInfo.color === 'yellow' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
              'bg-purple-50 border-purple-200 text-purple-800'
            }`}>
              <div className="flex items-center gap-3">
                <Icon name={kindInfo.icon} className="text-xl" />
                <div>
                  <span className="font-semibold">{kindInfo.label}</span>
                  <p className="text-sm opacity-80">
                    {data.typeKind === 'simple' && 'Dieser Typ ist eine einfache Typ-Definition basierend auf einem Basistyp.'}
                    {data.typeKind === 'result' && 'Dieser Typ wird als Rückgabewert von API-Funktionen verwendet.'}
                    {data.typeKind === 'eventData' && 'Dieser Typ enthält Event-spezifische Daten für System-Log-Einträge.'}
                    {data.typeKind === 'complex' && 'Dieser Typ ist eine komplexe Datenstruktur mit mehreren Feldern.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enums List Component
    // ============================================

    const EnumsView = ({ instance, onSelectItem, language }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');

      // Set page title
      usePageTitle(`${language === 'de' ? 'Aufzählungen' : 'Enums'}`);

      useEffect(() => {
        loadEnums();
      }, [instance]);

      const loadEnums = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/enums'));
          const result = await response.json();
          if (result.success) {
            setData(result);
          }
        } catch (err) {
          console.error('Error loading enums:', err);
        }
        setLoading(false);
      };

      const filteredItems = useMemo(() => {
        if (!data?.items) return [];
        if (!searchTerm) return data.items;
        return data.items.filter(item => 
          item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          item.description?.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }, [data, searchTerm]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="list-ol" className="mr-3 text-amber-600" />
                Aufzählungen (Enums)
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="relative">
                <input
                  type="text"
                  placeholder="Enum suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                />
                <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
              </div>
            </div>

            {/* Enum Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {filteredItems.map(enumItem => (
                <div 
                  key={enumItem.id}
                  className="item-card bg-white rounded-lg shadow overflow-hidden cursor-pointer"
                  onClick={() => onSelectItem && onSelectItem('enum', enumItem)}
                >
                  <div className="p-4 border-b bg-amber-50">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <Icon name="list-ol" className="text-amber-600" />
                      </div>
                      <div>
                        <code className="text-amber-700 font-semibold">{enumItem.name}</code>
                        <div className="text-xs text-gray-500">{enumItem.category}</div>
                      </div>
                    </div>
                  </div>
                  <div className="p-4">
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                      {enumItem.description || 'Keine Beschreibung'}
                    </p>
                    <div className="text-xs font-semibold text-gray-500 mb-2">
                      Werte ({enumItem.valueCount}):
                    </div>
                    <div className="flex flex-wrap gap-1">
                      {enumItem.values.slice(0, 6).map((val, idx) => (
                        <span 
                          key={idx}
                          className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-700 font-mono"
                        >
                          {val.name}
                          {val.numericValue !== undefined && (
                            <span className="text-gray-400 ml-1">({val.numericValue})</span>
                          )}
                        </span>
                      ))}
                      {enumItem.values.length > 6 && (
                        <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-500">
                          +{enumItem.values.length - 6}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Enum Detail View Component
    // ============================================

    const EnumDetailView = ({ instance, enumId, onBack, onNavigateToEnum, onNavigateToOtherEnum, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [allEnums, setAllEnums] = useState([]);

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(data ? `${data.name} - ${language === 'de' ? 'Aufzählung' : 'Enumeration'}` : null);

      useEffect(() => {
        loadEnum();
        loadAllEnums();
      }, [instance, enumId]);

      const loadEnum = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/enum/${enumId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.enum);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading enum:', err);
          setError('Fehler beim Laden des Enums');
        }
        setLoading(false);
      };

      const loadAllEnums = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/enums'));
          const result = await response.json();
          if (result.success) {
            setAllEnums(result.items || []);
          }
        } catch (err) {
          console.error('Error loading all enums:', err);
        }
      };

      const handleNavigateToOtherEnum = (enumItem) => {
        if (onNavigateToOtherEnum) {
          onNavigateToOtherEnum(enumItem);
        } else if (onNavigateToEnum) {
          onNavigateToEnum(enumItem.name);
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="enums"
            currentId={enumId}
            currentName={data?.name || enumId}
            items={allEnums}
            onBack={onBack}
            onNavigate={handleNavigateToOtherEnum}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header Card */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-amber-500 to-amber-600 p-6 text-white">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="list-ol" className="text-3xl" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-3 mt-2">
                        {data.category && (
                          <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                            {data.category}
                          </span>
                        )}
                        <span className="px-3 py-1 bg-white/20 rounded-full text-sm">
                          {data.valueCount} {language === 'de' ? 'Werte' : 'Values'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                  <Icon name="info-circle" className="mr-2 text-blue-500" />
                  Beschreibung
                </h2>
                <p className="text-gray-700 leading-relaxed">{data.description || 'Keine Beschreibung verfügbar.'}</p>
                {data.germanText && (
                  <p className="text-gray-600 mt-2 italic">{data.germanText}</p>
                )}
              </div>
            </div>

            {/* Values Table */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="p-4 bg-gray-50 border-b">
                <h3 className="font-semibold text-gray-800 flex items-center">
                  <Icon name="list" className="mr-2 text-amber-500" />
                  Enumerationswerte
                  <span className="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full">
                    {data.values.length}
                  </span>
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Wert</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Beschreibung</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {data.values.map((val, idx) => (
                      <tr key={idx} className={`hover:bg-gray-50 ${val.deprecated ? 'opacity-60' : ''}`}>
                        <td className="px-4 py-3">
                          <code className="text-amber-700 font-semibold bg-amber-50 px-2 py-0.5 rounded">
                            {val.name}
                          </code>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            {val.numericValue !== undefined && (
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-sm font-mono">
                                {val.numericValue}
                              </span>
                            )}
                            {val.hexValue && (
                              <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-sm font-mono">
                                {val.hexValue}
                              </span>
                            )}
                            {val.numericValue === undefined && !val.hexValue && (
                              <span className="text-gray-400 text-sm">-</span>
                            )}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 max-w-md">
                          {val.description || '-'}
                          {val.germanText && (
                            <p className="text-gray-400 text-xs mt-1 italic">{val.germanText}</p>
                          )}
                          {val.usage && (
                            <p className="text-blue-600 text-xs mt-1">
                              <Icon name="lightbulb" className="mr-1" />
                              {val.usage}
                            </p>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          {val.deprecated ? (
                            <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                              <Icon name="exclamation-triangle" className="mr-1" />
                              Veraltet
                            </span>
                          ) : (
                            <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                              <Icon name="check" className="mr-1" />
                              Aktiv
                            </span>
                          )}
                          {val.since && (
                            <span className="block text-gray-400 text-xs mt-1">
                              Seit: {val.since}
                            </span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Additional Info Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Type Info */}
              {data.typeInfo && (data.typeInfo.asn1Type || data.typeInfo.javaType || data.typeInfo.cType) && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="code" className="mr-2 text-purple-500" />
                    Typ-Informationen
                  </h3>
                  <div className="space-y-2">
                    {data.typeInfo.asn1Type && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">ASN.1 Type</span>
                        <code className="text-sm text-purple-600">{data.typeInfo.asn1Type}</code>
                      </div>
                    )}
                    {data.typeInfo.javaType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Java Type</span>
                        <code className="text-sm text-orange-600">{data.typeInfo.javaType}</code>
                      </div>
                    )}
                    {data.typeInfo.cType && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">C Type</span>
                        <code className="text-sm text-blue-600">{data.typeInfo.cType}</code>
                      </div>
                    )}
                    {data.typeInfo.encoding && (
                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span className="text-sm text-gray-600">Encoding</span>
                        <code className="text-sm text-green-600">{data.typeInfo.encoding}</code>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Usage Context */}
              {data.usageContext && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="crosshairs" className="mr-2 text-blue-500" />
                    Verwendungskontext
                  </h3>
                  <p className="text-gray-600 text-sm">{data.usageContext}</p>
                </div>
              )}

              {/* Constraints */}
              {data.constraints && data.constraints.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="lock" className="mr-2 text-red-500" />
                    Einschränkungen
                  </h3>
                  <div className="space-y-2">
                    {data.constraints.map((c, idx) => (
                      <div key={idx} className="p-2 bg-red-50 rounded border-l-2 border-red-300">
                        <span className="font-medium text-red-700 text-sm">{c.type}</span>
                        {c.description && (
                          <p className="text-red-600 text-xs mt-1">{c.description}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Related Enumerations */}
              {data.relatedEnumerations && data.relatedEnumerations.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="link" className="mr-2 text-amber-500" />
                    Verwandte Enums
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {data.relatedEnumerations.map((rel, idx) => (
                      <span 
                        key={idx}
                        className="px-3 py-1 bg-amber-50 text-amber-700 rounded-full text-sm cursor-pointer hover:bg-amber-100 transition-colors"
                        onClick={() => onNavigateToEnum && onNavigateToEnum(rel)}
                      >
                        {rel}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Notes */}
              {data.notes && data.notes.length > 0 && (
                <div className="bg-white rounded-lg shadow p-5">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                    <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                    Hinweise
                  </h3>
                  <ul className="space-y-2">
                    {data.notes.map((note, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-start">
                        <Icon name="angle-right" className="mr-2 mt-1 text-gray-400" />
                        {note}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* Metadata Footer */}
            {(data.version || data.lastModified) && (
              <div className="mt-6 p-4 bg-gray-50 rounded-lg border text-sm text-gray-500">
                <div className="flex items-center gap-4">
                  {data.version && (
                    <span>
                      <Icon name="tag" className="mr-1" />
                      Version: {data.version}
                    </span>
                  )}
                  {data.lastModified && (
                    <span>
                      <Icon name="clock" className="mr-1" />
                      {language === 'de' ? 'Zuletzt geändert:' : 'Last modified:'} {data.lastModified}
                    </span>
                  )}
                </div>
              </div>
            )}
          </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Exception Detail View Component
    // ============================================

    const ExceptionDetailView = ({ instance, exceptionId, onBack, onNavigateToFunction, onNavigateToException, onNavigateToOtherException, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('overview');
      const [allExceptions, setAllExceptions] = useState([]);
      const [groupedExceptions, setGroupedExceptions] = useState({});
      const [currentGroup, setCurrentGroup] = useState(null);

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(data ? `${data.name} - Exception` : null);

      useEffect(() => {
        loadException();
        loadAllExceptions();
      }, [instance, exceptionId]);

      const loadException = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, `/exception/${exceptionId}`));
          const result = await response.json();
          if (result.success) {
            setData(result.exception);
          } else {
            setError(result.error || 'Fehler beim Laden');
          }
        } catch (err) {
          console.error('Error loading exception:', err);
          setError('Fehler beim Laden der Exception');
        }
        setLoading(false);
      };

      const loadAllExceptions = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/exceptions'));
          const result = await response.json();
          if (result.success) {
            setAllExceptions(result.items || []);
            setGroupedExceptions(result.grouped || {});
            // Find current group
            Object.entries(result.grouped || {}).forEach(([groupName, items]) => {
              if (items.some(item => item.name === exceptionId)) {
                setCurrentGroup(groupName);
              }
            });
          }
        } catch (err) {
          console.error('Error loading all exceptions:', err);
        }
      };

      const handleNavigateToOtherException = (exc) => {
        if (onNavigateToOtherException) {
          onNavigateToOtherException(exc);
        } else if (onNavigateToException) {
          onNavigateToException(exc.name);
        }
      };

      const getSeverityColor = (severity) => {
        switch (severity) {
          case 'Critical': return { bg: 'bg-red-500', light: 'bg-red-100', text: 'text-red-700', border: 'border-red-300' };
          case 'High': return { bg: 'bg-orange-500', light: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-300' };
          case 'Medium': return { bg: 'bg-yellow-500', light: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-300' };
          case 'Low': return { bg: 'bg-green-500', light: 'bg-green-100', text: 'text-green-700', border: 'border-green-300' };
          default: return { bg: 'bg-gray-500', light: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-300' };
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      const severityColor = getSeverityColor(data.severity);

      const tabs = [
        { id: 'overview', label: 'Übersicht', icon: 'info-circle' },
        { id: 'trigger', label: language === 'de' ? 'Ausführungssequenz' : 'Execution Sequence', icon: 'list' },
        { id: 'handling', label: language === 'de' ? 'Behandlung' : 'Handling', icon: 'first-aid' }
      ];

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="exceptions"
            currentId={exceptionId}
            currentName={data?.name || exceptionId}
            groupedItems={groupedExceptions}
            currentGroup={currentGroup}
            onBack={onBack}
            onNavigate={handleNavigateToOtherException}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-4">
          <div className="max-w-7xl mx-auto">
            {/* Compact Header */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-4">
              <div className={`${severityColor.bg} p-4 text-white`}>
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                      <Icon name="exclamation-triangle" className="text-2xl" />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold">{data.name}</h1>
                      <div className="flex items-center gap-2 mt-1 flex-wrap">
                        <span className="px-2 py-0.5 bg-white/20 rounded text-xs">{t(data.category)}</span>
                        {data.subcategory && t(data.subcategory) && (
                          <span className="px-2 py-0.5 bg-white/10 rounded text-xs">{t(data.subcategory)}</span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
                      {data.severity}
                    </span>
                    {data.thrownBy && data.thrownBy.length > 0 && (
                      <span className="px-3 py-1 bg-white/10 rounded-full text-xs">
                        {data.thrownBy.length} {language === 'de' ? 'Funktionen' : 'Functions'}
                      </span>
                    )}
                  </div>
                </div>
              </div>              

              {/* Description - compact */}
              <div className="p-4 bg-gray-50 border-b">
                <p className="text-gray-600 text-sm font-bold">{t(data.javadoc.summary)}</p>
                <p className="text-gray-700 text-sm leading-relaxed">{t(data.description)}</p>
              </div>

              {/* Tabs */}
              <div className="flex border-b bg-white overflow-x-auto">
                {tabs.map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors whitespace-nowrap ${
                      activeTab === tab.id
                        ? `${severityColor.text} border-current`
                        : 'text-gray-500 border-transparent hover:text-gray-700'
                    }`}
                  >
                    <Icon name={tab.icon} />
                    {tab.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Main Content with Sidebar */}
            <div className="flex gap-4 flex-col lg:flex-row">
              {/* Main Content Area */}
              <div className="flex-1 min-w-0">
                {/* Tab: Overview */}
                {activeTab === 'overview' && (
                  <div className="space-y-4">
                    {/* Notes & Implementation Context combined */}
                    {((data.notes && data.notes.length > 0) || (data.implementationContext && data.implementationContext.length > 0)) && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-base">
                          <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                          {language === 'de' ? 'Hinweise & Kontext' : 'Notes & Context'}
                        </h3>
                        <div className="space-y-2">
                          {data.notes && data.notes.map((note, idx) => (
                            <div key={`note-${idx}`} className="flex items-start gap-2 text-sm text-gray-600">
                              <Icon name="angle-right" className="text-yellow-400 mt-0.5 flex-shrink-0" />
                              <span>{t(note)}</span>
                            </div>
                          ))}
                          {data.implementationContext && data.implementationContext.map((note, idx) => (
                            <div key={`impl-${idx}`} className="flex items-start gap-2 text-sm text-gray-500">
                              <Icon name="cog" className="text-teal-400 mt-0.5 flex-shrink-0" />
                              <span>{t(note)}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Specification */}
                    {data.specification && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-base">
                          <Icon name="file-contract" className="mr-2 text-purple-500" />
                          {language === 'de' ? 'Spezifikation' : 'Specification'}
                        </h3>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          {data.specification.source && (
                            <div>
                              <span className="text-xs text-gray-400 uppercase">{language === 'de' ? 'Quelle' : 'Source'}</span>
                              <p className="text-gray-700">{data.specification.source}</p>
                            </div>
                          )}
                          {data.specification.section && (
                            <div>
                              <span className="text-xs text-gray-400 uppercase">{language === 'de' ? 'Abschnitt' : 'Section'}</span>
                              <p className="text-gray-700 font-mono text-xs">{data.specification.section}</p>
                            </div>
                          )}
                        </div>
                        {t(data.specification.applicability) && (
                          <p className="mt-2 text-sm text-gray-500">
                            <span className="font-medium">{language === 'de' ? 'Anwendbarkeit:' : 'Applicability:'}</span> {t(data.specification.applicability)}
                          </p>
                        )}
                        {t(data.specification.requirement) && (
                          <div className="mt-3 p-2 bg-purple-50 rounded text-sm text-gray-700 border-l-2 border-purple-400">
                            {t(data.specification.requirement)}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Related Exceptions */}
                    {data.relatedExceptions && data.relatedExceptions.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-base">
                          <Icon name="link" className="mr-2 text-orange-500" />
                          {language === 'de' ? 'Verwandte Exceptions' : 'Related Exceptions'}
                        </h3>
                        <div className="flex flex-wrap gap-2">
                          {data.relatedExceptions.map((exc, idx) => (
                            <span 
                              key={idx}
                              onClick={() => onNavigateToException && onNavigateToException(typeof exc === 'string' ? exc : exc.name)}
                              className="px-2 py-1 bg-red-50 text-red-700 rounded text-sm cursor-pointer hover:bg-red-100 transition-colors"
                            >
                              {typeof exc === 'string' ? exc : exc.name}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Tab: Trigger */}
                {activeTab === 'trigger' && (
                  <div className="space-y-4">
                    {/* Execution Sequence */}
                    {data.executionSequence && data.executionSequence.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-base">
                          <Icon name="list-ol" className="mr-2 text-indigo-500" />
                          {language === 'de' ? 'Ausführungssequenz' : 'Execution Sequence'}
                          <span className="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full">
                            {data.executionSequence.length} {language === 'de' ? 'Schritte' : 'Steps'}
                          </span>
                        </h3>
                        <div className="space-y-1">
                          {data.executionSequence.map((step, idx) => {
                            const stepDesc = t(step.description);
                            const isError = stepDesc.toLowerCase().includes('error') || 
                                           stepDesc.includes('→') ||
                                           (step.number && step.number.includes('a'));
                            return (
                              <div 
                                key={idx} 
                                className={`flex items-start gap-2 p-2 rounded text-sm ${
                                  isError ? 'bg-red-50 text-red-700' : 'bg-gray-50 text-gray-700'
                                }`}
                              >
                                <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold ${
                                  isError ? 'bg-red-200 text-red-800' : 'bg-indigo-100 text-indigo-700'
                                }`}>
                                  {step.number || idx + 1}
                                </span>
                                <div className="flex-1">
                                  {step.name && <span className="font-medium">{step.name}: </span>}
                                  {stepDesc}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Tab: Handling */}
                {activeTab === 'handling' && (
                  <div className="space-y-4">
                    {/* Recovery */}
                    {data.recovery && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-base">
                          <Icon name="first-aid" className="mr-2 text-green-500" />
                          {language === 'de' ? 'Wiederherstellung' : 'Recovery'}
                        </h3>
                        
                        {t(data.recovery.description) && (
                          <p className="text-gray-600 text-sm mb-3">{t(data.recovery.description)}</p>
                        )}
                        
                        {t(data.recovery.action) && (
                          <div className="p-2 bg-green-50 rounded border-l-2 border-green-400 mb-2">
                            <span className="text-xs font-medium text-green-700">{language === 'de' ? 'Empfohlene Aktion:' : 'Recommended Action:'}</span>
                            <p className="text-gray-700 text-sm mt-1">{t(data.recovery.action)}</p>
                          </div>
                        )}
                        
                        {t(data.recovery.alternativePath) && (
                          <div className="p-2 bg-blue-50 rounded border-l-2 border-blue-400 mb-2">
                            <span className="text-xs font-medium text-blue-700">{language === 'de' ? 'Alternativer Pfad:' : 'Alternative Path:'}</span>
                            <p className="text-gray-700 text-sm mt-1">{t(data.recovery.alternativePath)}</p>
                          </div>
                        )}
                        
                        {data.recovery.steps && data.recovery.steps.length > 0 && (
                          <ol className="space-y-1">
                            {data.recovery.steps.map((step, idx) => (
                              <li key={idx} className="flex items-start gap-2 text-sm text-gray-700">
                                <span className="flex-shrink-0 w-5 h-5 rounded-full bg-green-100 text-green-700 flex items-center justify-center text-sm font-medium">
                                  {idx + 1}
                                </span>
                                <span>{t(step)}</span>
                              </li>
                            ))}
                          </ol>
                        )}
                      </div>
                    )}

                    {/* Postconditionality */}
                    {data.postconditionality && data.postconditionality.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center text-base">
                          <Icon name="flag-checkered" className="mr-2 text-purple-500" />
                          {language === 'de' ? 'Zustand nach Exception' : 'Postcondition State'}
                          <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">
                            {data.postconditionality.length}
                          </span>
                        </h3>
                        <div className="space-y-2">
                          {data.postconditionality.map((state, idx) => (
                            <div key={idx} className="flex items-start gap-2">
                              <span className="w-2.5 h-2.5 bg-purple-500 flex-shrink-0 mt-1"></span>
                              <span className="text-gray-700 text-sm">{t(state.description) || t(state)}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Sidebar */}
              <div className="lg:w-64 flex-shrink-0 space-y-4">
                {/* Thrown By */}
                {data.thrownBy && data.thrownBy.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-800 mb-2 flex items-center text-sm">
                      <Icon name="code" className="mr-2 text-blue-500" />
                      {language === 'de' ? 'Funktionen' : 'Functions'}
                      <span className="ml-auto px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                        {data.thrownBy.length}
                      </span>
                    </h3>
                    <div className="max-h-48 overflow-y-auto space-y-1">
                      {data.thrownBy.map((func, idx) => (
                        <div 
                          key={idx}
                          onClick={() => onNavigateToFunction && onNavigateToFunction(func)}
                          className="flex items-center justify-between p-1.5 rounded hover:bg-blue-50 cursor-pointer text-xs group"
                        >
                          <code className="text-blue-600">{func}</code>
                          <Icon name="chevron-right" className="text-gray-300 group-hover:text-blue-500" />
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Quick Stats */}
                <div className={`rounded-lg p-4 ${severityColor.light} ${severityColor.border} border`}>
                  <div className="text-center">
                    <div className={`text-2xl font-bold ${severityColor.text}`}>{data.severity}</div>
                    <div className="text-xs text-gray-500 mt-1">{language === 'de' ? 'Schweregrad' : 'Severity'}</div>
                  </div>
                  <div className="mt-3 pt-3 border-t border-current/10 grid grid-cols-2 gap-2 text-center">
                    <div>
                      <div className="text-lg font-semibold text-gray-700">{data.thrownBy?.length || 0}</div>
                      <div className="text-xs text-gray-500">{language === 'de' ? 'Funktionen' : 'Functions'}</div>
                    </div>
                    <div>
                      <div className="text-lg font-semibold text-gray-700">{data.relatedExceptions?.length || 0}</div>
                      <div className="text-xs text-gray-500">{language === 'de' ? 'Verwandt' : 'Related'}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      );
    };


    // ============================================
    // Exceptions List Component
    // ============================================

    const ExceptionsView = ({ instance, onSelectItem, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterSeverity, setFilterSeverity] = useState('all');
      const [expandedCategories, setExpandedCategories] = useState({});
      const [activeCategory, setActiveCategory] = useState(null);
      const contentRef = useRef(null);
      const categoryRefs = useRef({});

      // Set page title
      usePageTitle(language === 'de' ? 'Exceptions' : 'Exceptions');

      // Helper to get text in current language
      const t = (obj) => getText(obj, language);

      useEffect(() => {
        loadExceptions();
      }, [instance]);

      const loadExceptions = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/exceptions'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            const expanded = {};
            Object.keys(result.grouped || {}).forEach(cat => {
              expanded[cat] = true;
            });
            setExpandedCategories(expanded);
            // Setze erste Kategorie als aktiv
            const cats = Object.keys(result.grouped || {});
            if (cats.length > 0) setActiveCategory(`cat-${cats[0].replace(/\s+/g, '-')}`);
          }
        } catch (err) {
          console.error('Error loading exceptions:', err);
        }
        setLoading(false);
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({
          ...prev,
          [category]: !prev[category]
        }));
      };

      const getSeverityColor = (severity) => {
        const colors = {
          'Critical': 'red',
          'High': 'orange',
          'Medium': 'yellow',
          'Low': 'green'
        };
        return colors[severity] || 'gray';
      };

      const getSeverityClasses = (severity) => {
        switch (severity) {
          case 'Critical': return 'bg-red-100 text-red-700';
          case 'High': return 'bg-orange-100 text-orange-700';
          case 'Medium': return 'bg-yellow-100 text-yellow-700';
          case 'Low': return 'bg-green-100 text-green-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      const filteredGroups = useMemo(() => {
        if (!data?.grouped) return {};

        const filtered = {};
        Object.entries(data.grouped).forEach(([cat, items]) => {
          const matchingItems = items.filter(item => {
            const descText = getText(item.description, language);
            const matchesSearch = !searchTerm || 
              item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              descText.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesSeverity = filterSeverity === 'all' || item.severity === filterSeverity;
            return matchesSearch && matchesSeverity;
          });
          if (matchingItems.length > 0) {
            filtered[cat] = matchingItems;
          }
        });
        return filtered;
      }, [data, searchTerm, filterSeverity]);

      // Scroll-Spy: Beobachte welche Kategorie gerade sichtbar ist
      useEffect(() => {
        if (!data?.grouped) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                setActiveCategory(entry.target.id);
              }
            });
          },
          {
            root: null,
            rootMargin: '-100px 0px -70% 0px',
            threshold: 0
          }
        );

        // Kurze Verzögerung um sicherzustellen, dass Refs gesetzt sind
        const timer = setTimeout(() => {
          Object.keys(categoryRefs.current).forEach(cat => {
            const el = categoryRefs.current[cat];
            if (el) observer.observe(el);
          });
        }, 100);

        return () => {
          clearTimeout(timer);
          observer.disconnect();
        };
      }, [data, searchTerm, filterSeverity]);

      const scrollToCategory = (category) => {
        const catId = `cat-${category.replace(/\s+/g, '-')}`;
        const element = categoryRefs.current[catId];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      const getCategoryId = (category) => `cat-${category.replace(/\s+/g, '-')}`;

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      const categories = Object.keys(filteredGroups);

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="exclamation-triangle" className="mr-3 text-red-600" />
                Exceptions
                <span className="ml-3 text-lg font-normal text-gray-500">({data?.count || 0})</span>
              </h2>
              
              <div className="flex items-center gap-4">
                {/* Severity Filter */}
                <select
                  value={filterSeverity}
                  onChange={(e) => setFilterSeverity(e.target.value)}
                  className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                >
                  <option value="all">Alle Schweregrade</option>
                  <option value="Critical">Critical</option>
                  <option value="High">High</option>
                  <option value="Medium">Medium</option>
                  <option value="Low">Low</option>
                </select>

                {/* Search */}
                <div className="relative">
                  <input
                    type="text"
                    placeholder="Exception suchen..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  />
                  <Icon name="search" className="absolute left-3 top-3 text-gray-400" />
                </div>
              </div>
            </div>

            {/* Main Content with TOC Sidebar */}
            <div className="flex gap-6">
              {/* Sticky TOC Sidebar */}
              <div className="hidden lg:block w-64 flex-shrink-0">
                <div className="sticky top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-gray-700 mb-3 flex items-center text-sm">
                      <Icon name="list" className="mr-2 text-red-500" />
                      Kategorien
                      <span className="ml-auto text-xs text-gray-400">{categories.length}</span>
                    </h3>
                    <nav className="space-y-1 max-h-[calc(100vh-200px)] overflow-y-auto">
                      {categories.map(category => {
                        const catId = getCategoryId(category);
                        const isActive = activeCategory === catId;
                        const itemCount = filteredGroups[category]?.length || 0;
                        
                        return (
                          <button
                            key={category}
                            onClick={() => scrollToCategory(category)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between group ${
                              isActive 
                                ? 'bg-red-50 text-red-700 font-medium border-l-3 border-red-500' 
                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                            }`}
                          >
                            <span className="truncate flex-1">{category}</span>
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-xs ${
                              isActive ? 'bg-red-200 text-red-800' : 'bg-gray-100 text-gray-500 group-hover:bg-gray-200'
                            }`}>
                              {itemCount}
                            </span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>

                  {/* Quick Stats */}
                  <div className="bg-white rounded-lg shadow p-4 mt-4">
                    <h3 className="font-semibold text-gray-700 mb-3 text-sm">Statistik</h3>
                    <div className="grid grid-cols-2 gap-2 text-center">
                      {['Critical', 'High', 'Medium', 'Low'].map(sev => {
                        const count = Object.values(filteredGroups).flat().filter(e => e.severity === sev).length;
                        if (count === 0) return null;
                        return (
                          <div key={sev} className={`p-2 rounded ${getSeverityClasses(sev)}`}>
                            <div className="text-lg font-bold">{count}</div>
                            <div className="text-xs">{sev}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              {/* Exception List */}
              <div className="flex-1 min-w-0 space-y-4" ref={contentRef}>
                {Object.entries(filteredGroups).map(([category, items]) => {
                  const catId = getCategoryId(category);
                  return (
                    <div 
                      key={category} 
                      id={catId}
                      ref={el => categoryRefs.current[catId] = el}
                      className="bg-white rounded-lg shadow overflow-hidden scroll-mt-4"
                    >
                      <div 
                        className="category-header px-4 py-3 bg-gray-50 border-b cursor-pointer flex items-center justify-between"
                        onClick={() => toggleCategory(category)}
                      >
                        <div className="flex items-center gap-3">
                          <Icon 
                            name={expandedCategories[category] ? 'chevron-down' : 'chevron-right'} 
                            className="text-gray-400"
                          />
                          <span className="font-semibold text-gray-700">{category}</span>
                          <span className="badge bg-red-100 text-red-700 rounded-full">{items.length}</span>
                        </div>
                      </div>

                      {expandedCategories[category] && (
                        <div className="divide-y">
                          {items.map(exc => {
                            return (
                              <div 
                                key={exc.id}
                                className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                                onClick={() => onSelectItem && onSelectItem('exception', exc)}
                              >
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <code className="text-red-600 font-semibold">{exc.name}</code>
                                      <span className={`badge rounded ${getSeverityClasses(exc.severity)}`}>
                                        {exc.severity}
                                      </span>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-1 line-clamp-2">{t(exc.description)}</p>
                                    {exc.thrownByCount > 0 && (
                                      <div className="flex items-center gap-2 mt-2 text-xs text-gray-500">
                                        <Icon name="code" className="mr-1" />
                                        {language === 'de' 
                                          ? `Verwendet in ${exc.thrownByCount} Funktion${exc.thrownByCount !== 1 ? 'en' : ''}`
                                          : `Used in ${exc.thrownByCount} function${exc.thrownByCount !== 1 ? 's' : ''}`
                                        }
                                      </div>
                                    )}
                                  </div>
                                  <Icon name="chevron-right" className="text-gray-300" />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Processes List Component
    // ============================================

    const ProcessesView = ({ instance, onSelectItem, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedActors, setExpandedActors] = useState({});
      const [filterType, setFilterType] = useState('all'); // all, flow, sequenz

      // Set page title
      usePageTitle(language === 'de' ? 'Prozesse' : 'Processes');

      const t = (obj) => getText(obj, language);

      useEffect(() => {
        loadProcesses();
      }, [instance]);

      const loadProcesses = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/processes'));
          const result = await response.json();
          if (result.success) {
            setData(result);
            // Expand all actors by default
            const expanded = {};
            Object.keys(result.groupedByActor || {}).forEach(actor => {
              expanded[actor] = true;
            });
            setExpandedActors(expanded);
          }
        } catch (err) {
          console.error('Error loading processes:', err);
        }
        setLoading(false);
      };

      const toggleActor = (actor) => {
        setExpandedActors(prev => ({
          ...prev,
          [actor]: !prev[actor]
        }));
      };

      const getDiagramTypeLabel = (type) => {
        switch (type) {
          case 'flow': return language === 'de' ? 'Flussdiagramm' : 'Flow Chart';
          case 'sequenz': return language === 'de' ? 'Sequenzdiagramm' : 'Sequence Diagram';
          default: return type;
        }
      };

      const getDiagramTypeIcon = (type) => {
        switch (type) {
          case 'flow': return 'sitemap';
          case 'sequenz': return 'exchange-alt';
          default: return 'diagram-project';
        }
      };

      const getActorLabel = (actor) => {
        const labels = {
          'kassensystem': language === 'de' ? 'Kassensystem' : 'Recording System',
          'nutzer': language === 'de' ? 'Nutzer' : 'User',
          'hersteller': language === 'de' ? 'Hersteller' : 'Manufacturer',
          'pruefer': language === 'de' ? 'Prüfer' : 'Auditor'
        };
        return labels[actor.toLowerCase()] || actor;
      };

      const filteredProcesses = useMemo(() => {
        if (!data?.items) return [];
        return data.items.filter(proc => {
          // Type filter
          if (filterType !== 'all' && proc.diagramType !== filterType) {
            return false;
          }
          // Search filter
          if (searchTerm) {
            const search = searchTerm.toLowerCase();
            return (
              proc.id.toLowerCase().includes(search) ||
              (proc.processId && proc.processId.toLowerCase().includes(search)) ||
              t(proc.name).toLowerCase().includes(search) ||
              t(proc.description).toLowerCase().includes(search) ||
              proc.actor.toLowerCase().includes(search)
            );
          }
          return true;
        });
      }, [data, searchTerm, filterType, language]);

      // Group filtered processes by actor
      const groupedProcesses = useMemo(() => {
        const grouped = {};
        filteredProcesses.forEach(proc => {
          const actor = proc.actor;
          if (!grouped[actor]) {
            grouped[actor] = [];
          }
          grouped[actor].push(proc);
        });
        return grouped;
      }, [filteredProcesses]);

      if (loading) {
        return (
          <div className="p-6 flex items-center justify-center">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-6 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                <Icon name="project-diagram" className="mr-3 text-teal-600" />
                {language === 'de' ? 'Prozesse' : 'Processes'}
                <span className="ml-3 text-lg font-normal text-gray-500">
                  ({data?.count || 0})
                </span>
              </h2>
            </div>

            {/* Search and Filter Bar */}
            <div className="bg-white rounded-lg shadow-sm border p-4 mb-6">
              <div className="flex flex-wrap gap-4">
                {/* Search Input */}
                <div className="flex-1 min-w-64">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder={language === 'de' ? 'Suche nach Prozessen...' : 'Search processes...'}
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    />
                    <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  </div>
                </div>
                
                {/* Type Filter */}
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">{language === 'de' ? 'Diagrammtyp:' : 'Diagram type:'}</span>
                  <select
                    value={filterType}
                    onChange={(e) => setFilterType(e.target.value)}
                    className="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500"
                  >
                    <option value="all">{language === 'de' ? 'Alle' : 'All'}</option>
                    <option value="flow">{language === 'de' ? 'Flussdiagramm' : 'Flow Chart'}</option>
                    <option value="sequenz">{language === 'de' ? 'Sequenzdiagramm' : 'Sequence Diagram'}</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Process List by Actor */}
            <div className="space-y-4">
              {Object.entries(groupedProcesses).sort(([a], [b]) => a.localeCompare(b)).map(([actor, processes]) => (
                <div key={actor} className="bg-white rounded-lg shadow-sm border overflow-hidden">
                  {/* Actor Header */}
                  <div 
                    className="flex items-center justify-between p-4 bg-gray-50 cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleActor(actor)}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                        <Icon name="user-cog" className="text-teal-600" />
                      </div>
                      <div>
                        <h3 className="font-semibold text-gray-800">{getActorLabel(actor)}</h3>
                        <p className="text-sm text-gray-500">
                          {processes.length} {language === 'de' ? 'Prozesse' : 'processes'}
                        </p>
                      </div>
                    </div>
                    <Icon 
                      name={expandedActors[actor] ? 'chevron-up' : 'chevron-down'} 
                      className="text-gray-400"
                    />
                  </div>

                  {/* Process List */}
                  {expandedActors[actor] && (
                    <div className="divide-y">
                      {processes.sort((a, b) => a.id.localeCompare(b.id)).map(proc => (
                        <div 
                          key={`${proc.actor}-${proc.diagramType}-${proc.baseName}`}
                          className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                          onClick={() => onSelectItem('process', proc)}
                        >
                          <div className="flex items-start gap-4">
                            {/* Diagram Type Icon */}
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                              proc.diagramType === 'flow' ? 'bg-blue-100' : 'bg-purple-100'
                            }`}>
                              <Icon 
                                name={getDiagramTypeIcon(proc.diagramType)} 
                                className={proc.diagramType === 'flow' ? 'text-blue-600' : 'text-purple-600'}
                              />
                            </div>

                            {/* Process Info */}
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-1">
                                <span className="font-mono text-sm text-gray-500">{proc.processId}</span>
                                <span className={`px-2 py-0.5 text-xs rounded-full ${
                                  proc.diagramType === 'flow' 
                                    ? 'bg-blue-100 text-blue-700' 
                                    : 'bg-purple-100 text-purple-700'
                                }`}>
                                  {getDiagramTypeLabel(proc.diagramType)}
                                </span>
                              </div>
                              <h4 className="font-medium text-gray-800 mb-1">
                                {t(proc.name)}
                              </h4>
                              <p className="text-sm text-gray-600 line-clamp-2">
                                {t(proc.description)}
                              </p>
                              
                              {/* Meta info */}
                              <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                {proc.functionCount > 0 && (
                                  <span className="flex items-center gap-1">
                                    <Icon name="code" />
                                    {proc.functionCount} {language === 'de' ? 'Funktionen' : 'functions'}
                                  </span>
                                )}
                                {proc.exceptionCount > 0 && (
                                  <span className="flex items-center gap-1">
                                    <Icon name="exclamation-triangle" />
                                    {proc.exceptionCount} {language === 'de' ? 'Exceptions' : 'exceptions'}
                                  </span>
                                )}
                              </div>
                            </div>

                            {/* Arrow */}
                            <Icon name="chevron-right" className="text-gray-400 mt-2" />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}

              {Object.keys(groupedProcesses).length === 0 && (
                <div className="bg-white rounded-lg shadow-sm border p-8 text-center">
                  <Icon name="search" className="text-4xl text-gray-300 mb-3" />
                  <p className="text-gray-500">
                    {language === 'de' 
                      ? 'Keine Prozesse gefunden.' 
                      : 'No processes found.'}
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Process Detail View Component
    // ============================================

    const ProcessDetailView = ({ 
      instance, 
      processId, 
      actor, 
      diagramType, 
      onBack, 
      onNavigateToFunction,
      onNavigateToException,
      onNavigateToType,
      onNavigateToEnum,
      onNavigateToProcess,
      language = 'de' 
    }) => {
      const [process, setProcess] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const mermaidRef = useRef(null);
      const [mermaidRendered, setMermaidRendered] = useState(false);
      const [allProcesses, setAllProcesses] = useState([]);
      const [groupedProcesses, setGroupedProcesses] = useState({});
      const [currentGroup, setCurrentGroup] = useState(null);
      const [knownTypes, setKnownTypes] = useState([]);
      const [knownEnums, setKnownEnums] = useState([]);

      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(process ? `${t(process.name)} - ${language === 'de' ? 'Prozess' : 'Process'}` : null);

      useEffect(() => {
        loadProcess();
        loadTypesAndEnums();
        loadAllProcesses();
      }, [instance, actor, diagramType, processId]);

      const loadProcess = async () => {
        setLoading(true);
        setError(null);
        setMermaidRendered(false);
        try {
          const response = await fetch(getApiUrl(instance, `/process/${actor}/${diagramType}/${processId}`));
          const result = await response.json();
          if (result.success) {
            setProcess(result.process);
          } else {
            setError(result.error || 'Failed to load process');
          }
        } catch (err) {
          console.error('Error loading process:', err);
          setError(err.message);
        }
        setLoading(false);
      };

      const loadAllProcesses = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/processes'));
          const result = await response.json();
          if (result.success) {
            setAllProcesses(result.items || []);
            setGroupedProcesses(result.groupedByActor || {});
            // Find current group - processes are grouped by actor
            Object.entries(result.groupedByActor || {}).forEach(([groupName, items]) => {
              if (items.some(item => item.baseName === processId)) {
                setCurrentGroup(groupName);
              }
            });
          }
        } catch (err) {
          console.error('Error loading all processes:', err);
        }
      };

      const handleNavigateToOtherProcess = (proc) => {
        if (onNavigateToProcess) {
          onNavigateToProcess(proc);
        }
      };

      const loadTypesAndEnums = async () => {
        try {
          const [typesRes, enumsRes] = await Promise.all([
            fetch(getApiUrl(instance, '/types')),
            fetch(getApiUrl(instance, '/enums'))
          ]);
          const typesData = await typesRes.json();
          const enumsData = await enumsRes.json();
          
          if (typesData.success) {
            setKnownTypes(typesData.items.map(t => t.name || t.id));
          }
          if (enumsData.success) {
            setKnownEnums(enumsData.items.map(e => e.name || e.id));
          }
        } catch (err) {
          console.error('Error loading types/enums:', err);
        }
      };

      // Check if a type name matches a known type or enum
      const getTypeLink = (typeName) => {
        if (!typeName) return null;
        // Clean type name (remove [], etc.)
        const cleanName = typeName.replace(/\[\]$/, '').trim();
        
        if (knownTypes.includes(cleanName)) {
          return { type: 'type', name: cleanName };
        }
        if (knownEnums.includes(cleanName)) {
          return { type: 'enum', name: cleanName };
        }
        return null;
      };

      // Render a type cell with optional link
      const renderTypeCell = (typeName) => {
        const link = getTypeLink(typeName);
        if (link) {
          const isArray = typeName.endsWith('[]');
          return (
            <button
              onClick={() => link.type === 'type' ? onNavigateToType?.(link.name) : onNavigateToEnum?.(link.name)}
              className={`font-mono text-sm hover:underline ${
                link.type === 'type' ? 'text-purple-600 hover:text-purple-800' : 'text-amber-600 hover:text-amber-800'
              }`}
            >
              {link.name}{isArray ? '[]' : ''}
              <Icon name={link.type === 'type' ? 'cube' : 'list-ol'} className="ml-1 text-xs" />
            </button>
          );
        }
        return <span className="text-purple-600 font-mono">{typeName}</span>;
      };

      // Render a data object with optional link
      const renderDataObject = (objName, idx) => {
        const link = getTypeLink(objName);
        if (link) {
          return (
            <button
              key={idx}
              onClick={() => link.type === 'type' ? onNavigateToType?.(link.name) : onNavigateToEnum?.(link.name)}
              className={`px-3 py-1 rounded-full text-sm font-mono transition-colors ${
                link.type === 'type' 
                  ? 'bg-purple-50 text-purple-700 hover:bg-purple-100' 
                  : 'bg-amber-50 text-amber-700 hover:bg-amber-100'
              }`}
            >
              {objName}
              <Icon name={link.type === 'type' ? 'cube' : 'list-ol'} className="ml-1 text-xs" />
            </button>
          );
        }
        return (
          <span key={idx} className="px-3 py-1 bg-indigo-50 rounded-full text-sm text-indigo-700 font-mono">
            {objName}
          </span>
        );
      };

      // Render Mermaid diagram
      useEffect(() => {
        const renderMermaid = async () => {
          // Get language-specific mermaid content
          const mermaidContent = process?.mermaidContent?.[language] || process?.mermaidContent?.de || process?.mermaidContent;
          
          if (mermaidContent && mermaidRef.current && window.mermaid) {
            try {
              // Clear previous content
              mermaidRef.current.innerHTML = '';
              
              // Generate unique ID for the diagram
              const id = `mermaid-${Date.now()}`;
              
              // Render the diagram
              const { svg } = await window.mermaid.render(id, mermaidContent);
              mermaidRef.current.innerHTML = svg;
              setMermaidRendered(true);
            } catch (err) {
              console.error('Mermaid rendering error:', err);
              mermaidRef.current.innerHTML = `<pre class="text-red-500 p-4">${err.message}</pre>`;
            }
          }
        };
        
        // Reset mermaidRendered when language changes
        setMermaidRendered(false);
        
        // Small delay to ensure mermaid is loaded
        const timer = setTimeout(renderMermaid, 100);
        return () => clearTimeout(timer);
      }, [process, language]);

      const getDiagramTypeLabel = (type) => {
        switch (type) {
          case 'flow': return language === 'de' ? 'Flussdiagramm' : 'Flow Chart';
          case 'sequenz': return language === 'de' ? 'Sequenzdiagramm' : 'Sequence Diagram';
          default: return type;
        }
      };

      const getActorLabel = (actor) => {
        const labels = {
          'kassensystem': language === 'de' ? 'Kassensystem' : 'Recording System',
          'nutzer': language === 'de' ? 'Nutzer' : 'User',
          'hersteller': language === 'de' ? 'Hersteller' : 'Manufacturer',
          'pruefer': language === 'de' ? 'Prüfer' : 'Auditor'
        };
        return labels[actor?.toLowerCase()] || actor;
      };

      if (loading) {
        return (
          <div className="p-6 flex items-center justify-center">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-circle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!process) {
        return (
          <div className="p-6 text-center text-gray-500">
            {language === 'de' ? 'Prozess nicht gefunden' : 'Process not found'}
          </div>
        );
      }

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="processes"
            currentId={processId}
            currentName={t(process?.name) || processId}
            groupedItems={groupedProcesses}
            items={allProcesses}
            currentGroup={currentGroup}
            onBack={onBack}
            onNavigate={handleNavigateToOtherProcess}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-6">
          <div className="max-w-full mx-auto">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-sm border mb-6">
              <div className="p-6">
                <div className="flex items-start gap-4">
                  <div className={`w-14 h-14 rounded-xl flex items-center justify-center ${
                    diagramType === 'flow' ? 'bg-blue-100' : 'bg-purple-100'
                  }`}>
                    <Icon 
                      name={diagramType === 'flow' ? 'sitemap' : 'exchange-alt'} 
                      className={`text-2xl ${diagramType === 'flow' ? 'text-blue-600' : 'text-purple-600'}`}
                    />
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-mono text-sm text-gray-500">{process.processId}</span>
                      <span className={`px-2 py-0.5 text-xs rounded-full ${
                        diagramType === 'flow' 
                          ? 'bg-blue-100 text-blue-700' 
                          : 'bg-purple-100 text-purple-700'
                      }`}>
                        {getDiagramTypeLabel(diagramType)}
                      </span>
                      <span className="px-2 py-0.5 text-xs rounded-full bg-teal-100 text-teal-700">
                        {getActorLabel(actor)}
                      </span>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">
                      {t(process.name)}
                    </h1>
                    <p className="text-gray-600">
                      {t(process.description)}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            {/* Mermaid Diagram - Full Width */}
            {(process.mermaidContent?.[language] || process.mermaidContent?.de || process.mermaidContent) && (
              <div className="bg-white rounded-lg shadow-sm border mb-6 overflow-hidden">
                <div className="border-b bg-gray-50 px-4 py-3 flex items-center justify-between">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name={diagramType === 'flow' ? 'sitemap' : 'exchange-alt'} className="mr-2 text-teal-600" />
                    {getDiagramTypeLabel(diagramType)}
                  </h3>
                </div>
                <div className="p-4 mermaid-container overflow-x-auto">
                  <div ref={mermaidRef} className="flex justify-center min-w-full">
                    <div className="text-gray-400 flex items-center gap-2">
                      <div className="loading-spinner"></div>
                      {language === 'de' ? 'Lade Diagramm...' : 'Loading diagram...'}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Metadata Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Actors */}
              {process.actors && process.actors.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="users" className="mr-2 text-teal-600" />
                      {language === 'de' ? 'Beteiligte Akteure' : 'Involved Actors'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                      {process.actors.map((a, idx) => (
                        <span key={idx} className="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-700">
                          {t(a)}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Used Objects */}
              {process.usedObjects && process.usedObjects.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="cube" className="mr-2 text-purple-600" />
                      {language === 'de' ? 'Verwendete Objekte' : 'Used Objects'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                      {process.usedObjects.map((obj, idx) => (
                        <span key={idx} className="px-3 py-1 bg-purple-50 rounded-full text-sm text-purple-700">
                          {t(obj)}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Interface Functions */}
              {process.interfaceFunctions && process.interfaceFunctions.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="code" className="mr-2 text-blue-600" />
                      {language === 'de' ? 'Schnittstellenfunktionen' : 'Interface Functions'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="space-y-2">
                      {process.interfaceFunctions.map((func, idx) => (
                        <button
                          key={idx}
                          onClick={() => onNavigateToFunction && onNavigateToFunction(func)}
                          className="block w-full text-left px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded text-blue-700 font-mono text-sm transition-colors"
                        >
                          {func}()
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Possible Exceptions */}
              {process.exceptions && process.exceptions.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="exclamation-triangle" className="mr-2 text-red-600" />
                      {language === 'de' ? 'Mögliche Exceptions' : 'Possible Exceptions'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="space-y-2">
                      {process.exceptions.map((exc, idx) => (
                        <button
                          key={idx}
                          onClick={() => onNavigateToException && onNavigateToException(exc)}
                          className="block w-full text-left px-3 py-2 bg-red-50 hover:bg-red-100 rounded text-red-700 font-mono text-sm transition-colors"
                        >
                          {exc}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Input Parameters */}
              {process.inputParameters && process.inputParameters.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="sign-in-alt" className="mr-2 text-green-600" />
                      {language === 'de' ? 'Eingabeparameter' : 'Input Parameters'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-gray-500 border-b">
                          <th className="pb-2">{language === 'de' ? 'Name' : 'Name'}</th>
                          <th className="pb-2">{language === 'de' ? 'Typ' : 'Type'}</th>
                          <th className="pb-2">{language === 'de' ? 'Beschreibung' : 'Description'}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {process.inputParameters.map((param, idx) => (
                          <tr key={idx} className="border-b last:border-0">
                            <td className="py-2 font-mono text-gray-800">{param.name}</td>
                            <td className="py-2">{renderTypeCell(param.type)}</td>
                            <td className="py-2 text-gray-600">{t(param.description)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Output Parameters */}
              {process.outputParameters && process.outputParameters.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="sign-out-alt" className="mr-2 text-orange-600" />
                      {language === 'de' ? 'Ausgabeparameter' : 'Output Parameters'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-gray-500 border-b">
                          <th className="pb-2">{language === 'de' ? 'Name' : 'Name'}</th>
                          <th className="pb-2">{language === 'de' ? 'Typ' : 'Type'}</th>
                          <th className="pb-2">{language === 'de' ? 'Beschreibung' : 'Description'}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {process.outputParameters.map((param, idx) => (
                          <tr key={idx} className="border-b last:border-0">
                            <td className="py-2 font-mono text-gray-800">{param.name}</td>
                            <td className="py-2">{renderTypeCell(param.type)}</td>
                            <td className="py-2 text-gray-600">{t(param.description)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Used Data Objects */}
              {process.usedDataObjects && process.usedDataObjects.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="database" className="mr-2 text-indigo-600" />
                      {language === 'de' ? 'Verwendete Datenobjekte' : 'Used Data Objects'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                      {process.usedDataObjects.map((obj, idx) => renderDataObject(obj, idx))}
                    </div>
                  </div>
                </div>
              )}

              {/* References */}
              {process.references && process.references.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="book" className="mr-2 text-gray-600" />
                      {language === 'de' ? 'Referenzen' : 'References'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <ul className="space-y-1">
                      {process.references.map((ref, idx) => (
                        <li key={idx} className="text-sm text-gray-600 flex items-start gap-2">
                          <Icon name="link" className="mt-1 text-gray-400" />
                          {ref}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}

              {/* Notes */}
              {process.notes && t(process.notes) && (
                <div className="bg-white rounded-lg shadow-sm border lg:col-span-2">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="sticky-note" className="mr-2 text-yellow-600" />
                      {language === 'de' ? 'Hinweise' : 'Notes'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <p className="text-gray-600">{t(process.notes)}</p>
                  </div>
                </div>
              )}
            </div>
          </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Process Map View Component
    // ============================================

    const ProcessMapView = ({ instance, onNavigateToProcess, onNavigateToProcessChain, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('categories');
      const [expandedCategories, setExpandedCategories] = useState({});
      const [processes, setProcesses] = useState([]);
      const [processChains, setProcessChains] = useState([]);

      // Set page title
      usePageTitle(language === 'de' ? 'Prozesslandkarte' : 'Process Map');

      const t = (obj) => getText(obj, language);

      useEffect(() => {
        loadData();
      }, [instance]);

      const loadData = async () => {
        setLoading(true);
        setError(null);
        try {
          // Load process map
          const mapResponse = await fetch(getApiUrl(instance, '/processmap'));
          const mapResult = await mapResponse.json();
          if (mapResult.success) {
            setData(mapResult.processMap);
            // Expand first category by default
            if (mapResult.processMap.categories?.length > 0) {
              setExpandedCategories({ [mapResult.processMap.categories[0].id]: true });
            }
          } else {
            setError(mapResult.error || 'Failed to load process map');
          }

          // Load processes for linking
          const processesResponse = await fetch(getApiUrl(instance, '/processes'));
          const processesResult = await processesResponse.json();
          if (processesResult.success) {
            setProcesses(processesResult.items || []);
          }

          // Load process chains for linking
          const chainsResponse = await fetch(getApiUrl(instance, '/processchains'));
          const chainsResult = await chainsResponse.json();
          if (chainsResult.success) {
            setProcessChains(chainsResult.items || []);
          }
        } catch (err) {
          console.error('Error loading process map:', err);
          setError(err.message);
        }
        setLoading(false);
      };

      const toggleCategory = (categoryId) => {
        setExpandedCategories(prev => ({
          ...prev,
          [categoryId]: !prev[categoryId]
        }));
      };

      // Find process by numeric ID
      const findProcess = (numericId) => {
        return processes.find(p => {
          const baseId = p.baseName?.split('-')[0];
          return baseId === numericId || p.baseName?.includes(`${numericId}-`);
        });
      };

      // Find process chain by ID
      const findProcessChain = (chainId) => {
        return processChains.find(pc => pc.chainId === chainId || pc.id?.includes(chainId));
      };

      const handleProcessClick = (numericId) => {
        const process = findProcess(numericId);
        if (process && onNavigateToProcess) {
          onNavigateToProcess(process);
        }
      };

      const handleProcessChainClick = (chainId) => {
        const chain = findProcessChain(chainId);
        if (chain && onNavigateToProcessChain) {
          onNavigateToProcessChain(chain);
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!data) return null;

      return (
        <div className="p-4 fade-in">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-xl shadow-lg p-6 text-white mb-6">
              <div className="flex items-start gap-4">
                <div className="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                  <Icon name="map" className="text-2xl" />
                </div>
                <div className="flex-1">
                  <h1 className="text-2xl font-bold mb-2">{t(data.metadata?.title)}</h1>
                  <p className="text-emerald-100 mb-3">{t(data.metadata?.description)}</p>
                  <div className="flex flex-wrap gap-2">
                    {data.metadata?.standards?.map((std, idx) => (
                      <span key={idx} className="px-2 py-1 bg-white/20 rounded text-xs">
                        {std}
                      </span>
                    ))}
                    <span className="px-2 py-1 bg-white/20 rounded text-xs">
                      v{data.metadata?.version}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-lg shadow-sm border mb-6">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'categories', icon: 'folder-tree', label: language === 'de' ? 'Kategorien' : 'Categories' },
                  { id: 'critical', icon: 'exclamation-circle', label: language === 'de' ? 'Kritische Prozesse' : 'Critical Processes' },
                  { id: 'quickstart', icon: 'rocket', label: language === 'de' ? 'Schnellstart' : 'Quick Start' },
                  { id: 'learning', icon: 'graduation-cap', label: language === 'de' ? 'Lernpfade' : 'Learning Paths' }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center gap-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-colors ${
                      activeTab === tab.id 
                        ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50' 
                        : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    <Icon name={tab.icon} />
                    {tab.label}
                  </button>
                ))}
              </div>

              <div className="p-4">
                {/* Categories Tab */}
                {activeTab === 'categories' && (
                  <div className="space-y-4">
                    {data.categories?.map((category) => (
                      <div key={category.id} className="border rounded-lg overflow-hidden">
                        <button
                          onClick={() => toggleCategory(category.id)}
                          className="w-full flex items-center gap-3 p-4 text-left hover:bg-gray-50 transition-colors"
                          style={{ borderLeftWidth: '4px', borderLeftColor: category.color }}
                        >
                          <span className="text-2xl">{category.icon}</span>
                          <div className="flex-1">
                            <h3 className="font-semibold text-gray-800">{t(category.name)}</h3>
                            <p className="text-sm text-gray-500">{t(category.description)}</p>
                          </div>
                          <Icon 
                            name={expandedCategories[category.id] ? 'chevron-up' : 'chevron-down'} 
                            className="text-gray-400"
                          />
                        </button>
                        
                        {expandedCategories[category.id] && (
                          <div className="border-t bg-gray-50 p-4">
                            <div className="space-y-4">
                              {category.subCategories?.map((subCat) => (
                                <div key={subCat.id} className="bg-white rounded-lg p-4 border">
                                  <h4 className="font-medium text-gray-700 mb-3">{t(subCat.name)}</h4>
                                  
                                  {/* Processes */}
                                  {subCat.processes?.length > 0 && (
                                    <div className="mb-3">
                                      <div className="text-xs font-semibold text-gray-400 uppercase mb-2">
                                        {language === 'de' ? 'Prozesse' : 'Processes'}
                                      </div>
                                      <div className="flex flex-wrap gap-2">
                                        {subCat.processes.map((proc, idx) => {
                                          const linkedProc = findProcess(proc.id);
                                          return (
                                            <button
                                              key={idx}
                                              onClick={() => linkedProc && handleProcessClick(proc.id)}
                                              className={`inline-flex items-center gap-1 px-2 py-1 rounded text-sm transition-colors ${
                                                proc.critical 
                                                  ? 'bg-red-100 text-red-700 hover:bg-red-200' 
                                                  : proc.mandatory 
                                                    ? 'bg-teal-100 text-teal-700 hover:bg-teal-200'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                              } ${linkedProc ? 'cursor-pointer' : 'opacity-75'}`}
                                            >
                                              <span className="font-mono text-xs">{proc.id}</span>
                                              <span>{t(proc.name)}</span>
                                              {proc.critical && <Icon name="exclamation-circle" className="text-xs" />}
                                              {linkedProc && <Icon name="external-link-alt" className="text-xs opacity-50" />}
                                            </button>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  )}

                                  {/* Process Chains */}
                                  {subCat.processChains?.length > 0 && (
                                    <div>
                                      <div className="text-xs font-semibold text-gray-400 uppercase mb-2">
                                        {language === 'de' ? 'Prozessketten' : 'Process Chains'}
                                      </div>
                                      <div className="flex flex-wrap gap-2">
                                        {subCat.processChains.map((chain, idx) => {
                                          const linkedChain = findProcessChain(chain.id);
                                          return (
                                            <button
                                              key={idx}
                                              onClick={() => linkedChain && handleProcessChainClick(chain.id)}
                                              className={`inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200 transition-colors ${
                                                linkedChain ? 'cursor-pointer' : 'opacity-75'
                                              }`}
                                            >
                                              <Icon name="link" className="text-xs" />
                                              <span className="font-mono text-xs">{chain.id}</span>
                                              <span>{t(chain.name)}</span>
                                              {linkedChain && <Icon name="external-link-alt" className="text-xs opacity-50" />}
                                            </button>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Critical Processes Tab */}
                {activeTab === 'critical' && (
                  <div className="space-y-3">
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                      <div className="flex items-center gap-2 text-red-700">
                        <Icon name="exclamation-triangle" />
                        <span className="font-medium">
                          {language === 'de' 
                            ? 'Diese Prozesse sind kritisch für den Betrieb der TSE'
                            : 'These processes are critical for TSE operation'}
                        </span>
                      </div>
                    </div>
                    {data.criticalProcesses?.map((proc, idx) => {
                      const linkedProc = findProcess(proc.id);
                      return (
                        <div 
                          key={idx}
                          onClick={() => linkedProc && handleProcessClick(proc.id)}
                          className={`bg-white border border-red-200 rounded-lg p-4 ${
                            linkedProc ? 'cursor-pointer hover:bg-red-50' : ''
                          } transition-colors`}
                        >
                          <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-red-600 font-mono font-bold">
                              {proc.id}
                            </div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <h4 className="font-semibold text-gray-800">{t(proc.name)}</h4>
                                {linkedProc && <Icon name="external-link-alt" className="text-gray-400 text-xs" />}
                              </div>
                              <p className="text-sm text-gray-600 mt-1">{t(proc.reason)}</p>
                              {proc.severity && (
                                <span className="inline-block mt-2 px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                                  {t(proc.severity)}
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Quick Start Tab */}
                {activeTab === 'quickstart' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {data.navigation?.startingPoints?.map((sp, idx) => {
                      const isChain = sp.start?.startsWith('PK');
                      const linkedItem = isChain ? findProcessChain(sp.start) : findProcess(sp.start);
                      return (
                        <div 
                          key={idx}
                          onClick={() => {
                            if (isChain && linkedItem) {
                              handleProcessChainClick(sp.start);
                            } else if (linkedItem) {
                              handleProcessClick(sp.start);
                            }
                          }}
                          className={`bg-gradient-to-br from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg p-4 ${
                            linkedItem ? 'cursor-pointer hover:from-emerald-100 hover:to-teal-100' : ''
                          } transition-colors`}
                        >
                          <div className="flex items-start gap-3">
                            <div className="w-12 h-12 bg-emerald-500 text-white rounded-lg flex items-center justify-center">
                              <Icon name="play" />
                            </div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <h4 className="font-semibold text-gray-800">{t(sp.role)}</h4>
                                <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-mono">
                                  {sp.start}
                                </span>
                                {linkedItem && <Icon name="external-link-alt" className="text-gray-400 text-xs" />}
                              </div>
                              <p className="text-sm text-gray-600 mt-1">{t(sp.description)}</p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Learning Paths Tab */}
                {activeTab === 'learning' && (
                  <div className="space-y-6">
                    {data.navigation?.learningPaths?.map((path, idx) => (
                      <div key={idx} className="bg-white border rounded-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-500 p-4 text-white">
                          <div className="flex items-center gap-2 mb-1">
                            <Icon name="graduation-cap" />
                            <h4 className="font-semibold">{t(path.name)}</h4>
                          </div>
                          <p className="text-sm text-purple-100">
                            {language === 'de' ? 'Zielgruppe:' : 'Target audience:'} {t(path.targetAudience)}
                          </p>
                        </div>
                        <div className="p-4">
                          <div className="relative">
                            {path.steps?.map((step, stepIdx) => {
                              const isChain = step.id?.startsWith('PK');
                              const linkedItem = isChain ? findProcessChain(step.id) : findProcess(step.id);
                              return (
                                <div key={stepIdx} className="flex items-start gap-3 pb-4">
                                  <div className="flex flex-col items-center">
                                    <div className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-sm">
                                      {stepIdx + 1}
                                    </div>
                                    {stepIdx < path.steps.length - 1 && (
                                      <div className="w-0.5 h-full bg-indigo-200 mt-1" style={{ minHeight: '24px' }} />
                                    )}
                                  </div>
                                  <div 
                                    onClick={() => {
                                      if (isChain && linkedItem) {
                                        handleProcessChainClick(step.id);
                                      } else if (linkedItem) {
                                        handleProcessClick(step.id);
                                      }
                                    }}
                                    className={`flex-1 bg-gray-50 rounded-lg p-3 ${
                                      linkedItem ? 'cursor-pointer hover:bg-indigo-50' : ''
                                    } transition-colors`}
                                  >
                                    <div className="flex items-center gap-2">
                                      <span className={`px-2 py-0.5 rounded text-xs font-mono ${
                                        isChain ? 'bg-indigo-100 text-indigo-700' : 'bg-teal-100 text-teal-700'
                                      }`}>
                                        {step.id}
                                      </span>
                                      <span className="text-sm text-gray-700">{t(step.description)}</span>
                                      {linkedItem && <Icon name="external-link-alt" className="text-gray-400 text-xs" />}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Process Chains List Component
    // ============================================

    const ProcessChainsView = ({ instance, onSelectItem, language = 'de' }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');

      // Set page title
      usePageTitle(language === 'de' ? 'Prozessketten' : 'Process Chains');

      const t = (obj) => getText(obj, language);

      useEffect(() => {
        loadProcessChains();
      }, [instance]);

      const loadProcessChains = async () => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/processchains'));
          const result = await response.json();
          if (result.success) {
            setData(result.items);
          }
        } catch (err) {
          console.error('Error loading process chains:', err);
        }
        setLoading(false);
      };

      const filteredChains = useMemo(() => {
        if (!data) return [];
        if (!searchTerm) return data;
        
        const search = searchTerm.toLowerCase();
        return data.filter(chain => 
          chain.chainId.toLowerCase().includes(search) ||
          t(chain.name).toLowerCase().includes(search) ||
          t(chain.description).toLowerCase().includes(search)
        );
      }, [data, searchTerm, language]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="p-4 fade-in">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="bg-gradient-to-r from-indigo-600 to-indigo-700 rounded-xl shadow-lg p-6 mb-6 text-white">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div className="flex items-center gap-4">
                  <div className="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <Icon name="link" className="text-3xl" />
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold">
                      {language === 'de' ? 'Prozessketten' : 'Process Chains'}
                    </h2>
                    <p className="text-indigo-100">
                      {language === 'de' ? 'Verkettete Prozessabläufe und Workflows' : 'Linked process flows and workflows'}
                    </p>
                  </div>
                </div>
                <div className="text-3xl font-bold">{data?.length || 0}</div>
              </div>
            </div>

            {/* Search */}
            <div className="bg-white rounded-lg shadow-sm border p-4 mb-6">
              <div className="relative">
                <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  placeholder={language === 'de' ? 'Suche nach ID, Name oder Beschreibung...' : 'Search by ID, name or description...'}
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
            </div>

            {/* Process Chains List */}
            <div className="space-y-4">
              {filteredChains.map(chain => (
                <div
                  key={chain.id}
                  onClick={() => onSelectItem('processchain', chain)}
                  className="bg-white rounded-lg shadow-sm border p-4 cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all"
                >
                  <div className="flex items-start gap-4">
                    <div className="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Icon name="link" className="text-xl text-indigo-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-mono text-sm text-gray-500">{chain.chainId}</span>
                      </div>
                      <h3 className="font-semibold text-gray-800 mb-1">{t(chain.name)}</h3>
                      <p className="text-sm text-gray-600 line-clamp-2">{t(chain.description)}</p>
                      
                      {/* Meta Info */}
                      <div className="flex items-center gap-4 mt-3 text-xs text-gray-500">
                        <span className="flex items-center gap-1">
                          <Icon name="project-diagram" />
                          {chain.processCount} {language === 'de' ? 'Prozesse' : 'Processes'}
                        </span>
                        <span className="flex items-center gap-1">
                          <Icon name="list-ol" />
                          {chain.stepCount} {language === 'de' ? 'Schritte' : 'Steps'}
                        </span>
                      </div>

                      {/* Involved Processes Preview */}
                      {chain.involvedProcesses && chain.involvedProcesses.length > 0 && (
                        <div className="flex flex-wrap gap-2 mt-3">
                          {chain.involvedProcesses.slice(0, 4).map((proc, idx) => (
                            <span key={idx} className="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-mono">
                              {proc.id}
                            </span>
                          ))}
                          {chain.involvedProcesses.length > 4 && (
                            <span className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">
                              +{chain.involvedProcesses.length - 4}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                    <Icon name="chevron-right" className="text-gray-400 flex-shrink-0" />
                  </div>
                </div>
              ))}

              {filteredChains.length === 0 && (
                <div className="text-center py-12 text-gray-500">
                  <Icon name="search" className="text-4xl mb-3 opacity-50" />
                  <p>{language === 'de' ? 'Keine Prozessketten gefunden' : 'No process chains found'}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Process Chain Detail View Component
    // ============================================

    const ProcessChainDetailView = ({ 
      instance, 
      chainId, 
      onBack, 
      onNavigateToProcess,
      onNavigateToFunction,
      onNavigateToOtherChain,
      language = 'de' 
    }) => {
      const [chain, setChain] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [processes, setProcesses] = useState([]);
      const [allChains, setAllChains] = useState([]);
      const mermaidRef = useRef(null);
      const [mermaidRendered, setMermaidRendered] = useState(false);

      const t = (obj) => getText(obj, language);

      // Set page title
      usePageTitle(chain ? `${t(chain.name)} - ${language === 'de' ? 'Prozesskette' : 'Process Chain'}` : null);

      useEffect(() => {
        loadChain();
        loadProcesses();
        loadAllChains();
      }, [instance, chainId]);

      const loadChain = async () => {
        setLoading(true);
        setError(null);
        setMermaidRendered(false);
        try {
          const response = await fetch(getApiUrl(instance, `/processchain/${chainId}`));
          const result = await response.json();
          if (result.success) {
            setChain(result.processChain);
          } else {
            setError(result.error || 'Failed to load process chain');
          }
        } catch (err) {
          console.error('Error loading process chain:', err);
          setError(err.message);
        }
        setLoading(false);
      };

      const loadProcesses = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/processes'));
          const result = await response.json();
          if (result.success) {
            setProcesses(result.items || []);
          }
        } catch (err) {
          console.error('Error loading processes:', err);
        }
      };

      const loadAllChains = async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/processchains'));
          const result = await response.json();
          if (result.success) {
            setAllChains(result.items || []);
          }
        } catch (err) {
          console.error('Error loading all chains:', err);
        }
      };

      const handleNavigateToOtherChain = (chainItem) => {
        if (onNavigateToOtherChain) {
          onNavigateToOtherChain(chainItem);
        }
      };

      // Find a process by its ID (e.g., "001" -> process with id containing "001")
      const findProcessByNumericId = (numericId) => {
        if (!numericId || !processes.length) return null;
        // Try to find process where baseName starts with the numeric ID
        return processes.find(p => {
          const baseId = p.baseName?.split('-')[0];
          return baseId === numericId || p.baseName?.includes(`${numericId}-`);
        });
      };

      // Handle click on a process link
      const handleProcessClick = (numericId) => {
        const process = findProcessByNumericId(numericId);
        if (process && onNavigateToProcess) {
          onNavigateToProcess(process);
        }
      };

      // Render Mermaid diagram
      useEffect(() => {
        const renderMermaid = async () => {
          // Get language-specific mermaid content
          const mermaidContent = chain?.mermaidContent?.[language] || chain?.mermaidContent?.de || chain?.mermaidContent;
          
          if (mermaidContent && mermaidRef.current && window.mermaid) {
            try {
              const id = `mermaid-chain-${Date.now()}`;
              const { svg } = await window.mermaid.render(id, mermaidContent);
              mermaidRef.current.innerHTML = svg;
              setMermaidRendered(true);
            } catch (err) {
              console.error('Mermaid render error:', err);
              mermaidRef.current.innerHTML = `<div class="text-red-500 p-4">${language === 'de' ? 'Fehler beim Rendern des Diagramms' : 'Error rendering diagram'}</div>`;
            }
          }
        };
        
        // Reset mermaidRendered when language changes
        setMermaidRendered(false);
        
        const timer = setTimeout(renderMermaid, 100);
        return () => clearTimeout(timer);
      }, [chain, language]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="p-6">
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
              <Icon name="exclamation-triangle" className="mr-2" />
              {error}
            </div>
          </div>
        );
      }

      if (!chain) return null;

      return (
        <div className="fade-in">
          {/* Detail Navigation */}
          <DetailNavigation
            category="processchains"
            currentId={chainId}
            currentName={t(chain?.name) || chain?.chainId || chainId}
            items={allChains}
            onBack={onBack}
            onNavigate={handleNavigateToOtherChain}
            onHistoryBack={() => window.history.back()}
            language={language}
          />

          <div className="p-4">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="bg-gradient-to-r from-indigo-600 to-indigo-700 p-6 text-white">
                <div className="flex items-start gap-4">
                  <div className="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <Icon name="link" className="text-2xl" />
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-mono text-sm text-indigo-200">{chain.chainId}</span>
                    </div>
                    <h1 className="text-2xl font-bold mb-2">{t(chain.name)}</h1>
                    <p className="text-indigo-100">{t(chain.description)}</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Mermaid Diagram */}
            {(chain.mermaidContent?.[language] || chain.mermaidContent?.de || chain.mermaidContent) && (
              <div className="bg-white rounded-lg shadow-sm border mb-6 overflow-hidden">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="project-diagram" className="mr-2 text-indigo-600" />
                    {language === 'de' ? 'Ablaufdiagramm' : 'Flow Diagram'}
                  </h3>
                </div>
                <div className="p-4 overflow-x-auto bg-gradient-to-br from-gray-50 to-white">
                  <div 
                    ref={mermaidRef}
                    className="mermaid-container flex justify-center min-h-[300px]"
                  />
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Involved Processes */}
              {chain.involvedProcesses && chain.involvedProcesses.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="project-diagram" className="mr-2 text-teal-600" />
                      {language === 'de' ? 'Beteiligte Prozesse' : 'Involved Processes'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="space-y-2">
                      {chain.involvedProcesses.map((proc, idx) => {
                        const linkedProcess = findProcessByNumericId(proc.id);
                        return (
                          <div
                            key={idx}
                            onClick={() => linkedProcess && handleProcessClick(proc.id)}
                            className={`flex items-center gap-3 p-2 bg-teal-50 rounded transition-colors ${
                              linkedProcess ? 'cursor-pointer hover:bg-teal-100' : ''
                            }`}
                          >
                            <span className="px-2 py-1 bg-teal-600 text-white rounded text-xs font-mono">
                              {proc.id}
                            </span>
                            <span className="text-gray-700 flex-1">{t(proc.name)}</span>
                            {linkedProcess && (
                              <Icon name="external-link-alt" className="text-teal-500 text-sm" />
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}

              {/* Prerequisites */}
              {chain.prerequisites && chain.prerequisites.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="check-circle" className="mr-2 text-green-600" />
                      {language === 'de' ? 'Voraussetzungen' : 'Prerequisites'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <ul className="space-y-2">
                      {chain.prerequisites.map((prereq, idx) => (
                        <li key={idx} className="flex items-start gap-2 text-gray-700">
                          <Icon name="check" className="text-green-500 mt-1 flex-shrink-0" />
                          <span>{t(prereq)}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}

              {/* Actors */}
              {chain.actors && chain.actors.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="users" className="mr-2 text-blue-600" />
                      {language === 'de' ? 'Beteiligte Akteure' : 'Involved Actors'}
                    </h3>
                  </div>
                  <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                      {chain.actors.map((actor, idx) => (
                        <span key={idx} className="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm">
                          {t(actor)}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Variants */}
              {chain.variants && chain.variants.length > 0 && (
                <div className="bg-white rounded-lg shadow-sm border">
                  <div className="border-b bg-gray-50 px-4 py-3">
                    <h3 className="font-semibold text-gray-700 flex items-center">
                      <Icon name="code-branch" className="mr-2 text-purple-600" />
                      {language === 'de' ? 'Varianten' : 'Variants'}
                    </h3>
                  </div>
                  <div className="p-4 space-y-3">
                    {chain.variants.map((variant, idx) => (
                      <div key={idx} className="p-3 bg-purple-50 rounded-lg">
                        <div className="font-medium text-purple-800 mb-1">{t(variant.name)}</div>
                        <div className="text-sm text-purple-700">{t(variant.description)}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Steps */}
            {chain.steps && chain.steps.length > 0 && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="list-ol" className="mr-2 text-indigo-600" />
                    {language === 'de' ? 'Ablaufschritte' : 'Process Steps'}
                  </h3>
                </div>
                <div className="p-4">
                  <div className="space-y-4">
                    {chain.steps.map((step, idx) => (
                      <div 
                        key={idx} 
                        className={`relative pl-8 pb-4 ${idx < chain.steps.length - 1 ? 'border-l-2 border-indigo-200 ml-3' : 'ml-3'}`}
                      >
                        {/* Step number circle */}
                        <div className={`absolute -left-3 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                          step.critical ? 'bg-red-500 text-white' :
                          step.optional ? 'bg-gray-300 text-gray-700' :
                          'bg-indigo-500 text-white'
                        }`}>
                          {step.stepNumber}
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4">
                          <div className="flex items-center gap-2 mb-2">
                            <h4 className="font-semibold text-gray-800">{t(step.name)}</h4>
                            {step.critical && (
                              <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                                {language === 'de' ? 'Kritisch' : 'Critical'}
                              </span>
                            )}
                            {step.optional && (
                              <span className="px-2 py-0.5 bg-gray-200 text-gray-700 rounded text-xs">
                                {language === 'de' ? 'Optional' : 'Optional'}
                              </span>
                            )}
                            {step.frequency && (
                              <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                                {step.frequency}
                              </span>
                            )}
                          </div>
                          
                          <p className="text-sm text-gray-600 mb-3">{t(step.description)}</p>

                          {step.function && (
                            <div className="flex items-center gap-2 text-sm flex-wrap">
                              <span className="text-gray-500">{language === 'de' ? 'Funktion:' : 'Function:'}</span>
                              <button
                                onClick={() => onNavigateToFunction && onNavigateToFunction(step.function.name)}
                                className="px-2 py-1 bg-blue-50 text-blue-700 rounded font-mono hover:bg-blue-100 transition-colors"
                              >
                                {step.function.name}()
                              </button>
                              {step.function.linkedProcess && (() => {
                                const linkedProc = findProcessByNumericId(step.function.linkedProcess.id);
                                const processName = step.function.linkedProcess.name ? t(step.function.linkedProcess.name) : null;
                                return (
                                  <>
                                    <span className="text-gray-400">→</span>
                                    <button
                                      onClick={() => linkedProc && handleProcessClick(step.function.linkedProcess.id)}
                                      className={`px-2 py-1 bg-teal-50 text-teal-700 rounded text-sm flex items-center gap-1 ${
                                        linkedProc ? 'hover:bg-teal-100 cursor-pointer' : ''
                                      }`}
                                    >
                                      <span className="font-mono">{step.function.linkedProcess.id}</span>
                                      {processName && (
                                        <span className="text-teal-600">– {processName}</span>
                                      )}
                                      {linkedProc && <Icon name="external-link-alt" className="text-xs ml-1" />}
                                    </button>
                                  </>
                                );
                              })()}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Outcome */}
            {chain.outcome && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="flag-checkered" className="mr-2 text-green-600" />
                    {language === 'de' ? 'Ergebnis' : 'Outcome'}
                  </h3>
                </div>
                <div className="p-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* PK08-style: State */}
                    {chain.outcome.state && (
                      <div className="p-3 bg-green-50 rounded-lg md:col-span-2">
                        <div className="text-sm text-green-600 mb-1">
                          {language === 'de' ? 'Endzustand' : 'Final State'}
                        </div>
                        <div className="text-green-800 font-medium">
                          {t(chain.outcome.state)}
                        </div>
                      </div>
                    )}

                    {/* PK01-style: minimumLogMessages */}
                    {chain.outcome.minimumLogMessages && (
                      <div className="p-3 bg-green-50 rounded-lg">
                        <div className="text-sm text-green-600 mb-1">
                          {language === 'de' ? 'Mindestanzahl Log-Nachrichten' : 'Minimum Log Messages'}
                        </div>
                        <div className="text-2xl font-bold text-green-700">
                          {chain.outcome.minimumLogMessages}
                        </div>
                      </div>
                    )}

                    {/* PK01-style: logTypes */}
                    {chain.outcome.logTypes && chain.outcome.logTypes.length > 0 && (
                      <div className="p-3 bg-blue-50 rounded-lg">
                        <div className="text-sm text-blue-600 mb-2">
                          {language === 'de' ? 'Log-Typen' : 'Log Types'}
                        </div>
                        <ul className="space-y-1 text-sm text-blue-700">
                          {chain.outcome.logTypes.map((lt, idx) => (
                            <li key={idx} className="flex items-center gap-1">
                              <Icon name="file-alt" className="text-xs" />
                              {t(lt)}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* PK08-style: logMessages */}
                    {chain.outcome.logMessages && chain.outcome.logMessages.length > 0 && (
                      <div className="p-3 bg-blue-50 rounded-lg">
                        <div className="text-sm text-blue-600 mb-2">
                          {language === 'de' ? 'Log-Nachrichten' : 'Log Messages'}
                        </div>
                        <ul className="space-y-1 text-sm text-blue-700">
                          {chain.outcome.logMessages.map((lm, idx) => (
                            <li key={idx} className="flex items-center gap-1">
                              <Icon name="file-alt" className="text-xs" />
                              {t(lm)}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* PK01-style: storedData */}
                    {chain.outcome.storedData && chain.outcome.storedData.length > 0 && (
                      <div className="p-3 bg-purple-50 rounded-lg md:col-span-2">
                        <div className="text-sm text-purple-600 mb-2">
                          {language === 'de' ? 'Gespeicherte Daten' : 'Stored Data'}
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {chain.outcome.storedData.map((data, idx) => (
                            <span key={idx} className="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                              {t(data)}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Important Notes */}
            {chain.importantNotes && chain.importantNotes.length > 0 && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-red-50 px-4 py-3">
                  <h3 className="font-semibold text-red-700 flex items-center">
                    <Icon name="exclamation-triangle" className="mr-2" />
                    {language === 'de' ? 'Wichtige Hinweise' : 'Important Notes'}
                  </h3>
                </div>
                <div className="p-4">
                  <ul className="space-y-2">
                    {chain.importantNotes.map((note, idx) => (
                      <li key={idx} className="flex items-start gap-2 text-gray-700">
                        <Icon name="exclamation-circle" className="text-red-500 mt-1 flex-shrink-0" />
                        <span>{t(note)}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}

            {/* Use Cases */}
            {chain.useCases && chain.useCases.length > 0 && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="tasks" className="mr-2 text-indigo-600" />
                    {language === 'de' ? 'Anwendungsfälle' : 'Use Cases'}
                  </h3>
                </div>
                <div className="p-4">
                  <ul className="space-y-2">
                    {chain.useCases.map((uc, idx) => (
                      <li key={idx} className="flex items-start gap-2 text-gray-700">
                        <Icon name="check-square" className="text-indigo-500 mt-1 flex-shrink-0" />
                        <span>{t(uc)}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}

            {/* Usage Scenario */}
            {chain.usageScenario && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="lightbulb" className="mr-2 text-yellow-600" />
                    {language === 'de' ? 'Anwendungsbeispiel' : 'Usage Scenario'}
                  </h3>
                </div>
                <div className="p-4">
                  <p className="text-gray-700">{t(chain.usageScenario)}</p>
                </div>
              </div>
            )}

            {/* References */}
            {chain.references && chain.references.length > 0 && (
              <div className="bg-white rounded-lg shadow-sm border mt-6">
                <div className="border-b bg-gray-50 px-4 py-3">
                  <h3 className="font-semibold text-gray-700 flex items-center">
                    <Icon name="book" className="mr-2 text-gray-600" />
                    {language === 'de' ? 'Referenzen' : 'References'}
                  </h3>
                </div>
                <div className="p-4">
                  <ul className="space-y-1">
                    {chain.references.map((ref, idx) => (
                      <li key={idx} className="text-gray-600 text-sm flex items-center gap-2">
                        <Icon name="external-link-alt" className="text-xs" />
                        {ref}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}
          </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Main Application Component
    // ============================================

    const InterfaceDesignApp = () => {
      // Parse initial state from URL
      const initialRoute = parseUrlRoute();
      
      const [instance, setInstance] = useState(initialRoute.instance);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [notification, setNotification] = useState(null);
      const [activeView, setActiveView] = useState(initialRoute.activeView);
      const [overview, setOverview] = useState(null);
      const [hasTestCases, setHasTestCases] = useState(false);
      const [selectedItem, setSelectedItem] = useState(initialRoute.selectedItem);
      const [language, setLanguage] = useState('de'); // Default language is German
      
      // Initialize
      useEffect(() => {
        const route = parseUrlRoute();
        setInstance(route.instance);
        setActiveView(route.activeView);
        setSelectedItem(route.selectedItem);
        
        if (route.instance) {
          loadOverview(route.instance);
        } else {
          setLoading(false);
        }

        // Handle browser back/forward buttons
        const handlePopState = (event) => {
          const route = parseUrlRoute();
          setActiveView(route.activeView);
          setSelectedItem(route.selectedItem);
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      // Update URL when view changes
      const navigateToView = useCallback((view, itemId = null, replace = false) => {
        setActiveView(view);
        if (itemId) {
          setSelectedItem({ type: view.replace('-detail', ''), item: { id: itemId } });
        } else if (!view.includes('-detail')) {
          setSelectedItem(null);
        }
        updateUrl(instance, view, itemId, replace);
      }, [instance]);

      const loadOverview = async (inst) => {
        setLoading(true);
        try {
          const response = await fetch(getApiUrl(inst || instance, '/overview'));
          const data = await response.json();
          if (data.success) {
            setOverview(data.overview);
            setHasTestCases(data.hasTestCases || false);
          }
          setLoading(false);
        } catch (err) {
          setError('Fehler beim Laden der Daten');
          setLoading(false);
        }
      };

      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      const handleSelectItem = (type, item) => {
        const detailView = `${type}-detail`;
        setSelectedItem({ type, item });
        setActiveView(detailView);
        
        // Special handling for processes (need actor and diagramType in URL)
        if (type === 'process') {
          updateUrl(instance, detailView, item.baseName, false, {
            actor: item.actor,
            diagramType: item.diagramType
          });
        } else if (type === 'processchain') {
          updateUrl(instance, detailView, item.id);
        } else {
          updateUrl(instance, detailView, item.id);
        }
      };

      const handleBackFromDetail = () => {
        const previousType = selectedItem?.type;
        setSelectedItem(null);
        // Return to the appropriate list view based on type
        let listView = 'overview';
        if (previousType === 'exception') {
          listView = 'exceptions';
        } else if (previousType === 'enum') {
          listView = 'enums';
        } else if (previousType === 'function') {
          listView = 'functions';
        } else if (previousType === 'type') {
          listView = 'types';
        } else if (previousType === 'process') {
          listView = 'processes';
        } else if (previousType === 'processchain') {
          listView = 'processchains';
        }
        setActiveView(listView);
        updateUrl(instance, listView);
      };

      const handleNavigateToEnum = (enumName) => {
        setSelectedItem({ type: 'enum', item: { id: enumName } });
        setActiveView('enum-detail');
        updateUrl(instance, 'enum-detail', enumName);
      };

      const handleNavigateToException = (excName) => {
        setSelectedItem({ type: 'exception', item: { id: excName } });
        setActiveView('exception-detail');
        updateUrl(instance, 'exception-detail', excName);
      };

      const handleNavigateToType = (typeName) => {
        setSelectedItem({ type: 'type', item: { id: typeName } });
        setActiveView('type-detail');
        updateUrl(instance, 'type-detail', typeName);
      };

      // Navigation handlers for prev/next in DetailViews
      const handleNavigateToFunction = (func) => {
        const funcName = func.name || func.id || func;
        setSelectedItem({ type: 'function', item: { id: funcName } });
        setActiveView('function-detail');
        updateUrl(instance, 'function-detail', funcName);
      };

      const handleNavigateToOtherType = (type) => {
        const typeName = type.name || type.id || type;
        setSelectedItem({ type: 'type', item: { id: typeName } });
        setActiveView('type-detail');
        updateUrl(instance, 'type-detail', typeName);
      };

      const handleNavigateToOtherEnum = (enumItem) => {
        const enumName = enumItem.name || enumItem.id || enumItem;
        setSelectedItem({ type: 'enum', item: { id: enumName } });
        setActiveView('enum-detail');
        updateUrl(instance, 'enum-detail', enumName);
      };

      const handleNavigateToOtherException = (exc) => {
        const excName = exc.name || exc.id || exc;
        setSelectedItem({ type: 'exception', item: { id: excName } });
        setActiveView('exception-detail');
        updateUrl(instance, 'exception-detail', excName);
      };

      const handleNavigateToProcess = (process) => {
        if (!process) return;
        setSelectedItem({ 
          type: 'process', 
          item: { 
            id: process.baseName,
            baseName: process.baseName,
            actor: process.actor,
            diagramType: process.diagramType
          } 
        });
        setActiveView('process-detail');
        updateUrl(instance, 'process-detail', process.baseName, false, {
          actor: process.actor,
          diagramType: process.diagramType
        });
      };

      const handleNavigateToProcessChain = (chain) => {
        if (!chain) return;
        const chainId = chain.id || chain.baseName || chain.chainId;
        setSelectedItem({ 
          type: 'processchain', 
          item: { 
            id: chainId
          }
        });
        setActiveView('processchain-detail');
        updateUrl(instance, 'processchain-detail', chain.baseName);
      };

      // Handle navigation from sidebar and overview
      const handleViewChange = (view) => {
        setActiveView(view);
        setSelectedItem(null);
        updateUrl(instance, view);
      };

      // Loading state
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-gray-600">Lade Schnittstellenbeschreibung...</p>
            </div>
          </div>
        );
      }

      // No instance selected
      if (!instance) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <Icon name="exclamation-triangle" className="text-6xl text-yellow-500 mb-4" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">Keine Instanz ausgewählt</h1>
              <p className="text-gray-600 mb-4">Bitte wählen Sie zuerst eine Instanz aus.</p>
              <a 
                href="/"
                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
              >
                <Icon name="home" className="mr-2" />
                Zur Instanzauswahl
              </a>
            </div>
          </div>
        );
      }

      // Render the appropriate view
      const renderMainContent = () => {
        switch (activeView) {
          case 'overview':
            return <OverviewView overview={overview} onNavigate={handleViewChange} language={language} />;
          case 'functions':
            return <FunctionsView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'function-detail':
            return (
              <FunctionDetailView 
                instance={instance} 
                functionId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToType={handleNavigateToType}
                onNavigateToEnum={handleNavigateToEnum}
                onNavigateToException={handleNavigateToException}
                onNavigateToFunction={handleNavigateToFunction}
                language={language}
              />
            );
          case 'types':
            return <TypesView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'type-detail':
            return (
              <TypeDetailView 
                instance={instance} 
                typeId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToType={handleNavigateToType}
                onNavigateToEnum={handleNavigateToEnum}
                onNavigateToOtherType={handleNavigateToOtherType}
                language={language}
              />
            );
          case 'enums':
            return <EnumsView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'enum-detail':
            return (
              <EnumDetailView 
                instance={instance} 
                enumId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToEnum={handleNavigateToEnum}
                onNavigateToOtherEnum={handleNavigateToOtherEnum}
                language={language}
              />
            );
          case 'exceptions':
            return <ExceptionsView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'exception-detail':
            return (
              <ExceptionDetailView 
                instance={instance} 
                exceptionId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToFunction={handleNavigateToFunction}
                onNavigateToException={handleNavigateToException}
                onNavigateToOtherException={handleNavigateToOtherException}
                language={language}
              />
            );
          case 'processes':
            return <ProcessesView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'process-detail':
            return (
              <ProcessDetailView 
                instance={instance} 
                processId={selectedItem?.item?.id || selectedItem?.item?.baseName}
                actor={selectedItem?.item?.actor}
                diagramType={selectedItem?.item?.diagramType}
                onBack={handleBackFromDetail}
                onNavigateToFunction={handleNavigateToFunction}
                onNavigateToException={handleNavigateToException}
                onNavigateToType={handleNavigateToType}
                onNavigateToEnum={handleNavigateToEnum}
                onNavigateToProcess={handleNavigateToProcess}
                language={language}
              />
            );
          case 'processchains':
            return <ProcessChainsView instance={instance} onSelectItem={handleSelectItem} language={language} />;
          case 'processchain-detail':
            return (
              <ProcessChainDetailView 
                instance={instance} 
                chainId={selectedItem?.item?.id}
                onBack={handleBackFromDetail}
                onNavigateToProcess={handleNavigateToProcess}
                onNavigateToFunction={handleNavigateToFunction}
                onNavigateToOtherChain={handleNavigateToProcessChain}
                language={language}
              />
            );
          case 'processmap':
            return (
              <ProcessMapView 
                instance={instance}
                onNavigateToProcess={handleNavigateToProcess}
                onNavigateToProcessChain={handleNavigateToProcessChain}
                language={language}
              />
            );
          default:
            return <OverviewView overview={overview} onNavigate={handleViewChange} language={language} />;
        }
      };

      return (
        <div className="h-screen bg-gray-50 flex flex-col overflow-hidden">
          {/* Notification */}
          {notification && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded shadow-lg fade-in ${
              notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
              {notification.message}
            </div>
          )}

          {/* Header */}
          <header className="bg-gradient-to-r from-emerald-700 to-emerald-900 text-white px-6 py-3 shadow-lg flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3">
                  <a 
                    href="/"
                    className="p-1.5 hover:bg-emerald-600 rounded transition-colors"
                    title="Zur Instanzauswahl"
                  >
                    <Icon name="home" />
                  </a>
                  <h1 className="text-xl font-bold flex items-center">
                    <Icon name="project-diagram" className="mr-2" />
                    Schnittstellenbeschreibung
                  </h1>
                  <span className="px-2 py-0.5 bg-emerald-600 rounded text-sm font-normal">
                    {instance}
                  </span>
                </div>
              </div>

              <div className="flex items-center gap-4">
                {/* Language Switcher */}
                <button
                  onClick={() => setLanguage(lang => lang === 'de' ? 'en' : 'de')}
                  className="flex items-center gap-1 px-2 py-1 bg-emerald-600 hover:bg-emerald-500 rounded text-sm transition-colors"
                  title={language === 'de' ? 'Switch to English' : 'Zu Deutsch wechseln'}
                >
                  <Icon name="globe" />
                  <span className="font-medium">{language.toUpperCase()}</span>
                </button>

                {/* Link to TestCases - only show if testcases module is active */}
                {hasTestCases && (
                  <a
                    href={`/${instance}`}
                    className="flex items-center text-sm text-emerald-200 hover:text-white transition-colors"
                    title="Zum Testcase Manager"
                  >
                    <Icon name="flask" className="mr-1" />
                    TestCases
                  </a>
                )}
                
                {/* Refresh Button */}
                <button
                  onClick={() => loadOverview()}
                  className="p-2 hover:bg-emerald-600 rounded transition-colors"
                  title="Aktualisieren"
                >
                  <Icon name="sync-alt" />
                </button>
              </div>
            </div>
          </header>

          {/* Error Banner */}
          {error && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
              <div className="flex items-center">
                <Icon name="exclamation-triangle" className="mr-2" />
                <p>{error}</p>
                <button
                  onClick={() => setError(null)}
                  className="ml-4 text-red-700 hover:text-red-900"
                >
                  <Icon name="times" />
                </button>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="flex flex-1 overflow-hidden min-h-0">
            {/* Sidebar */}
            <Sidebar 
              activeView={activeView} 
              onViewChange={handleViewChange} 
              overview={overview}
              loading={loading}
              language={language}
            />

            {/* Main Area */}
            <main className="flex-1 overflow-y-auto bg-gray-100">
              {renderMainContent()}
            </main>
          </div>
        </div>
      );
    };

    // ============================================
    // Render Application
    // ============================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InterfaceDesignApp />);
  </script>
</body>
</html>
